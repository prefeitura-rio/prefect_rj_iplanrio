{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v5.json", "dbt_version": "1.7.3", "generated_at": "2024-09-30T15:24:20.987626Z", "invocation_id": "de8e99cd-4c70-4f63-8ed8-c02cb00d801a", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:16.907686Z", "completed_at": "2024-09-30T15:21:16.916599Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:16.917972Z", "completed_at": "2024-09-30T15:21:16.917984Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013273954391479492, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.agency", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nSAFE_CAST(agency_id AS STRING) agency_id,\nREPLACE(content,\"None\",\"\") content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.agency as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`agency`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:16.922780Z", "completed_at": "2024-09-30T15:21:16.927524Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:16.929015Z", "completed_at": "2024-09-30T15:21:16.929026Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009054183959960938, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.autuacao_citran", "compiled": true, "compiled_code": "\n\n\nSELECT\n  DATE(data) AS data,\n  SAFE_CAST(JSON_VALUE(content,'$.Hora') AS STRING) hora,\n  Cod__Detran as id_auto_infracao,\n  IF(JSON_VALUE(content, '$.DtLimDP') != '', SAFE_CAST(PARSE_DATE('%d/%m/%Y', JSON_VALUE(content,'$.DtLimDP')) AS STRING), NULL) data_limite_defesa_previa,\n  IF(JSON_VALUE(content, '$.DtLimR') != '', SAFE_CAST(PARSE_DATE('%d/%m/%Y', JSON_VALUE(content,'$.DtLimR')) AS STRING), NULL) data_limite_recurso,\n  SAFE_CAST(JSON_VALUE(content,'$.Situacao Atual') AS STRING) situacao_atual,\n  SAFE_CAST(JSON_VALUE(content,'$.\"St. Infracao\"') AS STRING) status_infracao,\n  SAFE_CAST(JSON_VALUE(content,'$.Multa') AS STRING) codigo_enquadramento,\n  SAFE_CAST(JSON_VALUE(content,'$.DsInf') AS STRING) tipificacao_resumida,\n  SAFE_CAST(JSON_VALUE(content,'$.Po') AS STRING) pontuacao,\n  SAFE_CAST(JSON_VALUE(content,'$.Tipo') AS STRING) tipo_veiculo,\n  SAFE_CAST(JSON_VALUE(content,'$.Marca') AS STRING) descricao_veiculo,\n  SAFE_CAST(JSON_VALUE(content,'$.Esp') AS STRING) especie_veiculo,\n  SAFE_CAST(JSON_VALUE(content,'$.CDUF') AS STRING) uf_proprietario,\n  SAFE_CAST(JSON_VALUE(content,'$.Cep') AS STRING) cep_proprietario,\n  SAFE_CAST(JSON_VALUE(content,'$.Ufir') AS NUMERIC) valor_infracao,\n  SAFE_CAST(JSON_VALUE(content,'$.VlPagto') AS NUMERIC) valor_pago,\n  IF(JSON_VALUE(content, '$.DtPagto') != '', SAFE_CAST(PARSE_DATE('%d/%m/%Y', JSON_VALUE(content,'$.DtPagto')) AS STRING), NULL) data_pagamento,\n  SAFE_CAST(JSON_VALUE(content,'$.Orgao') AS STRING) descricao_autuador,\n  SAFE_CAST(JSON_VALUE(content,'$.LocInf') AS STRING) endereco_autuacao,\n  SAFE_CAST(JSON_VALUE(content,'$.ProAutu') AS STRING) processo_defesa_autuacao,\n  SAFE_CAST(JSON_VALUE(content,'$.NotifPen') AS STRING) recurso_penalidade_multa,\n  SAFE_CAST(JSON_VALUE(content,'$.ProcRI') AS STRING) processo_troca_real_infrator,\n\nFROM\n  `rj-smtr-staging`.`infracao_staging`.`autuacoes_citran` as t", "relation_name": "`rj-smtr`.`transito_staging`.`autuacao_citran`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:16.933616Z", "completed_at": "2024-09-30T15:21:16.946417Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:16.947757Z", "completed_at": "2024-09-30T15:21:16.947767Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.016965866088867188, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.aux_h3_res9", "compiled": true, "compiled_code": "\n\nSELECT\n  tile_id,\n  ST_GEOGFROMTEXT(geometry) AS geometry\nFROM\n  `rj-smtr`.`br_rj_riodejaneiro_geo`.`h3_res9`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`aux_h3_res9`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:16.951681Z", "completed_at": "2024-09-30T15:21:16.955645Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:16.956923Z", "completed_at": "2024-09-30T15:21:16.956931Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007709980010986328, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.brt_registros", "compiled": true, "compiled_code": "SELECT\n    SAFE_CAST(id_veiculo AS STRING) id_veiculo,\n    SAFE_CAST(DATETIME(TIMESTAMP(timestamp_gps), \"America/Sao_Paulo\" ) AS DATETIME) timestamp_gps,\n    SAFE_CAST(DATETIME(TIMESTAMP_TRUNC(TIMESTAMP(timestamp_captura), SECOND), \"America/Sao_Paulo\" ) AS DATETIME) timestamp_captura,\n    REPLACE(content,\"None\",\"\") content,\n    data,\n    hora\nfrom\n    rj-smtr-staging.br_rj_riodejaneiro_brt_gps_staging.registros as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_registros`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:16.961237Z", "completed_at": "2024-09-30T15:21:16.965673Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:16.967065Z", "completed_at": "2024-09-30T15:21:16.967075Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0088043212890625, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.calendar", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nSAFE_CAST(service_id AS STRING) service_id,\nREPLACE(content,\"None\",\"\") content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.calendar as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`calendar`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:16.971106Z", "completed_at": "2024-09-30T15:21:16.975050Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:16.976408Z", "completed_at": "2024-09-30T15:21:16.976418Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0077936649322509766, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.dicionario", "compiled": true, "compiled_code": "\nSELECT\n  SAFE_CAST(chave AS STRING) AS chave,\n  SAFE_CAST(cobertura_temporal AS STRING) AS cobertura_temporal,\n  SAFE_CAST(id_tabela AS STRING) AS id_tabela,\n  SAFE_CAST(coluna AS STRING) AS coluna,\n  SAFE_CAST(valor AS STRING) AS valor\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`dicionario`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`dicionario`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:16.981039Z", "completed_at": "2024-09-30T15:21:16.993601Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:16.994949Z", "completed_at": "2024-09-30T15:21:16.994959Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.016657590866088867, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.feed_info_gtfs", "compiled": true, "compiled_code": "\n\nWITH feed_info AS (\n  SELECT\n    SAFE_CAST(timestamp_captura AS STRING) AS feed_version,\n    SAFE_CAST(data_versao AS DATE) AS feed_start_date,\n    NULL AS feed_end_date,\n    SAFE_CAST(feed_publisher_name AS STRING) feed_publisher_name,\n    SAFE_CAST(JSON_VALUE(content, '$.feed_publisher_url') AS STRING) feed_publisher_url,\n    SAFE_CAST(JSON_VALUE(content, '$.feed_lang') AS STRING) feed_lang,\n    SAFE_CAST(JSON_VALUE(content, '$.default_lang') AS STRING) default_lang,\n    SAFE_CAST(JSON_VALUE(content, '$.feed_contact_email') AS STRING) feed_contact_email,\n    SAFE_CAST(JSON_VALUE(content, '$.feed_contact_url') AS STRING) feed_contact_url,\n    CURRENT_DATETIME(\"America/Sao_Paulo\") AS feed_update_datetime,\n    '' AS versao_modelo\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`feed_info`\n  \n    WHERE\n      data_versao =  '2024-05-03'\n    UNION ALL\n      SELECT\n        *\n      FROM\n        `rj-smtr`.`gtfs`.`feed_info`\n      WHERE\n        feed_start_date != DATE('2024-05-03')\n  \n  )\n  SELECT\n    feed_version,\n    feed_start_date,\n    DATE_SUB(LEAD(DATE(feed_version)) OVER (ORDER BY feed_version), INTERVAL 1 DAY) AS feed_end_date,\n    feed_publisher_name,\n    feed_publisher_url,\n    feed_lang,\n    default_lang,\n    feed_contact_email,\n    feed_contact_url,\n    feed_update_datetime,\n    versao_modelo\n  FROM\n    feed_info", "relation_name": "`rj-smtr`.`gtfs`.`feed_info`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:16.999201Z", "completed_at": "2024-09-30T15:21:17.004365Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.005641Z", "completed_at": "2024-09-30T15:21:17.005649Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008884429931640625, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.frota_determinada", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nSAFE_CAST(route_id AS STRING) route_id,\nREPLACE(content,\"None\",\"\") content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.frota_determinada as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`frota_determinada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.009620Z", "completed_at": "2024-09-30T15:21:17.013759Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.015020Z", "completed_at": "2024-09-30T15:21:17.015028Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007961273193359375, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.holidays", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nDATE(SAFE_CAST(Data AS DATETIME)) data,\nREPLACE(content,\"None\",\"\") content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.holidays as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`holidays`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.018807Z", "completed_at": "2024-09-30T15:21:17.022318Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.023568Z", "completed_at": "2024-09-30T15:21:17.023576Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007122039794921875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.linhas", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nSAFE_CAST(linha_id AS STRING) linha_id,\nREPLACE(content,\"None\",\"\") content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.linhas as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`linhas`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.027495Z", "completed_at": "2024-09-30T15:21:17.030430Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.031765Z", "completed_at": "2024-09-30T15:21:17.031775Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006874561309814453, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.metadado_coluna", "compiled": true, "compiled_code": "SELECT\n  table_catalog AS project_id,\n  table_schema AS dataset_id,\n  table_name AS table_id,\n  column_name,\n  data_type,\n  description\nFROM\n  rj-smtr.`region-US`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS", "relation_name": "`rj-smtr`.`catalogo`.`metadado_coluna`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.036177Z", "completed_at": "2024-09-30T15:21:17.039787Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.041250Z", "completed_at": "2024-09-30T15:21:17.041261Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007855415344238281, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.my_first_dbt_model", "compiled": true, "compiled_code": "/*\n    Welcome to your first dbt model!\n    Did you know that you can also configure models directly within SQL files?\n    This will override configurations stated in dbt_project.yml\n\n    Try changing \"table\" to \"view\" below\n*/\n\n\n\nwith source_data as (\n\n    select 1 as id\n    union all\n    select null as id\n\n)\n\nselect *\nfrom source_data\n\n/*\n    Uncomment the line below to remove records with null `id` values\n*/\n\n-- where id is not null", "relation_name": "`rj-smtr`.`dbt`.`my_first_dbt_model`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.047824Z", "completed_at": "2024-09-30T15:21:17.055853Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.057385Z", "completed_at": "2024-09-30T15:21:17.057397Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.014427900314331055, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.receita_autuacao", "compiled": true, "compiled_code": "\n\nWITH receita_unpivot AS (\n  SELECT\n    ano,\n    CASE\n      WHEN mes = 'janeiro' THEN '01'\n      WHEN mes = 'fevereiro' THEN '02'\n      WHEN mes = 'marco' THEN '03'\n      WHEN mes = 'abril' THEN '04'\n      WHEN mes = 'maio' THEN '05'\n      WHEN mes = 'junho' THEN '06'\n      WHEN mes = 'julho' THEN '07'\n      WHEN mes = 'agosto' THEN '08'\n      WHEN mes = 'setembro' THEN '09'\n      WHEN mes = 'outubro' THEN '10'\n      WHEN mes = 'novembro' THEN '11'\n      WHEN mes = 'dezembro' THEN '12'\n    END AS mes,\n    SAFE_CAST(REPLACE(REPLACE(valor_arrecadacao, '.', ''), ',', '.') AS NUMERIC) AS valor_arrecadacao\n  FROM\n    `rj-smtr-staging`.`infracao_staging`.`receita_autuacao`\n  UNPIVOT (\n    valor_arrecadacao FOR mes IN (janeiro, fevereiro, marco, abril, maio, junho, julho, agosto, setembro, outubro, novembro, dezembro)\n  )\n\n),\n\nreceita_com_data AS (\n  SELECT\n    PARSE_DATE('%Y-%m-%d', CONCAT(ano, '-', mes, '-01')) AS data,\n    ano,\n    mes,\n    valor_arrecadacao\n  FROM receita_unpivot\n  WHERE valor_arrecadacao IS NOT NULL\n)\n\nSELECT\n  data,\n  ano,\n  mes,\n  valor_arrecadacao\nFROM receita_com_data\n\n    WHERE\n      data BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n", "relation_name": "`rj-smtr`.`transito`.`receita_autuacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.062082Z", "completed_at": "2024-09-30T15:21:17.066115Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.067405Z", "completed_at": "2024-09-30T15:21:17.067415Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007894754409790039, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.recursos_sppo_servico_dia_avaliacao", "compiled": true, "compiled_code": "\n\nSELECT\n  PARSE_DATE(\"%d/%m/%Y\", DATA) AS data,\n  id_recurso,\n  tipo_recurso,\n  servico,\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_servico_dia_avaliacao`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos`.`recursos_sppo_servico_dia_avaliacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.071442Z", "completed_at": "2024-09-30T15:21:17.075872Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.077272Z", "completed_at": "2024-09-30T15:21:17.077283Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008830547332763672, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.recursos_sppo_servico_dia_pago", "compiled": true, "compiled_code": "\n\nWITH\n  -- 1. Trata os IDs de recurso de forma que, caso tenha mais que um, sempre estejam separados por v\u00edrgula, ordenados do menor para o maior e sem espa\u00e7os adicionais\n  treated_id_recurso AS (\n  SELECT\n    DISTINCT *\n  FROM (\n    SELECT\n      id_recurso_old,\n      ARRAY_TO_STRING(ARRAY(\n        SELECT\n          TRIM(id)\n        FROM\n          UNNEST(id_array) AS id\n        ORDER BY\n          id), \", \") AS id_recurso\n    FROM (\n      SELECT\n        id_recurso AS id_recurso_old,\n        SPLIT(REPLACE(id_recurso, \" e \", \", \"), \", \") AS id_array\n      FROM\n        `rj-smtr-staging`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_servico_dia_pago`\n  ))),\n  -- 2. Trata a tabela em staging\n  treated_recurso AS (\n  SELECT\n    * EXCEPT(DATA,\n      valor_pago,\n      tipo_dia),\n    PARSE_DATE(\"%d/%m/%Y\", DATA) AS DATA,\n    SAFE_CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(valor_pago, r\"\\.\", \"\"), r\",\", \".\"), r\"[^\\d\\.-]\", \"\") AS FLOAT64) AS valor_pago,\n    CASE\n      WHEN tipo_dia LIKE \"R$%\" OR tipo_dia = \"\" THEN NULL\n    ELSE\n    tipo_dia\n  END\n    AS tipo_dia\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_servico_dia_pago`\n  WHERE\n    DATA NOT LIKE \"%-%\" )\nSELECT\n  data,\n  tipo_dia,\n  i.id_recurso,\n  tipo_recurso,\n  quinzena_ocorrencia,\n  quinzena_pagamento,\n  consorcio,\n  servico,\n  valor_pago\nFROM\n  treated_recurso AS t\nLEFT JOIN\n  treated_id_recurso AS i\nON\n  t.id_recurso = i.id_recurso_old", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos`.`recursos_sppo_servico_dia_pago`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.082721Z", "completed_at": "2024-09-30T15:21:17.087288Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.089070Z", "completed_at": "2024-09-30T15:21:17.089080Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009307622909545898, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.routes", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nSAFE_CAST(route_id AS STRING) route_id,\nREPLACE(content, \"None\", '') content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.routes as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.093268Z", "completed_at": "2024-09-30T15:21:17.097065Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.098323Z", "completed_at": "2024-09-30T15:21:17.098333Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007828235626220703, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.shapes", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nSAFE_CAST(shape_id AS STRING) shape_id,\nREPLACE(content, \"None\", '') content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.shapes as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.102239Z", "completed_at": "2024-09-30T15:21:17.107306Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.108591Z", "completed_at": "2024-09-30T15:21:17.108601Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008856773376464844, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_infracao_staging", "compiled": true, "compiled_code": "\n\n\nSELECT\n  data,\n  SAFE_CAST(DATETIME(TIMESTAMP_TRUNC(TIMESTAMP(timestamp_captura), SECOND), \"America/Sao_Paulo\" ) AS DATETIME) timestamp_captura,\n  SAFE_CAST(JSON_VALUE(content,'$.modo') AS STRING) modo,\n  SAFE_CAST(JSON_VALUE(content,'$.permissao') AS STRING) permissao,\n  SAFE_CAST(placa AS STRING) placa,\n  SAFE_CAST(id_auto_infracao AS STRING) id_auto_infracao,\n  PARSE_DATE(\"%d/%m/%Y\", SAFE_CAST(JSON_VALUE(content,'$.data_infracao') AS STRING)) data_infracao,\n  SAFE_CAST(JSON_VALUE(content,'$.valor') AS FLOAT64) valor,\n  SAFE_CAST(JSON_VALUE(content,'$.id_infracao') AS STRING) id_infracao,\n  SAFE_CAST(JSON_VALUE(content,'$.infracao') AS STRING) infracao,\n  SAFE_CAST(JSON_VALUE(content,'$.status') AS STRING) status,\n  IF(JSON_VALUE(content,'$.data_pagamento') = \"\", NULL, PARSE_DATE(\"%d/%m/%Y\", JSON_VALUE(content,'$.data_pagamento'))) data_pagamento\nFROM\n  `rj-smtr-staging`.`veiculo_staging`.`sppo_infracao` as t", "relation_name": "`rj-smtr`.`veiculo_staging`.`sppo_infracao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.112862Z", "completed_at": "2024-09-30T15:21:17.116923Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.118186Z", "completed_at": "2024-09-30T15:21:17.118195Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008090019226074219, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_licenciamento_solicitacao_staging", "compiled": true, "compiled_code": "\n\nSELECT\n   SAFE_CAST(data AS DATE) data,\n   SAFE_CAST(DATETIME(TIMESTAMP_TRUNC(TIMESTAMP(timestamp_captura), SECOND), \"America/Sao_Paulo\" ) AS DATETIME) timestamp_captura,\n   SAFE_CAST(JSON_VALUE(content,\"$.modo\") AS STRING) modo,\n   SAFE_CAST(id_veiculo AS STRING) id_veiculo,\n   SAFE_CAST(JSON_VALUE(content,\"$.ano_fabricacao\") AS STRING) ano_fabricacao,\n   SAFE_CAST(JSON_VALUE(content,\"$.carroceria\") AS STRING) carroceria,\n   SAFE_CAST(JSON_VALUE(content,\"$.data_ultima_vistoria\") AS STRING) data_ultima_vistoria,\n   SAFE_CAST(JSON_VALUE(content,\"$.id_carroceria\") AS INT64) id_carroceria,\n   SAFE_CAST(JSON_VALUE(content,\"$.id_chassi\") AS INT64) id_chassi,\n   SAFE_CAST(JSON_VALUE(content,\"$.id_fabricante_chassi\") AS INT64) id_fabricante_chassi,\n   SAFE_CAST(JSON_VALUE(content,\"$.id_interno_carroceria\") AS INT64) id_interno_carroceria,\n   SAFE_CAST(JSON_VALUE(content,\"$.id_planta\") AS INT64) id_planta,\n   SAFE_CAST(JSON_VALUE(content,\"$.indicador_ar_condicionado\") AS BOOL) indicador_ar_condicionado,\n   SAFE_CAST(JSON_VALUE(content,\"$.indicador_elevador\") AS BOOL) indicador_elevador,\n   SAFE_CAST(JSON_VALUE(content,\"$.indicador_usb\") AS BOOL) indicador_usb,\n   SAFE_CAST(JSON_VALUE(content,\"$.indicador_wifi\") AS BOOL) indicador_wifi,\n   SAFE_CAST(JSON_VALUE(content,\"$.nome_chassi\") AS STRING) nome_chassi,\n   SAFE_CAST(JSON_VALUE(content,\"$.permissao\") AS STRING) permissao,\n   SAFE_CAST(JSON_VALUE(content,\"$.placa\") AS STRING) placa,\n   SAFE_CAST(JSON_VALUE(content,\"$.quantidade_lotacao_pe\") AS INT64) quantidade_lotacao_pe,\n   SAFE_CAST(JSON_VALUE(content,\"$.quantidade_lotacao_sentado\") AS INT64) quantidade_lotacao_sentado,\n   SAFE_CAST(JSON_VALUE(content,\"$.tipo_combustivel\") AS STRING) tipo_combustivel,\n   SAFE_CAST(JSON_VALUE(content,\"$.tipo_veiculo\") AS STRING) tipo_veiculo,\n   SAFE_CAST(JSON_VALUE(content,\"$.status\") AS STRING) status,\n   SAFE_CAST(JSON_VALUE(content,\"$.solicitacao\") AS STRING) solicitacao\n FROM\n     `rj-smtr-staging`.`veiculo_staging`.`sppo_licenciamento_solicitacao` as t", "relation_name": "`rj-smtr`.`veiculo_staging`.`sppo_licenciamento_solicitacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.122277Z", "completed_at": "2024-09-30T15:21:17.126492Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.127923Z", "completed_at": "2024-09-30T15:21:17.127933Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008173465728759766, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_licenciamento_stu_staging", "compiled": true, "compiled_code": "\n\nSELECT\n   data,\n   SAFE_CAST(DATETIME(TIMESTAMP_TRUNC(TIMESTAMP(timestamp_captura), SECOND), \"America/Sao_Paulo\" ) AS DATETIME) timestamp_captura,\n   SAFE_CAST(JSON_VALUE(content,\"$.modo\") AS STRING) modo,\n   SAFE_CAST(id_veiculo AS STRING) id_veiculo,\n   SAFE_CAST(JSON_VALUE(content,\"$.ano_fabricacao\") AS INT64) ano_fabricacao,\n   SAFE_CAST(JSON_VALUE(content,\"$.carroceria\") AS STRING) carroceria,\n   CASE\n    WHEN JSON_VALUE(content,\"$.data_ultima_vistoria\") = \"\" THEN NULL\n   ELSE\n    SAFE_CAST(PARSE_DATETIME(\"%d/%m/%Y\", JSON_VALUE(content,\"$.data_ultima_vistoria\")) AS DATE)\n   END\n   AS data_ultima_vistoria,\n   SAFE_CAST(JSON_VALUE(content,\"$.id_carroceria\") AS INT64) id_carroceria,\n   SAFE_CAST(JSON_VALUE(content,\"$.id_chassi\") AS INT64) id_chassi,\n   SAFE_CAST(JSON_VALUE(content,\"$.id_fabricante_chassi\") AS INT64) id_fabricante_chassi,\n   SAFE_CAST(JSON_VALUE(content,\"$.id_interno_carroceria\") AS INT64) id_interno_carroceria,\n   SAFE_CAST(JSON_VALUE(content,\"$.id_planta\") AS INT64) id_planta,\n   SAFE_CAST(JSON_VALUE(content,\"$.indicador_ar_condicionado\") AS BOOL) indicador_ar_condicionado,\n   SAFE_CAST(JSON_VALUE(content,\"$.indicador_elevador\") AS BOOL) indicador_elevador,\n   SAFE_CAST(JSON_VALUE(content,\"$.indicador_usb\") AS BOOL) indicador_usb,\n   SAFE_CAST(JSON_VALUE(content,\"$.indicador_wifi\") AS BOOL) indicador_wifi,\n   SAFE_CAST(JSON_VALUE(content,\"$.nome_chassi\") AS STRING) nome_chassi,\n   SAFE_CAST(JSON_VALUE(content,\"$.permissao\") AS STRING) permissao,\n   SAFE_CAST(JSON_VALUE(content,\"$.placa\") AS STRING) placa,\n   SAFE_CAST(JSON_VALUE(content,\"$.quantidade_lotacao_pe\") AS INT64) quantidade_lotacao_pe,\n   SAFE_CAST(JSON_VALUE(content,\"$.quantidade_lotacao_sentado\") AS INT64) quantidade_lotacao_sentado,\n   SAFE_CAST(JSON_VALUE(content,\"$.tipo_combustivel\") AS STRING) tipo_combustivel,\n   SAFE_CAST(JSON_VALUE(content,\"$.tipo_veiculo\") AS STRING) tipo_veiculo,\n   SAFE_CAST(JSON_VALUE(content,\"$.status\") AS STRING) status,\n   CASE\n    WHEN JSON_VALUE(content,\"$.data_inicio_vinculo\") = \"\" THEN NULL\n    ELSE\n    SAFE_CAST(PARSE_DATETIME(\"%d/%m/%Y\", JSON_VALUE(content,\"$.data_inicio_vinculo\")) AS DATE)\n  END\n    AS data_inicio_vinculo,\n FROM\n    `rj-smtr-staging`.`veiculo_staging`.`sppo_licenciamento_stu` as t", "relation_name": "`rj-smtr`.`veiculo_staging`.`sppo_licenciamento_stu`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.132051Z", "completed_at": "2024-09-30T15:21:17.136354Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.139063Z", "completed_at": "2024-09-30T15:21:17.139080Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010391950607299805, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_realocacao", "compiled": true, "compiled_code": "SELECT\n  SAFE_CAST(id_veiculo AS STRING) id_veiculo,\n  SAFE_CAST(DATETIME(TIMESTAMP(datetime_operacao), \"America/Sao_Paulo\") AS DATETIME) datetime_operacao,\n  concat(\n    ifnull(REGEXP_EXTRACT(servico, r'[A-Z]+'), \"\"),\n    ifnull(REGEXP_EXTRACT(servico, r'[0-9]+'), \"\")\n  ) as servico,\n  SAFE_CAST(DATETIME(TIMESTAMP(datetime_entrada), \"America/Sao_Paulo\") AS DATETIME) as datetime_entrada,\n  SAFE_CAST(DATETIME(TIMESTAMP(datetime_saida), \"America/Sao_Paulo\") AS DATETIME) as datetime_saida,\n  SAFE_CAST(DATETIME(TIMESTAMP(timestamp_processamento), \"America/Sao_Paulo\") AS DATETIME) as timestamp_processamento,\n  SAFE_CAST(DATETIME(TIMESTAMP(timestamp_captura), \"America/Sao_Paulo\") AS DATETIME) as timestamp_captura,\n  data,\n  hora\nFROM\n  rj-smtr-staging.br_rj_riodejaneiro_onibus_gps_staging.realocacao as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_realocacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.145618Z", "completed_at": "2024-09-30T15:21:17.150144Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.151606Z", "completed_at": "2024-09-30T15:21:17.151616Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008745193481445312, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_realocacao_zirix", "compiled": true, "compiled_code": "\n\nSELECT\n  SAFE_CAST(id_veiculo AS STRING) id_veiculo,\n  SAFE_CAST(DATETIME(TIMESTAMP(datetime_operacao), \"America/Sao_Paulo\") AS DATETIME) datetime_operacao,\n  concat(\n    ifnull(REGEXP_EXTRACT(servico, r'[A-Z]+'), \"\"),\n    ifnull(REGEXP_EXTRACT(servico, r'[0-9]+'), \"\")\n  ) as servico,\n  SAFE_CAST(DATETIME(TIMESTAMP(datetime_entrada), \"America/Sao_Paulo\") AS DATETIME) as datetime_entrada,\n  SAFE_CAST(DATETIME(TIMESTAMP(datetime_saida), \"America/Sao_Paulo\") AS DATETIME) as datetime_saida,\n  SAFE_CAST(DATETIME(TIMESTAMP(timestamp_processamento), \"America/Sao_Paulo\") AS DATETIME) as timestamp_processamento,\n  SAFE_CAST(DATETIME(TIMESTAMP(timestamp_captura), \"America/Sao_Paulo\") AS DATETIME) as timestamp_captura,\n  SAFE_CAST(data AS DATE) as data,\n  SAFE_CAST(hora AS INT64) as hora\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_onibus_gps_zirix_staging`.`realocacao`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_realocacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.155656Z", "completed_at": "2024-09-30T15:21:17.160794Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.162060Z", "completed_at": "2024-09-30T15:21:17.162070Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00910496711730957, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_registro_agente_verao_staging", "compiled": true, "compiled_code": "\n\nSELECT\n  SAFE_CAST(PARSE_DATETIME(\"%d/%m/%Y %H:%M:%S\", datetime_registro) AS DATE) AS data,\n  SAFE_CAST(PARSE_DATETIME(\"%d/%m/%Y %H:%M:%S\", datetime_registro) AS DATETIME) AS datetime_registro,\n  SHA256(PARSE_DATETIME(\"%d/%m/%Y %H:%M:%S\", datetime_registro) || \"_\" || SAFE_CAST(email AS STRING)) AS id_registro,\n  SAFE_CAST(JSON_VALUE(content,'$.id_veiculo') AS STRING) AS id_veiculo,\n  SAFE_CAST(JSON_VALUE(content,'$.servico') AS STRING) AS servico,\n  SAFE_CAST(JSON_VALUE(content,'$.link_foto') AS STRING) AS link_foto,\n  SAFE_CAST(JSON_VALUE(content,'$.validacao') AS BOOL) AS validacao,\n  SAFE_CAST(DATETIME(TIMESTAMP_TRUNC(TIMESTAMP(timestamp_captura), SECOND), \"America/Sao_Paulo\" ) AS DATETIME) AS datetime_captura,\n  \"\" AS versao\nFROM\n  `rj-smtr-staging`.`veiculo_staging`.`sppo_registro_agente_verao`", "relation_name": "`rj-smtr`.`veiculo_staging`.`sppo_registro_agente_verao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.166015Z", "completed_at": "2024-09-30T15:21:17.169599Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.170860Z", "completed_at": "2024-09-30T15:21:17.170867Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0071926116943359375, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_registros", "compiled": true, "compiled_code": "SELECT\n    SAFE_CAST(ordem AS STRING) ordem,\n    SAFE_CAST(REPLACE(latitude, ',', '.') AS FLOAT64) latitude,\n    SAFE_CAST(REPLACE(longitude, ',', '.') AS FLOAT64) longitude,\n    SAFE_CAST(DATETIME(TIMESTAMP(datahora), \"America/Sao_Paulo\") AS DATETIME) timestamp_gps,\n    SAFE_CAST(velocidade AS INT64) velocidade,\n    concat(\n        ifnull(REGEXP_EXTRACT(linha, r'[A-Z]+'), \"\"),\n        ifnull(REGEXP_EXTRACT(linha, r'[0-9]+'), \"\")\n    ) as linha,\n    SAFE_CAST(DATETIME(TIMESTAMP(timestamp_captura), \"America/Sao_Paulo\") AS DATETIME) timestamp_captura,\n    SAFE_CAST(data AS DATE) data,\n    SAFE_CAST(hora AS INT64) hora\nfrom\n    rj-smtr-staging.br_rj_riodejaneiro_onibus_gps_staging.registros as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_registros`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.174713Z", "completed_at": "2024-09-30T15:21:17.178904Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.180234Z", "completed_at": "2024-09-30T15:21:17.180242Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00808405876159668, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_registros_zirix", "compiled": true, "compiled_code": "\n\nSELECT\n    SAFE_CAST(ordem AS STRING) ordem,\n    SAFE_CAST(REPLACE(latitude, ',', '.') AS FLOAT64) latitude,\n    SAFE_CAST(REPLACE(longitude, ',', '.') AS FLOAT64) longitude,\n    SAFE_CAST(DATETIME(TIMESTAMP(datahora), \"America/Sao_Paulo\") AS DATETIME) timestamp_gps,\n    SAFE_CAST(velocidade AS INT64) velocidade,\n    concat(\n        ifnull(REGEXP_EXTRACT(linha, r'[A-Z]+'), \"\"),\n        ifnull(REGEXP_EXTRACT(linha, r'[0-9]+'), \"\")\n    ) as linha,\n    SAFE_CAST(DATETIME(TIMESTAMP(timestamp_captura), \"America/Sao_Paulo\") AS DATETIME) timestamp_captura,\n    SAFE_CAST(data AS DATE) data,\n    SAFE_CAST(hora AS INT64) hora\nfrom\n    `rj-smtr-staging`.`br_rj_riodejaneiro_onibus_gps_zirix_staging`.`registros`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_registros`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.184127Z", "completed_at": "2024-09-30T15:21:17.187897Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.189142Z", "completed_at": "2024-09-30T15:21:17.189150Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007380247116088867, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_vistoria_tr_subtt_cglf_2023_staging", "compiled": true, "compiled_code": "\n\nSELECT\n  SAFE_CAST(data AS DATE) AS data,\n  SAFE_CAST(id_veiculo AS STRING) AS id_veiculo,\n  SAFE_CAST(placa AS STRING) AS placa,\n  SAFE_CAST(permissao AS STRING) AS permissao,\n  SAFE_CAST(chassi AS STRING) AS chassi,\n  SAFE_CAST(ano_fabricacao AS INT64) AS ano_fabricacao,\n  SAFE_CAST(selo AS STRING) AS selo,\n  SAFE_CAST(darm AS STRING) AS darm,\n  SAFE_CAST(ano_ultima_vistoria AS INT64) AS ano_ultima_vistoria,\nFROM\n  `rj-smtr-staging`.`veiculo_staging`.`sppo_vistoria_tr_subtt_cglf_2023`", "relation_name": "`rj-smtr`.`veiculo_staging`.`sppo_vistoria_tr_subtt_cglf_2023`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.193088Z", "completed_at": "2024-09-30T15:21:17.196849Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.198107Z", "completed_at": "2024-09-30T15:21:17.198116Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007750272750854492, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_vistoria_tr_subtt_cglf_2024_staging", "compiled": true, "compiled_code": "\n\nSELECT\n  SAFE_CAST(data AS DATE) AS data,\n  SAFE_CAST(id_veiculo AS STRING) AS id_veiculo,\n  SAFE_CAST(placa AS STRING) AS placa,\n  SAFE_CAST(permissao AS STRING) AS permissao,\n  SAFE_CAST(chassi AS STRING) AS chassi,\n  SAFE_CAST(ano_fabricacao AS INT64) AS ano_fabricacao,\n  SAFE_CAST(selo AS STRING) AS selo,\n  SAFE_CAST(darm AS STRING) AS darm,\n  SAFE_CAST(ano_ultima_vistoria AS INT64) AS ano_ultima_vistoria,\nFROM\n  `rj-smtr-staging`.`veiculo_staging`.`sppo_vistoria_tr_subtt_cglf_2024`", "relation_name": "`rj-smtr`.`veiculo_staging`.`sppo_vistoria_tr_subtt_cglf_2024`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.202166Z", "completed_at": "2024-09-30T15:21:17.205786Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.207051Z", "completed_at": "2024-09-30T15:21:17.207059Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008944272994995117, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_vistoria_tr_subtt_cglf_pendentes_2024_staging", "compiled": true, "compiled_code": "\n\nSELECT\n  SAFE_CAST(data AS DATE) AS data,\n  SAFE_CAST(id_veiculo AS STRING) AS id_veiculo,\n  SAFE_CAST(placa AS STRING) AS placa,\n  SAFE_CAST(empresa AS STRING) AS empresa,\n  SAFE_CAST(ano_ultima_vistoria AS INT64) AS ano_ultima_vistoria,\nFROM\n  `rj-smtr-staging`.`veiculo_staging`.`sppo_vistoria_tr_subtt_cglf_pendentes_2024`", "relation_name": "`rj-smtr`.`veiculo_staging`.`sppo_vistoria_tr_subtt_cglf_pendentes_2024`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.212643Z", "completed_at": "2024-09-30T15:21:17.216530Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.217784Z", "completed_at": "2024-09-30T15:21:17.217792Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007578849792480469, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_arquivo_retorno", "compiled": true, "compiled_code": "\n\nSELECT\n  data,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n  id,\n  DATE(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E3SZ', SAFE_CAST(JSON_VALUE(content, '$.dataCaptura') AS STRING))) AS dataCaptura,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E3SZ', SAFE_CAST(JSON_VALUE(content, '$.dataHoraGeracaoRetorno') AS STRING)), \"America/Sao_Paulo\") AS dataHoraGeracaoRetorno,\n  DATE(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E3SZ', SAFE_CAST(JSON_VALUE(content, '$.dataOrdem') AS STRING))) AS dataOrdem,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E3SZ', SAFE_CAST(JSON_VALUE(content, '$.dataProcessamento') AS STRING)), \"America/Sao_Paulo\") AS dataProcessamento,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E3S%Ez', SAFE_CAST(JSON_VALUE(content, '$.dataVencimento') AS STRING))) AS dataVencimento,\n  SAFE_CAST(JSON_VALUE(content, '$.favorecido') AS STRING) AS favorecido,\n  SAFE_CAST(JSON_VALUE(content, '$.idConsorcio') AS STRING) AS idConsorcio,\n  SAFE_CAST(JSON_VALUE(content, '$.idOperadora') AS STRING) AS idOperadora,\n  SAFE_CAST(JSON_VALUE(content, '$.idOrdemPagamento') AS STRING) AS idOrdemPagamento,\n  SAFE_CAST(JSON_VALUE(content, '$.isPago') AS BOOL) AS isPago,\n  SAFE_CAST(JSON_VALUE(content, '$.nomeConsorcio') AS STRING) AS nomeConsorcio,\n  SAFE_CAST(JSON_VALUE(content, '$.nomeOperadora') AS STRING) AS nomeOperadora,\n  JSON_VALUE(content, '$.ocorrencias') AS ocorrencias,\n  SAFE_CAST(JSON_VALUE(content, '$.valor') AS NUMERIC) AS valor,\n  SAFE_CAST(JSON_VALUE(content, '$.valorRealEfetivado') AS NUMERIC) AS valorRealEfetivado\nFROM\n  `rj-smtr-staging`.`controle_financeiro_staging`.`arquivo_retorno`", "relation_name": "`rj-smtr`.`controle_financeiro_staging`.`arquivo_retorno`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.221639Z", "completed_at": "2024-09-30T15:21:17.225886Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.227266Z", "completed_at": "2024-09-30T15:21:17.227275Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008090972900390625, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_cliente", "compiled": true, "compiled_code": "\n\nWITH\n    cliente AS (\n        SELECT\n            data,\n            SAFE_CAST(CD_CLIENTE AS STRING) AS cd_cliente,\n            timestamp_captura,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_TIPO_DOCUMENTO') AS STRING) AS cd_tipo_documento,\n            SAFE_CAST(JSON_VALUE(content, '$.NM_CLIENTE') AS STRING) AS nm_cliente,\n            SAFE_CAST(JSON_VALUE(content, '$.NM_CLIENTE_SOCIAL') AS STRING) AS nm_cliente_social,\n            SAFE_CAST(JSON_VALUE(content, '$.IN_TIPO_PESSOA_FISICA_JURIDICA') AS STRING) AS in_tipo_pessoa_fisica_juridica,\n            SAFE_CAST(JSON_VALUE(content, '$.NR_DOCUMENTO') AS STRING) AS nr_documento,\n            SAFE_CAST(JSON_VALUE(content, '$.NR_DOCUMENTO_ALTERNATIVO') AS STRING) AS nr_documento_alternativo,\n            SAFE_CAST(JSON_VALUE(content, '$.TX_EMAIL') AS STRING) AS tx_email,\n            SAFE_CAST(JSON_VALUE(content, '$.NR_TELEFONE') AS STRING) AS nr_telefone,\n            SAFE_CAST(JSON_VALUE(content, '$.DT_CADASTRO') AS STRING) AS dt_cadastro\n        FROM\n            `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`cliente`\n    ),\n    cliente_rn AS (\n        SELECT\n            *,\n            ROW_NUMBER() OVER (PARTITION BY cd_cliente ORDER BY timestamp_captura DESC) AS rn\n        FROM\n            cliente\n    )\nSELECT\n  * EXCEPT(rn)\nFROM\n  cliente_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`cliente`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.231137Z", "completed_at": "2024-09-30T15:21:17.235338Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.236647Z", "completed_at": "2024-09-30T15:21:17.236655Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007866382598876953, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_consorcio", "compiled": true, "compiled_code": "\n\nWITH\n    consorcio AS (\n        SELECT\n            data,\n            SAFE_CAST(CD_CONSORCIO AS STRING) AS cd_consorcio,\n            timestamp_captura,\n            DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', SAFE_CAST(JSON_VALUE(content, '$.DT_INCLUSAO') AS STRING)), \"America/Sao_Paulo\") AS datetime_inclusao,\n            SAFE_CAST(JSON_VALUE(content, '$.NM_CONSORCIO') AS STRING) AS nm_consorcio\n        FROM\n            `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`consorcio`\n    ),\n    consorcio_rn AS (\n        SELECT\n            *,\n            ROW_NUMBER() OVER (PARTITION BY cd_consorcio ORDER BY timestamp_captura DESC) AS rn\n        FROM\n            consorcio\n    )\nSELECT\n  * EXCEPT(rn)\nFROM\n  consorcio_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`consorcio`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.240431Z", "completed_at": "2024-09-30T15:21:17.244412Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.245700Z", "completed_at": "2024-09-30T15:21:17.245709Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0077626705169677734, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_conta_bancaria", "compiled": true, "compiled_code": "\n\nWITH\n    conta_bancaria AS (\n        SELECT\n            data,\n            SAFE_CAST(CD_CLIENTE AS STRING) AS cd_cliente,\n            timestamp_captura,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_AGENCIA') AS STRING) AS cd_agencia,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_TIPO_CONTA') AS STRING) AS cd_tipo_conta,\n            SAFE_CAST(JSON_VALUE(content, '$.NM_BANCO') AS STRING) AS nm_banco,\n            SAFE_CAST(JSON_VALUE(content, '$.NR_BANCO') AS STRING) AS nr_banco,\n            SAFE_CAST(JSON_VALUE(content, '$.NR_CONTA') AS STRING) AS nr_conta,\n        FROM\n            `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`conta_bancaria`\n    ),\n    conta_bancaria_rn AS (\n        SELECT\n            *,\n            ROW_NUMBER() OVER (PARTITION BY cd_cliente ORDER BY timestamp_captura DESC) AS rn\n        FROM\n            conta_bancaria\n    )\nSELECT\n  * EXCEPT(rn)\nFROM\n  conta_bancaria_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`conta_bancaria`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.250346Z", "completed_at": "2024-09-30T15:21:17.254735Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.256011Z", "completed_at": "2024-09-30T15:21:17.256020Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008394241333007812, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_contato_pessoa_juridica", "compiled": true, "compiled_code": "\n\nWITH\n    contato_pessoa_juridica AS (\n        SELECT\n            data,\n            SAFE_CAST(NR_SEQ_CONTATO AS STRING) AS nr_seq_contato,\n            SAFE_CAST(CD_CLIENTE AS STRING) AS cd_cliente,\n            timestamp_captura,\n            DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', SAFE_CAST(JSON_VALUE(content, '$.DT_INCLUSAO') AS STRING)), \"America/Sao_Paulo\") AS datetime_inclusao,\n            SAFE_CAST(JSON_VALUE(content, '$.NM_CONTATO') AS STRING) AS nm_contato,\n            SAFE_CAST(JSON_VALUE(content, '$.NR_RAMAL') AS STRING) AS nr_ramal,\n            SAFE_CAST(JSON_VALUE(content, '$.NR_TELEFONE') AS STRING) AS nr_telefone,\n            SAFE_CAST(JSON_VALUE(content, '$.TX_EMAIL') AS STRING) AS tx_email,\n        FROM\n            `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`contato_pessoa_juridica`\n    ),\n    contato_pessoa_juridica_rn AS (\n        SELECT\n            *,\n            ROW_NUMBER() OVER (PARTITION BY nr_seq_contato, cd_cliente ORDER BY timestamp_captura DESC) AS rn\n        FROM\n            contato_pessoa_juridica\n    )\nSELECT\n  * EXCEPT(rn)\nFROM\n  contato_pessoa_juridica_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`contato_pessoa_juridica`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.260650Z", "completed_at": "2024-09-30T15:21:17.266266Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.267821Z", "completed_at": "2024-09-30T15:21:17.267835Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010892868041992188, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_endereco", "compiled": true, "compiled_code": "\n\nWITH\n    endereco AS (\n        SELECT\n            data,\n            SAFE_CAST(NR_SEQ_ENDERECO AS STRING) AS nr_seq_endereco,\n            timestamp_captura,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_CLIENTE') AS STRING) AS cd_cliente,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_TIPO_ENDERECO') AS STRING) AS cd_tipo_endereco,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_TIPO_LOGRADOURO') AS STRING) AS cd_tipo_logradouro,\n            DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', SAFE_CAST(JSON_VALUE(content, '$.DT_INCLUSAO') AS STRING)), \"America/Sao_Paulo\") AS dt_inclusao,\n            SAFE_CAST(JSON_VALUE(content, '$.NM_BAIRRO') AS STRING) AS nm_bairro,\n            SAFE_CAST(JSON_VALUE(content, '$.NM_CIDADE') AS STRING) AS nm_cidade,\n            SAFE_CAST(JSON_VALUE(content, '$.NR_CEP') AS STRING) AS nr_cep,\n            SAFE_CAST(JSON_VALUE(content, '$.NR_LOGRADOURO') AS STRING) AS nr_logradouro,\n            SAFE_CAST(JSON_VALUE(content, '$.SG_UF') AS STRING) AS sg_uf,\n            SAFE_CAST(JSON_VALUE(content, '$.TX_COMPLEMENTO_LOGRADOURO') AS STRING) AS tx_complemento_logradouro,\n            SAFE_CAST(JSON_VALUE(content, '$.TX_LOGRADOURO') AS STRING) AS tx_logradouro\n        FROM\n            `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`endereco`\n    ),\n    endereco_rn AS (\n        SELECT\n            *,\n            ROW_NUMBER() OVER (PARTITION BY nr_seq_endereco ORDER BY timestamp_captura DESC) AS rn\n        FROM\n            endereco\n    )\nSELECT\n  * EXCEPT(rn)\nFROM\n  endereco_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`endereco`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.273403Z", "completed_at": "2024-09-30T15:21:17.277677Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.279111Z", "completed_at": "2024-09-30T15:21:17.279127Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009248971939086914, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_gps_validador", "compiled": true, "compiled_code": "\n\n\nSELECT\n    data,\n    hora,\n    REPLACE(SAFE_CAST(id AS STRING), \".0\", \"\") AS id,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n    SAFE_CAST(JSON_VALUE(content, '$.bytes_recebidos_app') AS FLOAT64) AS bytes_recebidos_app,\n    SAFE_CAST(JSON_VALUE(content, '$.bytes_recebidos_geral') AS FLOAT64) AS bytes_recebidos_geral,\n    SAFE_CAST(JSON_VALUE(content, '$.bytes_transmitidos_app') AS FLOAT64) AS bytes_transmitidos_app,\n    SAFE_CAST(JSON_VALUE(content, '$.bytes_transmitidos_geral') AS FLOAT64) AS bytes_transmitidos_geral,\n    SAFE_CAST(JSON_VALUE(content, '$.codigo_linha_veiculo') AS STRING) AS codigo_linha_veiculo,\n    REPLACE(SAFE_CAST(JSON_VALUE(content, '$.codigo_operadora') AS STRING), \".0\", \"\") AS codigo_operadora,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_tracking') AS STRING)), 'America/Sao_Paulo') AS data_tracking,\n    SAFE_CAST(JSON_VALUE(content, '$.estado_equipamento') AS STRING) AS estado_equipamento,\n    SAFE_CAST(JSON_VALUE(content, '$.fabricante_equipamento') AS STRING) AS fabricante_equipamento,\n    SAFE_CAST(JSON_VALUE(content, '$.latitude_equipamento') AS FLOAT64) AS latitude_equipamento,\n    SAFE_CAST(JSON_VALUE(content, '$.longitude_equipamento') AS FLOAT64) AS longitude_equipamento,\n    SAFE_CAST(JSON_VALUE(content, '$.modelo_equipamento') AS STRING) AS modelo_equipamento,\n    SAFE_CAST(JSON_VALUE(content, '$.numero_cartao_operador') AS STRING) AS numero_cartao_operador,\n    SAFE_CAST(JSON_VALUE(content, '$.numero_chip_sam') AS STRING) AS numero_chip_sam,\n    SAFE_CAST(JSON_VALUE(content, '$.numero_chip_telefonia') AS STRING) AS numero_chip_telefonia,\n    SAFE_CAST(JSON_VALUE(content, '$.numero_serie_equipamento') AS STRING) AS numero_serie_equipamento,\n    SAFE_CAST(JSON_VALUE(content, '$.prefixo_veiculo') AS STRING) AS prefixo_veiculo,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_transacoes_enviadas') AS FLOAT64) AS qtd_transacoes_enviadas,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_transacoes_pendentes') AS FLOAT64) AS qtd_transacoes_pendentes,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_venda_botao') AS FLOAT64) AS qtd_venda_botao,\n    SAFE_CAST(JSON_VALUE(content, '$.sentido_linha') AS STRING) AS sentido_linha,\n    SAFE_CAST(JSON_VALUE(content, '$.tarifa_linha') AS FLOAT64) AS tarifa_linha,\n    SAFE_CAST(JSON_VALUE(content, '$.versao_app') AS STRING) AS versao_app,\n    SAFE_CAST(JSON_VALUE(content, '$.temperatura') AS FLOAT64) AS temperatura\nFROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`gps_validador`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`gps_validador`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.283681Z", "completed_at": "2024-09-30T15:21:17.287643Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.288896Z", "completed_at": "2024-09-30T15:21:17.288906Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008091926574707031, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_gratuidade", "compiled": true, "compiled_code": "\n\nSELECT\n    data,\n    SAFE_CAST(id AS STRING) AS id,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_cliente') AS STRING) AS cd_cliente,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_inclusao') AS STRING)), 'America/Sao_Paulo') AS data_inclusao,\n    SAFE_CAST(JSON_VALUE(content, '$.id_status_gratuidade') AS STRING) AS id_status_gratuidade,\n    SAFE_CAST(JSON_VALUE(content, '$.id_tipo_gratuidade') AS STRING) AS id_tipo_gratuidade,\n    SAFE_CAST(JSON_VALUE(content, '$.tipo_gratuidade') AS STRING) AS tipo_gratuidade\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`gratuidade`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`gratuidade`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.294097Z", "completed_at": "2024-09-30T15:21:17.302539Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.304116Z", "completed_at": "2024-09-30T15:21:17.304125Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012655019760131836, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_integracao_transacao", "compiled": true, "compiled_code": "\n\nSELECT\n  data,\n  SAFE_CAST(id AS STRING) AS id,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_inclusao') AS STRING)), 'America/Sao_Paulo') AS data_inclusao,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_processamento') AS STRING)), 'America/Sao_Paulo') AS data_processamento,\n  -- Seleciona colunas com os dados de cada transa\u00e7\u00e3o da integra\u00e7\u00e3o com os tipos adequados com base no dicionario de parametros\n  \n    \n      \n        DATETIME(\n          PARSE_TIMESTAMP(\n            '%Y-%m-%dT%H:%M:%E*S%Ez',\n            SAFE_CAST(JSON_VALUE(content, '$.data_transacao_t0') AS STRING)\n          ),\n          'America/Sao_Paulo') AS data_transacao_t0,\n      \n    \n      \n        DATETIME(\n          PARSE_TIMESTAMP(\n            '%Y-%m-%dT%H:%M:%E*S%Ez',\n            SAFE_CAST(JSON_VALUE(content, '$.data_transacao_ti1') AS STRING)\n          ),\n          'America/Sao_Paulo') AS data_transacao_t1,\n      \n    \n      \n        DATETIME(\n          PARSE_TIMESTAMP(\n            '%Y-%m-%dT%H:%M:%E*S%Ez',\n            SAFE_CAST(JSON_VALUE(content, '$.data_transacao_ti2') AS STRING)\n          ),\n          'America/Sao_Paulo') AS data_transacao_t2,\n      \n    \n      \n        DATETIME(\n          PARSE_TIMESTAMP(\n            '%Y-%m-%dT%H:%M:%E*S%Ez',\n            SAFE_CAST(JSON_VALUE(content, '$.data_transacao_ti3') AS STRING)\n          ),\n          'America/Sao_Paulo') AS data_transacao_t3,\n      \n    \n      \n        DATETIME(\n          PARSE_TIMESTAMP(\n            '%Y-%m-%dT%H:%M:%E*S%Ez',\n            SAFE_CAST(JSON_VALUE(content, '$.data_transacao_ti4') AS STRING)\n          ),\n          'America/Sao_Paulo') AS data_transacao_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_aplicacao_t0') AS STRING), '.0', '') AS id_aplicacao_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_aplicacao_ti1') AS STRING), '.0', '') AS id_aplicacao_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_aplicacao_ti2') AS STRING), '.0', '') AS id_aplicacao_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_aplicacao_ti3') AS STRING), '.0', '') AS id_aplicacao_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_aplicacao_ti4') AS STRING), '.0', '') AS id_aplicacao_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_consorcio_t0') AS STRING), '.0', '') AS id_consorcio_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_consorcio_ti1') AS STRING), '.0', '') AS id_consorcio_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_consorcio_ti2') AS STRING), '.0', '') AS id_consorcio_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_consorcio_ti3') AS STRING), '.0', '') AS id_consorcio_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_consorcio_ti4') AS STRING), '.0', '') AS id_consorcio_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_emissor_t0') AS STRING), '.0', '') AS id_emissor_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_emissor_ti1') AS STRING), '.0', '') AS id_emissor_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_emissor_ti2') AS STRING), '.0', '') AS id_emissor_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_emissor_ti3') AS STRING), '.0', '') AS id_emissor_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_emissor_ti4') AS STRING), '.0', '') AS id_emissor_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_linha_t0') AS STRING), '.0', '') AS id_linha_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_linha_ti1') AS STRING), '.0', '') AS id_linha_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_linha_ti2') AS STRING), '.0', '') AS id_linha_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_linha_ti3') AS STRING), '.0', '') AS id_linha_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_linha_ti4') AS STRING), '.0', '') AS id_linha_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_matriz_integracao_t0') AS STRING), '.0', '') AS id_matriz_integracao_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_matriz_integracao_ti1') AS STRING), '.0', '') AS id_matriz_integracao_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_matriz_integracao_ti2') AS STRING), '.0', '') AS id_matriz_integracao_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_matriz_integracao_ti3') AS STRING), '.0', '') AS id_matriz_integracao_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_matriz_integracao_ti4') AS STRING), '.0', '') AS id_matriz_integracao_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_operadora_t0') AS STRING), '.0', '') AS id_operadora_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_operadora_ti1') AS STRING), '.0', '') AS id_operadora_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_operadora_ti2') AS STRING), '.0', '') AS id_operadora_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_operadora_ti3') AS STRING), '.0', '') AS id_operadora_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_operadora_ti4') AS STRING), '.0', '') AS id_operadora_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_ordem_rateio_t0') AS STRING), '.0', '') AS id_ordem_rateio_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_ordem_rateio_ti1') AS STRING), '.0', '') AS id_ordem_rateio_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_ordem_rateio_ti2') AS STRING), '.0', '') AS id_ordem_rateio_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_ordem_rateio_ti3') AS STRING), '.0', '') AS id_ordem_rateio_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_ordem_rateio_ti4') AS STRING), '.0', '') AS id_ordem_rateio_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.id_secao_t0') AS STRING) AS id_secao_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.id_secao_ti1') AS STRING) AS id_secao_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.id_secao_ti2') AS STRING) AS id_secao_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.id_secao_ti3') AS STRING) AS id_secao_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.id_secao_ti4') AS STRING) AS id_secao_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_servico_t0') AS STRING), '.0', '') AS id_servico_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_servico_ti1') AS STRING), '.0', '') AS id_servico_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_servico_ti2') AS STRING), '.0', '') AS id_servico_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_servico_ti3') AS STRING), '.0', '') AS id_servico_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_servico_ti4') AS STRING), '.0', '') AS id_servico_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal_t0') AS STRING), '.0', '') AS id_tipo_modal_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal_ti1') AS STRING), '.0', '') AS id_tipo_modal_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal_ti2') AS STRING), '.0', '') AS id_tipo_modal_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal_ti3') AS STRING), '.0', '') AS id_tipo_modal_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal_ti4') AS STRING), '.0', '') AS id_tipo_modal_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.id_transacao_t0') AS STRING) AS id_transacao_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.id_transacao_ti1') AS STRING) AS id_transacao_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.id_transacao_ti2') AS STRING) AS id_transacao_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.id_transacao_ti3') AS STRING) AS id_transacao_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.id_transacao_ti4') AS STRING) AS id_transacao_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.latitude_trx_t0') AS FLOAT64) AS latitude_trx_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.latitude_trx_ti1') AS FLOAT64) AS latitude_trx_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.latitude_trx_ti2') AS FLOAT64) AS latitude_trx_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.latitude_trx_ti3') AS FLOAT64) AS latitude_trx_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.latitude_trx_ti4') AS FLOAT64) AS latitude_trx_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.longitude_trx_t0') AS FLOAT64) AS longitude_trx_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.longitude_trx_ti1') AS FLOAT64) AS longitude_trx_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.longitude_trx_ti2') AS FLOAT64) AS longitude_trx_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.longitude_trx_ti3') AS FLOAT64) AS longitude_trx_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.longitude_trx_ti4') AS FLOAT64) AS longitude_trx_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.nr_logico_midia_operador_t0') AS STRING) AS nr_logico_midia_operador_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.nr_logico_midia_operador_ti1') AS STRING) AS nr_logico_midia_operador_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.nr_logico_midia_operador_ti2') AS STRING) AS nr_logico_midia_operador_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.nr_logico_midia_operador_ti3') AS STRING) AS nr_logico_midia_operador_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.nr_logico_midia_operador_ti4') AS STRING) AS nr_logico_midia_operador_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.perc_rateio_t0') AS FLOAT64) AS perc_rateio_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.perc_rateio_ti1') AS FLOAT64) AS perc_rateio_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.perc_rateio_ti2') AS FLOAT64) AS perc_rateio_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.perc_rateio_ti3') AS FLOAT64) AS perc_rateio_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.perc_rateio_ti4') AS FLOAT64) AS perc_rateio_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.posicao_validador_t0') AS STRING) AS posicao_validador_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.posicao_validador_ti1') AS STRING) AS posicao_validador_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.posicao_validador_ti2') AS STRING) AS posicao_validador_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.posicao_validador_ti3') AS STRING) AS posicao_validador_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.posicao_validador_ti4') AS STRING) AS posicao_validador_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.sentido_t0') AS STRING), '.0', '') AS sentido_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.sentido_ti1') AS STRING), '.0', '') AS sentido_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.sentido_ti2') AS STRING), '.0', '') AS sentido_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.sentido_ti3') AS STRING), '.0', '') AS sentido_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.sentido_ti4') AS STRING), '.0', '') AS sentido_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_t0') AS FLOAT64) AS valor_rateio_compensacao_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_ti1') AS FLOAT64) AS valor_rateio_compensacao_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_ti2') AS FLOAT64) AS valor_rateio_compensacao_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_ti3') AS FLOAT64) AS valor_rateio_compensacao_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_ti4') AS FLOAT64) AS valor_rateio_compensacao_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_t0') AS FLOAT64) AS valor_rateio_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_ti1') AS FLOAT64) AS valor_rateio_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_ti2') AS FLOAT64) AS valor_rateio_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_ti3') AS FLOAT64) AS valor_rateio_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_ti4') AS FLOAT64) AS valor_rateio_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_tarifa_t0') AS FLOAT64) AS valor_tarifa_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_tarifa_ti1') AS FLOAT64) AS valor_tarifa_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_tarifa_ti2') AS FLOAT64) AS valor_tarifa_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_tarifa_ti3') AS FLOAT64) AS valor_tarifa_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_tarifa_ti4') AS FLOAT64) AS valor_tarifa_t4,\n      \n    \n  \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_transacao_t0') AS FLOAT64) AS valor_transacao_t0,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_transacao_ti1') AS FLOAT64) AS valor_transacao_t1,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_transacao_ti2') AS FLOAT64) AS valor_transacao_t2,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_transacao_ti3') AS FLOAT64) AS valor_transacao_t3,\n      \n    \n      \n        SAFE_CAST(JSON_VALUE(content, '$.valor_transacao_ti4') AS FLOAT64) AS valor_transacao_t4,\n      \n    \n  \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.veiculo_id_t0') AS STRING), '.0', '') AS veiculo_id_t0,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.veiculo_id_ti1') AS STRING), '.0', '') AS veiculo_id_t1,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.veiculo_id_ti2') AS STRING), '.0', '') AS veiculo_id_t2,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.veiculo_id_ti3') AS STRING), '.0', '') AS veiculo_id_t3,\n      \n    \n      \n        REPLACE(SAFE_CAST(JSON_VALUE(content, '$.veiculo_id_ti4') AS STRING), '.0', '') AS veiculo_id_t4,\n      \n    \n  \n  SAFE_CAST(JSON_VALUE(content, '$.id_status_integracao') AS STRING) AS id_status_integracao,\n  SAFE_CAST(JSON_VALUE(content, '$.valor_transacao_total') AS FLOAT64) AS valor_transacao_total,\n  SAFE_CAST(JSON_VALUE(content, '$.tx_adicional') AS STRING) AS tx_adicional\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`integracao_transacao`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`integracao_transacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.307962Z", "completed_at": "2024-09-30T15:21:17.312125Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.313497Z", "completed_at": "2024-09-30T15:21:17.313507Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008022785186767578, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_linha", "compiled": true, "compiled_code": "\n\nWITH\n    linha AS (\n        SELECT\n            data,\n            DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n            SAFE_CAST(CD_LINHA AS STRING) AS cd_linha,\n            DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', SAFE_CAST(JSON_VALUE(content, '$.DT_INCLUSAO') AS STRING)), \"America/Sao_Paulo\") AS datetime_inclusao,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_LINHA_OFICIAL') AS STRING) AS cd_linha_oficial,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_LOCAL_OPERACAO_LINHA') AS STRING) AS cd_local_operacao_linha,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_TIPO_CATEGORIA_LINHA') AS STRING) AS cd_tipo_categoria_linha,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_TIPO_LINHA') AS STRING) AS cd_tipo_linha,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_TIPO_MATRIZ_CALCULO_SUBSIDIO') AS STRING) AS cd_tipo_matriz_calculo_subsidio,\n            SAFE_CAST(JSON_VALUE(content, '$.IN_SITUACAO_ATIVIDADE') AS STRING) AS in_situacao_atividade,\n            SAFE_CAST(JSON_VALUE(content, '$.KM_LINHA') AS FLOAT64) AS km_linha,\n            SAFE_CAST(JSON_VALUE(content, '$.LATITUDE_DESTINO') AS STRING) AS latitude_destino,\n            SAFE_CAST(JSON_VALUE(content, '$.LATITUDE_ORIGEM') AS STRING) AS latitude_origem,\n            SAFE_CAST(JSON_VALUE(content, '$.LONGITUDE_DESTINO') AS STRING) AS longitude_destino,\n            SAFE_CAST(JSON_VALUE(content, '$.LONGITUDE_ORIGEM') AS STRING) AS longitude_origem,\n            SAFE_CAST(JSON_VALUE(content, '$.NM_LINHA') AS STRING) AS nm_linha,\n            SAFE_CAST(JSON_VALUE(content, '$.NR_LINHA') AS STRING) AS nr_linha,\n            SAFE_CAST(JSON_VALUE(content, '$.QUANTIDADE_SECAO') AS STRING) AS quantidade_secao,\n            SAFE_CAST(JSON_VALUE(content, '$.GTFS_ROUTE_ID') AS STRING) AS gtfs_route_id,\n            SAFE_CAST(JSON_VALUE(content, '$.GTFS_STOP_ID') AS STRING) AS gtfs_stop_id\n        FROM\n            `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha`\n    ),\n    linha_rn AS (\n        SELECT\n            *,\n            ROW_NUMBER() OVER (PARTITION BY cd_linha ORDER BY timestamp_captura DESC) AS rn\n        FROM\n            linha\n    )\nSELECT\n  * EXCEPT(rn)\nFROM\n  linha_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.317336Z", "completed_at": "2024-09-30T15:21:17.322670Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.323955Z", "completed_at": "2024-09-30T15:21:17.323964Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009059429168701172, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_linha_consorcio", "compiled": true, "compiled_code": "\n\nWITH linha_consorcio AS (\n  SELECT\n    data,\n    SAFE_CAST(CD_CONSORCIO AS STRING) AS cd_consorcio,\n    SAFE_CAST(CD_LINHA AS STRING) AS cd_linha,\n    timestamp_captura,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', SAFE_CAST(JSON_VALUE(content, '$.DT_INCLUSAO') AS STRING)), \"America/Sao_Paulo\") AS dt_inclusao,\n    PARSE_DATE(\"%Y-%m-%d\", SAFE_CAST(JSON_VALUE(content, '$.DT_INICIO_VALIDADE') AS STRING)) AS dt_inicio_validade,\n    PARSE_DATE(\"%Y-%m-%d\", SAFE_CAST(JSON_VALUE(content, '$.DT_FIM_VALIDADE') AS STRING)) AS dt_fim_validade\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_consorcio`\n),\nlinha_consorcio_rn AS (\n  SELECT\n    *,\n    ROW_NUMBER() OVER (PARTITION BY cd_consorcio, cd_linha ORDER BY timestamp_captura DESC) AS rn\n  FROM\n    linha_consorcio\n)\nSELECT\n  * EXCEPT(rn)\nFROM\n  linha_consorcio_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_consorcio`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.328565Z", "completed_at": "2024-09-30T15:21:17.333029Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.334292Z", "completed_at": "2024-09-30T15:21:17.334302Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009069204330444336, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_linha_consorcio_operadora_transporte", "compiled": true, "compiled_code": "\n\nWITH linha_consorcio_operadora_transporte AS (\n  SELECT\n    data,\n    SAFE_CAST(CD_CONSORCIO AS STRING) AS cd_consorcio,\n    SAFE_CAST(CD_OPERADORA_TRANSPORTE AS STRING) AS cd_operadora_transporte,\n    SAFE_CAST(CD_LINHA AS STRING) AS cd_linha,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', SAFE_CAST(JSON_VALUE(content, '$.DT_INCLUSAO') AS STRING)), \"America/Sao_Paulo\") AS dt_inclusao,\n    PARSE_DATE(\"%Y-%m-%d\", SAFE_CAST(JSON_VALUE(content, '$.DT_INICIO_VALIDADE') AS STRING)) AS dt_inicio_validade,\n    PARSE_DATE(\"%Y-%m-%d\", SAFE_CAST(JSON_VALUE(content, '$.DT_FIM_VALIDADE') AS STRING)) AS dt_fim_validade\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_consorcio_operadora_transporte`\n),\nlinha_consorcio_operadora_transporte_rn AS (\n  SELECT\n    *,\n    ROW_NUMBER() OVER (PARTITION BY cd_consorcio, cd_operadora_transporte, cd_linha ORDER BY timestamp_captura DESC) AS rn\n  FROM\n    linha_consorcio_operadora_transporte\n)\nSELECT\n  * EXCEPT(rn)\nFROM\n  linha_consorcio_operadora_transporte_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_consorcio_operadora_transporte`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.338839Z", "completed_at": "2024-09-30T15:21:17.343005Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.344474Z", "completed_at": "2024-09-30T15:21:17.344484Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00828242301940918, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_linha_sem_ressarcimento", "compiled": true, "compiled_code": "\n\nWITH linha_sem_ressarcimento AS (\n  SELECT\n    data,\n    SAFE_CAST(id_linha AS STRING) AS id_linha,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.dt_inclusao') AS STRING)), 'America/Sao_Paulo') AS dt_inclusao\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_sem_ressarcimento`\n)\nSELECT\n  * EXCEPT(rn)\nFROM\n(\n  SELECT\n    *,\n    ROW_NUMBER() OVER (PARTITION BY id_linha ORDER BY timestamp_captura DESC) AS rn\n  FROM\n    linha_sem_ressarcimento\n)\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_sem_ressarcimento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.348987Z", "completed_at": "2024-09-30T15:21:17.353391Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.354701Z", "completed_at": "2024-09-30T15:21:17.354710Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008118152618408203, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_operadora_empresa", "compiled": true, "compiled_code": "\n\nWITH\n    operadora_empresa AS (\n        SELECT\n            data,\n            SAFE_CAST(Perm_Autor AS STRING) AS perm_autor,\n            timestamp_captura,\n            SAFE_CAST(JSON_VALUE(content, '$.CNPJ') AS STRING) AS cnpj,\n            DATE(PARSE_TIMESTAMP('%d/%m/%Y', SAFE_CAST(JSON_VALUE(content, '$.Data') AS STRING)), \"America/Sao_Paulo\") AS data_registro,\n            SAFE_CAST(JSON_VALUE(content, '$.Processo') AS STRING) AS processo,\n            SAFE_CAST(JSON_VALUE(content, '$.Razao_Social') AS STRING) AS razao_social,\n            SAFE_CAST(JSON_VALUE(content, '$.id_modo') AS STRING) AS id_modo,\n            SAFE_CAST(JSON_VALUE(content, '$.modo') AS STRING) AS modo,\n            SAFE_CAST(JSON_VALUE(content, '$.tipo_permissao') AS STRING) AS tipo_permissao\n        FROM\n            `rj-smtr-staging`.`br_rj_riodejaneiro_stu_staging`.`operadora_empresa`\n    ),\n    operadora_empresa_rn AS (\n        SELECT\n            *,\n            ROW_NUMBER() OVER (PARTITION BY COALESCE(cnpj, perm_autor), modo ORDER BY timestamp_captura DESC, data_registro DESC) AS rn\n        FROM\n            operadora_empresa\n    )\nSELECT\n  * EXCEPT(rn)\nFROM\n  operadora_empresa_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_stu`.`operadora_empresa`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.358677Z", "completed_at": "2024-09-30T15:21:17.363127Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.364435Z", "completed_at": "2024-09-30T15:21:17.364444Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008351325988769531, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_operadora_pessoa_fisica", "compiled": true, "compiled_code": "\n\nWITH\n    operadora_pessoa_fisica AS (\n        SELECT\n            data,\n            SAFE_CAST(Perm_Autor AS STRING) AS perm_autor,\n            timestamp_captura,\n            SAFE_CAST(JSON_VALUE(content, '$.CPF') AS STRING) AS cpf,\n            PARSE_DATE('%d/%m/%Y', LEFT(SAFE_CAST(JSON_VALUE(content, '$.Data') AS STRING), 10)) AS data_registro,\n            SAFE_CAST(JSON_VALUE(content, '$.Ratr') AS STRING) AS ratr,\n            SAFE_CAST(JSON_VALUE(content, '$.Processo') AS STRING) AS processo,\n            SAFE_CAST(JSON_VALUE(content, '$.Nome') AS STRING) AS nome,\n            SAFE_CAST(JSON_VALUE(content, '$.Placa') AS STRING) AS placa,\n            SAFE_CAST(JSON_VALUE(content, '$.id_modo') AS STRING) AS id_modo,\n            SAFE_CAST(JSON_VALUE(content, '$.modo') AS STRING) AS modo,\n            SAFE_CAST(JSON_VALUE(content, '$.tipo_permissao') AS STRING) AS tipo_permissao\n        FROM\n            `rj-smtr-staging`.`br_rj_riodejaneiro_stu_staging`.`operadora_pessoa_fisica`\n    ),\n    operadora_pessoa_fisica_rn AS (\n        SELECT\n            *,\n            ROW_NUMBER() OVER (PARTITION BY COALESCE(cpf, perm_autor), modo ORDER BY timestamp_captura DESC, data_registro DESC) AS rn\n        FROM\n            operadora_pessoa_fisica\n    )\nSELECT\n  * EXCEPT(rn)\nFROM\n  operadora_pessoa_fisica_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_stu`.`operadora_pessoa_fisica`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.369105Z", "completed_at": "2024-09-30T15:21:17.374042Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.375344Z", "completed_at": "2024-09-30T15:21:17.375360Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009751558303833008, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_operadora_transporte", "compiled": true, "compiled_code": "\n\nWITH\n    operadora_transporte AS (\n        SELECT\n            data,\n            SAFE_CAST(CD_OPERADORA_TRANSPORTE AS STRING) AS cd_operadora_transporte,\n            timestamp_captura,\n            DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', SAFE_CAST(JSON_VALUE(content, '$.DT_INCLUSAO') AS STRING)), \"America/Sao_Paulo\") AS datetime_inclusao,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_CLIENTE') AS STRING) AS cd_cliente,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_TIPO_CLIENTE') AS STRING) AS cd_tipo_cliente,\n            SAFE_CAST(JSON_VALUE(content, '$.CD_TIPO_MODAL') AS STRING) AS cd_tipo_modal,\n            SAFE_CAST(JSON_VALUE(content, '$.IN_SITUACAO_ATIVIDADE') AS STRING) AS in_situacao_atividade,\n            SAFE_CAST(JSON_VALUE(content, '$.DS_TIPO_MODAL') AS STRING) AS ds_tipo_modal\n        FROM\n            `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`operadora_transporte`\n    ),\n    operadora_transporte_rn AS (\n        SELECT\n            *,\n            ROW_NUMBER() OVER (PARTITION BY cd_operadora_transporte ORDER BY timestamp_captura DESC) AS rn\n        FROM\n            operadora_transporte\n    )\nSELECT\n  * EXCEPT(rn)\nFROM\n  operadora_transporte_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`operadora_transporte`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.380444Z", "completed_at": "2024-09-30T15:21:17.385583Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.387262Z", "completed_at": "2024-09-30T15:21:17.387272Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009618520736694336, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_ordem_pagamento", "compiled": true, "compiled_code": "\n\nWITH ordem_pagamento AS (\n  SELECT\n    data,\n    SAFE_CAST(id AS STRING) AS id_ordem_pagamento,\n    timestamp_captura,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_inclusao') AS STRING)), \"America/Sao_Paulo\") AS datetime_inclusao,\n    PARSE_DATE('%Y-%m-%d', SAFE_CAST(JSON_VALUE(content, '$.data_ordem') AS STRING)) AS data_ordem,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_pagamento') AS STRING)), \"America/Sao_Paulo\") AS data_pagamento,\n    SAFE_CAST(JSON_VALUE(content, '$.id_status_ordem') AS STRING) AS id_status_ordem,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_debito') AS INTEGER) AS qtd_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_gratuidade') AS INTEGER) AS qtd_gratuidade,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_integracao') AS INTEGER) AS qtd_integracao,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_credito') AS INTEGER) AS qtd_rateio_credito,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_debito') AS INTEGER) AS qtd_rateio_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_vendaabordo') AS INTEGER) AS qtd_vendaabordo,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_bruto') AS NUMERIC) AS valor_bruto,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_debito') AS NUMERIC) AS valor_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_gratuidade') AS NUMERIC) AS valor_gratuidade,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_integracao') AS NUMERIC) AS valor_integracao,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_liquido') AS NUMERIC) AS valor_liquido,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_credito') AS NUMERIC) AS valor_rateio_credito,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_debito') AS NUMERIC) AS valor_rateio_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_taxa') AS NUMERIC) AS valor_taxa,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_vendaabordo') AS NUMERIC) AS valor_vendaabordo\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_pagamento`\n),\nordem_pagamento_rn AS (\n  SELECT\n    *,\n    ROW_NUMBER() OVER (PARTITION BY id_ordem_pagamento ORDER BY timestamp_captura DESC) AS rn\n  FROM\n    ordem_pagamento\n)\nSELECT\n  * EXCEPT(rn)\nFROM\n  ordem_pagamento_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_pagamento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.391173Z", "completed_at": "2024-09-30T15:21:17.395614Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.396890Z", "completed_at": "2024-09-30T15:21:17.396899Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008222818374633789, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_ordem_pagamento_consorcio", "compiled": true, "compiled_code": "\n\nWITH ordem_pagamento_consorcio AS (\n  SELECT\n    data,\n    SAFE_CAST(id AS STRING) AS id_ordem_pagamento_consorcio,\n    timestamp_captura,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_inclusao') AS STRING)), \"America/Sao_Paulo\") AS datetime_inclusao,\n    PARSE_DATE('%Y-%m-%d', SAFE_CAST(JSON_VALUE(content, '$.data_ordem') AS STRING)) AS data_ordem,\n    SAFE_CAST(JSON_VALUE(content, '$.id_consorcio') AS STRING) AS id_consorcio,\n    SAFE_CAST(JSON_VALUE(content, '$.id_ordem_pagamento') AS STRING) AS id_ordem_pagamento,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_debito') AS INTEGER) AS qtd_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_gratuidade') AS INTEGER) AS qtd_gratuidade,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_integracao') AS INTEGER) AS qtd_integracao,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_credito') AS INTEGER) AS qtd_rateio_credito,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_debito') AS INTEGER) AS qtd_rateio_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_vendaabordo') AS INTEGER) AS qtd_vendaabordo,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_bruto') AS NUMERIC) AS valor_bruto,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_debito') AS NUMERIC) AS valor_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_gratuidade') AS NUMERIC) AS valor_gratuidade,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_integracao') AS NUMERIC) AS valor_integracao,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_liquido') AS NUMERIC) AS valor_liquido,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_credito') AS NUMERIC) AS valor_rateio_credito,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_debito') AS NUMERIC) AS valor_rateio_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_taxa') AS NUMERIC) AS valor_taxa,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_vendaabordo') AS NUMERIC) AS valor_vendaabordo\n  FROM\n      `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_pagamento_consorcio`\n),\nordem_pagamento_consorcio_rn AS (\n  SELECT\n      *,\n      ROW_NUMBER() OVER (PARTITION BY id_ordem_pagamento_consorcio ORDER BY timestamp_captura DESC) AS rn\n  FROM\n      ordem_pagamento_consorcio\n)\nSELECT\n  * EXCEPT(rn)\nFROM\n  ordem_pagamento_consorcio_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_pagamento_consorcio`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.400706Z", "completed_at": "2024-09-30T15:21:17.405248Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.406534Z", "completed_at": "2024-09-30T15:21:17.406543Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008341789245605469, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_ordem_pagamento_consorcio_operadora", "compiled": true, "compiled_code": "\n\nWITH ordem_pagamento_consorcio_operadora AS (\n  SELECT\n    data,\n    SAFE_CAST(id AS STRING) AS id_ordem_pagamento_consorcio_operadora,\n    timestamp_captura,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_inclusao') AS STRING)), \"America/Sao_Paulo\") AS datetime_inclusao,\n    PARSE_DATE('%Y-%m-%d', SAFE_CAST(JSON_VALUE(content, '$.data_ordem') AS STRING)) AS data_ordem,\n    SAFE_CAST(JSON_VALUE(content, '$.id_consorcio') AS STRING) AS id_consorcio,\n    SAFE_CAST(JSON_VALUE(content, '$.id_operadora') AS STRING) AS id_operadora,\n    SAFE_CAST(JSON_VALUE(content, '$.id_ordem_pagamento_consorcio') AS STRING) AS id_ordem_pagamento_consorcio,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_debito') AS INTEGER) AS qtd_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_gratuidade') AS INTEGER) AS qtd_gratuidade,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_integracao') AS INTEGER) AS qtd_integracao,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_credito') AS INTEGER) AS qtd_rateio_credito,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_debito') AS INTEGER) AS qtd_rateio_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.qtd_vendaabordo') AS INTEGER) AS qtd_vendaabordo,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_bruto') AS NUMERIC) AS valor_bruto,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_debito') AS NUMERIC) AS valor_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_gratuidade') AS NUMERIC) AS valor_gratuidade,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_integracao') AS NUMERIC) AS valor_integracao,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_liquido') AS NUMERIC) AS valor_liquido,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_credito') AS NUMERIC) AS valor_rateio_credito,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_debito') AS NUMERIC) AS valor_rateio_debito,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_taxa') AS NUMERIC) AS valor_taxa,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_vendaabordo') AS NUMERIC) AS valor_vendaabordo\n  FROM\n      `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_pagamento_consorcio_operadora`\n),\nordem_pagamento_consorcio_operadora_rn AS (\n  SELECT\n      *,\n      ROW_NUMBER() OVER (PARTITION BY id_ordem_pagamento_consorcio_operadora ORDER BY timestamp_captura DESC) AS rn\n  FROM\n      ordem_pagamento_consorcio_operadora\n)\nSELECT\n  * EXCEPT(rn)\nFROM\n  ordem_pagamento_consorcio_operadora_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_pagamento_consorcio_operadora`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.412604Z", "completed_at": "2024-09-30T15:21:17.416821Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.418082Z", "completed_at": "2024-09-30T15:21:17.418092Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010274410247802734, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_ordem_rateio", "compiled": true, "compiled_code": "\n\nWITH ordem_rateio AS (\n  SELECT\n    data,\n        SAFE_CAST(id AS STRING) AS id,\n        timestamp_captura,\n        DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_inclusao') AS STRING)), 'America/Sao_Paulo') AS data_inclusao,\n        PARSE_DATE('%Y-%m-%d', SAFE_CAST(JSON_VALUE(content, '$.data_ordem') AS STRING)) AS data_ordem,\n        SAFE_CAST(JSON_VALUE(content, '$.id_consorcio') AS STRING) AS id_consorcio,\n        SAFE_CAST(JSON_VALUE(content, '$.id_linha') AS STRING) AS id_linha,\n        SAFE_CAST(JSON_VALUE(content, '$.id_operadora') AS STRING) AS id_operadora,\n        SAFE_CAST(JSON_VALUE(content, '$.id_ordem_pagamento') AS STRING) AS id_ordem_pagamento,\n        SAFE_CAST(JSON_VALUE(content, '$.id_ordem_pagamento_consorcio') AS STRING) AS id_ordem_pagamento_consorcio,\n        SAFE_CAST(JSON_VALUE(content, '$.id_ordem_pagamento_consorcio_operadora') AS STRING) AS id_ordem_pagamento_consorcio_operadora,\n        SAFE_CAST(JSON_VALUE(content, '$.id_status_ordem') AS STRING) AS id_status_ordem,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_credito_t0') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_credito_t0,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_credito_t1') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_credito_t1,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_credito_t2') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_credito_t2,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_credito_t3') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_credito_t3,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_credito_t4') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_credito_t4,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_credito_total') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_credito_total,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_debito_t0') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_debito_t0,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_debito_t1') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_debito_t1,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_debito_t2') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_debito_t2,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_debito_t3') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_debito_t3,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_debito_t4') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_debito_t4,\n        SAFE_CAST(SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_compensacao_debito_total') AS FLOAT64) AS INTEGER) AS qtd_rateio_compensacao_debito_total,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_credito_t0') AS NUMERIC) AS valor_rateio_compensacao_credito_t0,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_credito_t1') AS NUMERIC) AS valor_rateio_compensacao_credito_t1,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_credito_t2') AS NUMERIC) AS valor_rateio_compensacao_credito_t2,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_credito_t3') AS NUMERIC) AS valor_rateio_compensacao_credito_t3,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_credito_t4') AS NUMERIC) AS valor_rateio_compensacao_credito_t4,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_credito_total') AS NUMERIC) AS valor_rateio_compensacao_credito_total,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_debito_t0') AS NUMERIC) AS valor_rateio_compensacao_debito_t0,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_debito_t1') AS NUMERIC) AS valor_rateio_compensacao_debito_t1,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_debito_t2') AS NUMERIC) AS valor_rateio_compensacao_debito_t2,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_debito_t3') AS NUMERIC) AS valor_rateio_compensacao_debito_t3,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_debito_t4') AS NUMERIC) AS valor_rateio_compensacao_debito_t4,\n        SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_compensacao_debito_total') AS NUMERIC) AS valor_rateio_compensacao_debito_total\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_rateio`\n)\nSELECT\n  * EXCEPT(rn)\nFROM\n(\n  SELECT\n    *,\n    ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp_captura DESC) AS rn\n  FROM\n    ordem_rateio\n)\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_rateio`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.422784Z", "completed_at": "2024-09-30T15:21:17.428378Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.429863Z", "completed_at": "2024-09-30T15:21:17.429873Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009510278701782227, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_ordem_ressarcimento", "compiled": true, "compiled_code": "\n\nWITH\n    ordem_ressarcimento AS (\n        SELECT\n            data,\n            SAFE_CAST(id AS STRING) AS id_ordem_ressarcimento,\n            timestamp_captura,\n            DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_inclusao') AS STRING)), \"America/Sao_Paulo\") AS datetime_inclusao,\n            PARSE_DATE('%Y-%m-%d', SAFE_CAST(JSON_VALUE(content, '$.data_ordem') AS STRING)) AS data_ordem,\n            SAFE_CAST(JSON_VALUE(content, '$.id_consorcio') AS STRING) AS id_consorcio,\n            SAFE_CAST(JSON_VALUE(content, '$.id_linha') AS STRING) AS id_linha,\n            SAFE_CAST(JSON_VALUE(content, '$.id_operadora') AS STRING) AS id_operadora,\n            SAFE_CAST(JSON_VALUE(content, '$.id_ordem_pagamento') AS STRING) AS id_ordem_pagamento,\n            SAFE_CAST(JSON_VALUE(content, '$.id_ordem_pagamento_consorcio') AS STRING) AS id_ordem_pagamento_consorcio,\n            SAFE_CAST(JSON_VALUE(content, '$.id_ordem_pagamento_consorcio_operadora') AS STRING) AS id_ordem_pagamento_consorcio_operadora,\n            SAFE_CAST(JSON_VALUE(content, '$.id_status_ordem') AS STRING) AS id_status_ordem,\n            SAFE_CAST(JSON_VALUE(content, '$.qtd_debito') AS INTEGER) AS qtd_debito,\n            SAFE_CAST(JSON_VALUE(content, '$.qtd_gratuidade') AS INTEGER) AS qtd_gratuidade,\n            SAFE_CAST(JSON_VALUE(content, '$.qtd_integracao') AS INTEGER) AS qtd_integracao,\n            SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_credito') AS INTEGER) AS qtd_rateio_credito,\n            SAFE_CAST(JSON_VALUE(content, '$.qtd_rateio_debito') AS INTEGER) AS qtd_rateio_debito,\n            SAFE_CAST(JSON_VALUE(content, '$.qtd_vendaabordo') AS INTEGER) AS qtd_vendaabordo,\n            SAFE_CAST(JSON_VALUE(content, '$.valor_bruto') AS NUMERIC) AS valor_bruto,\n            SAFE_CAST(JSON_VALUE(content, '$.valor_debito') AS NUMERIC) AS valor_debito,\n            SAFE_CAST(JSON_VALUE(content, '$.valor_gratuidade') AS NUMERIC) AS valor_gratuidade,\n            SAFE_CAST(JSON_VALUE(content, '$.valor_integracao') AS NUMERIC) AS valor_integracao,\n            SAFE_CAST(JSON_VALUE(content, '$.valor_liquido') AS NUMERIC) AS valor_liquido,\n            SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_credito') AS NUMERIC) AS valor_rateio_credito,\n            SAFE_CAST(JSON_VALUE(content, '$.valor_rateio_debito') AS NUMERIC) AS valor_rateio_debito,\n            SAFE_CAST(JSON_VALUE(content, '$.valor_taxa') AS NUMERIC) AS valor_taxa,\n            SAFE_CAST(JSON_VALUE(content, '$.valor_vendaabordo') AS NUMERIC) AS valor_vendaabordo\n        FROM\n            `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_ressarcimento`\n    ),\n    ordem_ressarcimento_rn AS (\n        SELECT\n            *,\n            ROW_NUMBER() OVER (PARTITION BY id_ordem_ressarcimento ORDER BY timestamp_captura DESC) AS rn\n        FROM\n            ordem_ressarcimento\n    )\nSELECT\n  * EXCEPT(rn)\nFROM\n  ordem_ressarcimento_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_ressarcimento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.433719Z", "completed_at": "2024-09-30T15:21:17.438096Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.439339Z", "completed_at": "2024-09-30T15:21:17.439348Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008016824722290039, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_percentual_rateio_integracao", "compiled": true, "compiled_code": "\n\nWITH percentual_rateio_integracao AS (\n  SELECT\n    data,\n    SAFE_CAST(id AS STRING) AS id,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n    SAFE_CAST(JSON_VALUE(content, '$.dt_fim_validade') AS STRING) AS dt_fim_validade,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:S%Ez', SAFE_CAST(JSON_VALUE(content, '$.dt_inclusao') AS STRING)), 'America/Sao_Paulo') AS dt_inclusao,\n    DATE(PARSE_TIMESTAMP('%Y-%m-%d', SAFE_CAST(JSON_VALUE(content, '$.dt_inicio_validade') AS STRING)), 'America/Sao_Paulo') AS dt_inicio_validade,\n    REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal_integracao_t1') AS STRING), '.0', '') AS id_tipo_modal_integracao_t1,\n    REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal_integracao_t2') AS STRING), '.0', '') AS id_tipo_modal_integracao_t2,\n    REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal_integracao_t3') AS STRING), '.0', '') AS id_tipo_modal_integracao_t3,\n    REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal_integracao_t4') AS STRING), '.0', '') AS id_tipo_modal_integracao_t4,\n    REPLACE(SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal_origem') AS STRING), '.0', '') AS id_tipo_modal_origem,\n    SAFE_CAST(JSON_VALUE(content, '$.perc_rateio_integracao_t1') AS FLOAT64) AS perc_rateio_integracao_t1,\n    SAFE_CAST(JSON_VALUE(content, '$.perc_rateio_integracao_t2') AS FLOAT64) AS perc_rateio_integracao_t2,\n    SAFE_CAST(JSON_VALUE(content, '$.perc_rateio_integracao_t3') AS FLOAT64) AS perc_rateio_integracao_t3,\n    SAFE_CAST(JSON_VALUE(content, '$.perc_rateio_integracao_t4') AS FLOAT64) AS perc_rateio_integracao_t4,\n    SAFE_CAST(JSON_VALUE(content, '$.perc_rateio_origem') AS FLOAT64) AS perc_rateio_origem\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`percentual_rateio_integracao`\n)\nSELECT\n  * EXCEPT(rn)\nFROM\n(\n  SELECT\n    *,\n    ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp_captura DESC) AS rn\n  FROM\n    percentual_rateio_integracao\n)\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`percentual_rateio_integracao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.443830Z", "completed_at": "2024-09-30T15:21:17.448092Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.449536Z", "completed_at": "2024-09-30T15:21:17.449547Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008597135543823242, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_recursos_sppo_bloqueio_via", "compiled": true, "compiled_code": "\n\n\nSELECT\n  JSON_EXTRACT_ARRAY(content, '$.customFieldValues') AS items,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S', REGEXP_REPLACE(JSON_VALUE(content, '$.createdDate'), r'(\\.\\d+)?$', '')), 'America/Sao_Paulo') AS datetime_recurso,\n  SAFE_CAST(protocol AS STRING) AS id_recurso,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S', REGEXP_REPLACE(JSON_VALUE(content, '$.lastUpdate'), r'(\\.\\d+)?$', '')), 'America/Sao_Paulo') AS datetime_update,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), 'America/Sao_Paulo') AS datetime_captura,\n  data\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_bloqueio_via`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`staging_recursos_sppo_bloqueio_via`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.454321Z", "completed_at": "2024-09-30T15:21:17.458304Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.459755Z", "completed_at": "2024-09-30T15:21:17.459768Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008637189865112305, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_recursos_sppo_reprocessamento", "compiled": true, "compiled_code": "\n\nSELECT\n  JSON_EXTRACT_ARRAY(content, '$.customFieldValues') AS items,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S', REGEXP_REPLACE(JSON_VALUE(content, '$.createdDate'), r'(\\.\\d+)?$', '')), 'America/Sao_Paulo') AS datetime_recurso,\n  SAFE_CAST(protocol AS STRING) AS id_recurso,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S', REGEXP_REPLACE(JSON_VALUE(content, '$.lastUpdate'), r'(\\.\\d+)?$', '')), 'America/Sao_Paulo') AS datetime_update,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), 'America/Sao_Paulo') AS datetime_captura,\n  data\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_reprocessamento`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`staging_recursos_sppo_reprocessamento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.464267Z", "completed_at": "2024-09-30T15:21:17.467918Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.469895Z", "completed_at": "2024-09-30T15:21:17.469905Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008440971374511719, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_recursos_sppo_viagens_individuais", "compiled": true, "compiled_code": "\n\n\n\nSELECT\n  JSON_EXTRACT_ARRAY(content, '$.customFieldValues') AS items,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S', REGEXP_REPLACE(JSON_VALUE(content, '$.createdDate'), r'(\\.\\d+)?$', '')), 'America/Sao_Paulo') AS datetime_recurso,\n  SAFE_CAST(protocol AS STRING) AS id_recurso,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S', REGEXP_REPLACE(JSON_VALUE(content, '$.lastUpdate'), r'(\\.\\d+)?$', '')), 'America/Sao_Paulo') AS datetime_update,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), 'America/Sao_Paulo') AS datetime_captura,\n  data\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_viagens_individuais`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`staging_recursos_sppo_viagens_individuais`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.473867Z", "completed_at": "2024-09-30T15:21:17.478440Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.479861Z", "completed_at": "2024-09-30T15:21:17.479870Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008339881896972656, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_rho_registros_sppo", "compiled": true, "compiled_code": "\n\n\nSELECT\n    CONCAT(TRIM(linha_rcti), '_', data_transacao, '_', hora_transacao, ano,'_', mes, '_', dia) id_transacao,\n    TRIM(linha) linha,\n    SAFE_CAST(data_transacao AS DATE) data_transacao,\n    SAFE_CAST(hora_transacao AS INT64) hora_transacao,\n    SAFE_CAST(total_gratuidades AS INT64) total_gratuidades,\n    SAFE_CAST(total_pagantes_especie AS INT64) total_pagantes_especie,\n    SAFE_CAST(total_pagantes_cartao AS INT64) total_pagantes_cartao,\n    SAFE_CAST(registro_processado AS STRING) registro_processado,\n    SAFE_CAST(data_processamento AS DATE) data_processamento,\n    SAFE_CAST(operadora AS STRING) operadora,\n    SAFE_CAST(linha_rcti AS STRING) linha_rcti,\n    DATETIME(TIMESTAMP(timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n    SAFE_CAST(ano AS INT64) ano,\n    SAFE_CAST(mes AS INT64) mes,\n    SAFE_CAST(dia AS INT64) dia,\n    DATE(CONCAT(ano,'-', mes, '-', dia)) data_particao\nFROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_rdo_staging`.`rho_registros_sppo`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_rdo_staging`.`rho_registros_sppo`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.483791Z", "completed_at": "2024-09-30T15:21:17.489323Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.490571Z", "completed_at": "2024-09-30T15:21:17.490580Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009272575378417969, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_rho_registros_stpl", "compiled": true, "compiled_code": "\n\nSELECT\n    SAFE_CAST(operadora AS STRING) operadora,\n    SAFE_CAST(linha AS STRING) linha,\n    SAFE_CAST(data_transacao AS DATE) data_transacao,\n    -- SAFE_CAST(PARSE_DATETIME(\"%Y-%m-%d\", data_transacao) AS DATETIME) data_transacao,\n    SAFE_CAST(hora_transacao AS INT64) hora_transacao,\n    SAFE_CAST(total_gratuidades AS INT64) total_gratuidades,\n    SAFE_CAST(total_pagantes AS INT64) total_pagantes,\n    SAFE_CAST(DATETIME(TIMESTAMP(timestamp_captura), \"America/Sao_Paulo\") AS DATETIME) timestamp_captura,\n    SAFE_CAST(ano AS INT64) ano,\n    SAFE_CAST(mes AS INT64) mes,\n    SAFE_CAST(dia AS INT64) dia,\n    DATE(CONCAT(ano,'-', mes, '-', dia)) data_particao\nfrom\n    `rj-smtr-staging`.`br_rj_riodejaneiro_rdo_staging`.`rho5_registros_stpl` as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_rdo_staging`.`rho_registros_stpl`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.495044Z", "completed_at": "2024-09-30T15:21:17.499349Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.500619Z", "completed_at": "2024-09-30T15:21:17.500628Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008220434188842773, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_servico_motorista", "compiled": true, "compiled_code": "\n\nSELECT\n  data,\n  SAFE_CAST(NR_LOGICO_MIDIA AS STRING) AS nr_logico_midia,\n  SAFE_CAST(ID_SERVICO AS STRING) AS id_servico,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n  SAFE_CAST(JSON_VALUE(content, '$.CD_LINHA') AS STRING) AS cd_linha,\n  SAFE_CAST(JSON_VALUE(content, '$.CD_OPERADORA') AS STRING) AS cd_operadora,\n  SAFE_CAST(JSON_VALUE(content, '$.CD_STATUS') AS STRING) AS cd_status,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', SAFE_CAST(JSON_VALUE(content, '$.DT_ABERTURA') AS STRING)), 'America/Sao_Paulo') AS dt_abertura,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%S%Ez', SAFE_CAST(JSON_VALUE(content, '$.DT_FECHAMENTO') AS STRING)), 'America/Sao_Paulo') AS dt_fechamento,\n  SAFE_CAST(JSON_VALUE(content, '$.ID_VEICULO') AS STRING) AS id_veiculo,\n  SAFE_CAST(JSON_VALUE(content, '$.NR_LOGICO_MIDIA_FECHAMENTO') AS STRING) AS nr_logico_midia_fechamento,\n  SAFE_CAST(JSON_VALUE(content, '$.SN_DEVICE') AS STRING) AS sn_device,\n  SAFE_CAST(JSON_VALUE(content, '$.TP_GERACAO') AS STRING) AS tp_geracao,\n  SAFE_CAST(JSON_VALUE(content, '$.VL_TARIFA_LINHA') AS FLOAT64) AS vl_tarifa_linha\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`servico_motorista`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`servico_motorista`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.504823Z", "completed_at": "2024-09-30T15:21:17.508780Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.510203Z", "completed_at": "2024-09-30T15:21:17.510215Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007916688919067383, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_transacao", "compiled": true, "compiled_code": "\n\nSELECT\n    data,\n    hora,\n    id,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n    SAFE_CAST(JSON_VALUE(content, '$.assinatura') AS STRING) AS assinatura,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_aplicacao') AS STRING) AS cd_aplicacao,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_emissor') AS STRING) AS cd_emissor,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_consorcio') AS STRING) AS cd_consorcio,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_linha') AS STRING) AS cd_linha,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_matriz_integracao') AS STRING) AS cd_matriz_integracao,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_operadora') AS STRING) AS cd_operadora,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_secao') AS STRING) AS cd_secao,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_status_transacao') AS STRING) AS cd_status_transacao,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E6S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_processamento') AS STRING)), \"America/Sao_Paulo\") AS data_processamento,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E6S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_transacao') AS STRING)), \"America/Sao_Paulo\") AS data_transacao,\n    SAFE_CAST(JSON_VALUE(content, '$.id_cliente') AS STRING) AS id_cliente,\n    SAFE_CAST(JSON_VALUE(content, '$.id_produto') AS STRING) AS id_produto,\n    SAFE_CAST(JSON_VALUE(content, '$.id_servico') AS STRING) AS id_servico,\n    SAFE_CAST(JSON_VALUE(content, '$.id_tipo_midia') AS STRING) AS id_tipo_midia,\n    SAFE_CAST(JSON_VALUE(content, '$.is_abt') AS BOOL) AS is_abt,\n    SAFE_CAST(JSON_VALUE(content, '$.latitude_trx') AS FLOAT64) AS latitude_trx,\n    SAFE_CAST(JSON_VALUE(content, '$.longitude_trx') AS FLOAT64) AS longitude_trx,\n    SAFE_CAST(JSON_VALUE(content, '$.nr_logico_midia_operador') AS STRING) AS nr_logico_midia_operador,\n    SAFE_CAST(JSON_VALUE(content, '$.numero_serie_validador') AS STRING) AS numero_serie_validador,\n    SAFE_CAST(JSON_VALUE(content, '$.pan_hash') AS STRING) AS pan_hash,\n    SAFE_CAST(JSON_VALUE(content, '$.posicao_validador') AS STRING) AS posicao_validador,\n    SAFE_CAST(JSON_VALUE(content, '$.sentido') AS STRING) AS sentido,\n    SAFE_CAST(JSON_VALUE(content, '$.tipo_integracao') AS STRING) AS tipo_integracao,\n    SAFE_CAST(JSON_VALUE(content, '$.tipo_transacao') AS STRING) AS tipo_transacao,\n    SAFE_CAST(JSON_VALUE(content, '$.uid_origem') AS STRING) AS uid_origem,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_tarifa') AS FLOAT64) AS valor_tarifa,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_transacao') AS FLOAT64) AS valor_transacao,\n    SAFE_CAST(JSON_VALUE(content, '$.veiculo_id') AS STRING) AS veiculo_id,\n    SAFE_CAST(JSON_VALUE(content, '$.vl_saldo') AS FLOAT64) AS vl_saldo,\n    SAFE_CAST(JSON_VALUE(content, '$.id_tipo_modal') AS STRING) AS id_tipo_modal\nFROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`transacao`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`transacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.514861Z", "completed_at": "2024-09-30T15:21:17.519135Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.520418Z", "completed_at": "2024-09-30T15:21:17.520427Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008065938949584961, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_transacao_riocard", "compiled": true, "compiled_code": "\n\nSELECT\n    data,\n    hora,\n    id,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n    SAFE_CAST(JSON_VALUE(content, '$.assinatura') AS STRING) AS assinatura,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_aplicacao') AS STRING) AS cd_aplicacao,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_emissor') AS STRING) AS cd_emissor,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_consorcio') AS STRING) AS cd_consorcio,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_linha') AS STRING) AS cd_linha,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_matriz_integracao') AS STRING) AS cd_matriz_integracao,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_operadora') AS STRING) AS cd_operadora,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_secao') AS STRING) AS cd_secao,\n    SAFE_CAST(JSON_VALUE(content, '$.cd_status_transacao') AS STRING) AS cd_status_transacao,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E6S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_processamento') AS STRING)), \"America/Sao_Paulo\") AS data_processamento,\n    DATETIME(PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E6S%Ez', SAFE_CAST(JSON_VALUE(content, '$.data_transacao') AS STRING)), \"America/Sao_Paulo\") AS data_transacao,\n    SAFE_CAST(JSON_VALUE(content, '$.id_cliente') AS STRING) AS id_cliente,\n    SAFE_CAST(JSON_VALUE(content, '$.id_produto') AS STRING) AS id_produto,\n    SAFE_CAST(JSON_VALUE(content, '$.id_servico') AS STRING) AS id_servico,\n    SAFE_CAST(JSON_VALUE(content, '$.id_tipo_midia') AS STRING) AS id_tipo_midia,\n    SAFE_CAST(JSON_VALUE(content, '$.latitude_trx') AS FLOAT64) AS latitude_trx,\n    SAFE_CAST(JSON_VALUE(content, '$.longitude_trx') AS FLOAT64) AS longitude_trx,\n    SAFE_CAST(JSON_VALUE(content, '$.nr_logico_midia_operador') AS STRING) AS nr_logico_midia_operador,\n    SAFE_CAST(JSON_VALUE(content, '$.numero_serie_validador') AS STRING) AS numero_serie_validador,\n    SAFE_CAST(JSON_VALUE(content, '$.pan_hash') AS STRING) AS pan_hash,\n    SAFE_CAST(JSON_VALUE(content, '$.posicao_validador') AS STRING) AS posicao_validador,\n    SAFE_CAST(JSON_VALUE(content, '$.sentido') AS STRING) AS sentido,\n    SAFE_CAST(JSON_VALUE(content, '$.tipo_integracao') AS STRING) AS tipo_integracao,\n    SAFE_CAST(JSON_VALUE(content, '$.tipo_transacao') AS STRING) AS tipo_transacao,\n    SAFE_CAST(JSON_VALUE(content, '$.uid_origem') AS STRING) AS uid_origem,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_tarifa') AS NUMERIC) AS valor_tarifa,\n    SAFE_CAST(JSON_VALUE(content, '$.valor_transacao') AS NUMERIC) AS valor_transacao,\n    SAFE_CAST(JSON_VALUE(content, '$.veiculo_id') AS STRING) AS veiculo_id,\n    SAFE_CAST(JSON_VALUE(content, '$.vl_saldo') AS NUMERIC) AS vl_saldo\nFROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_bilhetagem_staging`.`transacao_riocard`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`transacao_riocard`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.524206Z", "completed_at": "2024-09-30T15:21:17.528702Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.530060Z", "completed_at": "2024-09-30T15:21:17.530072Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00845789909362793, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.staging_viagem_informada", "compiled": true, "compiled_code": "\n\nSELECT\n  id_viagem,\n  data,\n  hora,\n  DATETIME(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S%Ez', timestamp_captura), \"America/Sao_Paulo\") AS timestamp_captura,\n  DATE(\n    PARSE_DATETIME(\n      '%Y-%m-%d',\n      SUBSTRING(\n        SAFE_CAST(JSON_VALUE(content, '$.data_viagem') AS STRING),\n        0,\n        10\n      )\n    )\n  ) AS data_viagem,\n  DATETIME(\n    PARSE_TIMESTAMP(\n      '%Y-%m-%dT%H:%M:%S',\n      REPLACE(\n        SAFE_CAST(JSON_VALUE(content, '$.datetime_chegada') AS STRING),\n        \"Z\",\n        \"\"\n      )\n    )\n  ) AS datetime_chegada,\n  DATETIME(\n    PARSE_TIMESTAMP(\n      '%Y-%m-%dT%H:%M:%S',\n      REPLACE(\n        SAFE_CAST(JSON_VALUE(content, '$.datetime_partida') AS STRING),\n        \"Z\",\n        \"\"\n      )\n    )\n  ) AS datetime_partida,\n  DATETIME(\n    PARSE_TIMESTAMP(\n      '%Y-%m-%dT%H:%M:%E*S',\n      REPLACE(\n        SAFE_CAST(JSON_VALUE(content, '$.datetime_processamento') AS STRING),\n        \"Z\",\n        \"\"\n      )\n    )\n  ) AS datetime_processamento,\n  SAFE_CAST(JSON_VALUE(content, '$.id_veiculo') AS STRING) AS id_veiculo,\n  SAFE_CAST(JSON_VALUE(content, '$.route_id') AS STRING) AS route_id,\n  SAFE_CAST(JSON_VALUE(content, '$.sentido') AS STRING) AS sentido,\n  SAFE_CAST(JSON_VALUE(content, '$.servico') AS STRING) AS servico,\n  SAFE_CAST(JSON_VALUE(content, '$.shape_id') AS STRING) AS shape_id,\n  SAFE_CAST(JSON_VALUE(content, '$.trip_id') AS STRING) AS trip_id\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_viagem_zirix_staging`.`viagem_informada`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_viagem_zirix_staging`.`viagem_informada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.534064Z", "completed_at": "2024-09-30T15:21:17.539280Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.540530Z", "completed_at": "2024-09-30T15:21:17.540539Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00880742073059082, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.stop_details", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nSAFE_CAST(stop_id AS STRING) stop_id,\nREPLACE(content,\"None\",\"\") content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.stop_details as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stop_details`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.545153Z", "completed_at": "2024-09-30T15:21:17.548797Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.550042Z", "completed_at": "2024-09-30T15:21:17.550055Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007699728012084961, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.stop_times", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nSAFE_CAST(stop_id AS STRING) stop_id,\nREPLACE(content,\"None\",\"\") content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.stop_times as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stop_times`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.554321Z", "completed_at": "2024-09-30T15:21:17.557893Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.559260Z", "completed_at": "2024-09-30T15:21:17.559274Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00773167610168457, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.stops", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nSAFE_CAST(stop_id AS STRING) stop_id,\nREPLACE(content, \"None\", '') content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.stops as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stops`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.563678Z", "completed_at": "2024-09-30T15:21:17.567748Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.569506Z", "completed_at": "2024-09-30T15:21:17.569515Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008249759674072266, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.subsidio_parametros", "compiled": true, "compiled_code": "\n\nSELECT\n  COALESCE(SAFE_CAST(indicador_licenciado AS BOOL), FALSE) indicador_licenciado,\n  COALESCE(SAFE_CAST(indicador_ar_condicionado AS BOOL), FALSE) indicador_ar_condicionado,\n  COALESCE(SAFE_CAST(indicador_autuacao_ar_condicionado AS BOOL), FALSE) indicador_autuacao_ar_condicionado,\n  COALESCE(SAFE_CAST(indicador_autuacao_seguranca AS BOOL), FALSE) indicador_autuacao_seguranca,\n  COALESCE(SAFE_CAST(indicador_autuacao_limpeza AS BOOL), FALSE) indicador_autuacao_limpeza,\n  COALESCE(SAFE_CAST(indicador_autuacao_equipamento AS BOOL), FALSE) indicador_autuacao_equipamento,\n  COALESCE(SAFE_CAST(indicador_sensor_temperatura AS BOOL), FALSE) indicador_sensor_temperatura,\n  COALESCE(SAFE_CAST(indicador_validador_sbd AS BOOL), FALSE) indicador_validador_sbd,\n  COALESCE(SAFE_CAST(indicador_registro_agente_verao_ar_condicionado AS BOOL), FALSE) indicador_registro_agente_verao_ar_condicionado,\n  SAFE_CAST(status AS STRING) status,\n  SAFE_CAST(subsidio_km AS FLOAT64) subsidio_km,\n  SAFE_CAST(irk AS FLOAT64) irk,\n  SAFE_CAST(data_inicio AS DATE) data_inicio,\n  SAFE_CAST(data_fim AS DATE) data_fim,\n  SAFE_CAST(legislacao AS STRING) legislacao,\n  SAFE_CAST(ordem AS INT64) ordem\nFROM\n  `rj-smtr-staging.dashboard_subsidio_sppo_staging.subsidio_parametros`", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo`.`subsidio_parametros`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.573379Z", "completed_at": "2024-09-30T15:21:17.577293Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.578763Z", "completed_at": "2024-09-30T15:21:17.578774Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007924795150756836, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.subsidio_quadro_horario", "compiled": true, "compiled_code": "SELECT\n    SAFE_CAST(data_versao AS DATE) data_versao,\n    SAFE_CAST(servico AS STRING) servico,\n    SAFE_CAST(vista AS STRING) vista,\n    SAFE_CAST(consorcio AS STRING) consorcio,\n    SAFE_CAST(horario_inicio AS STRING) horario_inicio,\n    SAFE_CAST(horario_fim AS STRING) horario_fim,\n    SAFE_CAST(trip_id AS STRING) trip_id,\n    SAFE_CAST(sentido AS STRING) sentido,\n    SAFE_CAST(distancia_planejada AS FLOAT64) distancia_planejada,\n    SAFE_CAST(tipo_dia AS STRING) tipo_dia,\n    SAFE_CAST(distancia_total_planejada AS FLOAT64) distancia_total_planejada\nFROM `rj-smtr-staging.projeto_subsidio_sppo_staging.quadro_horario` AS t", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`subsidio_quadro_horario`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.583122Z", "completed_at": "2024-09-30T15:21:17.588416Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.589686Z", "completed_at": "2024-09-30T15:21:17.589696Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009061098098754883, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.subsidio_trips_desaninhada", "compiled": true, "compiled_code": "-- 1. Cria view das trips consideradas no subsidio\nselect\n    trip_id,\n    -- concat(substr(trip_id, 1, 10), substr(trip_id, 12, 4)) as trip_no_direction,\n    route_id,\n    trip_headsign,\n    case\n        when REGEXP_EXTRACT(trip_short_name, r'[A-Z]+') is null\n        then trip_short_name\n        else concat(REGEXP_EXTRACT(trip_short_name, r'[A-Z]+'),\n                REGEXP_EXTRACT(trip_short_name, r'[0-9]+'))\n    end as trip_short_name,\n    shape_id,\n    \"DU\" as variacao_itinerario,\n    DATE(data_versao) data_versao\nfrom\n    `rj-smtr-staging.projeto_subsidio_sppo_staging.trips` t", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`subsidio_trips_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.595070Z", "completed_at": "2024-09-30T15:21:17.599363Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.600626Z", "completed_at": "2024-09-30T15:21:17.600635Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009271621704101562, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.subsidio_valor_km_tipo_viagem", "compiled": true, "compiled_code": "\n\nSELECT\n  SAFE_CAST(status AS STRING) status,\n  SAFE_CAST(subsidio_km AS FLOAT64) subsidio_km,\n  SAFE_CAST(irk AS FLOAT64) irk,\n  SAFE_CAST(data_inicio AS DATE) data_inicio,\n  SAFE_CAST(data_fim AS DATE) data_fim,\n  SAFE_CAST(indicador_penalidade_judicial AS BOOL) indicador_penalidade_judicial,\n  SAFE_CAST(legislacao AS STRING) legislacao\nFROM\n  `rj-smtr-staging`.`dashboard_subsidio_sppo_staging`.`subsidio_valor_km_tipo_viagem`", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo_staging`.`subsidio_valor_km_tipo_viagem`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.605095Z", "completed_at": "2024-09-30T15:21:17.608612Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.610010Z", "completed_at": "2024-09-30T15:21:17.610022Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007465362548828125, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.trips", "compiled": true, "compiled_code": "/*\n\nQuery para publicar a tabela.\n\nEsse \u00e9 o lugar para:\n    - modificar nomes, ordem e tipos de colunas\n    - dar join com outras tabelas\n    - criar colunas extras (e.g. logs, propor\u00e7\u00f5es, etc.)\n\nQualquer coluna definida aqui deve tamb\u00e9m existir em `table_config.yaml`.\n\n# Al\u00e9m disso, sinta-se \u00e0 vontade para alterar alguns nomes obscuros\n# para algo um pouco mais expl\u00edcito.\n\nTIPOS:\n    - Para modificar tipos de colunas, basta substituir STRING por outro tipo v\u00e1lido.\n    - Exemplo: `SAFE_CAST(column_name AS NUMERIC) column_name`\n    - Mais detalhes: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types\n\n*/\n\nSELECT\nSAFE_CAST(trip_id AS STRING) trip_id,\nREPLACE(content,\"None\",\"\") content,\nSAFE_CAST(data_versao AS DATE) data_versao\nfrom rj-smtr-staging.br_rj_riodejaneiro_sigmob_staging.trips as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.615155Z", "completed_at": "2024-09-30T15:21:17.619754Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.621023Z", "completed_at": "2024-09-30T15:21:17.621032Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008703947067260742, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.valor_tipo_penalidade", "compiled": true, "compiled_code": "\n\n-- DEC RIO N. 51940/2023 e 53856/2023\nwith penalidade as (\n    select 0 as perc_km_inferior, 40 as perc_km_superior, \"Grave\" as tipo_penalidade, 1126.55 as valor, date(\"2023-01-16\") as data_inicio, date(\"2024-12-31\") as data_fim\n    union all\n    select 40 as perc_km_inferior, 60 as perc_km_superior, \"M\u00e9dia\" as tipo_penalidade, 563.28 as valor, date(\"2023-01-16\") as data_inicio, date(\"2024-12-31\") as data_fim\n    union all\n    select 60 as perc_km_inferior, 80 as perc_km_superior, \"Nula\" as tipo_penalidade, 0 as valor, date(\"2023-01-16\") as data_inicio, date(\"2024-12-31\") as data_fim\n    union all\n    select 80 as perc_km_inferior, 100 as perc_km_superior, null as tipo_penalidade, null as valor, date(\"2023-01-16\") as data_inicio, date(\"2024-12-31\") as data_fim\n\n)\nselect * from penalidade", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo`.`valor_tipo_penalidade`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.624740Z", "completed_at": "2024-09-30T15:21:17.628913Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.630231Z", "completed_at": "2024-09-30T15:21:17.630240Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00791621208190918, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.agency_desaninhada", "compiled": true, "compiled_code": "SELECT\n  agency_id,\n  JSON_VALUE(content, \"$.agency_name\") agency_name,\n  JSON_VALUE(content, \"$.agency_url\") agency_url,\n  JSON_VALUE(content, \"$.agency_timezone\") agency_timezone,\n  JSON_VALUE(content, \"$.agency_lang\") agency_lang,\n  JSON_VALUE(content, \"$.agency_phone\") agency_phone,\n  DATE(data_versao) data_versao\nFROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`agency`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`agency_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.634052Z", "completed_at": "2024-09-30T15:21:17.641352Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.642717Z", "completed_at": "2024-09-30T15:21:17.642728Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011127710342407227, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.autuacao", "compiled": true, "compiled_code": "\n\nWITH citran AS (\n    SELECT\n        data,\n        id_auto_infracao,\n        DATETIME(concat(data,' ',hora,':00')) AS datetime_autuacao,\n        data_limite_defesa_previa,\n        data_limite_recurso,\n        situacao_atual AS descricao_situacao_autuacao,\n        IF(status_infracao != \"\", status_infracao, NULL) AS status_infracao,\n        IF(codigo_enquadramento != \"\", codigo_enquadramento, NULL) AS codigo_enquadramento,\n        IF(tipificacao_resumida != \"\", tipificacao_resumida, NULL) AS tipificacao_resumida,\n        IF(pontuacao != \"\", pontuacao, NULL) AS pontuacao,\n        NULL AS gravidade,\n        NULL AS amparo_legal,\n        IF(tipo_veiculo != \"\", tipo_veiculo, NULL) AS tipo_veiculo,\n        IF(descricao_veiculo != \"\", descricao_veiculo, NULL) AS descricao_veiculo,\n        NULL AS placa_veiculo,\n        NULL AS ano_fabricacao_veiculo,\n        NULL AS ano_modelo_veiculo,\n        NULL AS cor_veiculo,\n        IF(especie_veiculo != \"\", especie_veiculo, NULL) AS especie_veiculo,\n        NULL AS uf_infrator,\n        NULL AS uf_principal_condutor,\n        IF(uf_proprietario != \"\", uf_proprietario, NULL) AS uf_proprietario,\n        IF(cep_proprietario != \"\", cep_proprietario, NULL) AS cep_proprietario,\n        valor_infracao / 100 AS valor_infracao,\n        valor_pago  / 100 AS valor_pago,\n        data_pagamento,\n        \"260010\" AS id_autuador,\n        IF(descricao_autuador != \"\", descricao_autuador, NULL) AS descricao_autuador,\n        \"6001\" AS id_municipio_autuacao,\n        \"RIO DE JANEIRO\" AS descricao_municipio,\n        \"RJ\" AS uf_autuacao,\n        NULL AS cep_autuacao, -- n\u00e3o padronizado na citran\n        NULL AS tile_autuacao,\n        IF(processo_defesa_autuacao != \"00000000\" AND processo_defesa_autuacao != \"\" , processo_defesa_autuacao, NULL) AS processo_defesa_autuacao,\n        IF(recurso_penalidade_multa != \"00000000\" AND recurso_penalidade_multa != \"\" , recurso_penalidade_multa, NULL) AS recurso_penalidade_multa,\n        IF(processo_troca_real_infrator != \"00000000\" AND processo_troca_real_infrator != \"\" , processo_troca_real_infrator, NULL) AS processo_troca_real_infrator,\n        FALSE AS status_sne,\n        \"CITRAN\" AS fonte\n    FROM `rj-smtr`.`transito_staging`.`autuacao_citran`\n    \n        WHERE\n            data BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n    \n)\n\nSELECT\n    data,\n    TO_HEX(SHA256(CONCAT(GENERATE_UUID(), id_auto_infracao))) AS id_autuacao,\n    id_auto_infracao,\n    datetime_autuacao,\n    data_limite_defesa_previa,\n    data_limite_recurso,\n    descricao_situacao_autuacao,\n    status_infracao,\n    codigo_enquadramento,\n    tipificacao_resumida,\n    pontuacao,\n    gravidade,\n    amparo_legal,\n    tipo_veiculo,\n    descricao_veiculo,\n    placa_veiculo,\n    ano_fabricacao_veiculo,\n    ano_modelo_veiculo,\n    cor_veiculo,\n    especie_veiculo,\n    uf_infrator,\n    uf_principal_condutor,\n    uf_proprietario,\n    cep_proprietario,\n    valor_infracao,\n    valor_pago,\n    data_pagamento,\n    id_autuador,\n    descricao_autuador,\n    id_municipio_autuacao,\n    descricao_municipio,\n    uf_autuacao,\n    cep_autuacao,\n    tile_autuacao,\n    processo_defesa_autuacao,\n    recurso_penalidade_multa,\n    processo_troca_real_infrator,\n    status_sne,\n    fonte\nFROM\n    citran", "relation_name": "`rj-smtr`.`transito`.`autuacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.647054Z", "completed_at": "2024-09-30T15:21:17.650565Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.652333Z", "completed_at": "2024-09-30T15:21:17.652342Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00775909423828125, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.brt_registros_desaninhada", "compiled": true, "compiled_code": "SELECT\ndata,\nhora,\nid_veiculo,\ntimestamp_gps,\ntimestamp_captura,\nSAFE_CAST(json_value(content,\"$.latitude\") AS FLOAT64) latitude,\nSAFE_CAST(json_value(content,\"$.longitude\") AS FLOAT64) longitude,\njson_value(content,\"$.servico\") servico,\njson_value(content,\"$.sentido\") sentido,\nSAFE_CAST(json_value(content,\"$.velocidade\") AS INT64) velocidade,\nfrom `rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_registros` as t", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_registros_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.656148Z", "completed_at": "2024-09-30T15:21:17.659800Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:17.661051Z", "completed_at": "2024-09-30T15:21:17.661061Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007333040237426758, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.calendar_desaninhada", "compiled": true, "compiled_code": "SELECT\n  service_id,\n  JSON_VALUE(content, \"$.monday\") monday,\n  JSON_VALUE(content, \"$.tuesday\") tuesday,\n  JSON_VALUE(content, \"$.wednesday\") wednesday,\n  JSON_VALUE(content, \"$.thursday\") thursday,\n  JSON_VALUE(content, \"$.friday\") friday,\n  JSON_VALUE(content, \"$.saturday\") saturday,\n  JSON_VALUE(content, \"$.sunday\") sunday,\n  JSON_VALUE(content, \"$.start_date\") start_date,\n  JSON_VALUE(content, \"$.end_date\") end_date,\n  DATE(data_versao) data_versao\n\nFROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`calendar`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`calendar_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:17.665023Z", "completed_at": "2024-09-30T15:21:20.144348Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:20.145797Z", "completed_at": "2024-09-30T15:21:20.145806Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.483138084411621, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.agency_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nSELECT\n  fi.feed_version,\n  SAFE_CAST(a.data_versao AS DATE) feed_start_date,\n  fi.feed_end_date,\n  SAFE_CAST(a.agency_id AS STRING) agency_id,\n  SAFE_CAST(JSON_VALUE(a.content, '$.agency_name') AS STRING) agency_name,\n  SAFE_CAST(JSON_VALUE(a.content, '$.agency_url') AS STRING) agency_url,\n  SAFE_CAST(JSON_VALUE(a.content, '$.agency_timezone') AS STRING) agency_timezone,\n  SAFE_CAST(JSON_VALUE(a.content, '$.agency_lang') AS STRING) agency_lang,\n  '' AS versao_modelo\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`agency` a\nJOIN\n  `rj-smtr`.`gtfs`.`feed_info` fi\nON\n  a.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n    a.data_versao IN ('2024-04-15', '2024-05-03')\n    AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`agency`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:20.149767Z", "completed_at": "2024-09-30T15:21:22.603690Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:22.605012Z", "completed_at": "2024-09-30T15:21:22.605022Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.4577033519744873, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.calendar_dates_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\n\nSELECT\n  fi.feed_version,\n  SAFE_CAST(cd.data_versao AS DATE) feed_start_date,\n  fi.feed_end_date,\n  SAFE_CAST(cd.service_id AS STRING) service_id,\n  PARSE_DATE('%Y%m%d', SAFE_CAST(cd.DATE AS STRING)) DATE,\n  SAFE_CAST(JSON_VALUE(cd.content, '$.exception_type') AS STRING) exception_type,\n  '' AS versao_modelo\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`calendar_dates` cd\nJOIN\n  `rj-smtr`.`gtfs`.`feed_info` fi\nON\n  cd.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n    cd.data_versao IN ('2024-04-15', '2024-05-03')\n    AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`calendar_dates`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:22.609029Z", "completed_at": "2024-09-30T15:21:25.061719Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:25.067173Z", "completed_at": "2024-09-30T15:21:25.067208Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.463899612426758, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.calendar_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nSELECT\n  fi.feed_version,\n  SAFE_CAST(c.data_versao AS DATE) feed_start_date,\n  fi.feed_end_date,\n  SAFE_CAST(c.service_id AS STRING) service_id,\n  SAFE_CAST(JSON_VALUE(c.content, '$.monday') AS STRING) monday,\n  SAFE_CAST(JSON_VALUE(c.content, '$.tuesday') AS STRING) tuesday,\n  SAFE_CAST(JSON_VALUE(c.content, '$.wednesday') AS STRING) wednesday,\n  SAFE_CAST(JSON_VALUE(c.content, '$.thursday') AS STRING) thursday,\n  SAFE_CAST(JSON_VALUE(c.content, '$.friday') AS STRING) friday,\n  SAFE_CAST(JSON_VALUE(c.content, '$.saturday') AS STRING) saturday,\n  SAFE_CAST(JSON_VALUE(c.content, '$.sunday') AS STRING) sunday,\n  PARSE_DATE('%Y%m%d', SAFE_CAST(JSON_VALUE(c.content, '$.start_date') AS STRING)) start_date,\n  PARSE_DATE('%Y%m%d', SAFE_CAST(JSON_VALUE(c.content, '$.end_date') AS STRING)) end_date,\n  '' AS versao_modelo\n FROM `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`calendar` c\nJOIN\n  `rj-smtr`.`gtfs`.`feed_info` fi\nON\n  c.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n    c.data_versao IN ('2024-04-15', '2024-05-03')\n    AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`calendar`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:25.083798Z", "completed_at": "2024-09-30T15:21:27.318507Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:27.325401Z", "completed_at": "2024-09-30T15:21:27.325451Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.252319097518921, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.fare_attributes_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nSELECT\n  fi.feed_version,\n  SAFE_CAST(fa.data_versao AS DATE) feed_start_date,\n  fi.feed_end_date,\n  SAFE_CAST(fa.fare_id AS STRING) fare_id,\n  SAFE_CAST(JSON_VALUE(fa.content, '$.price') AS FLOAT64) price,\n  SAFE_CAST(JSON_VALUE(fa.content, '$.currency_type') AS STRING) currency_type,\n  SAFE_CAST(JSON_VALUE(fa.content, '$.payment_method') AS STRING) payment_method,\n  SAFE_CAST(JSON_VALUE(fa.content, '$.transfers') AS STRING) transfers,\n  SAFE_CAST(JSON_VALUE(fa.content, '$.agency_id') AS STRING) agency_id,\n  SAFE_CAST(JSON_VALUE(fa.content, '$.transfer_duration') AS INT64) transfer_duration,\n  '' AS versao_modelo\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`fare_attributes` fa\nJOIN\n  `rj-smtr`.`gtfs`.`feed_info` fi\nON\n  fa.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n    fa.data_versao IN ('2024-04-15', '2024-05-03')\n    AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`fare_attributes`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:27.341911Z", "completed_at": "2024-09-30T15:21:29.656078Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:29.657315Z", "completed_at": "2024-09-30T15:21:29.657325Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.3214244842529297, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.fare_rules_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nSELECT\n  fi.feed_version,\n  SAFE_CAST(fr.data_versao AS DATE) feed_start_date,\n  fi.feed_end_date,\n  SAFE_CAST(fr.fare_id AS STRING) fare_id,\n  SAFE_CAST(fr.route_id AS STRING) route_id,\n  SAFE_CAST(JSON_VALUE(fr.content, '$.origin_id') AS STRING) origin_id,\n  SAFE_CAST(JSON_VALUE(fr.content, '$.destination_id') AS STRING) destination_id,\n  SAFE_CAST(JSON_VALUE(fr.content, '$.contains_id') AS STRING) contains_id,\n  '' AS versao_modelo\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`fare_rules` fr\nJOIN\n  `rj-smtr`.`gtfs`.`feed_info` fi\nON\n  fr.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n    fr.data_versao IN ('2024-04-15', '2024-05-03')\n    AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`fare_rules`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:29.661069Z", "completed_at": "2024-09-30T15:21:32.572653Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:32.576363Z", "completed_at": "2024-09-30T15:21:32.576385Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.9189016819000244, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.frequencies_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nSELECT\n  fi.feed_version,\n  SAFE_CAST(f.data_versao AS DATE) as feed_start_date,\n  fi.feed_end_date,\n  SAFE_CAST(f.trip_id AS STRING) trip_id,\n  SAFE_CAST(f.start_time AS STRING) start_time,\n  SAFE_CAST(JSON_VALUE(f.content, '$.end_time') AS STRING) end_time,\n  SAFE_CAST(JSON_VALUE(f.content, '$.headway_secs') AS INT64) headway_secs,\n  SAFE_CAST(JSON_VALUE(f.content, '$.exact_times') AS STRING) exact_times,\n  '' AS versao_modelo\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`frequencies` f\nJOIN\n  `rj-smtr`.`gtfs`.`feed_info` fi\nON\n  f.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n    f.data_versao IN ('2024-04-15', '2024-05-03')\n    AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`frequencies`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:32.584333Z", "completed_at": "2024-09-30T15:21:32.596178Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:32.597886Z", "completed_at": "2024-09-30T15:21:32.597897Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01761937141418457, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_servico_faixa_horaria", "compiled": true, "compiled_code": "\n\nWITH\n  dados AS (\n  SELECT\n    SAFE_CAST(data_versao AS DATE) AS data_versao,\n    SAFE_CAST(tipo_os AS STRING) AS tipo_os,\n    SAFE_CAST(servico AS STRING) AS servico,\n    SAFE_CAST(JSON_VALUE(content, \"$.consorcio\") AS STRING) AS consorcio,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_00h_e_03h_dias_uteis') AS STRING) AS partidas_entre_00h_e_03h_dias_uteis,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_00h_e_03h_dias_uteis') AS STRING) AS quilometragem_entre_00h_e_03h_dias_uteis,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_03h_e_12h_dias_uteis') AS STRING) AS partidas_entre_03h_e_12h_dias_uteis,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_03h_e_12h_dias_uteis') AS STRING) AS quilometragem_entre_03h_e_12h_dias_uteis,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_12h_e_21h_dias_uteis') AS STRING) AS partidas_entre_12h_e_21h_dias_uteis,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_12h_e_21h_dias_uteis') AS STRING) AS quilometragem_entre_12h_e_21h_dias_uteis,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_21h_e_24h_dias_uteis') AS STRING) AS partidas_entre_21h_e_24h_dias_uteis,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_21h_e_24h_dias_uteis') AS STRING) AS quilometragem_entre_21h_e_24h_dias_uteis,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_24h_e_03h_diaseguinte_dias_uteis') AS STRING) AS partidas_entre_24h_e_03h_diaseguinte_dias_uteis,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_24h_e_03h_diaseguinte_dias_uteis') AS STRING) AS quilometragem_entre_24h_e_03h_diaseguinte_dias_uteis,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_00h_e_03h_sabado') AS STRING) AS partidas_entre_00h_e_03h_sabado,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_00h_e_03h_sabado') AS STRING) AS quilometragem_entre_00h_e_03h_sabado,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_03h_e_12h_sabado') AS STRING) AS partidas_entre_03h_e_12h_sabado,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_03h_e_12h_sabado') AS STRING) AS quilometragem_entre_03h_e_12h_sabado,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_12h_e_21h_sabado') AS STRING) AS partidas_entre_12h_e_21h_sabado,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_12h_e_21h_sabado') AS STRING) AS quilometragem_entre_12h_e_21h_sabado,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_21h_e_24h_sabado') AS STRING) AS partidas_entre_21h_e_24h_sabado,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_21h_e_24h_sabado') AS STRING) AS quilometragem_entre_21h_e_24h_sabado,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_24h_e_03h_diaseguinte_sabado') AS STRING) AS partidas_entre_24h_e_03h_diaseguinte_sabado,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_24h_e_03h_diaseguinte_sabado') AS STRING) AS quilometragem_entre_24h_e_03h_diaseguinte_sabado,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_00h_e_03h_domingo') AS STRING) AS partidas_entre_00h_e_03h_domingo,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_00h_e_03h_domingo') AS STRING) AS quilometragem_entre_00h_e_03h_domingo,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_03h_e_12h_domingo') AS STRING) AS partidas_entre_03h_e_12h_domingo,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_03h_e_12h_domingo') AS STRING) AS quilometragem_entre_03h_e_12h_domingo,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_12h_e_21h_domingo') AS STRING) AS partidas_entre_12h_e_21h_domingo,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_12h_e_21h_domingo') AS STRING) AS quilometragem_entre_12h_e_21h_domingo,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_21h_e_24h_domingo') AS STRING) AS partidas_entre_21h_e_24h_domingo,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_21h_e_24h_domingo') AS STRING) AS quilometragem_entre_21h_e_24h_domingo,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_24h_e_03h_diaseguinte_domingo') AS STRING) AS partidas_entre_24h_e_03h_diaseguinte_domingo,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_24h_e_03h_diaseguinte_domingo') AS STRING) AS quilometragem_entre_24h_e_03h_diaseguinte_domingo,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_00h_e_03h_ponto_facultativo') AS STRING) AS partidas_entre_00h_e_03h_ponto_facultativo,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_00h_e_03h_ponto_facultativo') AS STRING) AS quilometragem_entre_00h_e_03h_ponto_facultativo,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_03h_e_12h_ponto_facultativo') AS STRING) AS partidas_entre_03h_e_12h_ponto_facultativo,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_03h_e_12h_ponto_facultativo') AS STRING) AS quilometragem_entre_03h_e_12h_ponto_facultativo,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_12h_e_21h_ponto_facultativo') AS STRING) AS partidas_entre_12h_e_21h_ponto_facultativo,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_12h_e_21h_ponto_facultativo') AS STRING) AS quilometragem_entre_12h_e_21h_ponto_facultativo,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_21h_e_24h_ponto_facultativo') AS STRING) AS partidas_entre_21h_e_24h_ponto_facultativo,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_21h_e_24h_ponto_facultativo') AS STRING) AS quilometragem_entre_21h_e_24h_ponto_facultativo,\n    SAFE_CAST(JSON_VALUE(content, '$.partidas_entre_24h_e_03h_diaseguinte_ponto_facultativo') AS STRING) AS partidas_entre_24h_e_03h_diaseguinte_ponto_facultativo,\n    SAFE_CAST(JSON_VALUE(content, '$.quilometragem_entre_24h_e_03h_diaseguinte_ponto_facultativo') AS STRING) AS quilometragem_entre_24h_e_03h_diaseguinte_ponto_facultativo\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`ordem_servico_faixa_horaria`\n  WHERE\n    data_versao = '2024-05-03'\n  ),\n  dados_agrupados AS (\n  SELECT\n    data_versao,\n    tipo_os,\n    servico,\n    consorcio,\n    CASE\n      WHEN column_name LIKE '%dias_uteis%' THEN 'Dia \u00datil'\n      WHEN column_name LIKE '%sabado%' THEN 'Sabado'\n      WHEN column_name LIKE '%domingo%' THEN 'Domingo'\n      WHEN column_name LIKE '%ponto_facultativo%' THEN 'Ponto Facultativo'\n    END AS tipo_dia,\n    CASE\n      WHEN column_name LIKE '%00h_e_03h%' THEN\n          '00:00:00'\n      WHEN column_name LIKE '%03h_e_12h%' THEN\n          '03:00:00'\n      WHEN column_name LIKE '%12h_e_21h%' THEN\n          '12:00:00'\n      WHEN column_name LIKE '%21h_e_24h%' THEN\n          '21:00:00'\n      WHEN column_name LIKE '%24h_e_03h_diaseguinte%' THEN\n          '24:00:00'\n    END AS faixa_horaria_inicio,\n    CASE\n      WHEN column_name LIKE '%00h_e_03h%' THEN\n          '02:59:59'\n      WHEN column_name LIKE '%03h_e_12h%' THEN\n          '11:59:59'\n      WHEN column_name LIKE '%12h_e_21h%' THEN\n          '20:59:59'\n      WHEN column_name LIKE '%21h_e_24h%' THEN\n          '23:59:59'\n      WHEN column_name LIKE '%24h_e_03h_diaseguinte%' THEN\n          '26:59:59'\n    END AS faixa_horaria_fim,\n    SUM(CASE\n        WHEN column_name LIKE '%partidas%' THEN SAFE_CAST(value AS INT64)\n        ELSE 0\n    END) AS partidas,\n    SUM(CASE\n        WHEN column_name LIKE '%quilometragem%' THEN SAFE_CAST(value AS FLOAT64)\n        ELSE 0\n    END) AS quilometragem\n  FROM dados\n  UNPIVOT (\n    value FOR column_name IN (\n      partidas_entre_00h_e_03h_dias_uteis,\n      quilometragem_entre_00h_e_03h_dias_uteis,\n      partidas_entre_03h_e_12h_dias_uteis,\n      quilometragem_entre_03h_e_12h_dias_uteis,\n      partidas_entre_12h_e_21h_dias_uteis,\n      quilometragem_entre_12h_e_21h_dias_uteis,\n      partidas_entre_21h_e_24h_dias_uteis,\n      quilometragem_entre_21h_e_24h_dias_uteis,\n      partidas_entre_24h_e_03h_diaseguinte_dias_uteis,\n      quilometragem_entre_24h_e_03h_diaseguinte_dias_uteis,\n      partidas_entre_00h_e_03h_sabado,\n      quilometragem_entre_00h_e_03h_sabado,\n      partidas_entre_03h_e_12h_sabado,\n      quilometragem_entre_03h_e_12h_sabado,\n      partidas_entre_12h_e_21h_sabado,\n      quilometragem_entre_12h_e_21h_sabado,\n      partidas_entre_21h_e_24h_sabado,\n      quilometragem_entre_21h_e_24h_sabado,\n      partidas_entre_24h_e_03h_diaseguinte_sabado,\n      quilometragem_entre_24h_e_03h_diaseguinte_sabado,\n      partidas_entre_00h_e_03h_domingo,\n      quilometragem_entre_00h_e_03h_domingo,\n      partidas_entre_03h_e_12h_domingo,\n      quilometragem_entre_03h_e_12h_domingo,\n      partidas_entre_12h_e_21h_domingo,\n      quilometragem_entre_12h_e_21h_domingo,\n      partidas_entre_21h_e_24h_domingo,\n      quilometragem_entre_21h_e_24h_domingo,\n      partidas_entre_24h_e_03h_diaseguinte_domingo,\n      quilometragem_entre_24h_e_03h_diaseguinte_domingo,\n      partidas_entre_00h_e_03h_ponto_facultativo,\n      quilometragem_entre_00h_e_03h_ponto_facultativo,\n      partidas_entre_03h_e_12h_ponto_facultativo,\n      quilometragem_entre_03h_e_12h_ponto_facultativo,\n      partidas_entre_12h_e_21h_ponto_facultativo,\n      quilometragem_entre_12h_e_21h_ponto_facultativo,\n      partidas_entre_21h_e_24h_ponto_facultativo,\n      quilometragem_entre_21h_e_24h_ponto_facultativo,\n      partidas_entre_24h_e_03h_diaseguinte_ponto_facultativo,\n      quilometragem_entre_24h_e_03h_diaseguinte_ponto_facultativo\n    )\n  )\n  GROUP BY 1, 2, 3, 4, 5, 6, 7\n)\nSELECT\n  fi.feed_version,\n  fi.feed_start_date,\n  fi.feed_end_date,\n  d.* EXCEPT(data_versao),\n  '' AS versao_modelo\nFROM\n  dados_agrupados AS d\nLEFT JOIN\n  `rj-smtr`.`gtfs`.`feed_info` AS fi\nON\n  d.data_versao = fi.feed_start_date\nWHERE\n  d.data_versao = '2024-05-03'\n  AND fi.feed_start_date = '2024-05-03'\n", "relation_name": "`rj-smtr`.`planejamento`.`ordem_servico_faixa_horaria`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:32.602370Z", "completed_at": "2024-09-30T15:21:32.608756Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:32.609951Z", "completed_at": "2024-09-30T15:21:32.609959Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01011347770690918, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_servico_gtfs", "compiled": true, "compiled_code": "\n\nWITH ordem_servico AS (\n  SELECT\n    fi.feed_version,\n    SAFE_CAST(os.data_versao AS DATE) as feed_start_date,\n    fi.feed_end_date,\n    SAFE_CAST(tipo_os AS STRING) tipo_os,\n    SAFE_CAST(os.servico AS STRING) servico,\n    SAFE_CAST(JSON_VALUE(os.content, '$.vista') AS STRING) vista,\n    SAFE_CAST(JSON_VALUE(os.content, '$.consorcio') AS STRING) consorcio,\n    SAFE_CAST(JSON_VALUE(os.content, '$.horario_inicio') AS STRING) horario_inicio,\n    SAFE_CAST(JSON_VALUE(os.content, '$.horario_fim') AS STRING) horario_fim,\n    SAFE_CAST(JSON_VALUE(os.content, '$.extensao_ida') AS FLOAT64) extensao_ida,\n    SAFE_CAST(JSON_VALUE(os.content, '$.extensao_volta') AS FLOAT64) extensao_volta,\n    SAFE_CAST(SAFE_CAST(JSON_VALUE(os.content, '$.partidas_ida_du') AS FLOAT64) AS INT64) partidas_ida_du,\n    SAFE_CAST(SAFE_CAST(JSON_VALUE(os.content, '$.partidas_volta_du') AS FLOAT64) AS INT64) partidas_volta_du,\n    SAFE_CAST(JSON_VALUE(os.content, '$.viagens_du') AS FLOAT64) viagens_du,\n    SAFE_CAST(JSON_VALUE(os.content, '$.km_dia_util') AS FLOAT64) km_du,\n    SAFE_CAST(SAFE_CAST(JSON_VALUE(os.content, '$.partidas_ida_pf') AS FLOAT64) AS INT64) partidas_ida_pf,\n    SAFE_CAST(SAFE_CAST(JSON_VALUE(os.content, '$.partidas_volta_pf') AS FLOAT64) AS INT64) partidas_volta_pf,\n    SAFE_CAST(JSON_VALUE(os.content, '$.viagens_pf') AS FLOAT64) viagens_pf,\n    SAFE_CAST(JSON_VALUE(os.content, '$.km_pf') AS FLOAT64) km_pf,\n    SAFE_CAST(SAFE_CAST(JSON_VALUE(os.content, '$.partidas_ida_sabado') AS FLOAT64) AS INT64) partidas_ida_sabado,\n    SAFE_CAST(SAFE_CAST(JSON_VALUE(os.content, '$.partidas_volta_sabado') AS FLOAT64) AS INT64) partidas_volta_sabado,\n    SAFE_CAST(JSON_VALUE(os.content, '$.viagens_sabado') AS FLOAT64) viagens_sabado,\n    SAFE_CAST(JSON_VALUE(os.content, '$.km_sabado') AS FLOAT64) km_sabado,\n    SAFE_CAST(SAFE_CAST(JSON_VALUE(os.content, '$.partidas_ida_domingo') AS FLOAT64) AS INT64) partidas_ida_domingo,\n    SAFE_CAST(SAFE_CAST(JSON_VALUE(os.content, '$.partidas_volta_domingo') AS FLOAT64) AS INT64) partidas_volta_domingo,\n    SAFE_CAST(JSON_VALUE(os.content, '$.viagens_domingo') AS FLOAT64) viagens_domingo,\n    SAFE_CAST(JSON_VALUE(os.content, '$.km_domingo') AS FLOAT64) km_domingo,\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`ordem_servico` os\n  JOIN\n    `rj-smtr`.`gtfs`.`feed_info` fi\n  ON\n    os.data_versao = CAST(fi.feed_start_date AS STRING)\n  WHERE\n      os.data_versao = '2024-05-03'\n      AND fi.feed_start_date = '2024-05-03'\n)\nSELECT *,\n  '' as versao_modelo\nFROM ordem_servico UNPIVOT (\n    (\n      partidas_ida,\n      partidas_volta,\n      viagens_planejadas,\n      distancia_total_planejada\n    ) FOR tipo_dia IN (\n      (\n        partidas_ida_du,\n        partidas_volta_du,\n        viagens_du,\n        km_du\n      ) AS 'Dia \u00datil',\n      (\n        partidas_ida_pf,\n        partidas_volta_pf,\n        viagens_pf,\n        km_pf\n      ) AS 'Ponto Facultativo',\n      (\n        partidas_ida_sabado,\n        partidas_volta_sabado,\n        viagens_sabado,\n        km_sabado\n      ) AS 'Sabado',\n      (\n        partidas_ida_domingo,\n        partidas_volta_domingo,\n        viagens_domingo,\n        km_domingo\n      ) AS 'Domingo'\n    )\n  )", "relation_name": "`rj-smtr`.`gtfs`.`ordem_servico`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:32.613608Z", "completed_at": "2024-09-30T15:21:32.619314Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:32.620553Z", "completed_at": "2024-09-30T15:21:32.620560Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009205818176269531, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_servico_trajeto_alternativo_gtfs", "compiled": true, "compiled_code": "\n\nWITH ordem_servico_trajeto_alternativo AS (\n  SELECT\n    fi.feed_version,\n    SAFE_CAST(o.data_versao AS DATE) feed_start_date,\n    fi.feed_end_date,\n    SAFE_CAST(tipo_os AS STRING) tipo_os,\n    SAFE_CAST(evento AS STRING) evento,\n    SAFE_CAST(o.servico AS STRING) servico,\n    SAFE_CAST(JSON_VALUE(o.content, \"$.ativacao\") AS STRING) ativacao,\n    SAFE_CAST(JSON_VALUE(o.content, \"$.consorcio\") AS STRING) consorcio,\n    SAFE_CAST(JSON_VALUE(o.content, \"$.descricao\") AS STRING) descricao,\n    SAFE_CAST(JSON_VALUE(o.content, \"$.extensao_ida\") AS FLOAT64) extensao_ida,\n    SAFE_CAST(JSON_VALUE(o.content, \"$.extensao_volta\") AS FLOAT64) extensao_volta,\n    SAFE_CAST(JSON_VALUE(o.content, \"$.horario_inicio\") AS STRING) horario_inicio,\n    SAFE_CAST(JSON_VALUE(o.content, \"$.horario_fim\") AS STRING) horario_fim,\n    SAFE_CAST(JSON_VALUE(o.content, \"$.vista\") AS STRING) vista,\n  FROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`ordem_servico_trajeto_alternativo` O\n  LEFT JOIN\n    `rj-smtr`.`gtfs`.`feed_info` fi\n  ON\n    o.data_versao = CAST(fi.feed_start_date AS STRING)\n  WHERE\n      o.data_versao = \"2024-05-03\"\n      AND fi.feed_start_date = \"2024-05-03\"\n)\n\nSELECT\n  feed_version,\n  feed_start_date,\n  feed_end_date,\n  tipo_os,\n  servico,\n  consorcio,\n  vista,\n  ativacao,\n  descricao,\n  CASE\n    WHEN evento LIKE '[%]' THEN LOWER(evento)\n    ELSE REGEXP_REPLACE(LOWER(evento), r\"([a-z\u00e1\u00e9\u00ed\u00f3\u00fa\u00f1\u00fc\u00e7]+)\", r\"[\\1]\")\n  END AS evento,\n  extensao_ida/1000 AS extensao_ida,\n  extensao_volta/1000 AS extensao_volta,\n  horario_inicio AS inicio_periodo,\n  horario_fim AS fim_periodo,\n  '' AS versao_modelo\nFROM\n  ordem_servico_trajeto_alternativo", "relation_name": "`rj-smtr`.`gtfs`.`ordem_servico_trajeto_alternativo`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:32.624222Z", "completed_at": "2024-09-30T15:21:34.886862Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:34.888895Z", "completed_at": "2024-09-30T15:21:34.888909Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.267360210418701, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.routes_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nSELECT\n  fi.feed_version,\n  SAFE_CAST(r.data_versao AS DATE) feed_start_date,\n  fi.feed_end_date,\n  SAFE_CAST(r.route_id AS STRING) route_id,\n  SAFE_CAST(JSON_VALUE(r.content, '$.agency_id') AS STRING) agency_id,\n  SAFE_CAST(JSON_VALUE(r.content, '$.route_short_name') AS STRING) route_short_name,\n  SAFE_CAST(JSON_VALUE(r.content, '$.route_long_name') AS STRING) route_long_name,\n  SAFE_CAST(JSON_VALUE(r.content, '$.route_desc') AS STRING) route_desc,\n  SAFE_CAST(JSON_VALUE(r.content, '$.route_type') AS STRING) route_type,\n  SAFE_CAST(JSON_VALUE(r.content, '$.route_url') AS STRING) route_url,\n  SAFE_CAST(JSON_VALUE(r.content, '$.route_color') AS STRING) route_color,\n  SAFE_CAST(JSON_VALUE(r.content, '$.route_text_color') AS STRING) route_text_color,\n  SAFE_CAST(JSON_VALUE(r.content, '$.route_sort_order') AS INT64) route_sort_order,\n  SAFE_CAST(JSON_VALUE(r.content, '$.continuous_pickup') AS STRING) continuous_pickup,\n  SAFE_CAST(JSON_VALUE(r.content, '$.continuous_drop_off') AS STRING) continuous_drop_off,\n  SAFE_CAST(JSON_VALUE(r.content, '$.network_id') AS STRING) network_id,\n  '' AS versao_modelo\n FROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`routes` r\nJOIN\n  `rj-smtr`.`gtfs`.`feed_info` fi\nON\n  r.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n    r.data_versao IN ('2024-04-15', '2024-05-03')\n    AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`routes`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:34.894073Z", "completed_at": "2024-09-30T15:21:37.144491Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:37.153266Z", "completed_at": "2024-09-30T15:21:37.153317Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.266960382461548, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.shapes_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nSELECT\n  fi.feed_version,\n  SAFE_CAST(s.data_versao AS DATE) as feed_start_date,\n  fi.feed_end_date,\n  SAFE_CAST(s.shape_id AS STRING) shape_id,\n  SAFE_CAST(JSON_VALUE(s.content, '$.shape_pt_lat') AS FLOAT64) shape_pt_lat,\n  SAFE_CAST(JSON_VALUE(s.content, '$.shape_pt_lon') AS FLOAT64) shape_pt_lon,\n  SAFE_CAST(s.shape_pt_sequence AS INT64) shape_pt_sequence,\n  SAFE_CAST(JSON_VALUE(s.content, '$.shape_dist_traveled') AS FLOAT64) shape_dist_traveled,\n  '' AS versao_modelo\nFROM\n  `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`shapes` s\nJOIN\n  `rj-smtr`.`gtfs`.`feed_info` fi\nON\n  s.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n    s.data_versao IN ('2024-04-15', '2024-05-03')\n    AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`shapes`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:37.171803Z", "completed_at": "2024-09-30T15:21:39.802367Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:39.810250Z", "completed_at": "2024-09-30T15:21:39.810291Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.6488516330718994, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.stop_times_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nSELECT\n    fi.feed_version,\n    SAFE_CAST(st.data_versao AS DATE) as feed_start_date,\n    fi.feed_end_date,\n    SAFE_CAST(st.trip_id AS STRING) trip_id,\n    SAFE_CAST(JSON_VALUE(st.content, '$.arrival_time') AS STRING) arrival_time,\n    SAFE_CAST(JSON_VALUE(st.content, '$.departure_time') AS DATETIME) departure_time,\n    SAFE_CAST(JSON_VALUE(st.content, '$.stop_id') AS STRING) stop_id,\n    SAFE_CAST(st.stop_sequence AS INT64) stop_sequence,\n    SAFE_CAST(JSON_VALUE(st.content, '$.stop_headsign') AS STRING) stop_headsign,\n    SAFE_CAST(JSON_VALUE(st.content, '$.pickup_type') AS STRING) pickup_type,\n    SAFE_CAST(JSON_VALUE(st.content, '$.drop_off_type') AS STRING) drop_off_type,\n    SAFE_CAST(JSON_VALUE(st.content, '$.continuous_pickup') AS STRING) continuous_pickup,\n    SAFE_CAST(JSON_VALUE(st.content, '$.continuous_drop_off') AS STRING) continuous_drop_off,\n    SAFE_CAST(JSON_VALUE(st.content, '$.shape_dist_traveled') AS FLOAT64) shape_dist_traveled,\n    SAFE_CAST(JSON_VALUE(st.content, '$.timepoint') AS STRING) timepoint,\n    '' AS versao_modelo\nFROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`stop_times` st\nJOIN\n    `rj-smtr`.`gtfs`.`feed_info` fi\nON\n    st.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n        st.data_versao IN ('2024-04-15', '2024-05-03')\n        AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`stop_times`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:39.825117Z", "completed_at": "2024-09-30T15:21:42.465308Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:42.467938Z", "completed_at": "2024-09-30T15:21:42.467951Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.648071050643921, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.stops_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nSELECT\n    fi.feed_version,\n    SAFE_CAST(s.data_versao AS DATE) as feed_start_date,\n    fi.feed_end_date,\n    SAFE_CAST(s.stop_id AS STRING) stop_id,\n    SAFE_CAST(JSON_VALUE(s.content, '$.stop_code') AS STRING) stop_code,\n    SAFE_CAST(JSON_VALUE(s.content, '$.stop_name') AS STRING) stop_name,\n    SAFE_CAST(JSON_VALUE(s.content, '$.tts_stop_name') AS STRING) tts_stop_name,\n    SAFE_CAST(JSON_VALUE(s.content, '$.stop_desc') AS STRING) stop_desc,\n    SAFE_CAST(JSON_VALUE(s.content, '$.stop_lat') AS FLOAT64) stop_lat,\n    SAFE_CAST(JSON_VALUE(s.content, '$.stop_lon') AS FLOAT64) stop_lon,\n    SAFE_CAST(JSON_VALUE(s.content, '$.zone_id') AS STRING) zone_id,\n    SAFE_CAST(JSON_VALUE(s.content, '$.stop_url') AS STRING) stop_url,\n    SAFE_CAST(SAFE_CAST(SAFE_CAST(JSON_VALUE(s.content, '$.location_type') AS FLOAT64) AS INT64) AS STRING) location_type,\n    SAFE_CAST(JSON_VALUE(s.content, '$.parent_station') AS STRING) parent_station,\n    SAFE_CAST(JSON_VALUE(s.content, '$.stop_timezone') AS STRING) stop_timezone,\n    SAFE_CAST(JSON_VALUE(s.content, '$.wheelchair_boarding') AS STRING) wheelchair_boarding,\n    SAFE_CAST(JSON_VALUE(s.content, '$.level_id') AS STRING) level_id,\n    SAFE_CAST(JSON_VALUE(s.content, '$.platform_code') AS STRING) platform_code,\n    '' AS versao_modelo\nFROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`stops` s\nJOIN\n    `rj-smtr`.`gtfs`.`feed_info` fi\nON\n    s.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n        s.data_versao IN ('2024-04-15', '2024-05-03')\n        AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`stops`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:42.473574Z", "completed_at": "2024-09-30T15:21:44.722135Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:44.727905Z", "completed_at": "2024-09-30T15:21:44.727956Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.261935234069824, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.trips_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nSELECT\n    fi.feed_version,\n    SAFE_CAST(t.data_versao AS DATE) as feed_start_date,\n    fi.feed_end_date,\n    SAFE_CAST(JSON_VALUE(t.content, '$.route_id') AS STRING) route_id,\n    SAFE_CAST(JSON_VALUE(t.content, '$.service_id') AS STRING) service_id,\n    SAFE_CAST(t.trip_id AS STRING) trip_id,\n    SAFE_CAST(JSON_VALUE(t.content, '$.trip_headsign') AS STRING) trip_headsign,\n    SAFE_CAST(JSON_VALUE(t.content, '$.trip_short_name') AS STRING) trip_short_name,\n    SAFE_CAST(JSON_VALUE(t.content, '$.direction_id') AS STRING) direction_id,\n    SAFE_CAST(JSON_VALUE(t.content, '$.block_id') AS STRING) block_id,\n    SAFE_CAST(JSON_VALUE(t.content, '$.shape_id') AS STRING) shape_id,\n    SAFE_CAST(JSON_VALUE(t.content, '$.wheelchair_accessible') AS STRING) wheelchair_accessible,\n    SAFE_CAST(JSON_VALUE(t.content, '$.bikes_allowed') AS STRING) bikes_allowed,\n    '' as versao_modelo\nFROM\n    `rj-smtr-staging`.`br_rj_riodejaneiro_gtfs_staging`.`trips` t\nJOIN\n    `rj-smtr`.`gtfs`.`feed_info` fi\nON\n    t.data_versao = CAST(fi.feed_start_date AS STRING)\nWHERE\n        t.data_versao IN ('2024-04-15', '2024-05-03')\n        AND fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`trips`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:44.746448Z", "completed_at": "2024-09-30T15:21:44.766765Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:44.768467Z", "completed_at": "2024-09-30T15:21:44.768479Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.029934167861938477, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.frota_determinada_desaninhada", "compiled": true, "compiled_code": "select\n    data_versao,\n    json_value(content, '$.IDFrotaDeterminada') IDFrotaDeterminada,\n    json_value(content, '$.TipoOnibusID') TipoOnibusID,\n    SAFE_CAST(json_value(content, '$.FrotaDeterminada') AS INT64) FrotaDeterminada,\n    SAFE_CAST(json_value(content, '$.FrotaServico') AS INT64) FrotaServico,\n    json_value(content, '$.dataInicioVigencia') dataInicioVigencia,\n    json_value(content, '$.dataFimVigencia') dataFimVigencia,\n    json_value(content, '$.legislacaoInicioVigencia') legislacaoInicioVigencia,\n    json_value(content, '$.legislacaoFimVigencia') legislacaoFimVigencia,\n    json_value(content, '$.route_id') route_id\nFROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`frota_determinada`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`frota_determinada_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:44.773176Z", "completed_at": "2024-09-30T15:21:44.777203Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:44.778711Z", "completed_at": "2024-09-30T15:21:44.778722Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008234262466430664, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.linhas_desaninhada", "compiled": true, "compiled_code": "SELECT\n  linha_id,\n  JSON_VALUE(content, \"$.agency_id\") agency_id,\n  JSON_VALUE(content, \"$.sigla\") sigla,\n  JSON_VALUE(content, \"$.idModalSmtr\") id_modal_smtr,\n  JSON_VALUE(content, \"$.TipoLinha\") tipo_linha,\n  JSON_VALUE(content, \"$.NomeLinha\") nome_linha,\n  JSON_VALUE(content, \"$.SiglaCompleta\") sigla_completa,\n  JSON_VALUE(content, \"$.NumeroServicos\") numero_servicos,\n  JSON_VALUE(content, \"$.ativa\") ativa,\n  JSON_VALUE(content, \"$.FrotaDeterminada\") frota_determinada,\n  JSON_VALUE(content, \"$.LegisFrotaDeterminada\") legis_frota_determinada,\n  JSON_VALUE(content, \"$.FrotaOperante\") frota_operante,\n  JSON_VALUE(content, \"$.id\") id,\n  JSON_VALUE(content, \"$.Apresentacao\") apresentacao,\n  JSON_VALUE(content, \"$.agency_name\") agency_name,\n  DATE(data_versao) data_versao\nFROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`linhas`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`linhas_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:44.782519Z", "completed_at": "2024-09-30T15:21:44.801811Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:44.803402Z", "completed_at": "2024-09-30T15:21:44.803423Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.023670196533203125, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ed_metadado_coluna", "compiled": true, "compiled_code": "\n  \n  \n  \n    \n  \n    \n  \n    \n  \n    \n  \n    \n  \n    \n  \n    \n  \n    \n  \n    \n  \n    \n  \n    \n  \n    \n  \n\n\nSELECT\n  *\nFROM\n  `rj-smtr`.`catalogo`.`metadado_coluna`\nWHERE\n  \n    (dataset_id = \"br_rj_riodejaneiro_bilhetagem\"\n    AND table_id = \"gps_validador\")\n  \n    OR (dataset_id = \"br_rj_riodejaneiro_bilhetagem\"\n    AND table_id = \"gps_validador_van\")\n  \n    OR (dataset_id = \"br_rj_riodejaneiro_bilhetagem_staging\"\n    AND table_id = \"cliente\")\n  \n    OR (dataset_id = \"br_rj_riodejaneiro_veiculos\"\n    AND table_id = \"gps_sppo_15_minutos\")\n  \n    OR (dataset_id = \"br_rj_riodejaneiro_veiculos\"\n    AND table_id = \"gps_sppo\")\n  \n    OR (dataset_id = \"br_rj_riodejaneiro_veiculos\"\n    AND table_id = \"gps_brt\")\n  \n    OR (dataset_id = \"br_rj_riodejaneiro_onibus_gps_zirix\"\n    AND table_id = \"gps_sppo\")\n  \n    OR (dataset_id = \"gtfs\"\n    AND table_id = \"shapes\")\n  \n    OR (dataset_id = \"gtfs\"\n    AND table_id = \"stops\")\n  \n    OR (dataset_id = \"gtfs\"\n    AND table_id = \"shapes_geom\")\n  \n    OR (dataset_id = \"cadastro\"\n    AND table_id = \"servicos\")\n  \n    OR (dataset_id = \"cadastro\"\n    AND table_id = \"operadoras\")\n  \n\n  OR (dataset_id = \"br_rj_riodejaneiro_stpl_gps\"\n    AND table_id = \"registros\")", "relation_name": "`rj-smtr`.`catalogo`.`ed_metadado_coluna`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:44.809349Z", "completed_at": "2024-09-30T15:21:44.814147Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:44.816335Z", "completed_at": "2024-09-30T15:21:44.816350Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010790824890136719, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.my_second_dbt_model", "compiled": true, "compiled_code": "-- Use the `ref` function to select from other models\n\nselect *\nfrom `rj-smtr`.`dbt`.`my_first_dbt_model`\nwhere id = 1", "relation_name": "`rj-smtr`.`dbt`.`my_second_dbt_model`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:44.821565Z", "completed_at": "2024-09-30T15:21:44.831989Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:44.833534Z", "completed_at": "2024-09-30T15:21:44.833545Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.014693737030029297, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_my_first_dbt_model_id.5fb22c2710", "compiled": true, "compiled_code": "\nSELECT\n    id\nFROM\n    `rj-smtr`.`dbt`.`my_first_dbt_model`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`dbt`.`my_first_dbt_model`)\nAND\n    id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:44.837715Z", "completed_at": "2024-09-30T15:21:44.846163Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:44.847562Z", "completed_at": "2024-09-30T15:21:44.847573Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012330055236816406, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_my_first_dbt_model_id.16e066b321", "compiled": true, "compiled_code": "\n    \n    \n\nwith dbt_test__target as (\n\n  select id as unique_field\n  from `rj-smtr`.`dbt`.`my_first_dbt_model`\n  where id is not null\n\n)\n\nselect\n    unique_field,\n    count(*) as n_records\n\nfrom dbt_test__target\ngroup by unique_field\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:44.851484Z", "completed_at": "2024-09-30T15:21:44.855188Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:44.856612Z", "completed_at": "2024-09-30T15:21:44.856621Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007518768310546875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.routes_desaninhada", "compiled": true, "compiled_code": "with desaninhada as (\n    select\n    data_versao,\n    json_value(content, '$.agency_id') agency_id,\n    json_value(content, '$.route_short_name') route_short_name,\n    json_value(content, '$.route_long_name') route_long_name,\n    json_value(content, '$.route_desc') route_desc,\n    json_value(content, '$.route_type') route_type,\n    json_value(content, '$.route_url') route_url,\n    json_value(content, '$.route_color') route_color,\n    json_value(content, '$.route_text_color') route_text_color,\n    json_value(content, '$.ATIVA') ATIVA,\n    json_value(content, '$.ATUALIZADO') ATUALIZADO,\n    json_value(content, '$.Descricao') Descricao,\n    json_value(content, '$.idModalSmtr') idModalSmtr,\n    json_value(content, '$.linha_id') linha_id,\n    json_value(content, '$.brs') brs,\n    json_value(content, '$.IDTipoServico') IDTipoServico,\n    json_value(content, '$.IDVariacaoServico') IDVariacaoServico,\n    json_value(content, '$.origem') origem,\n    json_value(content, '$.destino') destino,\n    json_value(content, '$.ClassificacaoEspacial') ClassificacaoEspacial,\n    json_value(content, '$.ClassificacaoHierarquica') ClassificacaoHierarquica,\n    json_value(content, '$.InicioVigencia') InicioVigencia,\n    json_value(content, '$.LegisInicioVigencia') LegisInicioVigencia,\n    json_value(content, '$.fimVigencia') fimVigencia,\n    json_value(content, '$.LegisfimVigencia') LegisfimVigencia,\n    json_value(content, '$.FlagVigente') FlagVigente,\n    json_value(content, '$.FrotaDeterminada') FrotaDeterminada,\n    json_value(content, '$.LegisFrota') LegisFrota,\n    json_value(content, '$.FrotaServico') FrotaServico,\n    json_value(content, '$.FrotaOperante') FrotaOperante,\n    json_value(content, '$.Observacoes') Observacoes,\n    json_value(content, '$.IDParadaOrigem') IDParadaOrigem,\n    json_value(content, '$.SiglaServico') SiglaServico,\n    json_value(content, '$.IDParadaDestino') IDParadaDestino,\n    json_value(content, '$.route_id') route_id,\n    json_value(content, '$.id') id,\n    json_value(content, '$.agency_name') agency_name,\n    json_value(content, '$.Via') Via,\n    json_value(content, '$.Vista') Vista,\n    json_value(content, '$.Complemento') Complemento,\n    json_value(content,'$.OLD_routes_id') old_route_id\nfrom `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes`\n),\nultimas_versoes as (\n    select\n        *\n    from desaninhada\n    where DATE(fimVigencia) >= DATE(data_versao) or fimVigencia is null\n    order by route_id, fimVigencia\n)\nselect\n    *\nfrom ultimas_versoes", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:44.860595Z", "completed_at": "2024-09-30T15:21:49.661501Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:49.663199Z", "completed_at": "2024-09-30T15:21:49.663224Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.805285930633545, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_infracao", "compiled": true, "compiled_code": "\n  \nWITH\n  infracao AS (\n    SELECT\n      * EXCEPT(data),\n      SAFE_CAST(data AS DATE) AS data\n    FROM\n      `rj-smtr`.`veiculo_staging`.`sppo_infracao` as t\n    WHERE\n      DATE(data) = DATE(\"2023-03-10\")\n  ),\n  infracao_rn AS (\n    SELECT\n      *,\n      ROW_NUMBER() OVER (PARTITION BY data, id_auto_infracao) rn\n    FROM\n      infracao\n  )\nSELECT\n  * EXCEPT(rn)\nFROM\n  infracao_rn\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`veiculo`.`sppo_infracao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:49.667559Z", "completed_at": "2024-09-30T15:21:49.673980Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:49.675724Z", "completed_at": "2024-09-30T15:21:49.675735Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011328458786010742, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_licenciamento_solicitacao", "compiled": true, "compiled_code": "\n\nSELECT\n   *\n FROM\n     `rj-smtr`.`veiculo_staging`.`sppo_licenciamento_solicitacao` as t", "relation_name": "`rj-smtr`.`veiculo`.`sppo_licenciamento_solicitacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:49.681151Z", "completed_at": "2024-09-30T15:21:51.559091Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.561820Z", "completed_at": "2024-09-30T15:21:51.561845Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 1.8847787380218506, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_registro_agente_verao", "compiled": true, "compiled_code": "\n\n\n  \n\n\n\nSELECT\n  * EXCEPT(rn)\nFROM\n  (\n    SELECT\n      *,\n      ROW_NUMBER() OVER(PARTITION BY id_registro ORDER BY datetime_captura DESC) AS rn\n    FROM\n      `rj-smtr`.`veiculo_staging`.`sppo_registro_agente_verao`\n    WHERE\n      data = DATE('2024-09-22')\n      AND validacao = TRUE\n  )\nWHERE rn = 1", "relation_name": "`rj-smtr`.`veiculo`.`sppo_registro_agente_verao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.570150Z", "completed_at": "2024-09-30T15:21:51.585203Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.586796Z", "completed_at": "2024-09-30T15:21:51.586810Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.02087855339050293, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_aux_registros_realocacao", "compiled": true, "compiled_code": "\n\n\n\n-- 1. Filtra realoca\u00e7\u00f5es v\u00e1lidas dentro do intervalo de GPS avaliado\nwith realocacao as (\n  select\n    * except(datetime_saida),\n    case\n      when datetime_saida is null then datetime_operacao\n      else datetime_saida\n    end as datetime_saida,\n  from\n    `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_realocacao`\n  where\n    -- Realoca\u00e7\u00e3o deve acontecer ap\u00f3s o registro de GPS e at\u00e9 1 hora depois\n    datetime_diff(datetime_operacao, datetime_entrada, minute) between 0 and 60\n    and data between DATE(\"2022-01-01T00:00:00\")\n    and DATE(datetime_add(\"2022-01-01T01:00:00\", interval 1 hour))\n    and datetime_operacao between datetime(\"2022-01-01T00:00:00\")\n    and datetime_add(\"2022-01-01T01:00:00\", interval 1 hour)),\n-- 2. Altera registros de GPS com servicos realocados\ngps as (\n  select\n    ordem,\n    timestamp_gps,\n    linha,\n    data,\n    hora\n  from `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_registros`\n  where\n    data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    and timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <= \"2022-01-01T01:00:00\"\n),\ncombinacao as (\n  select\n    r.id_veiculo,\n    g.timestamp_gps,\n    g.linha as servico_gps,\n    r.servico as servico_realocado,\n    r.datetime_operacao as datetime_realocacao,\n    g.data,\n    g.hora\n  from gps g\n  inner join realocacao r\n  on\n    g.ordem = r.id_veiculo\n    and g.linha != r.servico\n    and g.timestamp_gps between r.datetime_entrada and r.datetime_saida\n)\n-- Filtra realocacao mais recente para cada timestamp\nselect\n  * except(rn)\nfrom (\n  select\n    *,\n    row_number() over (partition by id_veiculo, timestamp_gps order by datetime_realocacao desc) as rn\n  from combinacao\n)\nwhere rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_realocacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.591440Z", "completed_at": "2024-09-30T15:21:51.598506Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.599850Z", "completed_at": "2024-09-30T15:21:51.599862Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011089563369750977, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_aux_registros_realocacao_zirix", "compiled": true, "compiled_code": "\n\n-- 1. Filtra realoca\u00e7\u00f5es v\u00e1lidas dentro do intervalo de GPS avaliado\nwith realocacao as (\n  select\n    * except(datetime_saida),\n    case\n      when datetime_saida is null then datetime_operacao\n      else datetime_saida\n    end as datetime_saida,\n  from\n    `rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_realocacao`\n  where\n    -- Realoca\u00e7\u00e3o deve acontecer ap\u00f3s o registro de GPS e at\u00e9 1 hora depois\n        datetime_diff(datetime_operacao, datetime_entrada, minute) between 0 and 60\n    and\n        data between DATE(\"2022-01-01T00:00:00\")\n        and DATE(datetime_add(\"2022-01-01T01:00:00\", interval 1\n        hour))\n    and\n        datetime_operacao between datetime(\"2022-01-01T00:00:00\")\n            and datetime_add(\"2022-01-01T01:00:00\", interval 1 hour)),\n-- 2. Altera registros de GPS com servicos realocados\ngps as (\n  select\n    ordem,\n    timestamp_gps,\n    linha,\n    data,\n    hora\n  from `rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_registros`\n  where\n    data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    and timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <= \"2022-01-01T01:00:00\"\n),\ncombinacao as (\n  select\n    r.id_veiculo,\n    g.timestamp_gps,\n    g.linha as servico_gps,\n    r.servico as servico_realocado,\n    r.datetime_operacao as datetime_realocacao,\n    g.data,\n    g.hora\n  from gps g\n  inner join realocacao r\n  on\n    g.ordem = r.id_veiculo\n    and g.linha != r.servico\n    and g.timestamp_gps between r.datetime_entrada and r.datetime_saida\n)\n-- Filtra realocacao mais recente para cada timestamp\nselect\n  * except(rn)\nfrom (\n  select\n    *,\n    row_number() over (partition by id_veiculo, timestamp_gps order by datetime_realocacao desc) as rn\n  from combinacao\n)\nwhere rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_aux_registros_realocacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.616332Z", "completed_at": "2024-09-30T15:21:51.622138Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.623524Z", "completed_at": "2024-09-30T15:21:51.623538Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009953022003173828, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.aux_retorno_ordem_pagamento", "compiled": true, "compiled_code": "\n\nSELECT DISTINCT\n  dataOrdem AS data_ordem,\n  DATE(dataVencimento) AS data_pagamento,\n  idConsorcio AS id_consorcio,\n  idOperadora AS id_operadora,\n  CONCAT(dataOrdem, idConsorcio, idOperadora) AS unique_id,\n  valorRealEfetivado AS valor_pago\nFROM\n  `rj-smtr`.`controle_financeiro_staging`.`arquivo_retorno`\nWHERE\n  isPago = TRUE\n\n  AND DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n", "relation_name": "`rj-smtr`.`controle_financeiro_staging`.`aux_retorno_ordem_pagamento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.628114Z", "completed_at": "2024-09-30T15:21:51.635542Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.637655Z", "completed_at": "2024-09-30T15:21:51.637673Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013041496276855469, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gratuidade_aux", "compiled": true, "compiled_code": "\n\n\n\n\n\nWITH gratuidade_complete_partitions AS (\n    SELECT\n        CAST(CAST(cd_cliente AS FLOAT64) AS INT64) AS id_cliente,\n        id AS id_gratuidade,\n        tipo_gratuidade,\n        data_inclusao AS data_inicio_validade,\n        timestamp_captura\n    FROM\n        `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`gratuidade`\n),\ngratuidade_deduplicada AS (\n    SELECT\n        * EXCEPT(rn)\n    FROM\n        (\n            SELECT\n                *,\n                ROW_NUMBER() OVER (PARTITION BY id_gratuidade ORDER BY timestamp_captura DESC) AS rn\n            FROM\n                gratuidade_complete_partitions\n        )\n    WHERE\n        rn = 1\n)\nSELECT\n    id_cliente,\n    id_gratuidade,\n    tipo_gratuidade,\n    data_inicio_validade,\n    LEAD(data_inicio_validade) OVER (PARTITION BY id_cliente ORDER BY data_inicio_validade) AS data_fim_validade,\n    timestamp_captura\nFROM\n    gratuidade_deduplicada", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`gratuidade_aux`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.644648Z", "completed_at": "2024-09-30T15:21:51.653405Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.654908Z", "completed_at": "2024-09-30T15:21:51.654920Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.014038324356079102, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.consorcios", "compiled": true, "compiled_code": "\n\nWITH stu AS (\n  SELECT\n      perm_autor AS id_consorcio,\n      cnpj,\n      processo,\n      data_registro,\n      razao_social,\n      CASE\n        \n          WHEN perm_autor = '221000014' THEN '6'\n        \n          WHEN perm_autor = '221000023' THEN '4'\n        \n          WHEN perm_autor = '221000032' THEN '3'\n        \n          WHEN perm_autor = '221000041' THEN '5'\n        \n          WHEN perm_autor = '221000050' THEN NULL\n        \n          WHEN perm_autor = '229000010' THEN '1'\n        \n      END AS cd_consorcio_jae\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_stu`.`operadora_empresa` AS stu\n  WHERE\n    perm_autor IN ('221000014', '221000023', '221000032', '221000041', '221000050', '229000010')\n), consorcio AS (\n  SELECT\n    COALESCE(s.id_consorcio, j.cd_consorcio) AS id_consorcio,\n    CASE\n      WHEN s.id_consorcio = '221000050' THEN \"Cons\u00f3rcio BRT\"\n      ELSE j.nm_consorcio\n    END AS consorcio,\n    s.cnpj,\n    s.razao_social,\n    s.id_consorcio AS id_consorcio_stu,\n    j.cd_consorcio AS id_consorcio_jae,\n    s.processo AS id_processo\n  FROM `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`consorcio` AS j\n  FULL OUTER JOIN\n    stu AS s\n  ON\n    j.cd_consorcio = s.cd_consorcio_jae\n)\nSELECT\n  c.id_consorcio,\n  c.consorcio,\n  m.modo,\n  c.cnpj,\n  c.razao_social,\n  c.id_consorcio_stu,\n  c.id_consorcio_jae,\n  c.id_processo\nFROM consorcio c\nLEFT JOIN\n  `rj-smtr`.`cadastro_staging`.`consorcio_modo` AS cm\nUSING (id_consorcio)\nLEFT JOIN\n  `rj-smtr`.`cadastro`.`modos` AS m\nON\n  m.id_modo = cm.id_modo\n  AND cm.fonte_id_modo = m.fonte", "relation_name": "`rj-smtr`.`cadastro`.`consorcios`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.659548Z", "completed_at": "2024-09-30T15:21:51.666831Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.668836Z", "completed_at": "2024-09-30T15:21:51.668849Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012095928192138672, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.operadoras", "compiled": true, "compiled_code": "\n\nWITH operadora_jae AS (\n  SELECT\n    ot.cd_operadora_transporte,\n    ot.cd_cliente,\n    m.modo,\n    ot.cd_tipo_modal,\n    ot.ds_tipo_modal AS modo_jae,\n    -- STU considera BRT como \u00d4nibus\n    CASE\n      WHEN ot.cd_tipo_modal = '3' THEN '\u00d4nibus'\n      ELSE m.modo\n    END AS modo_join,\n    ot.in_situacao_atividade,\n    CASE\n      WHEN c.in_tipo_pessoa_fisica_juridica = 'F' THEN 'CPF'\n      WHEN c.in_tipo_pessoa_fisica_juridica = 'J' THEN 'CNPJ'\n    END AS tipo_documento,\n    c.nr_documento,\n    c.nm_cliente,\n    cb.cd_agencia,\n    cb.cd_tipo_conta,\n    cb.nm_banco,\n    cb.nr_banco,\n    cb.nr_conta\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`operadora_transporte` AS ot\n  JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`cliente` AS c\n  ON\n    ot.cd_cliente = c.cd_cliente\n  LEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`conta_bancaria` AS cb\n  ON\n    ot.cd_cliente = cb.cd_cliente\n  JOIN\n    `rj-smtr`.`cadastro`.`modos` m\n  ON\n    ot.cd_tipo_modal = m.id_modo AND m.fonte = \"jae\"\n),\nstu_pessoa_juridica AS (\n  SELECT\n    perm_autor,\n    cnpj AS documento,\n    processo,\n    id_modo,\n    modo AS modo_stu,\n    tipo_permissao,\n    data_registro,\n    razao_social AS nome_operadora,\n    \"CNPJ\" AS tipo_documento\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_stu`.`operadora_empresa`\n  WHERE perm_autor NOT IN ('221000014', '221000023', '221000032', '221000041', '221000050')\n),\nstu_pessoa_fisica AS (\n  SELECT\n    perm_autor,\n    cpf AS documento,\n    processo,\n    id_modo,\n    modo AS modo_stu,\n    tipo_permissao,\n    data_registro,\n    nome AS nome_operadora,\n    \"CPF\" AS tipo_documento\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_stu`.`operadora_pessoa_fisica`\n),\nstu AS (\n  SELECT\n    s.*,\n    m.modo\n  FROM (\n    SELECT\n      *\n    FROM\n      stu_pessoa_juridica\n\n    UNION ALL\n\n    SELECT\n      *\n    FROM\n      stu_pessoa_fisica\n  ) s\n  JOIN\n    `rj-smtr`.`cadastro`.`modos` m\n  ON\n    s.id_modo = m.id_modo AND m.fonte = \"stu\"\n),\ncadastro AS (\n  SELECT\n    COALESCE(s.perm_autor, j.cd_operadora_transporte) AS id_operadora,\n    UPPER(REGEXP_REPLACE(NORMALIZE(COALESCE(s.nome_operadora, j.nm_cliente), NFD), r\"\\pM\", '')) AS operadora_completo,\n    s.tipo_permissao AS tipo_operadora,\n    COALESCE(j.modo, s.modo) AS modo,\n    s.modo_stu,\n    j.modo_jae,\n    s.processo AS id_processo,\n    s.data_registro AS data_processo,\n    COALESCE(s.documento, j.nr_documento) AS documento,\n    COALESCE(s.tipo_documento, j.tipo_documento) AS tipo_documento,\n    s.perm_autor AS id_operadora_stu,\n    j.cd_operadora_transporte AS id_operadora_jae,\n    SAFE_CAST(j.in_situacao_atividade AS BOOLEAN) AS indicador_operador_ativo_jae,\n    j.cd_agencia AS agencia,\n    j.cd_tipo_conta AS tipo_conta,\n    j.nm_banco AS banco,\n    LPAD(j.nr_banco, 3, '0') AS codigo_banco,\n    j.nr_conta AS conta\n  FROM\n    stu AS s\n  FULL OUTER JOIN\n    operadora_jae AS j\n  ON\n    s.documento = j.nr_documento\n    AND s.modo = j.modo_join\n)\nSELECT\n  id_operadora,\n  modo,\n  modo_stu,\n  modo_jae,\n  CASE\n    WHEN tipo_documento = \"CNPJ\" THEN operadora_completo\n    ELSE REGEXP_REPLACE(operadora_completo, '[^ ]', '*')\n  END AS operadora,\n  operadora_completo,\n  tipo_operadora,\n  tipo_documento,\n  documento,\n  codigo_banco,\n  banco,\n  agencia,\n  tipo_conta,\n  conta,\n  id_operadora_stu,\n  id_operadora_jae,\n  id_processo,\n  data_processo,\n  indicador_operador_ativo_jae\nFROM\n  cadastro\nWHERE\n  modo NOT IN (\"Escolar\", \"T\u00e1xi\", \"TEC\")", "relation_name": "`rj-smtr`.`cadastro`.`operadoras`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.673625Z", "completed_at": "2024-09-30T15:21:51.683087Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.684404Z", "completed_at": "2024-09-30T15:21:51.684414Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013825654983520508, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.matriz_integracao", "compiled": true, "compiled_code": "\n\nWITH matriz_melt AS (\n  SELECT\n    i.id,\n    im.sequencia_integracao,\n    im.id_tipo_modal,\n    im.perc_rateio,\n    i.dt_inicio_validade,\n    i.dt_fim_validade\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`percentual_rateio_integracao` i,\n    -- Transforma colunas com os dados de cada modo da integra\u00e7\u00e3o em linhas diferentes\n    UNNEST(\n      [\n        \n          STRUCT(\n            \n              id_tipo_modal_origem AS id_tipo_modal,\n            \n              perc_rateio_origem AS perc_rateio,\n            \n            0 AS sequencia_integracao\n          ),\n        \n          STRUCT(\n            \n              id_tipo_modal_integracao_t1 AS id_tipo_modal,\n            \n              perc_rateio_integracao_t1 AS perc_rateio,\n            \n            1 AS sequencia_integracao\n          ),\n        \n          STRUCT(\n            \n              id_tipo_modal_integracao_t2 AS id_tipo_modal,\n            \n              perc_rateio_integracao_t2 AS perc_rateio,\n            \n            2 AS sequencia_integracao\n          ),\n        \n          STRUCT(\n            \n              id_tipo_modal_integracao_t3 AS id_tipo_modal,\n            \n              perc_rateio_integracao_t3 AS perc_rateio,\n            \n            3 AS sequencia_integracao\n          ),\n        \n          STRUCT(\n            \n              id_tipo_modal_integracao_t4 AS id_tipo_modal,\n            \n              perc_rateio_integracao_t4 AS perc_rateio,\n            \n            4 AS sequencia_integracao\n          )\n        \n      ]\n    ) im\n)\nSELECT\n  i.id AS id_matriz_integracao,\n  i.sequencia_integracao,\n  m.modo,\n  i.perc_rateio AS percentual_rateio,\n  i.dt_inicio_validade AS data_inicio_validade,\n  i.dt_fim_validade AS data_fim_validade,\n  '' as versao\nFROM\n  matriz_melt i\nLEFT JOIN\n    `rj-smtr`.`cadastro`.`modos` m\nON\n  i.id_tipo_modal = m.id_modo AND m.fonte = \"jae\"\nWHERE\n  i.id_tipo_modal IS NOT NULL", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`matriz_integracao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.688488Z", "completed_at": "2024-09-30T15:21:51.694189Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.695552Z", "completed_at": "2024-09-30T15:21:51.695562Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009598970413208008, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.recursos_sppo_bloqueio_via_ultimo_julgamento", "compiled": true, "compiled_code": "\nWITH exploded AS (\n  SELECT\n    id_recurso,\n    datetime_update AS data_julgamento,\n    SAFE_CAST(COALESCE(JSON_VALUE(items, '$.value'), JSON_VALUE(items, '$.items[0].customFieldItem')) AS STRING\n    ) AS julgamento,\n    SAFE_CAST(JSON_EXTRACT(items, '$.customFieldId') AS STRING ) AS field_id\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`staging_recursos_sppo_bloqueio_via`,\n    UNNEST(items) items\n  WHERE\n        DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\")\n        AND DATE(\"2022-01-01T01:00:00\")\n),\npivotado AS (\n  SELECT * EXCEPT(field_id)\n  FROM\n    exploded\n  WHERE field_id = '111865'\n\n),\n\n  julgamento AS (\n    SELECT\n      p.id_recurso,\n      p.julgamento,\n      p.data_julgamento,\n      t.julgamento AS ultimo_julgamento\n    FROM\n      pivotado p\n    LEFT JOIN\n      `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_bloqueio_via_ultimo_julgamento` AS t\n    USING (id_recurso)\n  )\n\n\nSELECT\n  id_recurso,\n  data_julgamento,\n  julgamento\nFROM\n(\n  SELECT\n    ROW_NUMBER() OVER(PARTITION BY j.id_recurso ORDER BY j.data_julgamento DESC) AS rn,\n    *\n  FROM\n    julgamento j\n  WHERE\n    j.julgamento != j.ultimo_julgamento OR j.ultimo_julgamento IS NULL\n)\nWHERE rn=1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_bloqueio_via_ultimo_julgamento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.700128Z", "completed_at": "2024-09-30T15:21:51.706115Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.707407Z", "completed_at": "2024-09-30T15:21:51.707416Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010020256042480469, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.recursos_sppo_reprocessamento_ultimo_julgamento", "compiled": true, "compiled_code": "\nWITH exploded AS (\n  SELECT\n    id_recurso,\n    datetime_update AS data_julgamento,\n    SAFE_CAST(COALESCE(JSON_VALUE(items, '$.value'), JSON_VALUE(items, '$.items[0].customFieldItem')) AS STRING\n    ) AS julgamento,\n    SAFE_CAST(JSON_EXTRACT(items, '$.customFieldId') AS STRING ) AS field_id\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`staging_recursos_sppo_reprocessamento`,\n    UNNEST(items) items\n  WHERE\n        DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\")\n        AND DATE(\"2022-01-01T01:00:00\")\n),\npivotado AS (\n  SELECT * EXCEPT(field_id)\n  FROM\n    exploded\n  WHERE field_id = '111865'\n\n),\n\n  julgamento AS (\n    SELECT\n      p.id_recurso,\n      p.julgamento,\n      p.data_julgamento,\n      t.julgamento AS ultimo_julgamento\n    FROM\n      pivotado p\n    LEFT JOIN\n      `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_reprocessamento_ultimo_julgamento` AS t\n    USING (id_recurso)\n  )\n\n\nSELECT\n  id_recurso,\n  data_julgamento,\n  julgamento\nFROM\n(\n  SELECT\n    ROW_NUMBER() OVER(PARTITION BY j.id_recurso ORDER BY j.data_julgamento DESC) AS rn,\n    *\n  FROM\n    julgamento j\n  WHERE\n    j.julgamento != j.ultimo_julgamento OR j.ultimo_julgamento IS NULL\n)\nWHERE rn=1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_reprocessamento_ultimo_julgamento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.712746Z", "completed_at": "2024-09-30T15:21:51.724979Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:51.728065Z", "completed_at": "2024-09-30T15:21:51.728083Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.02028512954711914, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.recursos_sppo_viagens_individuais_ultimo_julgamento", "compiled": true, "compiled_code": "\nWITH exploded AS (\n  SELECT\n    id_recurso,\n    datetime_update AS data_julgamento,\n    SAFE_CAST(COALESCE(JSON_VALUE(items, '$.value'), JSON_VALUE(items, '$.items[0].customFieldItem')) AS STRING\n    ) AS julgamento,\n    SAFE_CAST(JSON_EXTRACT(items, '$.customFieldId') AS STRING ) AS field_id\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`staging_recursos_sppo_viagens_individuais`,\n    UNNEST(items) items\n  WHERE\n        DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\")\n        AND DATE(\"2022-01-01T01:00:00\")\n),\npivotado AS (\n  SELECT * EXCEPT(field_id)\n  FROM\n    exploded\n  WHERE field_id = '111865'\n\n),\n\n  julgamento AS (\n    SELECT\n      p.id_recurso,\n      p.julgamento,\n      p.data_julgamento,\n      t.julgamento AS ultimo_julgamento\n    FROM\n      pivotado p\n    LEFT JOIN\n      `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_viagens_individuais_ultimo_julgamento` AS t\n    USING (id_recurso)\n  )\n\n\nSELECT\n  id_recurso,\n  data_julgamento,\n  julgamento\nFROM\n(\n  SELECT\n    ROW_NUMBER() OVER(PARTITION BY j.id_recurso ORDER BY j.data_julgamento DESC) AS rn,\n    *\n  FROM\n    julgamento j\n  WHERE\n    j.julgamento != j.ultimo_julgamento OR j.ultimo_julgamento IS NULL\n\n)\nWHERE rn=1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_viagens_individuais_ultimo_julgamento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:51.735250Z", "completed_at": "2024-09-30T15:21:54.391053Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:54.392678Z", "completed_at": "2024-09-30T15:21:54.392689Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.660689115524292, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.rho_registros_sppo", "compiled": true, "compiled_code": "\n\n\n\n    \n        \n\n        \n\n        \n    \n\n\nWITH rho_new AS (\n    SELECT\n        data_transacao,\n        hora_transacao,\n        data_processamento,\n        data_particao AS data_arquivo_rho,\n        linha AS servico_riocard,\n        linha_rcti AS linha_riocard,\n        operadora,\n        total_pagantes_cartao AS quantidade_transacao_cartao,\n        total_pagantes_especie AS quantidade_transacao_especie,\n        total_gratuidades AS quantidade_transacao_gratuidade,\n        registro_processado,\n        timestamp_captura AS datetime_captura\n    FROM\n        `rj-smtr`.`br_rj_riodejaneiro_rdo_staging`.`rho_registros_sppo`\n    \n        WHERE\n            ano BETWEEN\n                EXTRACT(YEAR FROM DATE(\"2022-01-01T00:00:00\"))\n                AND EXTRACT(YEAR FROM DATE(\"2022-01-01T01:00:00\"))\n            AND mes BETWEEN\n                EXTRACT(MONTH FROM DATE(\"2022-01-01T00:00:00\"))\n                AND EXTRACT(MONTH FROM DATE(\"2022-01-01T01:00:00\"))\n            AND dia BETWEEN\n                EXTRACT(DAY FROM DATE(\"2022-01-01T00:00:00\"))\n                AND EXTRACT(DAY FROM DATE(\"2022-01-01T01:00:00\"))\n    \n),\nrho_complete_partitions AS (\n    SELECT\n        *\n    FROM\n        rho_new\n\n    \n),\n-- Deduplica os dados com base na data e hora da transacao, linha, linha_rcti e operadora\nrho_rn AS (\n    SELECT\n        *,\n        ROW_NUMBER() OVER(\n            PARTITION BY\n                data_transacao,\n                hora_transacao,\n                data_arquivo_rho,\n                servico_riocard,\n                linha_riocard,\n                operadora\n            ORDER BY\n                datetime_captura DESC\n        ) AS rn\n    FROM\n        rho_complete_partitions\n)\nSELECT\n    * EXCEPT(rn)\nFROM\n    rho_rn\nWHERE\n    rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_rdo`.`rho_registros_sppo`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:54.397423Z", "completed_at": "2024-09-30T15:21:57.415662Z"}, {"name": "execute", "started_at": "2024-09-30T15:21:57.417020Z", "completed_at": "2024-09-30T15:21:57.417030Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.022224187850952, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.rho_registros_stpl_aux", "compiled": true, "compiled_code": "\n\n-- Tabela auxiliar para manter os dados com os mesmos identificadores:\n-- data e hora de transacao, linha e operadora desagregados antes de somar na tabela final\n-- Foi criada para n\u00e3o ter o risco de somar os dados do mesmo arquivo mais de uma vez\n\n\n\n\n\n\n    \n        \n\n        \n\n        \n    \n\n\n\nWITH rho_new AS (\n    SELECT\n        data_transacao,\n        hora_transacao,\n        data_particao AS data_arquivo_rho,\n        linha AS servico_riocard,\n        operadora,\n        total_pagantes AS quantidade_transacao_pagante,\n        total_gratuidades AS quantidade_transacao_gratuidade,\n        timestamp_captura AS datetime_captura\n    FROM\n        `rj-smtr`.`br_rj_riodejaneiro_rdo_staging`.`rho_registros_stpl`\n    \n        WHERE\n            \n    ano BETWEEN\n        EXTRACT(YEAR FROM DATE(\"2022-01-01T00:00:00\"))\n        AND EXTRACT(YEAR FROM DATE(\"2022-01-01T01:00:00\"))\n    AND mes BETWEEN\n        EXTRACT(MONTH FROM DATE(\"2022-01-01T00:00:00\"))\n        AND EXTRACT(MONTH FROM DATE(\"2022-01-01T01:00:00\"))\n    AND dia BETWEEN\n        EXTRACT(DAY FROM DATE(\"2022-01-01T00:00:00\"))\n        AND EXTRACT(DAY FROM DATE(\"2022-01-01T01:00:00\"))\n\n    \n),\nrho_complete_partitions AS (\n    SELECT\n        *\n    FROM\n        rho_new\n\n    \n\n        UNION ALL\n\n        SELECT\n            *\n        FROM\n            `rj-smtr`.`br_rj_riodejaneiro_rdo_staging`.`rho_registros_stpl_aux`\n        WHERE\n            data_transacao IN ('2021-12-31', '2022-01-01', '2021-12-29', '2021-12-30', '2021-12-28', '2021-12-22', '2021-12-23', '2021-12-24', '2021-12-26', '2021-12-27')\n    \n)\nSELECT\n    data_transacao,\n    hora_transacao,\n    data_arquivo_rho,\n    servico_riocard,\n    operadora,\n    quantidade_transacao_pagante,\n    quantidade_transacao_gratuidade,\n    datetime_captura\nFROM\n    (\n        SELECT\n            *,\n            ROW_NUMBER() OVER(\n                PARTITION BY\n                    data_transacao,\n                    hora_transacao,\n                    data_arquivo_rho,\n                    servico_riocard,\n                    operadora\n                ORDER BY\n                    datetime_captura DESC\n                ) AS rn\n        FROM\n            rho_complete_partitions\n    )\nWHERE\n    rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_rdo_staging`.`rho_registros_stpl_aux`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:21:57.421078Z", "completed_at": "2024-09-30T15:22:01.310015Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:01.311622Z", "completed_at": "2024-09-30T15:22:01.311633Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.892984628677368, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.viagem_informada", "compiled": true, "compiled_code": "\n\n\n\n\n\n  \n    \n\n    \n  \n\n\nWITH staging_data AS (\n  SELECT\n    data_viagem AS data,\n    datetime_partida,\n    datetime_chegada,\n    datetime_processamento,\n    timestamp_captura AS datetime_captura,\n    id_veiculo,\n    trip_id,\n    route_id,\n    shape_id,\n    servico,\n    CASE\n      WHEN sentido = 'I' THEN 'Ida'\n      WHEN sentido = 'V' THEN 'Volta'\n      ELSE sentido\n    END AS sentido,\n    id_viagem\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_viagem_zirix_staging`.`viagem_informada`\n  \n    WHERE\n      \n  DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n\n  \n),\ncomplete_partitions AS (\n  SELECT\n    *,\n    0 AS priority\n  FROM\n    staging_data\n\n  \n),\ndeduplicado AS (\n  SELECT\n    * EXCEPT(rn, priority)\n  FROM\n    (\n      SELECT\n        *,\n        ROW_NUMBER() OVER(PARTITION BY id_viagem ORDER BY datetime_captura DESC, priority) AS rn\n      FROM\n        complete_partitions\n    )\n  WHERE\n    rn = 1\n)\nSELECT\n  *,\n  '' AS versao,\n  CURRENT_DATETIME(\"America/Sao_Paulo\") as datetime_ultima_atualizacao\nFROM\n  deduplicado", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_viagem_zirix`.`viagem_informada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:01.315953Z", "completed_at": "2024-09-30T15:22:01.325554Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:01.326841Z", "completed_at": "2024-09-30T15:22:01.326851Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013508796691894531, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.stop_details_desaninhada", "compiled": true, "compiled_code": "/*Desaninha os campos presentes em 'content' da tabela stop_details*/\nSELECT\n  stop_id,\n  json_value(content, '$.stop_name') stop_name,\n  json_value(content, '$.stop_desc') stop_desc,\n  json_value(content, '$.stop_lat') stop_lat,\n  json_value(content, '$.stop_lon') stop_lon,\n  json_value(content, '$.location_type') location_type,\n  json_value(content, '$.Modal') modal,\n  json_value(content, '$.Corredor') corredor,\n  json_value(content, '$.Tipo de parada') tipo_de_parada ,\n  json_value(content, '$.Tipo Sentido') tipo_sentido,\n  json_value(content, '$.Propriedade da Parada') propriedade_da_parada,\n  json_value(content, '$.Seletivado') seletivado,\n  json_value(content, '$.Sinaliza\u00e7\u00e3o') sinalizacao,\n  json_value(content, '$.Conserva\u00e7\u00e3o') conservacao,\n  json_value(content, '$.Tipo de abrigo') tipo_de_abrigo,\n  json_value(content, '$.Conserva\u00e7\u00e3o do abrigo') conservacao_do_abrigo,\n  json_value(content, '$.Tipo de assento') tipo_do_assento,\n  json_value(content, '$.Tipo de baia') tipo_de_baia,\n  json_value(content, '$.Tipo de cal\u00e7ada') tipo_de_calcada,\n  json_value(content, '$.\"Possui lixeiras?\"') possui_lixeiras,\n  json_value(content, '$.Tipo rampa') tipo_rampa,\n  json_value(content, '$.\"Braile?\"') braile,\n  json_value(content, '$.\"Piso t\u00e1til?\"') piso_tatil,\n  json_value(content, '$.\"Elevador?\"') elevador,\n  json_value(content, '$.N\u00famero de vagas') numero_de_vagas,\n  json_value(content, '$.N\u00famero de cabines') numero_de_cabines,\n  json_value(content, '$.AP') ap,\n  json_value(content, '$.RA') ra,\n  json_value(content, '$.Bairro') bairro,\n  json_value(content, '$.Observa\u00e7\u00f5es') observacoes,\n  json_value(content, '$.Endere\u00e7o') endereco,\n  json_value(content, '$.MultiModal') multi_modal,\n  json_value(content, '$.id_sequencial') id_sequencial,\n  json_value(content, '$.NumeroLinha') numero_linha,\n  json_value(content, '$.Vista') vista,\n  json_value(content, '$.Hor\u00e1rios') horarios,\n  json_value(content, '$.\"Existe o ponto?\"') existe_o_ponto,\n  json_value(content, '$.parent_station') parent_station,\n  json_value(content, '$.nome_ponto') nome_ponto,\n  json_value(content, '$.route_type') route_type,\n  data_versao\n\nFROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stop_details`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stop_details_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:01.330787Z", "completed_at": "2024-09-30T15:22:01.334179Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:01.335464Z", "completed_at": "2024-09-30T15:22:01.335472Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007080554962158203, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.stop_times_desaninhada", "compiled": true, "compiled_code": "SELECT\n  stop_id,\n  JSON_VALUE(content, \"$.trip_id\") trip_id,\n  JSON_VALUE(content, \"$.arrival_time\") arrival_time,\n  JSON_VALUE(content, \"$.departure_time\") departure_time,\n  JSON_VALUE(content, \"$.stop_sequence\") stop_sequence,\n  JSON_VALUE(content, \"$.shape_dist_traveled\") shape_dist_traveled,\n  DATE(data_versao) data_versao\nFROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stop_times`", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stop_times_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:01.339518Z", "completed_at": "2024-09-30T15:22:01.342856Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:01.344163Z", "completed_at": "2024-09-30T15:22:01.344171Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007122039794921875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.agg_stops_vistoriadas", "compiled": true, "compiled_code": "WITH t AS (\nSELECT\n    data_versao,\n    case\n        when\n        json_value(content, '$.IDPropriedadeParada') is null\n        then false\n    else true\n    end flag_vistoriada,\n    json_value(content, '$.AP') as AP,\n    json_value(content, '$.RA') as RA,\n    json_value(content, '$.Bairro') as Bairro\nFROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stops`\nwhere json_value(content, '$.PontoExistente') = 'SIM'\nand json_value(content, '$.idModalSmtr') in ('22', 'O'))\nselect data_versao, AP, Bairro,\n    sum(case when flag_vistoriada then 1 else 0 end) n_vistoridas,\n    count(*) n_pontos\nfrom t\ngroup by data_versao, AP, Bairro\norder by 1,2,3", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`agg_stops_vistoriadas`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:01.348109Z", "completed_at": "2024-09-30T15:22:01.351757Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:01.353007Z", "completed_at": "2024-09-30T15:22:01.353015Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007338285446166992, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.stops_desaninhada", "compiled": true, "compiled_code": "SELECT\n    stop_id,\n    case when json_value(content, '$.IDPropriedadeParada') is null then false else true end flag_vistoriada,\n    json_value(content, '$.stop_name') as stop_name,\n    json_value(content, '$.stop_desc') as stop_desc,\n    json_value(content, '$.stop_lat') as stop_lat,\n    json_value(content, '$.stop_lon') as stop_lon,\n    json_value(content, '$.location_type') as location_type,\n    json_value(content, '$.GrupoLatitude') as GrupoLatitude,\n    json_value(content, '$.GrupoLongitude') as GrupoLongitude,\n    json_value(content, '$.idModalSmtr') as idModalSmtr,\n    json_value(content, '$.IDCorredor') as IDCorredor,\n    json_value(content, '$.IDTipoParada') as IDTipoParada,\n    json_value(content, '$.IDTipoSentido') as IDTipoSentido,\n    json_value(content, '$.IDPropriedadeParada') as IDPropriedadeParada,\n    json_value(content, '$.Seletivado') as Seletivado,\n    json_value(content, '$.BRS') as BRS,\n    json_value(content, '$.IDTipoSinalizacao') as IDTipoSinalizacao,\n    json_value(content, '$.IDConservacaoSinalizacao') as IDConservacaoSinalizacao,\n    json_value(content, '$.IDTipoAbrigo') as IDTipoAbrigo,\n    json_value(content, '$.ConservacaoAbrigo') as ConservacaoAbrigo,\n    json_value(content, '$.IDTipoAssento') as IDTipoAssento,\n    json_value(content, '$.IDTipoBaia') as IDTipoBaia,\n    json_value(content, '$.QualidadePavimento') as QualidadePavimento,\n    json_value(content, '$.IDTipoCalcada') as IDTipoCalcada,\n    json_value(content, '$.IDLixeiras') as IDLixeiras,\n    json_value(content, '$.IDRampa') as IDRampa,\n    json_value(content, '$.braile') as braile,\n    json_value(content, '$.piso_tatil') as piso_tatil,\n    json_value(content, '$.elevador') as elevador,\n    json_value(content, '$.n_vagas') as n_vagas,\n    json_value(content, '$.n_cabines') as n_cabines,\n    json_value(content, '$.AP') as AP,\n    json_value(content, '$.RA') as RA,\n    json_value(content, '$.Bairro') as Bairro,\n    json_value(content, '$.Observacoes') as Observacoes,\n    json_value(content, '$.dataAtualizacao') as dataAtualizacao,\n    json_value(content, '$.endereco') as endereco,\n    json_value(content, '$.IDBairro') as IDBairro,\n    json_value(content, '$.IDRa') as IDRa,\n    json_value(content, '$.MultiModal') as MultiModal,\n    json_value(content, '$.id_sequencial') as id_sequencial,\n    json_value(content, '$.NumeroLinha') as NumeroLinha,\n    json_value(content, '$.Vista') as Vista,\n    json_value(content, '$.Horarios') as Horarios,\n    json_value(content, '$.id') as id,\n    json_value(content, '$.PontoExistente') as PontoExistente\nFROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stops` t\nwhere data_versao = (select max(data_versao) FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stops`)\nand json_value(content, '$.PontoExistente') = 'SIM'\nand json_value(content, '$.idModalSmtr') in ('22', '23', 'O')", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stops_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:01.356793Z", "completed_at": "2024-09-30T15:22:12.572278Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:12.575541Z", "completed_at": "2024-09-30T15:22:12.575555Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 11.221463203430176, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.subsidio_data_versao_efetiva", "compiled": true, "compiled_code": "\n\n\n\n  \n  \n  \n\n\nWITH\n  dates AS (\n  SELECT\n    data,\n    CASE\n        WHEN data = \"2022-06-16\" THEN \"Domingo\"\n        WHEN data = \"2022-06-17\" THEN \"Sabado\"\n        WHEN data = \"2022-09-02\" THEN \"Sabado\"\n        WHEN data = \"2022-09-07\" THEN \"Domingo\"\n        WHEN data = \"2022-10-12\" THEN \"Domingo\"\n        WHEN data = \"2022-10-17\" THEN \"Sabado\"\n        WHEN data = \"2022-11-02\" THEN \"Domingo\"\n        WHEN data = \"2022-11-14\" THEN \"Sabado\"\n        WHEN data = \"2022-11-15\" THEN \"Domingo\"\n        WHEN data = \"2022-11-24\" THEN \"Sabado\"\n        WHEN data = \"2022-11-28\" THEN \"Sabado\"\n        WHEN data = \"2022-12-02\" THEN \"Sabado\"\n        WHEN data = \"2022-12-05\" THEN \"Sabado\"\n        WHEN data = \"2022-12-09\" THEN \"Sabado\"\n        WHEN data = \"2023-04-06\" THEN \"Sabado\" -- Ponto Facultativo - DECRETO RIO N\u00ba 52275/2023\n        WHEN data = \"2023-04-07\" THEN \"Domingo\" -- Paix\u00e3o de Cristo -- Art. 1\u00ba, V - PORTARIA ME N\u00ba 11.090/2022\n        WHEN data = \"2023-06-08\" THEN \"Domingo\" -- Corpus Christi - Lei n\u00ba 336/1949 - OF\u00cdCIO N\u00ba MTR-OFI-2023/03260 (MTROFI202303260A)\n        WHEN data = \"2023-06-09\" THEN \"Sabado\" -- Ponto Facultativo - DECRETO RIO N\u00ba 52584/2023\n        WHEN data = \"2023-09-08\" THEN \"Ponto Facultativo\" -- Ponto Facultativo - DECRETO RIO N\u00ba 53137/2023\n        WHEN data = \"2023-10-13\" THEN \"Ponto Facultativo\" -- Ponto Facultativo - DECRETO RIO N\u00ba 53296/2023\n        WHEN data = \"2023-10-16\" THEN \"Ponto Facultativo\" -- Dia do Com\u00e9rcio - OS Outubro/Q2\n        WHEN data = \"2023-11-03\" THEN \"Ponto Facultativo\" -- Ponto Facultativo - DECRETO RIO N\u00ba 53417/2023\n        WHEN data = \"2023-11-05\" THEN \"Sabado\" -- Domingo At\u00edpico - ENEM - OS Novembro/Q1\n        WHEN data = \"2023-11-12\" THEN \"Sabado\" -- Domingo At\u00edpico - ENEM - OS Novembro/Q1\n        WHEN data = \"2023-12-02\" THEN \"Sabado - Ver\u00e3o\" -- OS de Ver\u00e3o\n        WHEN data = \"2023-12-03\" THEN \"Domingo - Ver\u00e3o\" -- OS de Ver\u00e3o\n        WHEN data = \"2023-12-16\" THEN \"Sabado - Ver\u00e3o\" -- OS de Ver\u00e3o\n        WHEN data = \"2023-12-17\" THEN \"Domingo - Ver\u00e3o\" -- OS de Ver\u00e3o\n        WHEN data = \"2024-01-06\" THEN \"Sabado - Ver\u00e3o\" -- OS de Ver\u00e3o\n        WHEN data = \"2024-01-07\" THEN \"Domingo - Ver\u00e3o\" -- OS de Ver\u00e3o\n        WHEN data = \"2024-02-09\" THEN \"Ponto Facultativo\" -- Despacho MTR-DES-2024/07951\n        WHEN data = \"2024-02-12\" THEN \"Domingo\" -- Despacho MTR-DES-2024/07951\n        WHEN data = \"2024-02-13\" THEN \"Domingo\" -- Despacho MTR-DES-2024/07951\n        WHEN data = \"2024-02-14\" THEN \"Ponto Facultativo\" -- Despacho MTR-DES-2024/07951\n        WHEN data = \"2023-12-31\" THEN \"Domingo - R\u00e9veillon\"\n        WHEN data = \"2024-01-01\" THEN \"Domingo - R\u00e9veillon\"\n        WHEN data = \"2024-02-24\" THEN \"Sabado - Ver\u00e3o\" -- OS de Ver\u00e3o - Despacho MTR-DES-2024/10516\n        WHEN data = \"2024-02-25\" THEN \"Domingo - Ver\u00e3o\" -- OS de Ver\u00e3o - Despacho MTR-DES-2024/10516\n        WHEN data = \"2024-03-16\" THEN \"Sabado - Ver\u00e3o\" -- OS de Ver\u00e3o - Despacho MTR-DES-2024/15504\n        WHEN data = \"2024-03-17\" THEN \"Domingo - Ver\u00e3o\" -- OS de Ver\u00e3o - Despacho MTR-DES-2024/15504\n        WHEN data = \"2024-03-22\" THEN \"Ponto Facultativo\" -- Ponto Facultativo - DECRETO RIO N\u00ba 54114/2024\n        WHEN data = \"2024-03-28\" THEN \"Ponto Facultativo\" -- Ponto Facultativo - DECRETO RIO N\u00ba 54081/2024\n        WHEN data = \"2024-03-29\" THEN \"Domingo\" -- Feriado de Paix\u00e3o de Cristo (Sexta-feira Santa)\n        WHEN EXTRACT(DAY FROM data) = 20 AND EXTRACT(MONTH FROM data) = 1 THEN \"Domingo\" -- Dia de S\u00e3o Sebasti\u00e3o -- Art. 8\u00b0, I - Lei Municipal n\u00ba 5146/2010\n        WHEN EXTRACT(DAY FROM data) = 23 AND EXTRACT(MONTH FROM data) = 4 THEN \"Domingo\" -- Dia de S\u00e3o Jorge -- Art. 8\u00b0, II - Lei Municipal n\u00ba 5146/2010 / Lei Estadual N\u00ba 5198/2008 / Lei Estadual N\u00ba 5645/2010\n        WHEN EXTRACT(DAY FROM data) = 20 AND EXTRACT(MONTH FROM data) = 11 THEN \"Domingo\" -- Anivers\u00e1rio de morte de Zumbi dos Palmares / Dia da Consci\u00eancia Negra -- Art. 8\u00b0, IV - Lei Municipal n\u00ba 5146/2010 / Lei Estadual n\u00ba 526/1982 / Lei Estadual n\u00ba 1929/1991 / Lei Estadual n\u00ba 4007/2002 / Lei Estadual N\u00ba 5645/2010\n        WHEN EXTRACT(DAY FROM data) = 21 AND EXTRACT(MONTH FROM data) = 4 THEN \"Domingo\" -- Tiradentes -- Art. 1\u00ba, VI - PORTARIA ME N\u00ba 11.090/2022\n        WHEN EXTRACT(DAY FROM data) = 1 AND EXTRACT(MONTH FROM data) = 5 THEN \"Domingo\" -- Dia Mundial do Trabalho -- Art. 1\u00ba, VII - PORTARIA ME N\u00ba 11.090/2022\n        WHEN EXTRACT(DAY FROM data) = 7 AND EXTRACT(MONTH FROM data) = 9 THEN \"Domingo\" -- Independ\u00eancia do Brasil -- Art. 1\u00ba, IX - PORTARIA ME N\u00ba 11.090/2022\n        WHEN EXTRACT(DAY FROM data) = 12 AND EXTRACT(MONTH FROM data) = 10 THEN \"Domingo\" -- Nossa Senhora Aparecida -- Art. 1\u00ba, X - PORTARIA ME N\u00ba 11.090/2022\n        WHEN EXTRACT(DAY FROM data) = 2 AND EXTRACT(MONTH FROM data) = 11 THEN \"Domingo\" -- Finados -- Art. 1\u00ba, XII - PORTARIA ME N\u00ba 11.090/2022\n        WHEN EXTRACT(DAY FROM data) = 15 AND EXTRACT(MONTH FROM data) = 11 THEN \"Domingo\" -- Proclama\u00e7\u00e3o da Rep\u00fablica -- Art. 1\u00ba, XIII - PORTARIA ME N\u00ba 11.090/2022\n        WHEN EXTRACT(DAY FROM data) = 25 AND EXTRACT(MONTH FROM data) = 12 THEN \"Domingo\" -- Natal -- Art. 1\u00ba, XIV - PORTARIA ME N\u00ba 11.090/2022\n        WHEN EXTRACT(DAYOFWEEK FROM data) = 1 THEN \"Domingo\"\n        WHEN EXTRACT(DAYOFWEEK FROM data) = 7 THEN \"Sabado\"\n        ELSE \"Dia \u00datil\"\n    END AS tipo_dia,\n    CASE\n      -- Reveillon 2022:\n      WHEN data = DATE(2022,12,31) THEN data\n      WHEN data = DATE(2023,1,1) THEN data\n      WHEN data BETWEEN DATE(2023,1,2) AND DATE(2023,1,15) THEN DATE(2023,1,2)\n      -- Reprocessamento:\n      WHEN data BETWEEN DATE(2023,1,15) AND DATE(2023,1,31) THEN DATE(2023,1,16)\n      WHEN data BETWEEN DATE(2023,3,16) AND DATE(2023,3,31) THEN DATE(2023,3,16)\n      -- Altera\u00e7\u00e3o de Planejamento\n      WHEN data BETWEEN DATE(2023,6,16) AND DATE(2023,6,30) THEN DATE(2023,6,16)\n      WHEN data BETWEEN DATE(2023,7,16) AND DATE(2023,7,31) THEN DATE(2023,7,16)\n      WHEN data BETWEEN DATE(2023,8,16) AND DATE(2023,8,31) THEN DATE(2023,8,16)\n      WHEN data BETWEEN DATE(2023,9,16) AND DATE(2023,9,30) THEN DATE(2023,9,16)\n      WHEN data BETWEEN DATE(2023,10,16) AND DATE(2023,10,16) THEN DATE(2023,10,16)\n      WHEN data BETWEEN DATE(2023,10,17) AND DATE(2023,10,23) THEN DATE(2023,10,17)\n      WHEN data BETWEEN DATE(2023,10,24) AND DATE(2023,10,31) THEN DATE(2023,10,24)\n      WHEN data = DATE(2023,12,01) THEN data -- Desvio do TIG\n      WHEN data BETWEEN DATE(2023,12,02) AND DATE(2023,12,03) THEN DATE(2023,12,03) -- OS de Ver\u00e3o\n      WHEN data BETWEEN DATE(2023,12,16) AND DATE(2023,12,17) THEN DATE(2023,12,03) -- OS de Ver\u00e3o\n      WHEN data BETWEEN DATE(2023,12,04) AND DATE(2023,12,20) THEN DATE(2023,12,02) -- Fim do desvio do TIG\n      WHEN data BETWEEN DATE(2023,12,21) AND DATE(2023,12,30) THEN DATE(2023,12,21)\n      -- Reveillon 2023:\n      WHEN data = DATE(2023,12,31) THEN data\n      WHEN data = DATE(2024,01,01) THEN data\n      -- 2024:\n      WHEN data BETWEEN DATE(2024,01,06) AND DATE(2024,01,07) THEN DATE(2024,01,03) -- OS de Ver\u00e3o\n      WHEN data BETWEEN DATE(2024,01,02) AND DATE(2024,01,14) THEN DATE(2024,01,02)\n      WHEN data BETWEEN DATE(2024,01,15) AND DATE(2024,01,31) THEN DATE(2024,01,15)\n      WHEN data BETWEEN DATE(2024,02,01) AND DATE(2024,02,18) THEN DATE(2024,02,01) -- OS fev/Q1\n      WHEN data BETWEEN DATE(2024,02,19) AND DATE(2024,02,23) THEN DATE(2024,02,19) -- OS fev/Q2\n      WHEN data BETWEEN DATE(2024,02,24) AND DATE(2024,02,25) THEN DATE(2024,02,25) -- OS fev/Q2 - TIG - OS Ver\u00e3o\n      WHEN data BETWEEN DATE(2024,02,26) AND DATE(2024,03,01) THEN DATE(2024,02,24) -- OS fev/Q2 - TIG\n      WHEN data BETWEEN DATE(2024,03,02) AND DATE(2024,03,10) THEN DATE(2024,03,02) -- OS mar/Q1\n      WHEN data BETWEEN DATE(2024,03,11) AND DATE(2024,03,15) THEN DATE(2024,03,11) -- OS mar/Q1\n      WHEN data BETWEEN DATE(2024,03,16) AND DATE(2024,03,17) THEN DATE(2024,03,12) -- OS mar/Q2\n      WHEN data BETWEEN DATE(2024,03,18) AND DATE(2024,03,29) THEN DATE(2024,03,18) -- OS mar/Q2\n      WHEN data BETWEEN DATE(2024,03,30) AND DATE(2024,04,30) THEN DATE(2024,03,30) -- OS abr/Q1\n      -- 2022:\n      WHEN data BETWEEN DATE(2022,10,1) AND DATE(2022,10,2) THEN DATE(2022,9,16)\n      WHEN data BETWEEN DATE(2022,6,1) AND LAST_DAY(DATE(2022,6,30), MONTH) THEN DATE(2022,6,1)\n      \n        WHEN data BETWEEN DATE(2022,7,1) AND DATE(2022,7,15) THEN DATE(2022,7,1)\n        WHEN data BETWEEN DATE(2022,7,16) AND LAST_DAY(DATE(2022,7,30), MONTH) THEN DATE(2022,7,16)\n      \n        WHEN data BETWEEN DATE(2022,8,1) AND DATE(2022,8,15) THEN DATE(2022,8,1)\n        WHEN data BETWEEN DATE(2022,8,16) AND LAST_DAY(DATE(2022,8,30), MONTH) THEN DATE(2022,8,16)\n      \n        WHEN data BETWEEN DATE(2022,9,1) AND DATE(2022,9,15) THEN DATE(2022,9,1)\n        WHEN data BETWEEN DATE(2022,9,16) AND LAST_DAY(DATE(2022,9,30), MONTH) THEN DATE(2022,9,16)\n      \n        WHEN data BETWEEN DATE(2022,10,1) AND DATE(2022,10,15) THEN DATE(2022,10,1)\n        WHEN data BETWEEN DATE(2022,10,16) AND LAST_DAY(DATE(2022,10,30), MONTH) THEN DATE(2022,10,16)\n      \n        WHEN data BETWEEN DATE(2022,11,1) AND DATE(2022,11,15) THEN DATE(2022,11,1)\n        WHEN data BETWEEN DATE(2022,11,16) AND LAST_DAY(DATE(2022,11,30), MONTH) THEN DATE(2022,11,16)\n      \n        WHEN data BETWEEN DATE(2022,12,1) AND DATE(2022,12,15) THEN DATE(2022,12,1)\n        WHEN data BETWEEN DATE(2022,12,16) AND LAST_DAY(DATE(2022,12,30), MONTH) THEN DATE(2022,12,16)\n      \n      -- 2023 a 2024:\n      \n        \n          WHEN EXTRACT(MONTH FROM data) = 1 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,1,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 2 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,2,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 3 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,3,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 4 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,4,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 5 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,5,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 6 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,6,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 7 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,7,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 8 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,8,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 9 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,9,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 10 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,10,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 11 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,11,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 12 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,12,1)\n        \n      \n        \n          WHEN EXTRACT(MONTH FROM data) = 1 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,1,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 2 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,2,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 3 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,3,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 4 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,4,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 5 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,5,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 6 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,6,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 7 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,7,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 8 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,8,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 9 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,9,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 10 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,10,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 11 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,11,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 12 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,12,1)\n        \n      \n    END AS data_versao_trips,\n    CASE\n      -- Reveillon 2022:\n      WHEN data = DATE(2022,12,31) THEN data\n      WHEN data = DATE(2023,1,1) THEN data\n      WHEN data BETWEEN DATE(2023,1,2) AND DATE(2023,1,15) THEN DATE(2023,1,2)\n      -- Reprocessamento:\n      WHEN data BETWEEN DATE(2023,1,15) AND DATE(2023,1,31) THEN DATE(2023,1,16)\n      WHEN data BETWEEN DATE(2023,3,16) AND DATE(2023,3,31) THEN DATE(2023,3,16)\n      -- Altera\u00e7\u00e3o de Planejamento\n      WHEN data BETWEEN DATE(2023,6,16) AND DATE(2023,6,30) THEN DATE(2023,6,16)\n      WHEN data BETWEEN DATE(2023,7,16) AND DATE(2023,7,31) THEN DATE(2023,7,16)\n      WHEN data BETWEEN DATE(2023,8,16) AND DATE(2023,8,31) THEN DATE(2023,8,16)\n      WHEN data BETWEEN DATE(2023,9,16) AND DATE(2023,9,30) THEN DATE(2023,9,16)\n      WHEN data BETWEEN DATE(2023,10,16) AND DATE(2023,10,16) THEN DATE(2023,10,16)\n      WHEN data BETWEEN DATE(2023,10,17) AND DATE(2023,10,23) THEN DATE(2023,10,17)\n      WHEN data BETWEEN DATE(2023,10,24) AND DATE(2023,10,31) THEN DATE(2023,10,24)\n      WHEN data = DATE(2023,12,01) THEN data -- Desvio do TIG\n      WHEN data BETWEEN DATE(2023,12,02) AND DATE(2023,12,03) THEN DATE(2023,12,03) -- OS de Ver\u00e3o\n      WHEN data BETWEEN DATE(2023,12,16) AND DATE(2023,12,17) THEN DATE(2023,12,03) -- OS de Ver\u00e3o\n      WHEN data BETWEEN DATE(2023,12,04) AND DATE(2023,12,20) THEN DATE(2023,12,02) -- Fim do desvio do TIG\n      WHEN data BETWEEN DATE(2023,12,21) AND DATE(2023,12,30) THEN DATE(2023,12,21)\n      -- Reveillon 2023:\n      WHEN data = DATE(2023,12,31) THEN data\n      WHEN data = DATE(2024,01,01) THEN data\n      -- 2024:\n      WHEN data BETWEEN DATE(2024,01,06) AND DATE(2024,01,07) THEN DATE(2024,01,03) -- OS de Ver\u00e3o\n      WHEN data BETWEEN DATE(2024,01,02) AND DATE(2024,01,14) THEN DATE(2024,01,02)\n      WHEN data BETWEEN DATE(2024,01,15) AND DATE(2024,01,31) THEN DATE(2024,01,15)\n      WHEN data BETWEEN DATE(2024,02,01) AND DATE(2024,02,18) THEN DATE(2024,02,01) -- OS fev/Q1\n      WHEN data BETWEEN DATE(2024,02,19) AND DATE(2024,02,23) THEN DATE(2024,02,19) -- OS fev/Q2\n      WHEN data BETWEEN DATE(2024,02,24) AND DATE(2024,02,25) THEN DATE(2024,02,25) -- OS fev/Q2 - TIG - OS Ver\u00e3o\n      WHEN data BETWEEN DATE(2024,02,26) AND DATE(2024,03,01) THEN DATE(2024,02,24) -- OS fev/Q2 - TIG\n      WHEN data BETWEEN DATE(2024,03,02) AND DATE(2024,03,10) THEN DATE(2024,03,02) -- OS mar/Q1\n      WHEN data BETWEEN DATE(2024,03,11) AND DATE(2024,03,15) THEN DATE(2024,03,11) -- OS mar/Q1\n      WHEN data BETWEEN DATE(2024,03,16) AND DATE(2024,03,17) THEN DATE(2024,03,12) -- OS mar/Q2\n      WHEN data BETWEEN DATE(2024,03,18) AND DATE(2024,03,29) THEN DATE(2024,03,18) -- OS mar/Q2\n      WHEN data BETWEEN DATE(2024,03,30) AND DATE(2024,04,30) THEN DATE(2024,03,30) -- OS abr/Q1\n      -- 2022:\n      WHEN data BETWEEN DATE(2022,10,1) AND DATE(2022,10,2) THEN DATE(2022,9,16)\n      WHEN data BETWEEN DATE(2022,6,1) AND LAST_DAY(DATE(2022,6,30), MONTH) THEN DATE(2022,6,1)\n      \n        WHEN data BETWEEN DATE(2022,7,1) AND DATE(2022,7,15) THEN DATE(2022,7,1)\n        WHEN data BETWEEN DATE(2022,7,16) AND LAST_DAY(DATE(2022,7,30), MONTH) THEN DATE(2022,7,16)\n      \n        WHEN data BETWEEN DATE(2022,8,1) AND DATE(2022,8,15) THEN DATE(2022,8,1)\n        WHEN data BETWEEN DATE(2022,8,16) AND LAST_DAY(DATE(2022,8,30), MONTH) THEN DATE(2022,8,16)\n      \n        WHEN data BETWEEN DATE(2022,9,1) AND DATE(2022,9,15) THEN DATE(2022,9,1)\n        WHEN data BETWEEN DATE(2022,9,16) AND LAST_DAY(DATE(2022,9,30), MONTH) THEN DATE(2022,9,16)\n      \n        WHEN data BETWEEN DATE(2022,10,1) AND DATE(2022,10,15) THEN DATE(2022,10,1)\n        WHEN data BETWEEN DATE(2022,10,16) AND LAST_DAY(DATE(2022,10,30), MONTH) THEN DATE(2022,10,16)\n      \n        WHEN data BETWEEN DATE(2022,11,1) AND DATE(2022,11,15) THEN DATE(2022,11,1)\n        WHEN data BETWEEN DATE(2022,11,16) AND LAST_DAY(DATE(2022,11,30), MONTH) THEN DATE(2022,11,16)\n      \n        WHEN data BETWEEN DATE(2022,12,1) AND DATE(2022,12,15) THEN DATE(2022,12,1)\n        WHEN data BETWEEN DATE(2022,12,16) AND LAST_DAY(DATE(2022,12,30), MONTH) THEN DATE(2022,12,16)\n      \n      -- 2023 a 2024:\n      \n        \n          WHEN EXTRACT(MONTH FROM data) = 1 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,1,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 2 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,2,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 3 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,3,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 4 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,4,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 5 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,5,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 6 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,6,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 7 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,7,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 8 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,8,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 9 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,9,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 10 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,10,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 11 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,11,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 12 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,12,1)\n        \n      \n        \n          WHEN EXTRACT(MONTH FROM data) = 1 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,1,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 2 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,2,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 3 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,3,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 4 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,4,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 5 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,5,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 6 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,6,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 7 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,7,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 8 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,8,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 9 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,9,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 10 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,10,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 11 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,11,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 12 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,12,1)\n        \n      \n    END AS data_versao_shapes,\n    CASE\n      -- Reveillon 2022:\n      WHEN data = DATE(2022,12,31) THEN data\n      WHEN data = DATE(2023,1,1) THEN data\n      WHEN data BETWEEN DATE(2023,1,2) AND DATE(2023,1,15) THEN DATE(2023,1,2)\n      -- Reprocessamento:\n      WHEN data BETWEEN DATE(2023,1,15) AND DATE(2023,1,31) THEN DATE(2023,1,16)\n      WHEN data BETWEEN DATE(2023,3,16) AND DATE(2023,3,31) THEN DATE(2023,3,16)\n      -- Altera\u00e7\u00e3o de Planejamento\n      WHEN data BETWEEN DATE(2023,6,16) AND DATE(2023,6,30) THEN DATE(2023,6,16)\n      WHEN data BETWEEN DATE(2023,7,16) AND DATE(2023,7,31) THEN DATE(2023,7,16)\n      WHEN data BETWEEN DATE(2023,8,16) AND DATE(2023,8,31) THEN DATE(2023,8,16)\n      WHEN data BETWEEN DATE(2023,9,16) AND DATE(2023,9,30) THEN DATE(2023,9,16)\n      WHEN data BETWEEN DATE(2023,10,16) AND DATE(2023,10,16) THEN DATE(2023,10,16)\n      WHEN data BETWEEN DATE(2023,10,17) AND DATE(2023,10,23) THEN DATE(2023,10,17)\n      WHEN data BETWEEN DATE(2023,10,24) AND DATE(2023,10,31) THEN DATE(2023,10,24)\n      WHEN data = DATE(2023,12,01) THEN data -- Desvio do TIG\n      WHEN data BETWEEN DATE(2023,12,02) AND DATE(2023,12,03) THEN DATE(2023,12,03) -- OS de Ver\u00e3o\n      WHEN data BETWEEN DATE(2023,12,16) AND DATE(2023,12,17) THEN DATE(2023,12,03) -- OS de Ver\u00e3o\n      WHEN data BETWEEN DATE(2023,12,04) AND DATE(2023,12,20) THEN DATE(2023,12,02) -- Fim do desvio do TIG\n      WHEN data BETWEEN DATE(2023,12,21) AND DATE(2023,12,30) THEN DATE(2023,12,21)\n      -- Reveillon 2023:\n      WHEN data = DATE(2023,12,31) THEN data\n      WHEN data = DATE(2024,01,01) THEN data\n      -- 2024:\n      WHEN data BETWEEN DATE(2024,01,06) AND DATE(2024,01,07) THEN DATE(2024,01,03) -- OS de Ver\u00e3o\n      WHEN data BETWEEN DATE(2024,01,02) AND DATE(2024,01,14) THEN DATE(2024,01,02)\n      WHEN data BETWEEN DATE(2024,01,15) AND DATE(2024,01,31) THEN DATE(2024,01,15)\n      WHEN data BETWEEN DATE(2024,02,01) AND DATE(2024,02,18) THEN DATE(2024,02,01) -- OS fev/Q1\n      WHEN data BETWEEN DATE(2024,02,19) AND DATE(2024,02,23) THEN DATE(2024,02,19) -- OS fev/Q2\n      WHEN data BETWEEN DATE(2024,02,24) AND DATE(2024,02,25) THEN DATE(2024,02,25) -- OS fev/Q2 - TIG - OS Ver\u00e3o\n      WHEN data BETWEEN DATE(2024,02,26) AND DATE(2024,03,01) THEN DATE(2024,02,24) -- OS fev/Q2 - TIG\n      WHEN data BETWEEN DATE(2024,03,02) AND DATE(2024,03,10) THEN DATE(2024,03,02) -- OS mar/Q1\n      WHEN data BETWEEN DATE(2024,03,11) AND DATE(2024,03,15) THEN DATE(2024,03,11) -- OS mar/Q1\n      WHEN data BETWEEN DATE(2024,03,16) AND DATE(2024,03,17) THEN DATE(2024,03,12) -- OS mar/Q2\n      WHEN data BETWEEN DATE(2024,03,18) AND DATE(2024,03,29) THEN DATE(2024,03,18) -- OS mar/Q2\n      WHEN data BETWEEN DATE(2024,03,30) AND DATE(2024,04,30) THEN DATE(2024,03,30) -- OS abr/Q1\n      -- 2022:\n      \n        WHEN data BETWEEN DATE(2022,6,1) AND DATE(2022,6,15) THEN DATE(2022,6,1)\n        WHEN data BETWEEN DATE(2022,6,16) AND LAST_DAY(DATE(2022,6,30), MONTH) THEN DATE(2022,6,16)\n      \n        WHEN data BETWEEN DATE(2022,7,1) AND DATE(2022,7,15) THEN DATE(2022,7,1)\n        WHEN data BETWEEN DATE(2022,7,16) AND LAST_DAY(DATE(2022,7,30), MONTH) THEN DATE(2022,7,16)\n      \n        WHEN data BETWEEN DATE(2022,8,1) AND DATE(2022,8,15) THEN DATE(2022,8,1)\n        WHEN data BETWEEN DATE(2022,8,16) AND LAST_DAY(DATE(2022,8,30), MONTH) THEN DATE(2022,8,16)\n      \n        WHEN data BETWEEN DATE(2022,9,1) AND DATE(2022,9,15) THEN DATE(2022,9,1)\n        WHEN data BETWEEN DATE(2022,9,16) AND LAST_DAY(DATE(2022,9,30), MONTH) THEN DATE(2022,9,16)\n      \n        WHEN data BETWEEN DATE(2022,10,1) AND DATE(2022,10,15) THEN DATE(2022,10,1)\n        WHEN data BETWEEN DATE(2022,10,16) AND LAST_DAY(DATE(2022,10,30), MONTH) THEN DATE(2022,10,16)\n      \n        WHEN data BETWEEN DATE(2022,11,1) AND DATE(2022,11,15) THEN DATE(2022,11,1)\n        WHEN data BETWEEN DATE(2022,11,16) AND LAST_DAY(DATE(2022,11,30), MONTH) THEN DATE(2022,11,16)\n      \n        WHEN data BETWEEN DATE(2022,12,1) AND DATE(2022,12,15) THEN DATE(2022,12,1)\n        WHEN data BETWEEN DATE(2022,12,16) AND LAST_DAY(DATE(2022,12,30), MONTH) THEN DATE(2022,12,16)\n      \n      -- 2023 a 2024:\n      \n        \n          WHEN EXTRACT(MONTH FROM data) = 1 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,1,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 2 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,2,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 3 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,3,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 4 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,4,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 5 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,5,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 6 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,6,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 7 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,7,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 8 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,8,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 9 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,9,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 10 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,10,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 11 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,11,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 12 AND EXTRACT(YEAR FROM data) = 2023 THEN DATE(2023,12,1)\n        \n      \n        \n          WHEN EXTRACT(MONTH FROM data) = 1 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,1,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 2 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,2,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 3 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,3,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 4 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,4,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 5 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,5,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 6 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,6,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 7 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,7,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 8 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,8,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 9 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,9,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 10 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,10,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 11 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,11,1)\n        \n          WHEN EXTRACT(MONTH FROM data) = 12 AND EXTRACT(YEAR FROM data) = 2024 THEN DATE(2024,12,1)\n        \n      \n    END AS data_versao_frequencies,\n    CASE\n      WHEN EXTRACT(YEAR FROM data) = 2022 THEN (\n        CASE\n          WHEN EXTRACT(MONTH FROM data) = 6 THEN 2.13\n          WHEN EXTRACT(MONTH FROM data) = 7 THEN 1.84\n          WHEN EXTRACT(MONTH FROM data) = 8 THEN 1.80\n          WHEN EXTRACT(MONTH FROM data) = 9 THEN 1.75\n          WHEN EXTRACT(MONTH FROM data) = 10 THEN 1.62\n          WHEN EXTRACT(MONTH FROM data) = 11 THEN 1.53\n          WHEN EXTRACT(MONTH FROM data) = 12 THEN 1.78\n        END\n      )\n      WHEN EXTRACT(YEAR FROM data) = 2023 THEN (\n        CASE\n          WHEN data <= DATE(\"2023-01-06\") THEN 3.18\n          ELSE 2.81\n        END\n      )\n    END AS valor_subsidio_por_km\n  FROM UNNEST(GENERATE_DATE_ARRAY(\"2022-06-01\", DATE_SUB(\"2024-04-01\", INTERVAL 1 DAY))) AS data),\n  trips AS (\n  SELECT\n    DISTINCT data_versao\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_trips_desaninhada`\n  \n  WHERE\n    data_versao >= DATE_TRUNC(DATE_SUB(DATE(\"2022-01-01T01:00:00\"), INTERVAL 30 DAY), MONTH)\n  \n  ),\n  shapes AS (\n  SELECT\n    DISTINCT data_versao\n  FROM\n    `rj-smtr-staging.projeto_subsidio_sppo_staging.shapes`\n  \n  WHERE\n    data_versao >= DATE_TRUNC(DATE_SUB(DATE(\"2022-01-01T01:00:00\"), INTERVAL 30 DAY), MONTH)\n  \n  ),\n  frequencies AS (\n  SELECT\n    DISTINCT data_versao\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_quadro_horario`\n  \n  WHERE\n    data_versao >= DATE_TRUNC(DATE_SUB(DATE(\"2022-01-01T01:00:00\"), INTERVAL 30 DAY), MONTH)\n  \n  )\nSELECT\n  data,\n  tipo_dia,\n  SAFE_CAST(NULL AS STRING) AS subtipo_dia,\n  COALESCE(t.data_versao, DATE(\"2024-03-30\")) AS data_versao_trips,\n  COALESCE(s.data_versao, DATE(\"2024-03-30\")) AS data_versao_shapes,\n  COALESCE(f.data_versao, DATE(\"2024-03-30\")) AS data_versao_frequencies,\n  valor_subsidio_por_km,\n  SAFE_CAST(NULL AS STRING) AS feed_version,\n  SAFE_CAST(NULL AS DATE)AS feed_start_date,\n  SAFE_CAST(NULL AS STRING) AS tipo_os,\nFROM\n  dates AS d\nLEFT JOIN\n  trips AS t\nON\n  t.data_versao = d.data_versao_trips\nLEFT JOIN\n  shapes AS s\nON\n  s.data_versao = d.data_versao_shapes\nLEFT JOIN\n  frequencies AS f\nON\n  f.data_versao = d.data_versao_frequencies\nWHERE\n\n  data BETWEEN DATE_SUB(DATE(\"2022-01-01T01:00:00\"), INTERVAL 1 DAY) AND DATE(\"2022-01-01T01:00:00\")\n\n\n", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`subsidio_data_versao_efetiva`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:12.580553Z", "completed_at": "2024-09-30T15:22:12.593941Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:12.595681Z", "completed_at": "2024-09-30T15:22:12.595693Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.018088340759277344, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.brt_aux_registros_filtrada", "compiled": true, "compiled_code": "\n/*\n- Descri\u00e7\u00e3o:\nFiltragem e tratamento b\u00e1sico de registros de gps.\n1. Filtra registros antigos. Remove registros que tem diferen\u00e7a maior\n   que 1 minuto entre o timestamp_captura e timestamp_gps.\n2. Filtra registros que est\u00e3o fora de uma caixa que cont\u00e9m a \u00e1rea do\n   munic\u00edpio de Rio de Janeiro.\n*/\nWITH\nbox AS (\n  /*1. Geometria de caixa que cont\u00e9m a \u00e1rea do munic\u00edpio de Rio de Janeiro.*/\n\tSELECT\n\t*\n\tFROM\n\trj-smtr.br_rj_riodejaneiro_geo.limites_geograficos_caixa),\ngps AS (\n  /* 1. Filtra registros antigos. Remove registros que tem diferen\u00e7a maior\n   que 1 minuto entre o timestamp_captura e timestamp_gps.*/\n  SELECT\n    *,\n    ST_GEOGPOINT(longitude, latitude) posicao_veiculo_geo\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_registros_desaninhada`\n  WHERE\n    data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <= \"2022-01-01T01:00:00\"\n    AND DATETIME_DIFF(timestamp_captura, timestamp_gps, MINUTE) BETWEEN 0 AND 1\n    ),\nfiltrada AS (\n  /* 2. Filtra registros que est\u00e3o fora de uma caixa que cont\u00e9m a \u00e1rea do\n   munic\u00edpio de Rio de Janeiro.*/\n  SELECT\n    id_veiculo,\n    latitude,\n    longitude,\n    posicao_veiculo_geo,\n    velocidade,\n    servico,\n    timestamp_gps,\n    timestamp_captura,\n    data,\n    hora,\n    row_number() over (partition by id_veiculo, timestamp_gps, servico) rn\n  FROM\n    gps\n  WHERE\n    ST_INTERSECTSBOX(posicao_veiculo_geo,\n      ( SELECT min_longitude FROM box),\n      ( SELECT min_latitude FROM box),\n      ( SELECT max_longitude FROM box),\n      ( SELECT max_latitude FROM box))\n  )\nSELECT\n  * except(rn),\n  \"\" as versao\nFROM\n  filtrada\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_aux_registros_filtrada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:12.609384Z", "completed_at": "2024-09-30T15:22:15.437111Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:15.438691Z", "completed_at": "2024-09-30T15:22:15.438705Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.8325161933898926, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.shapes_geom_gtfs", "compiled": true, "compiled_code": "\n\n\n  \n\n\nWITH contents AS (\n    SELECT\n        shape_id,\n        ST_GEOGPOINT(shape_pt_lon, shape_pt_lat) AS ponto_shape,\n        shape_pt_sequence,\n        feed_start_date,\n    FROM `rj-smtr`.`gtfs`.`shapes` s\n    WHERE feed_start_date IN ('2024-04-15', '2024-05-03')\n),\npts AS (\n    SELECT *,\n        MAX(shape_pt_sequence) OVER(PARTITION BY feed_start_date, shape_id) final_pt_sequence\n    FROM contents c\n    ORDER BY feed_start_date,\n        shape_id,\n        shape_pt_sequence\n),\nshapes AS (\n    -- BUILD LINESTRINGS OVER SHAPE POINTS\n    SELECT\n        shape_id,\n        feed_start_date,\n        ST_MAKELINE(ARRAY_AGG(ponto_shape)) AS shape,\n        ARRAY_AGG(ponto_shape)[ORDINAL(1)] AS start_pt,\n        ARRAY_AGG(ponto_shape)[ORDINAL(ARRAY_LENGTH(ARRAY_AGG(ponto_shape)))] AS end_pt,\n    FROM pts\n    GROUP BY 1,\n            2\n),\nshapes_half AS (\n    -- BUILD HALF LINESTRINGS OVER SHAPE POINTS\n    (\n        SELECT\n            shape_id,\n            feed_start_date,\n            shape_id || \"_0\" AS new_shape_id,\n            ST_MAKELINE(ARRAY_AGG(ponto_shape)) AS shape,\n            ARRAY_AGG(ponto_shape)[ORDINAL(1)] AS start_pt,\n            ARRAY_AGG(ponto_shape)[ORDINAL(ARRAY_LENGTH(ARRAY_AGG(ponto_shape)))] AS end_pt,\n        FROM\n            pts\n        WHERE\n            shape_pt_sequence <= ROUND(final_pt_sequence / 2)\n        GROUP BY\n            1,\n            2\n    )\n    UNION ALL\n    (\n        SELECT\n            shape_id,\n            feed_start_date,\n            shape_id || \"_1\" AS new_shape_id,\n            ST_MAKELINE(ARRAY_AGG(ponto_shape)) AS shape,\n            ARRAY_AGG(ponto_shape)[ORDINAL(1)] AS start_pt,\n            ARRAY_AGG(ponto_shape)[ORDINAL(ARRAY_LENGTH(ARRAY_AGG(ponto_shape)))] AS end_pt,\n        FROM\n            pts\n        WHERE\n            shape_pt_sequence > ROUND(final_pt_sequence / 2)\n        GROUP BY\n            1,\n            2\n    )\n),\nids AS (\n    SELECT\n      * EXCEPT(rn)\n    FROM\n    (\n        SELECT\n            feed_start_date,\n            shape_id,\n            shape,\n            start_pt,\n            end_pt,\n            ROW_NUMBER() OVER(PARTITION BY feed_start_date, shape_id) rn\n        FROM\n            shapes\n    )\n    WHERE rn = 1\n),\nunion_shapes AS (\n  (\n    SELECT\n        feed_start_date,\n        shape_id,\n        shape,\n        start_pt,\n        end_pt,\n    FROM\n        ids\n  )\n  UNION ALL\n  (\n    SELECT\n        feed_start_date,\n        new_shape_id AS shape_id,\n        s.shape,\n        s.start_pt,\n        s.end_pt,\n    FROM\n        ids AS i\n    LEFT JOIN\n        shapes_half AS s\n    USING\n        (feed_start_date, shape_id)\n    WHERE\n        ROUND(ST_Y(i.start_pt),4) = ROUND(ST_Y(i.end_pt),4)\n        AND ROUND(ST_X(i.start_pt),4) = ROUND(ST_X(i.end_pt),4)\n  )\n)\nSELECT\n    feed_version,\n    feed_start_date,\n    feed_end_date,\n    shape_id,\n    shape,\n    ROUND(ST_LENGTH(shape), 1) shape_distance,\n    start_pt,\n    end_pt,\n    '' as versao_modelo\nFROM union_shapes AS m\nLEFT JOIN\n    `rj-smtr`.`gtfs`.`feed_info` AS fi\nUSING\n    (feed_start_date)\nWHERE\n    fi.feed_start_date IN ('2024-04-15', '2024-05-03')", "relation_name": "`rj-smtr`.`gtfs`.`shapes_geom`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:15.455072Z", "completed_at": "2024-09-30T15:22:15.459999Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:15.461263Z", "completed_at": "2024-09-30T15:22:15.461273Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00927591323852539, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_my_second_dbt_model_id.151b76d778", "compiled": true, "compiled_code": "\nSELECT\n    id\nFROM\n    `rj-smtr`.`dbt`.`my_second_dbt_model`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`dbt`.`my_second_dbt_model`)\nAND\n    id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:15.465059Z", "completed_at": "2024-09-30T15:22:15.473124Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:15.474386Z", "completed_at": "2024-09-30T15:22:15.474396Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011713266372680664, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_my_second_dbt_model_id.57a0f8c493", "compiled": true, "compiled_code": "\n    \n    \n\nwith dbt_test__target as (\n\n  select id as unique_field\n  from `rj-smtr`.`dbt`.`my_second_dbt_model`\n  where id is not null\n\n)\n\nselect\n    unique_field,\n    count(*) as n_records\n\nfrom dbt_test__target\ngroup by unique_field\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:15.478264Z", "completed_at": "2024-09-30T15:22:15.482337Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:15.483616Z", "completed_at": "2024-09-30T15:22:15.483625Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0077495574951171875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.trips_desaninhada", "compiled": true, "compiled_code": "with contents as (\n  select\n    trip_id,\n    json_value(content, \"$.route_id\") route_id,\n    json_value(content, \"$.service_id\") service_id,\n    json_value(content, \"$.trip_headsign\") trip_headsign,\n    json_value(content, \"$.trip_short_name\") trip_short_name,\n    json_value(content, \"$.direction_id\") direction_id,\n    json_value(content, \"$.block_id\") block_id,\n    json_value(content, \"$.shape_id\") shape_id,\n    json_value(content, \"$.variacao_itinerario\") variacao_itinerario,\n    json_value(content, \"$.versao\") versao,\n    json_value(content, \"$.complemento\") complemento,\n    json_value(content, \"$.via\") via,\n    json_value(content, \"$.observacoes\") observacoes,\n    json_value(content, \"$.ultima_medicao_operante\") ultima_medicao_operante,\n    json_value(content, \"$.idModalSmtr\") id_modal_smtr,\n    json_value(content, \"$.Direcao\") direcao,\n    json_value(content, \"$.id\") id,\n    DATE(data_versao) data_versao\n\n  from `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips`\n),\nroutes as (\n  select\n    *\n  from `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes_desaninhada`\n),\nultimas_versoes as (\n  select\n    c.*,\n    row_number() over(\n      partition by c.data_versao, c.route_id, c.direction_id, c.variacao_itinerario\n      order by c.versao desc\n    ) rn\n  from contents c\n  join routes r\n  on c.route_id = r.route_id\n  and c.data_versao = r.data_versao\n)\nselect\n  * except(rn)\nfrom ultimas_versoes\nwhere rn=1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips_desaninhada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:15.487449Z", "completed_at": "2024-09-30T15:22:15.494113Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:15.496505Z", "completed_at": "2024-09-30T15:22:15.496518Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011711835861206055, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_routes_desaninhada_route_id__data_versao.dd77dca831", "compiled": true, "compiled_code": "\nSELECT\n    route_id\nFROM\n    `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes_desaninhada`\nWHERE\n    data_versao = (SELECT MAX(data_versao) FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes_desaninhada`)\nAND\n    route_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:15.502371Z", "completed_at": "2024-09-30T15:22:15.515798Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:15.517124Z", "completed_at": "2024-09-30T15:22:15.517134Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01754283905029297, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_key_routes_desaninhada_route_id____data_versao.c670eae320", "compiled": true, "compiled_code": "\nSELECT\n    *\nFROM (\n    SELECT\n        route_id,\n        data_versao,\n        ROW_NUMBER() over (partition by route_id) rn\n    FROM\n        `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes_desaninhada`\n    WHERE\n        data_versao = (select max(data_versao) from `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes_desaninhada`)\n)\n\nWHERE rn>1\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:15.521972Z", "completed_at": "2024-09-30T15:22:15.529868Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:15.531223Z", "completed_at": "2024-09-30T15:22:15.531233Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012467145919799805, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_aux_registros_filtrada", "compiled": true, "compiled_code": "\n\n\n\n  /*\nDescri\u00e7\u00e3o:\nFiltragem e tratamento b\u00e1sico de registros de gps.\n1. Filtra registros que est\u00e3o fora de uma caixa que cont\u00e9m a \u00e1rea do munic\u00edpio de Rio de Janeiro.\n2. Filtra registros antigos. Remove registros que tem diferen\u00e7a maior que 1 minuto entre o timestamp_captura e timestamp_gps.\n3. Muda o nome de vari\u00e1veis para o padr\u00e3o do projeto.\n\t- id_veiculo --> ordem\n*/\nWITH\nbox AS (\n  /*1. Geometria de caixa que cont\u00e9m a \u00e1rea do munic\u00edpio de Rio de Janeiro.*/\n\tSELECT\n\t*\n\tFROM\n\trj-smtr.br_rj_riodejaneiro_geo.limites_geograficos_caixa\n),\ngps AS (\n  /*2. Filtra registros antigos. Remove registros que tem diferen\u00e7a maior que 1 minuto entre o timestamp_captura e timestamp_gps.*/\n  SELECT\n    *,\n    ST_GEOGPOINT(longitude, latitude) posicao_veiculo_geo\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_registros`\n  WHERE\n    data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n  AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"),\nrealocacao as (\n  SELECT\n    g.* except(linha),\n    coalesce(r.servico_realocado, g.linha) as linha\n  FROM\n    gps g\n  LEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_realocacao` r\n  ON\n    g.ordem = r.id_veiculo\n    and g.timestamp_gps = r.timestamp_gps\n),\nfiltrada AS (\n  /*1,2, e 3. Muda o nome de vari\u00e1veis para o padr\u00e3o do projeto.*/\n  SELECT\n    ordem AS id_veiculo,\n    latitude,\n    longitude,\n    posicao_veiculo_geo,\n    velocidade,\n    linha,\n    timestamp_gps,\n    timestamp_captura,\n    data,\n    hora,\n    row_number() over (partition by ordem, timestamp_gps, linha) rn\n  FROM\n    realocacao\n  WHERE\n    ST_INTERSECTSBOX(posicao_veiculo_geo,\n      ( SELECT min_longitude FROM box),\n      ( SELECT min_latitude FROM box),\n      ( SELECT max_longitude FROM box),\n      ( SELECT max_latitude FROM box))\n  )\nSELECT\n  * except(rn),\n  \"\" as versao\nFROM\n  filtrada\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_filtrada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:15.536332Z", "completed_at": "2024-09-30T15:22:15.544894Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:15.546184Z", "completed_at": "2024-09-30T15:22:15.546194Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012557029724121094, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_aux_registros_filtrada_zirix", "compiled": true, "compiled_code": "\n  /*\nDescri\u00e7\u00e3o:\nFiltragem e tratamento b\u00e1sico de registros de gps.\n1. Filtra registros que est\u00e3o fora de uma caixa que cont\u00e9m a \u00e1rea do munic\u00edpio de Rio de Janeiro.\n2. Filtra registros antigos. Remove registros que tem diferen\u00e7a maior que 1 minuto entre o timestamp_captura e timestamp_gps.\n3. Muda o nome de vari\u00e1veis para o padr\u00e3o do projeto.\n\t- id_veiculo --> ordem\n*/\nWITH\nbox AS (\n  /*1. Geometria de caixa que cont\u00e9m a \u00e1rea do munic\u00edpio de Rio de Janeiro.*/\n\tSELECT\n\t*\n\tFROM\n\trj-smtr.br_rj_riodejaneiro_geo.limites_geograficos_caixa\n),\ngps AS (\n  /*2. Filtra registros antigos. Remove registros que tem diferen\u00e7a maior que 1 minuto entre o timestamp_captura e timestamp_gps.*/\n  SELECT\n    *,\n    ST_GEOGPOINT(longitude, latitude) posicao_veiculo_geo\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_registros`\n  WHERE\n    data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"),\nrealocacao as (\n  SELECT\n    g.* except(linha),\n    coalesce(r.servico_realocado, g.linha) as linha\n  FROM\n    gps g\n  LEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_aux_registros_realocacao` r\n  ON\n    g.ordem = r.id_veiculo\n    and g.timestamp_gps = r.timestamp_gps\n),\nfiltrada AS (\n  /*1,2, e 3. Muda o nome de vari\u00e1veis para o padr\u00e3o do projeto.*/\n  SELECT\n    ordem AS id_veiculo,\n    latitude,\n    longitude,\n    posicao_veiculo_geo,\n    velocidade,\n    linha,\n    timestamp_gps,\n    timestamp_captura,\n    data,\n    hora,\n    row_number() over (partition by ordem, timestamp_gps, linha) rn\n  FROM\n    realocacao\n  WHERE\n    ST_INTERSECTSBOX(posicao_veiculo_geo,\n      ( SELECT min_longitude FROM box),\n      ( SELECT min_latitude FROM box),\n      ( SELECT max_longitude FROM box),\n      ( SELECT max_latitude FROM box))\n  )\nSELECT\n  * except(rn),\n  \"\" as versao\nFROM\n  filtrada\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_aux_registro_filtrada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:15.550001Z", "completed_at": "2024-09-30T15:22:19.360663Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:19.364171Z", "completed_at": "2024-09-30T15:22:19.364189Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.8171699047088623, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_licenciamento", "compiled": true, "compiled_code": "-- depends_on: __dbt__cte__aux_sppo_licenciamento_vistoria_atualizada\n\n\n\n  \n\n\nwith\n     __dbt__cte__aux_sppo_licenciamento_vistoria_atualizada as (\n\n\n/* Dados auxiliares de vistoria de \u00f4nibus levantados pela Coordenadoria Geral de Licenciamento e Fiscaliza\u00e7\u00e3o (TR/SUBTT/CGLF),\npara atualiza\u00e7\u00e3o da data de \u00faltima vistoria informada no sistema (STU). */\n\nSELECT\n  data,\n  id_veiculo,\n  placa,\n  MAX(ano_ultima_vistoria) AS ano_ultima_vistoria,\nFROM\n    (\n        SELECT\n            data,\n            id_veiculo,\n            placa,\n            ano_ultima_vistoria,\n        FROM\n            `rj-smtr`.`veiculo_staging`.`sppo_vistoria_tr_subtt_cglf_2023`\n        UNION ALL\n        SELECT\n            data,\n            id_veiculo,\n            placa,\n            ano_ultima_vistoria,\n        FROM\n            `rj-smtr`.`veiculo_staging`.`sppo_vistoria_tr_subtt_cglf_2024`\n        UNION ALL\n        SELECT\n            data,\n            id_veiculo,\n            placa,\n            ano_ultima_vistoria,\n        FROM\n            `rj-smtr`.`veiculo_staging`.`sppo_vistoria_tr_subtt_cglf_pendentes_2024`\n    )\nGROUP BY\n  1,\n  2,\n  3\n), -- Tabela de licenciamento\n    stu as (\n        select\n            * except(data),\n            date(data) AS data\n        from\n            `rj-smtr`.`veiculo_staging`.`sppo_licenciamento_stu` as t\n        where\n            date(data) = date(\"2023-02-01\")\n            and tipo_veiculo not like \"%ROD%\"\n    ),\n    stu_rn AS (\n        select\n            * except (timestamp_captura),\n            EXTRACT(YEAR FROM data_ultima_vistoria) AS ano_ultima_vistoria,\n            ROW_NUMBER() OVER (PARTITION BY data, id_veiculo) rn\n        from\n            stu\n    ),\n    stu_ano_ultima_vistoria AS (\n        -- Temporariamente considerando os dados de vistoria enviados pela TR/SUBTT/CGLF\n        \n        SELECT\n            s.* EXCEPT(ano_ultima_vistoria),\n            s.ano_ultima_vistoria AS ano_ultima_vistoria_atualizado,\n        FROM\n            stu_rn AS s\n        \n    )\nselect\n  * except(rn),\nfrom\n  stu_ano_ultima_vistoria\nwhere\n  rn = 1", "relation_name": "`rj-smtr`.`veiculo`.`sppo_licenciamento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:19.370312Z", "completed_at": "2024-09-30T15:22:19.375793Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:19.377270Z", "completed_at": "2024-09-30T15:22:19.377280Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010116100311279297, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.pagamento_bilhetagem_jae", "compiled": true, "compiled_code": "\n\n\nWITH arquivo_retorno AS (\n  SELECT\n    id,\n    DATE(dataVencimento) AS data,\n    dataVencimento AS datetime_pagamento,\n    timestamp_captura AS datetime_captura,\n    idConsorcio AS id_consorcio,\n    idOperadora AS id_operadora,\n    dataOrdem AS data_ordem,\n    idOrdemPagamento AS id_ordem_pagamento,\n    favorecido,\n    valor AS valor_ordem,\n    valorRealEfetivado AS valor_pago,\n    isPago AS indicador_pagamento_realizado\n  FROM\n    `rj-smtr`.`controle_financeiro_staging`.`arquivo_retorno`\n),\narquivo_retorno_deduplicado AS (\n  SELECT\n    * EXCEPT(rn)\n  FROM\n  (\n    SELECT\n      *,\n      ROW_NUMBER() OVER (PARTITION BY id_consorcio, id_operadora, data_ordem ORDER BY indicador_pagamento_realizado DESC, datetime_captura DESC) AS rn\n    FROM\n      arquivo_retorno\n  )\n  WHERE\n    rn = 1\n)\nSELECT\n  a.data,\n  a.datetime_pagamento,\n  a.datetime_captura,\n  a.id_consorcio,\n  a.id_operadora,\n  c.modo,\n  CASE\n    WHEN c.modo = \"Van\" THEN c.consorcio\n    ELSE a.favorecido\n  END AS favorecido,\n  a.data_ordem,\n  a.id_ordem_pagamento,\n  a.valor_ordem,\n  a.valor_pago,\n  a.indicador_pagamento_realizado,\n  '' AS versao\nFROM\n  arquivo_retorno_deduplicado a\nLEFT JOIN\n  `rj-smtr`.`cadastro`.`consorcios` c\nUSING(id_consorcio)", "relation_name": "`rj-smtr`.`controle_financeiro`.`pagamento_bilhetagem_jae`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:19.381763Z", "completed_at": "2024-09-30T15:22:19.387693Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:19.388998Z", "completed_at": "2024-09-30T15:22:19.389007Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010212898254394531, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.passageiro_gratuidade", "compiled": true, "compiled_code": "\n\nWITH consorcio AS (\n  SELECT\n    id_consorcio,\n    modo\n  FROM\n    `rj-smtr`.`cadastro`.`consorcios`\n    -- rj-smtr.cadastro.consorcios\n  WHERE\n    modo IN (\"\u00d4nibus\", \"BRT\")\n)\nSELECT\n  DATE_TRUNC(data, MONTH) AS data,\n  rdo.ano,\n  rdo.mes,\n  c.modo,\n  SUM(rdo.qtd_grt_idoso + rdo.qtd_grt_especial +\n      rdo.qtd_grt_estud_federal + rdo.qtd_grt_estud_estadual +\n      rdo.qtd_grt_estud_municipal + rdo.qtd_grt_rodoviario +\n      rdo.qtd_grt_passe_livre_universitario) AS quantidade_passageiro_gratuidade_mes,\n  CURRENT_DATE(\"America/Sao_Paulo\") AS data_ultima_atualizacao,\n  '' as versao\nFROM\n  consorcio AS c\nLEFT JOIN\n  `rj-smtr`.`br_rj_riodejaneiro_rdo`.`rdo40_tratado` AS rdo\nON\n  rdo.termo = c.id_consorcio\nWHERE\n  rdo.data >= \"2015-01-01\"\n  \n  AND rdo.data BETWEEN DATE_TRUNC(DATE(\"2022-01-01T01:00:00\"), MONTH)\n  AND LAST_DAY(DATE(\"2022-01-01T01:00:00\"), MONTH)\n  AND rdo.data < DATE_TRUNC(CURRENT_DATE(\"America/Sao_Paulo\"), MONTH)\n  \nGROUP BY\n  data,\n  rdo.ano,\n  rdo.mes,\n  c.modo", "relation_name": "`rj-smtr`.`indicadores_continuados_egp_staging`.`passageiro_gratuidade`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:19.393385Z", "completed_at": "2024-09-30T15:22:19.403230Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:19.404543Z", "completed_at": "2024-09-30T15:22:19.404553Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013692378997802734, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.passageiro_pagante", "compiled": true, "compiled_code": "\n\nWITH consorcio AS (\n  SELECT\n    id_consorcio,\n    modo\n  FROM\n    `rj-smtr`.`cadastro`.`consorcios`\n    -- rj-smtr.cadastro.consorcios\n  WHERE\n    modo IN (\"\u00d4nibus\", \"BRT\")\n)\nSELECT\n  DATE_TRUNC(data, MONTH) AS data,\n  rdo.ano,\n  rdo.mes,\n  c.modo,\n  SUM(qtd_buc_1_perna+qtd_buc_2_perna_integracao+\n      qtd_buc_supervia_1_perna+qtd_buc_supervia_2_perna_integracao+\n      qtd_cartoes_perna_unica_e_demais+qtd_pagamentos_especie) AS quantidade_passageiro_pagante_mes,\n  CURRENT_DATE(\"America/Sao_Paulo\") AS data_ultima_atualizacao,\n  '' as versao\nFROM\n  consorcio AS c\nLEFT JOIN\n  `rj-smtr`.`br_rj_riodejaneiro_rdo`.`rdo40_tratado` AS rdo\nON\n  rdo.termo = c.id_consorcio\nWHERE\n  rdo.data >= \"2015-01-01\"\n  \n  AND rdo.data BETWEEN DATE_TRUNC(DATE(\"2022-01-01T01:00:00\"), MONTH)\n  AND LAST_DAY(DATE(\"2022-01-01T01:00:00\"), MONTH)\n  AND rdo.data < DATE_TRUNC(CURRENT_DATE(\"America/Sao_Paulo\"), MONTH)\n  \nGROUP BY\n  data,\n  rdo.ano,\n  rdo.mes,\n  c.modo", "relation_name": "`rj-smtr`.`indicadores_continuados_egp_staging`.`passageiro_pagante`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:19.408322Z", "completed_at": "2024-09-30T15:22:19.412225Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:19.413471Z", "completed_at": "2024-09-30T15:22:19.413479Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007474184036254883, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.rdo40_registros", "compiled": true, "compiled_code": "WITH\n  consorcios AS (\n  SELECT\n    id_consorcio,\n    case when id_consorcio = \"221000050\" then \"Cons\u00f3rcio BRT\" else consorcio end as consorcio\n  FROM\n    -- rj-smtr.cadastro.consorcios\n    `rj-smtr`.`cadastro`.`consorcios` )\nSELECT\n  data,\n  ano,\n  mes,\n  dia,\n  id_consorcio,\n  consorcio,\n  linha AS servico,\n  r.* EXCEPT(data,\n    ano,\n    mes,\n    dia,\n    termo),\n  (qtd_grt_idoso + qtd_grt_especial + qtd_grt_estud_federal + qtd_grt_estud_estadual + qtd_grt_estud_municipal + qtd_grt_rodoviario + qtd_buc_1_perna + qtd_buc_2_perna_integracao + qtd_buc_supervia_1_perna + qtd_buc_supervia_2_perna_integracao + qtd_cartoes_perna_unica_e_demais + qtd_pagamentos_especie + qtd_grt_passe_livre_universitario) AS qtd_passageiros_total\nFROM\n  `rj-smtr`.`br_rj_riodejaneiro_rdo`.`rdo40_tratado` r\nLEFT JOIN\n  consorcios c\nON\n  r.termo = c.id_consorcio", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_rdo`.`rdo40_registros`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:19.417315Z", "completed_at": "2024-09-30T15:22:19.424889Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:19.426144Z", "completed_at": "2024-09-30T15:22:19.426154Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011205434799194336, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.aux_transacao_ordem", "compiled": true, "compiled_code": "\n\n-- WITH servico_motorista AS (\n--     SELECT\n--         * EXCEPT(rn)\n--     FROM\n--     (\n--         SELECT\n--             id_servico,\n--             dt_fechamento,\n--             nr_logico_midia,\n--             cd_linha,\n--             cd_operadora,\n--             ROW_NUMBER() OVER (PARTITION BY id_servico, nr_logico_midia ORDER BY timestamp_captura DESC) AS rn\n--         FROM\n--             `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`servico_motorista`\n--         \n--     )\n-- ),\nWITH transacao AS (\n  SELECT\n    t.id AS id_transacao,\n    t.timestamp_captura,\n    DATE(t.data_transacao) AS data_transacao,\n    DATE(t.data_processamento) AS data_processamento,\n    t.data_processamento AS datetime_processamento,\n    t.cd_linha AS id_servico_jae,\n    do.id_operadora,\n    t.valor_transacao,\n    t.tipo_transacao,\n    t.id_tipo_modal,\n    dc.id_consorcio,\n    -- sm.dt_fechamento AS datetime_fechamento_servico,\n    -- sm.cd_linha AS cd_linha_servico,\n    -- sm.cd_operadora AS cd_operadora_servico,\n    t.id_servico\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`transacao` t\n  -- LEFT JOIN\n  --     servico_motorista sm\n  -- ON\n  --     sm.id_servico = t.id_servico\n  --     AND sm.nr_logico_midia = t.nr_logico_midia_operador\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`operadoras` AS do\n  ON\n    t.cd_operadora = do.id_operadora_jae\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`consorcios` AS dc\n  ON\n    t.cd_consorcio = dc.id_consorcio_jae\n  WHERE\n    \n      DATE(t.data) <= CURRENT_DATE(\"America/Sao_Paulo\")\n      AND DATE(t.data_processamento) <= CURRENT_DATE(\"America/Sao_Paulo\")\n    \n),\ntransacao_deduplicada AS (\n  SELECT\n    t.* EXCEPT(rn),\n    DATE_ADD(data_processamento, INTERVAL 1 DAY) AS data_ordem -- TODO: Regra da data por servi\u00e7os fechados no modo \u00d4nibus quando come\u00e7ar a opera\u00e7\u00e3o\n  FROM\n  (\n    SELECT\n      *,\n      ROW_NUMBER() OVER (PARTITION BY id_transacao ORDER BY timestamp_captura DESC) AS rn\n    FROM\n      transacao\n  ) t\n  WHERE\n    rn = 1\n)\nSELECT\n  t.*\nFROM\n  transacao_deduplicada t\nLEFT JOIN\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_sem_ressarcimento` l\nON\n  t.id_servico_jae = l.id_linha\nWHERE\n  -- Remove dados com data de ordem de pagamento maiores que a execu\u00e7\u00e3o do modelo\n  \n    t.data_ordem <= CURRENT_DATE(\"America/Sao_Paulo\")\n  \n  -- Remove linhas de teste que n\u00e3o entram no ressarcimento\n  AND l.id_linha IS NULL\n  -- Remove gratuidades e transfer\u00eancias da contagem de transa\u00e7\u00f5es\n  AND tipo_transacao NOT IN ('5', '21', '40')", "relation_name": "`rj-smtr`.`validacao_dados_jae_staging`.`aux_transacao_ordem`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:19.429885Z", "completed_at": "2024-09-30T15:22:19.434031Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:19.435296Z", "completed_at": "2024-09-30T15:22:19.435304Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007744312286376953, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.operadoras_contato", "compiled": true, "compiled_code": "\n\n\nSELECT\n  d.id_operadora,\n  cpj.nm_contato AS contato,\n  cpj.nr_ramal AS ramal,\n  COALESCE(cpj.nr_telefone, c.nr_telefone) AS telefone,\n  COALESCE(cpj.tx_email, c.tx_email) AS email\nFROM\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`cliente` AS c\nLEFT JOIN\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`contato_pessoa_juridica` cpj\nON\n  c.cd_cliente = cpj.cd_cliente\nJOIN\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`operadora_transporte` AS ot\nON\n  ot.cd_cliente = c.cd_cliente\nJOIN\n  `rj-smtr`.`cadastro`.`operadoras` d\nON d.id_operadora_jae = ot.cd_operadora_transporte", "relation_name": "`rj-smtr`.`cadastro`.`operadoras_contato`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:19.439210Z", "completed_at": "2024-09-30T15:22:40.832747Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:40.834645Z", "completed_at": "2024-09-30T15:22:40.834658Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 21.398159980773926, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.transacao_riocard", "compiled": true, "compiled_code": "\n\n\n\n\n\n  \n\n  \n\n\nWITH staging_transacao AS (\n  SELECT\n    *\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`transacao_riocard`\n  \n    WHERE\n      \n  DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n  AND timestamp_captura BETWEEN DATETIME(\"2022-01-01T00:00:00\") AND DATETIME(\"2022-01-01T01:00:00\")\n\n  \n),\nnovos_dados AS (\n  SELECT\n    EXTRACT(DATE FROM t.data_transacao) AS data,\n    EXTRACT(HOUR FROM t.data_transacao) AS hora,\n    t.data_transacao AS datetime_transacao,\n    t.data_processamento AS datetime_processamento,\n    t.timestamp_captura AS datetime_captura,\n    COALESCE(do.modo, dc.modo) AS modo,\n    dc.id_consorcio,\n    dc.consorcio,\n    do.id_operadora,\n    do.operadora,\n    t.cd_linha AS id_servico_jae,\n    l.nr_linha AS servico_jae,\n    l.nm_linha AS descricao_servico_jae,\n    t.sentido,\n    CASE\n      WHEN do.modo = \"VLT\" THEN SUBSTRING(t.veiculo_id, 1, 3)\n      WHEN do.modo = \"BRT\" THEN NULL\n      ELSE t.veiculo_id\n    END AS id_veiculo,\n    t.numero_serie_validador AS id_validador,\n    t.id AS id_transacao,\n    t.latitude_trx AS latitude,\n    t.longitude_trx AS longitude,\n    ST_GEOGPOINT(t.longitude_trx, t.latitude_trx) AS geo_point_transacao,\n    t.valor_transacao\n  FROM\n    staging_transacao t\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`operadoras` do\n  ON\n    t.cd_operadora = do.id_operadora_jae\n  LEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha` l\n  ON\n    t.cd_linha = l.cd_linha\n  LEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_consorcio` lc\n  ON\n    t.cd_linha = lc.cd_linha\n    AND (\n      t.data_transacao BETWEEN lc.dt_inicio_validade AND lc.dt_fim_validade\n      OR lc.dt_fim_validade IS NULL\n    )\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`consorcios` dc\n  ON\n    lc.cd_consorcio = dc.id_consorcio_jae\n),\n-- consorcios AS (\n--   SELECT\n--     t.data,\n--     t.hora,\n--     t.datetime_transacao,\n--     t.datetime_processamento,\n--     t.datetime_captura,\n--     COALESCE(t.modo, dc.modo) AS modo,\n--     dc.id_consorcio,\n--     dc.consorcio,\n--     t.id_operadora,\n--     t.operadora,\n--     t.id_servico_jae,\n--     t.servico_jae,\n--     t.descricao_servico_jae,\n--     t.sentido,\n--     t.id_veiculo,\n--     t.id_validador,\n--     t.id_transacao,\n--     t.latitude,\n--     t.longitude,\n--     t.valor_transacao\n--   FROM\n--     novos_dados t\n--   LEFT JOIN\n--     `rj-smtr`.`cadastro`.`consorcios` dc\n--   USING(id_consorcio_jae)\n-- ),\nparticoes_completas AS (\n  SELECT\n    *,\n    0 AS priority\n  FROM\n    novos_dados\n\n  \n),\ntransacao_deduplicada AS (\n  SELECT\n    * EXCEPT(rn, priority)\n  FROM\n  (\n    SELECT\n      *,\n      ROW_NUMBER() OVER (PARTITION BY id_transacao ORDER BY datetime_captura DESC, priority) AS rn\n    FROM\n      particoes_completas\n  )\n  WHERE\n    rn = 1\n)\nSELECT\n  *,\n  '' AS versao\nFROM\n  transacao_deduplicada", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao_riocard`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:40.838917Z", "completed_at": "2024-09-30T15:22:40.847609Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:40.848870Z", "completed_at": "2024-09-30T15:22:40.848880Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012412548065185547, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.recursos_sppo_bloqueio_via", "compiled": true, "compiled_code": "\n\nWITH exploded AS (\n  SELECT\n    id_recurso,\n    datetime_recurso,\n    datetime_captura,\n    datetime_update,\n    SAFE_CAST(COALESCE(JSON_VALUE(items, '$.value'), JSON_VALUE(items, '$.items[0].customFieldItem')) AS STRING\n    ) AS value,\n    SAFE_CAST(JSON_EXTRACT(items, '$.customFieldId') AS STRING ) AS field_id\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`staging_recursos_sppo_bloqueio_via`,\n    UNNEST(items) items\n  WHERE\n      DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\")\n        AND DATE(\"2022-01-01T01:00:00\")\n),\npivotado AS (\n  SELECT *,\n  ROW_NUMBER() OVER(PARTITION BY id_recurso ORDER BY datetime_captura DESC) AS rn,\n  FROM\n    exploded PIVOT(\n      ANY_VALUE(value) FOR field_id IN (\n        '111870', '111871', '111872',\n        '111901', '111865', '111867', '111868',\n        '111869', '111866', '111904', '125615',\n        '111900', '111874'\n      )\n    )\n),\ntratado AS (\n  SELECT\n    id_recurso,\n    datetime_captura,\n    datetime_recurso,\n    datetime_update,\n    SAFE_CAST(p.111865 AS STRING) AS julgamento,\n    SAFE_CAST(p.111870 AS STRING) AS consorcio,\n    CASE\n      WHEN SAFE_CAST(p.111872 AS STRING) = \"SR - Regular\" THEN SAFE_CAST(p.111871 AS STRING)\n      ELSE CONCAT(REPLACE(SPLIT(SAFE_CAST(p.111872 AS STRING), \"-\")[OFFSET(0)], \" \", \"\"), SAFE_CAST(p.111871 AS STRING))\n    END AS servico,\n     CASE\n        WHEN SAFE_CAST(p.111901 AS STRING) = \"Ida\" THEN \"I\"\n        WHEN SAFE_CAST(p.111901 AS STRING) = \"Volta\" THEN \"V\"\n        WHEN SAFE_CAST(p.111901 AS STRING) = \"Circular\" THEN \"C\"\n    END\n      AS sentido,\n    PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez',SAFE_CAST(p.111867 AS STRING), 'America/Sao_Paulo') AS data_viagem,\n    SAFE_CAST(p.111874 AS STRING) AS numero_relatorio_cimu,\n    COALESCE(SAFE_CAST(p.111904 AS STRING), SAFE_CAST(p.111900 AS STRING)) AS motivo_julgamento,\n    SAFE_CAST(p.125615 AS STRING) AS observacao,\n\n  FROM\n    pivotado p\n  WHERE rn=1\n)\n\nSELECT\n      t.id_recurso,\n      DATE(datetime_recurso) AS data,\n      t.datetime_captura,\n      t.datetime_recurso,\n      t.datetime_update,\n      t.consorcio,\n      t.servico,\n      t.sentido,\n      DATE(EXTRACT(date FROM TIMESTAMP(data_viagem))) AS data_viagem,\n      t.numero_relatorio_cimu,\n      t.julgamento,\n      t.motivo_julgamento,\n      t.observacao AS observacao_julgamento,\n      j.data_julgamento\n\nFROM\n      tratado t\n\nLEFT JOIN\n\n    `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_bloqueio_via_ultimo_julgamento` AS j\n\n  ON t.id_recurso = j.id_recurso", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos`.`recursos_sppo_bloqueio_via`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:40.852703Z", "completed_at": "2024-09-30T15:22:40.857996Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:40.859266Z", "completed_at": "2024-09-30T15:22:40.859274Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008902549743652344, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.recursos_sppo_reprocessamento", "compiled": true, "compiled_code": "\n\nWITH exploded AS (\n  SELECT\n    id_recurso,\n    datetime_recurso,\n    datetime_captura,\n    datetime_update,\n    SAFE_CAST(COALESCE(JSON_VALUE(items, '$.value'), JSON_VALUE(items, '$.items[0].customFieldItem')) AS STRING\n    ) AS value,\n    SAFE_CAST(JSON_EXTRACT(items, '$.customFieldId') AS STRING ) AS field_id\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`staging_recursos_sppo_reprocessamento`,\n    UNNEST(items) items\n\n  WHERE\n    DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\")\n        AND DATE(\"2022-01-01T01:00:00\")\n\n),\npivotado AS (\n  SELECT *,\n  ROW_NUMBER() OVER(PARTITION BY id_recurso ORDER BY datetime_captura DESC) AS rn,\n  FROM\n    exploded PIVOT(\n      ANY_VALUE(value) FOR field_id IN (\n        '113816', '113817', '111865','111866','111904',\n        '111900', '125615'\n      )\n    )\n),\ntratado AS (\n  SELECT\n    id_recurso,\n    datetime_captura,\n    datetime_recurso,\n    datetime_update,\n    SAFE_CAST(p.111865 AS STRING) AS julgamento,\n    PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S', SAFE_CAST(p.113816 AS STRING), 'America/Sao_Paulo') AS data_hora_inicio,\n    PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%S', SAFE_CAST(p.113817 AS STRING), 'America/Sao_Paulo') AS data_hora_fim,\n    COALESCE(SAFE_CAST(p.111904 AS STRING), SAFE_CAST(p.111900 AS STRING)) AS motivo_julgamento,\n    SAFE_CAST(p.125615 AS STRING) AS observacao,\n\n  FROM\n    pivotado p\n  WHERE rn = 1\n)\nSELECT\n      t.id_recurso,\n      DATE(datetime_recurso) AS data,\n      t.datetime_captura,\n      t.datetime_recurso,\n      t.datetime_update,\n      DATETIME(TIMESTAMP_SUB(data_hora_inicio, INTERVAL 3 HOUR)) AS data_hora_inicio_viagem,\n      DATETIME(TIMESTAMP_SUB(data_hora_fim, INTERVAL 3 HOUR)) AS data_hora_fim_viagem,\n      t.julgamento,\n      t.motivo_julgamento,\n      t.observacao AS observacao_julgamento,\n      j.data_julgamento\n\nFROM\n      tratado t\n\nLEFT JOIN\n\n    `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_reprocessamento_ultimo_julgamento` AS j\n\n  ON t.id_recurso = j.id_recurso", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos`.`recursos_sppo_reprocessamento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:40.863232Z", "completed_at": "2024-09-30T15:22:40.871774Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:40.873040Z", "completed_at": "2024-09-30T15:22:40.873050Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012283802032470703, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.recursos_sppo_viagens_individuais", "compiled": true, "compiled_code": "\n\nWITH exploded AS (\n  SELECT\n    id_recurso,\n    datetime_recurso,\n    datetime_captura,\n    datetime_update,\n    SAFE_CAST(COALESCE(JSON_VALUE(items, '$.value'), JSON_VALUE(items, '$.items[0].customFieldItem')) AS STRING\n    ) AS value,\n    SAFE_CAST(JSON_EXTRACT(items, '$.customFieldId') AS STRING ) AS field_id\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`staging_recursos_sppo_viagens_individuais`,\n    UNNEST(items) items\n\n  WHERE\n      DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\")\n        AND DATE(\"2022-01-01T01:00:00\")\n\n),\npivotado AS (\n  SELECT *,\n  ROW_NUMBER() OVER(PARTITION BY id_recurso ORDER BY datetime_captura DESC) AS rn,\n  FROM\n    exploded PIVOT(\n      ANY_VALUE(value) FOR field_id IN (\n        '111870', '111871', '111872', '111873',\n        '111901', '111865', '111867', '111868',\n        '111869', '111866', '111904', '125615',\n        '111900'\n      )\n    )\n),\ntratado AS (\n  SELECT\n    id_recurso,\n    datetime_captura,\n    datetime_recurso,\n    datetime_update,\n    SAFE_CAST(p.111865 AS STRING) AS julgamento,\n    SAFE_CAST(p.111870 AS STRING) AS consorcio,\n    CASE\n      WHEN SAFE_CAST(p.111872 AS STRING) = \"SR - Regular\" THEN SAFE_CAST(p.111871 AS STRING)\n      ELSE CONCAT(REPLACE(SPLIT(SAFE_CAST(p.111872 AS STRING), \"-\")[OFFSET(0)], \" \", \"\"), SAFE_CAST(p.111871 AS STRING))\n    END AS servico,\n    SAFE_CAST(p.111873 AS STRING) AS id_veiculo,\n    CASE\n        WHEN SAFE_CAST(p.111901 AS STRING) = \"Ida\" THEN \"I\"\n        WHEN SAFE_CAST(p.111901 AS STRING) = \"Volta\" THEN \"V\"\n        WHEN SAFE_CAST(p.111901 AS STRING) = \"Circular\" THEN \"C\"\n    END\n      AS sentido,\n    PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez',SAFE_CAST(p.111867 AS STRING), 'America/Sao_Paulo') AS data_viagem,\n    PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(p.111868 AS STRING), 'America/Sao_Paulo') AS hora_inicio_viagem,\n    PARSE_TIMESTAMP('%Y-%m-%dT%H:%M:%E*S%Ez', SAFE_CAST(p.111869 AS STRING), 'America/Sao_Paulo') AS hora_fim_viagem,\n    SAFE_CAST(p.111866 AS STRING) AS motivo,\n    COALESCE(SAFE_CAST(p.111904 AS STRING), SAFE_CAST(p.111900 AS STRING)) AS motivo_julgamento,\n    SAFE_CAST(p.125615 AS STRING) AS observacao,\n\n  FROM\n    pivotado p\n  WHERE rn=1\n)\nSELECT\n      t.id_recurso,\n      DATE(datetime_recurso) AS data,\n      t.datetime_captura,\n      t.datetime_recurso,\n      t.datetime_update,\n      t.consorcio,\n      t.servico,\n      t.sentido,\n      t.id_veiculo AS id_veiculo_numeral,\n      DATETIME(EXTRACT(date FROM TIMESTAMP(data_viagem)), EXTRACT(time FROM TIMESTAMP_SUB(hora_inicio_viagem, INTERVAL 2 HOUR)) ) AS datetime_partida,\n      CASE\n        WHEN\n          EXTRACT(time FROM TIMESTAMP_SUB(hora_inicio_viagem, INTERVAL 2 HOUR)) > EXTRACT(time FROM TIMESTAMP_SUB(hora_fim_viagem, INTERVAL 2 HOUR))\n\n        THEN\n          DATETIME(EXTRACT(date FROM TIMESTAMP_ADD(data_viagem, INTERVAL 1 DAY)), EXTRACT(time FROM TIMESTAMP_SUB(hora_fim_viagem, INTERVAL 2 HOUR)))\n        ELSE\n          DATETIME(EXTRACT(date FROM TIMESTAMP(data_viagem)),\n            EXTRACT(time FROM TIMESTAMP_SUB(hora_fim_viagem, INTERVAL 2 HOUR))\n          )\n      END AS datetime_chegada,\n      t.motivo AS motivo_recurso,\n      t.julgamento,\n      t.motivo_julgamento,\n      t.observacao AS observacao_julgamento,\n      j.data_julgamento\n\nFROM\n      tratado t\nLEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_recursos_staging`.`recursos_sppo_viagens_individuais_ultimo_julgamento` AS j\n\n  ON t.id_recurso = j.id_recurso", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_recursos`.`recursos_sppo_viagens_individuais`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:40.876971Z", "completed_at": "2024-09-30T15:22:43.311352Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:43.314467Z", "completed_at": "2024-09-30T15:22:43.314489Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.4416792392730713, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.rho_registros_stpl", "compiled": true, "compiled_code": "\n\n\n\n    \n        \n\n        \n\n        \n    \n\n\nSELECT\n    data_transacao,\n    hora_transacao,\n    servico_riocard,\n    operadora,\n    SUM(quantidade_transacao_pagante) AS quantidade_transacao_pagante,\n    SUM(quantidade_transacao_gratuidade) AS quantidade_transacao_gratuidade\nFROM\n    `rj-smtr`.`br_rj_riodejaneiro_rdo_staging`.`rho_registros_stpl_aux`\n\n    WHERE\n        data_transacao\n        \n            IN ('2021-12-31', '2022-01-01', '2021-12-29', '2021-12-30', '2021-12-28', '2021-12-22', '2021-12-23', '2021-12-24', '2021-12-26', '2021-12-27')\n        \n\nGROUP BY\n    1,\n    2,\n    3,\n    4", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_rdo`.`rho_registros_stpl`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:43.323940Z", "completed_at": "2024-09-30T15:22:43.338729Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:43.341784Z", "completed_at": "2024-09-30T15:22:43.341807Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.023704051971435547, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_servico_viagens_planejadas", "compiled": true, "compiled_code": "\n\nWITH\n  data_versao AS (\n  SELECT\n    feed_start_date,\n    feed_start_date AS data_inicio,\n    COALESCE(DATE_SUB(LEAD(feed_start_date) OVER (ORDER BY feed_start_date), INTERVAL 1 DAY), LAST_DAY(feed_start_date, MONTH)) AS data_fim\n  FROM (\n    SELECT\n      DISTINCT feed_start_date,\n    FROM\n      `rj-smtr`.`gtfs`.`ordem_servico` )),\n  subsidio_data_versao_efetiva AS (\n  SELECT\n    * EXCEPT(tipo_dia),\n    SPLIT(tipo_dia, \" - \")[0] AS tipo_dia\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_data_versao_efetiva` )\nSELECT\n  data,\n  sd.tipo_dia,\n  servico,\n  viagens_planejadas\nFROM\n  UNNEST(GENERATE_DATE_ARRAY((SELECT MIN(data_inicio) FROM data_versao), (SELECT MAX(data_fim) FROM data_versao))) AS data\nLEFT JOIN\n  data_versao AS d\nON\n  data BETWEEN d.data_inicio\n  AND d.data_fim\nLEFT JOIN\n  subsidio_data_versao_efetiva AS sd\nON\n  data = sd.data\n  AND (d.feed_start_date = sd.feed_start_date\n      OR sd.feed_start_date IS NULL)\nLEFT JOIN\n  `rj-smtr`.`gtfs`.`ordem_servico` AS o\nON\n  d.feed_start_date = o.feed_start_date\n  AND sd.tipo_dia = o.tipo_dia", "relation_name": "`rj-smtr`.`gtfs`.`ordem_servico_viagens_planejadas`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:43.348947Z", "completed_at": "2024-09-30T15:22:43.355498Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:43.357122Z", "completed_at": "2024-09-30T15:22:43.357135Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011744260787963867, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.subsidio_shapes_geom", "compiled": true, "compiled_code": "\n\nwith data_versao as (\n    select data_versao_shapes\n    from `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_data_versao_efetiva`\n    where data between date_sub(\"2022-01-01T01:00:00\", interval 1 day) and date(\"2022-01-01T01:00:00\")\n),\ncontents as (\n    SELECT\n        shape_id,\n        ST_GEOGPOINT(\n            SAFE_CAST(shape_pt_lon AS FLOAT64),\n            SAFE_CAST(shape_pt_lat AS FLOAT64)\n        ) ponto_shape,\n        SAFE_CAST(shape_pt_sequence as INT64) shape_pt_sequence,\n        DATE(data_versao) AS data_versao\n    FROM\n        `rj-smtr-staging.projeto_subsidio_sppo_staging.shapes` s\n    \n    WHERE\n        data_versao in (select data_versao_shapes from data_versao)\n    \n),\npts as (\n    select\n        *,\n        max(shape_pt_sequence) over(\n                partition by data_versao, shape_id\n        ) final_pt_sequence\n    from\n        contents c\n    order by\n        data_versao, shape_id, shape_pt_sequence\n),\nshapes as (\n-- BUILD LINESTRINGS OVER SHAPE POINTS\n    SELECT\n        shape_id,\n        data_versao,\n        st_makeline(ARRAY_AGG(ponto_shape)) as shape\n    FROM pts\n    GROUP BY 1,2\n),\nboundary as (\n-- EXTRACT START AND END POINTS FROM SHAPES\n    SELECT\n        c1.shape_id,\n        c1.ponto_shape start_pt,\n        c2.ponto_shape end_pt,\n        c1.data_versao\n    FROM\n        (select * from pts where shape_pt_sequence = 1) c1\n    JOIN\n        (select * from pts where shape_pt_sequence = final_pt_sequence) c2\n    ON\n        c1.shape_id = c2.shape_id and c1.data_versao = c2.data_versao\n),\nmerged as (\n-- JOIN SHAPES AND BOUNDARY POINTS\n    SELECT\n        s.*,\n        b.* except(data_versao, shape_id),\n        round(ST_LENGTH(shape),1) shape_distance,\n    FROM\n        shapes s\n    JOIN\n        boundary b\n    ON\n        s.shape_id = b.shape_id and s.data_versao = b.data_versao\n),\nids as (\n    SELECT\n        shape_id,\n        shape,\n        shape_distance,\n        start_pt,\n        end_pt,\n        data_versao,\n        row_number() over(\n                partition by data_versao, shape_id\n        ) rn\n    FROM merged m\n)\nSELECT\n       * except(rn),\n       \"\" as versao_modelo\nFROM ids\nWHERE rn = 1", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`subsidio_shapes_geom`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:43.386296Z", "completed_at": "2024-09-30T15:22:43.392706Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:43.394353Z", "completed_at": "2024-09-30T15:22:43.394364Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012728214263916016, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.servicos_sentido", "compiled": true, "compiled_code": "\n\nWITH\n  servicos_exclusivos_sabado AS (\n    SELECT\n      DISTINCT servico\n    FROM\n      `rj-smtr`.`gtfs`.`ordem_servico`\n    WHERE\n      tipo_dia = \"Dia \u00datil\"\n      AND viagens_planejadas = 0),\n  servicos AS (\n    SELECT\n      * EXCEPT(versao_modelo,\n        shape)\n    FROM\n      `rj-smtr`.`gtfs`.`trips` AS t\n    LEFT JOIN\n      `rj-smtr`.`gtfs`.`shapes_geom` AS s\n    USING\n      (feed_start_date,\n        shape_id)\n    WHERE\n      (feed_start_date >= \"2023-06-01\" AND\n        ( trip_short_name NOT IN (SELECT * FROM servicos_exclusivos_sabado)\n          AND (service_id LIKE \"U_R%\"\n            OR service_id LIKE \"U_O%\") )\n        OR ( trip_short_name IN (SELECT * FROM servicos_exclusivos_sabado)\n          AND (service_id LIKE \"S_R%\"\n            OR service_id LIKE \"S_O%\")))\n      OR\n      (feed_start_date < \"2023-06-01\" AND\n        ( trip_short_name NOT IN (SELECT * FROM servicos_exclusivos_sabado)\n        OR ( trip_short_name IN (SELECT * FROM servicos_exclusivos_sabado)\n          AND service_id = \"S\")))\n      AND shape_distance IS NOT NULL),\n  servicos_rn AS (\n    SELECT\n      *,\n      ROW_NUMBER() OVER (PARTITION BY feed_start_date, trip_short_name, direction_id ORDER BY trip_short_name, service_id, shape_id, direction_id) AS rn\n    FROM\n      servicos ),\n    servicos_filtrada AS (\n    SELECT\n      * EXCEPT(rn)\n    FROM\n      servicos_rn\n    WHERE\n      rn = 1),\n  servicos_potencialmente_circulares AS (\n    SELECT\n      feed_start_date,\n      trip_short_name,\n      COUNT(DISTINCT direction_id) AS q_direcoes\n    FROM\n      servicos_filtrada\n    GROUP BY\n      1,\n      2\n    HAVING\n      COUNT(DISTINCT direction_id) = 1 )\nSELECT\n  feed_start_date,\n  trip_short_name AS servico,\n  CASE\n    WHEN q_direcoes = 1 AND ST_DISTANCE(start_pt, end_pt) <= 50 THEN \"C\"\n    WHEN direction_id = \"0\" THEN \"I\"\n    WHEN direction_id = \"1\" THEN \"V\"\nEND\n  AS sentido\nFROM\n  servicos_filtrada AS sf\nLEFT JOIN\n  servicos_potencialmente_circulares AS spc\nUSING\n  (feed_start_date,\n    trip_short_name)", "relation_name": "`rj-smtr`.`gtfs`.`servicos_sentido`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:46.282516Z", "completed_at": "2024-09-30T15:22:49.643866Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:49.650279Z", "completed_at": "2024-09-30T15:22:49.650335Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.3761210441589355, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.shapes_geom", "compiled": true, "compiled_code": "\n\n       \n\nwith\n       trips as (\n              SELECT\n                     trip_id,\n                     shape_id,\n                     route_id,\n                     DATE(data_versao) data_versao\n              FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips_desaninhada` t\n              WHERE DATE(data_versao) between DATE(\"2022-08-14\") and DATE_ADD(DATE(\"2022-08-14\"), INTERVAL 15 DAY)\n       ),\n       linhas as (\n              SELECT\n                     trip_id,\n                     shape_id,\n                     t.route_id,\n                     route_short_name linha,\n                     idModalSmtr id_modal_smtr,\n                     t.data_versao,\n              FROM trips t\n              INNER JOIN (\n              SELECT *\n              FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes_desaninhada`\n              WHERE DATE(data_versao) between DATE(\"2022-08-14\") and DATE_ADD(DATE(\"2022-08-14\"), INTERVAL 15 DAY)\n              ) r\n              on t.route_id = r.route_id\n              and t.data_versao = r.data_versao\n       ),\n       contents as (\n       -- EXTRACTS VALUES FROM JSON STRING FIELD 'content'\n              SELECT\n                     shape_id,\n                     ST_GEOGPOINT(\n                            SAFE_CAST(json_value(content, \"$.shape_pt_lon\") AS FLOAT64),\n                            SAFE_CAST(json_value(content, \"$.shape_pt_lat\") AS FLOAT64)\n                     ) ponto_shape,\n                     SAFE_CAST(json_value(content, \"$.shape_pt_sequence\") as INT64) shape_pt_sequence,\n                     DATE(data_versao) AS data_versao\n              FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes` s\n              WHERE DATE(data_versao) between DATE(\"2022-08-14\") and DATE_ADD(DATE(\"2022-08-14\"), INTERVAL 15 DAY)\n       ),\n       pts as (\n              select\n                     *,\n                     max(shape_pt_sequence) over(\n                            partition by data_versao, shape_id\n                     ) final_pt_sequence\n              from contents c\n              order by data_versao, shape_id, shape_pt_sequence\n       ),\n       shapes as (\n              -- BUILD LINESTRINGS OVER SHAPE POINTS\n              SELECT\n                     shape_id,\n                     data_versao,\n                     st_makeline(ARRAY_AGG(ponto_shape)) as shape\n              FROM pts\n              GROUP BY 1,2\n       ),\n       boundary as (\n              -- EXTRACT START AND END POINTS FROM SHAPES\n              SELECT\n                     c1.shape_id,\n                     c1.ponto_shape start_pt,\n                     c2.ponto_shape end_pt,\n                     c1.data_versao\n              FROM (select * from pts where shape_pt_sequence = 1) c1\n              JOIN (select * from pts where shape_pt_sequence = final_pt_sequence) c2\n              ON c1.shape_id = c2.shape_id and c1.data_versao = c2.data_versao\n       ),\n       merged as (\n              -- JOIN SHAPES AND BOUNDARY POINTS\n              SELECT\n                     s.*,\n                     b.* except(data_versao, shape_id),\n                     round(ST_LENGTH(shape),1) shape_distance,\n              FROM shapes s\n              JOIN boundary b\n              ON s.shape_id = b.shape_id and s.data_versao = b.data_versao\n       ),\n       ids as (\n              SELECT\n                     trip_id,\n                     m.shape_id,\n                     route_id,\n                     id_modal_smtr,\n                     replace(linha, \" \", \"\") as linha_gtfs,\n                     shape,\n                     shape_distance,\n                     start_pt,\n                     end_pt,\n                     m.data_versao,\n                     row_number() over(\n                            partition by m.data_versao, m.shape_id, l.trip_id\n                     ) rn\n              FROM merged m\n              JOIN linhas l\n              ON m.shape_id = l.shape_id\n              AND m.data_versao = l.data_versao\n              -- mudar join para o route_id em todas as dependencias\n       )\nSELECT\n       * except(rn)\nFROM ids\nWHERE rn = 1\n\nAND data_versao > DATE(\"2022-08-14\")\n", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:49.668106Z", "completed_at": "2024-09-30T15:22:57.851181Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:57.857293Z", "completed_at": "2024-09-30T15:22:57.857342Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 8.199655055999756, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.many_to_one_trips_desaninhada_route_id__route_id__data_versao__ref_routes_desaninhada_.eb4384bb9b", "compiled": true, "compiled_code": "with t as (\nSELECT\n    m.route_id from_col,\n    n.route_id to_col\nFROM (\n    SELECT\n        route_id\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips_desaninhada`\n    WHERE data_versao = \"2022-09-12\"\n) m\nLEFT JOIN (\n    SELECT\n        route_id\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes_desaninhada`\n    WHERE data_versao = \"2022-09-12\"\n) n\nON m.route_id = n.route_id\n)\n\nSELECT\n    *\nFROM t\nWHERE to_col is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:57.870777Z", "completed_at": "2024-09-30T15:22:57.880171Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:57.882543Z", "completed_at": "2024-09-30T15:22:57.882566Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.017168521881103516, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_trips_desaninhada_trip_id__data_versao.bc1b38cd1a", "compiled": true, "compiled_code": "\nSELECT\n    trip_id\nFROM\n    `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips_desaninhada`\nWHERE\n    data_versao = (SELECT MAX(data_versao) FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips_desaninhada`)\nAND\n    trip_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:57.888613Z", "completed_at": "2024-09-30T15:22:57.897077Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:57.898400Z", "completed_at": "2024-09-30T15:22:57.898410Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01279592514038086, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_key_trips_desaninhada_trip_id____data_versao.42406b5b36", "compiled": true, "compiled_code": "\nSELECT\n    *\nFROM (\n    SELECT\n        trip_id,\n        data_versao,\n        ROW_NUMBER() over (partition by trip_id) rn\n    FROM\n        `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips_desaninhada`\n    WHERE\n        data_versao = (select max(data_versao) from `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips_desaninhada`)\n)\n\nWHERE rn>1\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:57.943382Z", "completed_at": "2024-09-30T15:22:57.960179Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:57.962032Z", "completed_at": "2024-09-30T15:22:57.962052Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.021425485610961914, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.viagem_planejada", "compiled": true, "compiled_code": "\n\n\n\n-- 1. Define datas do per\u00edodo planejado\nwith data_efetiva as (\n    select\n        data,\n        tipo_dia,\n        data_versao_shapes,\n        data_versao_trips,\n        data_versao_frequencies\n    from `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_data_versao_efetiva`\n    where data between date_sub(\"2022-01-01T01:00:00\", interval 1 day) and date(\"2022-01-01T01:00:00\")\n),\n-- 2. Puxa dados de distancia quadro no quadro hor\u00e1rio\nquadro as (\n    select\n        e.data,\n        e.tipo_dia,\n        p.* except(tipo_dia, data_versao, horario_inicio, horario_fim),\n        IF(horario_inicio IS NOT NULL AND ARRAY_LENGTH(SPLIT(horario_inicio, \":\")) = 3,\n            DATETIME_ADD(\n                DATETIME(\n                    e.data,\n                    PARSE_TIME(\"%T\",\n                        CONCAT(\n                        SAFE_CAST(MOD(SAFE_CAST(SPLIT(horario_inicio, \":\")[OFFSET(0)] AS INT64), 24) AS INT64),\n                        \":\",\n                        SAFE_CAST(SPLIT(horario_inicio, \":\")[OFFSET(1)] AS INT64),\n                        \":\",\n                        SAFE_CAST(SPLIT(horario_inicio, \":\")[OFFSET(2)] AS INT64)\n                        )\n                    )\n                ),\n                INTERVAL DIV(SAFE_CAST(SPLIT(horario_inicio, \":\")[OFFSET(0)] AS INT64), 24) DAY\n            ),\n            NULL\n        ) AS inicio_periodo,\n        IF(horario_fim IS NOT NULL AND ARRAY_LENGTH(SPLIT(horario_fim, \":\")) = 3,\n            DATETIME_ADD(\n                DATETIME(\n                    e.data,\n                    PARSE_TIME(\"%T\",\n                        CONCAT(\n                        SAFE_CAST(MOD(SAFE_CAST(SPLIT(horario_fim, \":\")[OFFSET(0)] AS INT64), 24) AS INT64),\n                        \":\",\n                        SAFE_CAST(SPLIT(horario_fim, \":\")[OFFSET(1)] AS INT64),\n                        \":\",\n                        SAFE_CAST(SPLIT(horario_fim, \":\")[OFFSET(2)] AS INT64)\n                        )\n                    )\n                ),\n                INTERVAL DIV(SAFE_CAST(SPLIT(horario_fim, \":\")[OFFSET(0)] AS INT64), 24) DAY\n            ),\n            NULL\n        ) AS fim_periodo\n    from\n        data_efetiva e\n    inner join (\n        select *\n        from `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_quadro_horario`\n        \n        where\n            data_versao in (select data_versao_frequencies from data_efetiva)\n        \n    ) p\n    on\n        e.data_versao_frequencies = p.data_versao\n    and\n        e.tipo_dia = p.tipo_dia\n),\n-- 3. Trata informa\u00e7\u00e3o de trips: adiciona ao sentido da trip o sentido\n--    planejado (os shapes/trips circulares s\u00e3o separados em\n--    ida/volta no sigmob)\ntrips as (\n    select\n        e.data,\n        t.*\n    from (\n        select *\n        from `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_trips_desaninhada`\n        \n        where\n            data_versao in (select data_versao_trips from data_efetiva)\n        \n    ) t\n    inner join\n        data_efetiva e\n    on\n        t.data_versao = e.data_versao_trips\n),\nquadro_trips as (\n    select\n        *\n    from (\n        select distinct\n            * except(trip_id),\n            trip_id as trip_id_planejado,\n            trip_id\n        from\n            quadro\n        where sentido = \"I\" or sentido = \"V\"\n    )\n    union all (\n        select\n            * except(trip_id),\n            trip_id as trip_id_planejado,\n            concat(trip_id, \"_0\") as trip_id,\n        from\n            quadro\n        where sentido = \"C\"\n    )\n    union all (\n        select\n            * except(trip_id),\n            trip_id as trip_id_planejado,\n            concat(trip_id, \"_1\") as trip_id,\n        from\n            quadro\n        where sentido = \"C\"\n    )\n),\nquadro_tratada as (\n    select\n        q.*,\n        t.shape_id as shape_id_planejado,\n        case\n            when sentido = \"C\"\n            then shape_id || \"_\" || split(q.trip_id, \"_\")[offset(1)]\n            else shape_id\n        end as shape_id, -- TODO: adicionar no sigmob\n    from\n        quadro_trips q\n    left join\n        trips t\n    on\n        t.data = q.data\n    and\n        t.trip_id = q.trip_id_planejado\n),\n-- 4. Trata informa\u00e7\u00f5es de shapes: junta trips e shapes para resgatar o sentido\n--    planejado (os shapes/trips circulares s\u00e3o separados em\n--    ida/volta no sigmob)\nshapes as (\n    select\n        e.data,\n        data_versao as data_shape,\n        shape_id,\n        shape,\n        start_pt,\n        end_pt\n    from\n        data_efetiva e\n    inner join (\n        select *\n        from `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_shapes_geom`\n        \n        where\n            data_versao in (select data_versao_shapes from data_efetiva)\n        \n    ) s\n    on\n        s.data_versao = e.data_versao_shapes\n)\n-- 5. Junta shapes e trips aos servicos planejados no quadro hor\u00e1rio\nselect\n    p.*,\n    s.data_shape,\n    s.shape,\n    case\n        when p.sentido = \"C\" and split(p.shape_id, \"_\")[offset(1)] = \"0\" then \"I\"\n        when p.sentido = \"C\" and split(p.shape_id, \"_\")[offset(1)] = \"1\" then \"V\"\n        when p.sentido = \"I\" or p.sentido = \"V\" then p.sentido\n    end as sentido_shape,\n    s.start_pt,\n    s.end_pt,\n    SAFE_CAST(NULL AS INT64) AS id_tipo_trajeto, -- Adapta\u00e7\u00e3o para formato da SUBSIDIO_V6\n    SAFE_CAST(NULL AS STRING) AS feed_version, -- Adapta\u00e7\u00e3o para formato da SUBSIDIO_V6\n    CURRENT_DATETIME(\"America/Sao_Paulo\") AS datetime_ultima_atualizacao -- Adapta\u00e7\u00e3o para formato da SUBSIDIO_V7\nfrom\n    quadro_tratada p\ninner join\n    shapes s\non\n    p.shape_id = s.shape_id\nand\n    p.data = s.data\n\n", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:57.966310Z", "completed_at": "2024-09-30T15:22:57.975732Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:57.976986Z", "completed_at": "2024-09-30T15:22:57.976995Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013138294219970703, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_servico_diaria", "compiled": true, "compiled_code": "\n\nWITH\n  feed_start_date AS (\n  SELECT\n    feed_start_date,\n    feed_start_date AS data_inicio,\n    COALESCE(DATE_SUB(LEAD(feed_start_date) OVER (ORDER BY feed_start_date), INTERVAL 1 DAY), LAST_DAY(feed_start_date, MONTH)) AS data_fim\n  FROM (\n    SELECT\n      DISTINCT feed_start_date,\n    FROM\n      `rj-smtr`.`gtfs`.`ordem_servico` )),\n  ordem_servico_pivot AS (\n  SELECT\n    *\n  FROM\n    `rj-smtr`.`gtfs`.`ordem_servico`\n    PIVOT( MAX(partidas_ida) AS partidas_ida,\n      MAX(partidas_volta) AS partidas_volta,\n      MAX(viagens_planejadas) AS viagens_planejadas,\n      MAX(distancia_total_planejada) AS km FOR\n      tipo_dia IN (\n        'Dia \u00datil' AS du,\n        'Ponto Facultativo' AS pf,\n        'Sabado' AS sab,\n        'Domingo' AS dom ))),\n  subsidio_feed_start_date_efetiva AS (\n  SELECT\n    data,\n    SPLIT(tipo_dia, \" - \")[0] AS tipo_dia,\n    tipo_dia AS tipo_dia_original\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_data_versao_efetiva` )\nSELECT\n  DATA,\n  tipo_dia_original AS tipo_dia,\n  servico,\n  vista,\n  consorcio,\n  sentido,\n  CASE\n  \n  \n      WHEN sentido  IN ('I', 'C')  AND tipo_dia = \"Dia \u00datil\" THEN  partidas_ida_du \n    \n      WHEN sentido  IN ('I', 'C')  AND tipo_dia = \"Ponto Facultativo\" THEN  partidas_ida_pf \n    \n      WHEN sentido  IN ('I', 'C')  AND tipo_dia = \"Sabado\" THEN  ROUND(SAFE_DIVIDE((partidas_ida_du * km_sab), km_du)) \n    \n      WHEN sentido  IN ('I', 'C')  AND tipo_dia = \"Domingo\" THEN  ROUND(SAFE_DIVIDE((partidas_ida_du * km_dom), km_du)) \n    \n      WHEN sentido  = \"V\"  AND tipo_dia = \"Dia \u00datil\" THEN  partidas_volta_du \n    \n      WHEN sentido  = \"V\"  AND tipo_dia = \"Ponto Facultativo\" THEN  partidas_volta_pf \n    \n      WHEN sentido  = \"V\"  AND tipo_dia = \"Sabado\" THEN  ROUND(SAFE_DIVIDE((partidas_volta_du * km_sab), km_du)) \n    \n      WHEN sentido  = \"V\"  AND tipo_dia = \"Domingo\" THEN  ROUND(SAFE_DIVIDE((partidas_volta_du * km_dom), km_du)) \n    END\n  AS viagens_planejadas,\n  horario_inicio AS inicio_periodo,\n  horario_fim AS fim_periodo\nFROM\n  UNNEST(GENERATE_DATE_ARRAY((SELECT MIN(data_inicio) FROM feed_start_date), (SELECT MAX(data_fim) FROM feed_start_date))) AS DATA\nLEFT JOIN\n  feed_start_date AS d\nON\n  DATA BETWEEN d.data_inicio\n  AND d.data_fim\nLEFT JOIN\n  subsidio_feed_start_date_efetiva AS sd\nUSING\n  (DATA)\nLEFT JOIN\n  ordem_servico_pivot AS o\nUSING\n  (feed_start_date)\nLEFT JOIN\n  `rj-smtr`.`gtfs`.`servicos_sentido`\nUSING\n  (feed_start_date,\n    servico)", "relation_name": "`rj-smtr`.`gtfs`.`ordem_servico_diaria`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:58.005056Z", "completed_at": "2024-09-30T15:22:58.016144Z"}, {"name": "execute", "started_at": "2024-09-30T15:22:58.018172Z", "completed_at": "2024-09-30T15:22:58.018182Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.015592813491821289, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.servicos", "compiled": true, "compiled_code": "\n\nwith __dbt__cte__aux_routes_vigencia_gtfs as (\n\n\nWITH routes_rn AS (\n  SELECT\n    route_id AS id_servico,\n    route_short_name AS servico,\n    route_long_name AS descricao_servico,\n    feed_start_date AS inicio_vigencia,\n    feed_end_date AS fim_vigencia,\n    LAG(feed_end_date) OVER (PARTITION BY route_id ORDER BY feed_start_date) AS feed_end_date_anterior,\n    ROW_NUMBER() OVER (PARTITION BY route_id ORDER BY feed_start_date DESC) AS rn\n  FROM\n    `rj-smtr`.`gtfs`.`routes`\n),\nroutes_agrupada AS (\n  SELECT\n    id_servico,\n    inicio_vigencia,\n    servico,\n    descricao_servico,\n    IFNULL(fim_vigencia, CURRENT_DATE(\"America/Sao_Paulo\")) as fim_vigencia,\n    SUM(\n      CASE\n        WHEN feed_end_date_anterior IS NULL OR feed_end_date_anterior <> DATE_SUB(inicio_vigencia, INTERVAL 1 DAY) THEN 1\n        ELSE 0\n      END\n    ) OVER (PARTITION BY id_servico ORDER BY inicio_vigencia) AS group_id\n  FROM\n    routes_rn\n),\nvigencia AS (\n  SELECT\n    id_servico,\n    MIN(inicio_vigencia) AS inicio_vigencia,\n    MAX(fim_vigencia) AS fim_vigencia\n  FROM\n    routes_agrupada\n  GROUP BY\n    id_servico,\n    group_id\n)\nSELECT\n  id_servico,\n  r.servico,\n  r.descricao_servico,\n  NULL AS latitude,\n  NULL AS longitude,\n  v.inicio_vigencia,\n  CASE\n    WHEN v.fim_vigencia != CURRENT_DATE(\"America/Sao_Paulo\") THEN v.fim_vigencia\n  END AS fim_vigencia,\n  'routes' AS tabela_origem_gtfs,\nFROM\n vigencia v\nJOIN\n(\n  SELECT\n    id_servico,\n    servico,\n    descricao_servico\n  FROM\n    routes_rn\n  WHERE\n    rn = 1\n) r\nUSING(id_servico)\n),  __dbt__cte__aux_stops_vigencia_gtfs as (\n\n\nWITH stops_rn AS (\n  SELECT\n    stop_id AS id_servico,\n    stop_code AS servico,\n    stop_name AS descricao_servico,\n    stop_lat AS latitude,\n    stop_lon AS longitude,\n    feed_start_date AS inicio_vigencia,\n    feed_end_date AS fim_vigencia,\n    LAG(feed_end_date) OVER (PARTITION BY stop_id ORDER BY feed_start_date) AS feed_end_date_anterior,\n    ROW_NUMBER() OVER (PARTITION BY stop_id ORDER BY feed_start_date DESC) AS rn\n  FROM\n    `rj-smtr`.`gtfs`.`stops`\n  WHERE\n    location_type = '1'\n),\nstops_agrupada AS (\n  SELECT\n    id_servico,\n    inicio_vigencia,\n    servico,\n    descricao_servico,\n    IFNULL(fim_vigencia, CURRENT_DATE(\"America/Sao_Paulo\")) AS fim_vigencia,\n    SUM(\n      CASE\n        WHEN feed_end_date_anterior IS NULL OR feed_end_date_anterior <> DATE_SUB(inicio_vigencia, INTERVAL 1 DAY) THEN 1\n        ELSE 0\n      END\n    ) OVER (PARTITION BY id_servico ORDER BY inicio_vigencia) AS group_id\n  FROM\n    stops_rn\n),\nvigencia AS (\n  SELECT\n    id_servico,\n    MIN(inicio_vigencia) AS inicio_vigencia,\n    MAX(fim_vigencia) AS fim_vigencia\n  FROM\n    stops_agrupada\n  GROUP BY\n    id_servico,\n    group_id\n)\nSELECT\n  id_servico,\n  r.servico,\n  r.descricao_servico,\n  r.latitude,\n  r.longitude,\n  v.inicio_vigencia,\n  CASE\n    WHEN v.fim_vigencia != CURRENT_DATE(\"America/Sao_Paulo\") THEN v.fim_vigencia\n  END AS fim_vigencia,\n  'stops' AS tabela_origem_gtfs,\nFROM\n vigencia v\nJOIN\n(\n  SELECT\n    id_servico,\n    servico,\n    descricao_servico,\n    latitude,\n    longitude\n  FROM\n    stops_rn\n  WHERE\n    rn = 1\n) r\nUSING(id_servico)\n),  __dbt__cte__aux_servicos_gtfs as (\n\n\nSELECT\n    id_servico,\n    servico,\n    descricao_servico,\n    latitude,\n    longitude,\n    inicio_vigencia,\n    fim_vigencia,\n    tabela_origem_gtfs,\n    '' as versao\nFROM\n    __dbt__cte__aux_routes_vigencia_gtfs\n\nUNION ALL\n\nSELECT\n    id_servico,\n    servico,\n    descricao_servico,\n    latitude,\n    longitude,\n    inicio_vigencia,\n    fim_vigencia,\n    tabela_origem_gtfs,\n    '' as versao\nFROM\n    __dbt__cte__aux_stops_vigencia_gtfs\n) SELECT\n    g.id_servico AS id_servico_gtfs,\n    j.cd_linha AS id_servico_jae,\n    COALESCE(g.servico, j.nr_linha) AS servico,\n    g.servico AS servico_gtfs,\n    j.nr_linha AS servico_jae,\n    COALESCE(g.descricao_servico, j.nm_linha) AS descricao_servico,\n    g.descricao_servico AS descricao_servico_gtfs,\n    j.nm_linha AS descricao_servico_jae,\n    g.latitude,\n    g.longitude,\n    g.tabela_origem_gtfs,\n    COALESCE(g.inicio_vigencia, DATE(j.datetime_inclusao)) AS data_inicio_vigencia,\n    g.fim_vigencia AS data_fim_vigencia,\n    '' as versao\nFROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha` j\nFULL OUTER JOIN\n    __dbt__cte__aux_servicos_gtfs g\nON\n    COALESCE(j.gtfs_route_id, j.gtfs_stop_id) = g.id_servico", "relation_name": "`rj-smtr`.`cadastro`.`servicos`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:22:58.033840Z", "completed_at": "2024-09-30T15:23:01.110342Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:01.116399Z", "completed_at": "2024-09-30T15:23:01.116440Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.088580846786499, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.data_versao_efetiva", "compiled": true, "compiled_code": "\n\nwith\nagency as (\nSELECT\n    data,\n    data_versao as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-08-03\") THEN DATE(\"2021-08-03\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`agency`\n    )\nON data = DATE(data_versao)\n),\ncalendar as (\nSELECT\n    data,\n    data_versao as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-09-30\") THEN DATE(\"2021-09-30\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`calendar`\n    )\nON data = DATE(data_versao)\n),\nfrota_determinada as (\nSELECT\n    data,\n    DATE(data_versao) as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-09-30\") THEN DATE(\"2021-09-30\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`frota_determinada`\n    )\nON DATE(data) = DATE(data_versao)\n),\nholidays as (\nSELECT\n    data,\n    data_versao as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-11-05\") THEN DATE(\"2021-11-05\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`holidays`\n    )\nON data = DATE(data_versao)\n),\nlinhas as (\n    SELECT\n    data,\n    DATE(data_versao) as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-08-03\") THEN DATE(\"2021-08-03\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`linhas`\n    )\nON data = DATE(data_versao)\n),\nroutes as (\nSELECT\n    data,\n    DATE(data_versao) as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-08-03\") THEN DATE(\"2021-08-03\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`routes`\n    )\nON data = data_versao\n),\nshapes as (\nSELECT\n    data,\n    data_versao as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-08-24\") THEN DATE(\"2021-08-24\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\n    )\nON data = DATE(data_versao)\n),\nstop_details as (\nSELECT\n    data,\n    data_versao as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-09-30\") THEN DATE(\"2021-09-30\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stop_details`\n    )\nON data = DATE(data_versao)\n),\nstop_times as (\nSELECT\n    data,\n    data_versao as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-08-03\") THEN DATE(\"2021-08-03\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stop_times`\n    )\nON data = DATE(data_versao)\n),\nstops as (\nSELECT\n    data,\n    data_versao as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-08-24\") THEN DATE(\"2021-08-24\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`stops`\n    )\nON data = DATE(data_versao)\n),\ntrips as (\nSELECT\n    data,\n    data_versao as data_versao_original,\n    CASE WHEN data <= DATE(\"2021-08-03\") THEN DATE(\"2021-08-03\") ELSE\n        LAST_VALUE(DATE(data_versao) IGNORE NULLS) OVER (ORDER BY data ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    END AS data_versao_efetiva\nFROM UNNEST(GENERATE_DATE_ARRAY(DATE('2021-01-01'), CURRENT_DATE())) data\nLEFT JOIN (\n    SELECT DISTINCT data_versao\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips`\n    )\nON data = DATE(data_versao)\n),\njoined as (\n    select\n    DATE_ADD(s.data, INTERVAL 1 DAY) data,\n    a.data_versao_efetiva as data_versao_efetiva_agency,\n    c.data_versao_efetiva as data_versao_efetiva_calendar,\n    f.data_versao_efetiva as data_versao_efetiva_frota_determinada,\n    h.data_versao_efetiva as data_versao_efetiva_holidays,\n    l.data_versao_efetiva as data_versao_efetiva_linhas,\n    r.data_versao_efetiva as data_versao_efetiva_routes,\n    s.data_versao_efetiva as data_versao_efetiva_shapes,\n    sd.data_versao_efetiva as data_versao_efetiva_stop_details,\n    st.data_versao_efetiva as data_versao_efetiva_stop_times,\n    sp.data_versao_efetiva as data_versao_efetiva_stops,\n    t.data_versao_efetiva as data_versao_efetiva_trips\n    from agency a\n    join shapes s\n    on s.data = a.data\n    join calendar c\n    on a.data = c.data\n    join frota_determinada f\n    on a.data = f.data\n    join holidays h\n    on a.data = h.data\n    join linhas l\n    on a.data = l.data\n    join routes r\n    on a.data = r.data\n    join stops sp\n    on a.data = sp.data\n    join stop_details sd\n    on a.data = sd.data\n    join stop_times st\n    on a.data = st.data\n    join trips t\n    on a.data = t.data\n)\nselect *\nfrom joined\n\n    \n    where DATE(data) > (\"2023-01-28\")\n", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_sigmob`.`data_versao_efetiva`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:01.166332Z", "completed_at": "2024-09-30T15:23:01.172741Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:01.174462Z", "completed_at": "2024-09-30T15:23:01.174471Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010524749755859375, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_shapes_geom_shape_id__data_versao.7a66dc45a2", "compiled": true, "compiled_code": "\nSELECT\n    shape_id\nFROM\n    `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\nWHERE\n    data_versao = (SELECT MAX(data_versao) FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`)\nAND\n    shape_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:01.178294Z", "completed_at": "2024-09-30T15:23:01.182931Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:01.184248Z", "completed_at": "2024-09-30T15:23:01.184258Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008342742919921875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_shapes_geom_trip_id__data_versao.80cc520fd9", "compiled": true, "compiled_code": "\nSELECT\n    trip_id\nFROM\n    `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\nWHERE\n    data_versao = (SELECT MAX(data_versao) FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`)\nAND\n    trip_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:01.188662Z", "completed_at": "2024-09-30T15:23:08.892723Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:08.901942Z", "completed_at": "2024-09-30T15:23:08.901998Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 7.7224977016448975, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.one_to_one_shapes_geom_trip_id__data_versao__ref_trips_desaninhada_.fa13c0400d", "compiled": true, "compiled_code": "\n\n\n\n\nwith t as (\nSELECT\n    m.trip_id from_col,\n    n.trip_id to_col\nFROM (\n    SELECT\n        trip_id\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\n    WHERE data_versao = \"2022-08-14\"\n) m\nLEFT JOIN (\n    SELECT\n        trip_id\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips_desaninhada`\n    WHERE data_versao = \"2022-09-12\"\n) n\nON m.trip_id = n.trip_id\n)\nSELECT *\nFROM (\n    SELECT\n        from_col,\n        count(to_col) ct\n    FROM t\n    GROUP BY from_col\n)\nwhere ct != 1\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:08.923003Z", "completed_at": "2024-09-30T15:23:15.795437Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.799163Z", "completed_at": "2024-09-30T15:23:15.799193Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 6.884007692337036, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.one_to_one_trips_desaninhada_trip_id__data_versao__ref_shapes_geom_.7192b80bfe", "compiled": true, "compiled_code": "\n\n\n\n\nwith t as (\nSELECT\n    m.trip_id from_col,\n    n.trip_id to_col\nFROM (\n    SELECT\n        trip_id\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`trips_desaninhada`\n    WHERE data_versao = \"2022-09-12\"\n) m\nLEFT JOIN (\n    SELECT\n        trip_id\n    FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\n    WHERE data_versao = \"2022-08-14\"\n) n\nON m.trip_id = n.trip_id\n)\nSELECT *\nFROM (\n    SELECT\n        from_col,\n        count(to_col) ct\n    FROM t\n    GROUP BY from_col\n)\nwhere ct != 1\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.808099Z", "completed_at": "2024-09-30T15:23:15.817263Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.819415Z", "completed_at": "2024-09-30T15:23:15.819430Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.015729427337646484, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_key_shapes_geom_trip_id____data_versao.a58fed7dbf", "compiled": true, "compiled_code": "\nSELECT\n    *\nFROM (\n    SELECT\n        trip_id,\n        data_versao,\n        ROW_NUMBER() over (partition by trip_id) rn\n    FROM\n        `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\n    WHERE\n        data_versao = (select max(data_versao) from `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`)\n)\n\nWHERE rn>1\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.830394Z", "completed_at": "2024-09-30T15:23:15.840571Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.841858Z", "completed_at": "2024-09-30T15:23:15.841868Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01965022087097168, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_viagem_planejada_sentido_shape__I__V__C.65301f5e21", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido_shape as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n    group by sentido_shape\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.845634Z", "completed_at": "2024-09-30T15:23:15.850878Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.852176Z", "completed_at": "2024-09-30T15:23:15.852185Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00889134407043457, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_viagem_planejada_tipo_dia__I__V__C.fabfbe2d14", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        tipo_dia as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n    group by tipo_dia\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.857163Z", "completed_at": "2024-09-30T15:23:15.866805Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.868165Z", "completed_at": "2024-09-30T15:23:15.868175Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.014486551284790039, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_viagem_planejada_variacao_itinerario__DD__DU__SS__RT__RM__DA__SA.19c1ddab9e", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        variacao_itinerario as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n    group by variacao_itinerario\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'DD','DU','SS','RT','RM','DA','SA'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.872180Z", "completed_at": "2024-09-30T15:23:15.877829Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.879349Z", "completed_at": "2024-09-30T15:23:15.879360Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009878396987915039, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_planejada_distancia_total_planejada.d8c80cf89c", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n    where distancia_total_planejada <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.883542Z", "completed_at": "2024-09-30T15:23:15.889282Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.890584Z", "completed_at": "2024-09-30T15:23:15.890593Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009736299514770508, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_consorcio.3058dfe52a", "compiled": true, "compiled_code": "\nSELECT\n    consorcio\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    consorcio is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.894462Z", "completed_at": "2024-09-30T15:23:15.901271Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.902788Z", "completed_at": "2024-09-30T15:23:15.902800Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011041641235351562, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_data.908c75b0d4", "compiled": true, "compiled_code": "\nSELECT\n    data\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    data is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.907092Z", "completed_at": "2024-09-30T15:23:15.911835Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.913105Z", "completed_at": "2024-09-30T15:23:15.913114Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00847172737121582, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_data_shape.5117fd368b", "compiled": true, "compiled_code": "\nSELECT\n    data_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    data_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.917631Z", "completed_at": "2024-09-30T15:23:15.922243Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.923503Z", "completed_at": "2024-09-30T15:23:15.923512Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008744478225708008, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_distancia_planejada.74a4f2d184", "compiled": true, "compiled_code": "\nSELECT\n    distancia_planejada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    distancia_planejada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.927311Z", "completed_at": "2024-09-30T15:23:15.931671Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.933228Z", "completed_at": "2024-09-30T15:23:15.933237Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008298397064208984, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_distancia_total_planejada.fc1b124982", "compiled": true, "compiled_code": "\nSELECT\n    distancia_total_planejada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    distancia_total_planejada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.937162Z", "completed_at": "2024-09-30T15:23:15.943038Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.944296Z", "completed_at": "2024-09-30T15:23:15.944306Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009551525115966797, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_fim_periodo.b2cf28f8cc", "compiled": true, "compiled_code": "\nSELECT\n    fim_periodo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    fim_periodo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.948021Z", "completed_at": "2024-09-30T15:23:15.952614Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.953861Z", "completed_at": "2024-09-30T15:23:15.953870Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008196115493774414, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_inicio_periodo.c62783ac90", "compiled": true, "compiled_code": "\nSELECT\n    inicio_periodo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    inicio_periodo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.957598Z", "completed_at": "2024-09-30T15:23:15.962107Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.963387Z", "completed_at": "2024-09-30T15:23:15.963395Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008136987686157227, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_intervalo.1fb7eb9e45", "compiled": true, "compiled_code": "\nSELECT\n    intervalo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    intervalo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.967139Z", "completed_at": "2024-09-30T15:23:15.971998Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.973289Z", "completed_at": "2024-09-30T15:23:15.973298Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00854802131652832, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_sentido.40310b764f", "compiled": true, "compiled_code": "\nSELECT\n    sentido\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    sentido is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.977534Z", "completed_at": "2024-09-30T15:23:15.985825Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.987095Z", "completed_at": "2024-09-30T15:23:15.987105Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012288808822631836, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_sentido_shape.7b97f6ff04", "compiled": true, "compiled_code": "\nSELECT\n    sentido_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    sentido_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:15.990924Z", "completed_at": "2024-09-30T15:23:15.995469Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:15.996718Z", "completed_at": "2024-09-30T15:23:15.996727Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008198261260986328, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_servico.a9fd6c7425", "compiled": true, "compiled_code": "\nSELECT\n    servico\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    servico is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.000586Z", "completed_at": "2024-09-30T15:23:16.006615Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.007861Z", "completed_at": "2024-09-30T15:23:16.007870Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009730100631713867, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_shape.5f910173a9", "compiled": true, "compiled_code": "\nSELECT\n    shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.011571Z", "completed_at": "2024-09-30T15:23:16.015974Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.017222Z", "completed_at": "2024-09-30T15:23:16.017230Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007993698120117188, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_tipo_dia.a605476b6d", "compiled": true, "compiled_code": "\nSELECT\n    tipo_dia\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    tipo_dia is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.021982Z", "completed_at": "2024-09-30T15:23:16.029319Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.030572Z", "completed_at": "2024-09-30T15:23:16.030582Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01175832748413086, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_planejada_variacao_itinerario.ea024350d5", "compiled": true, "compiled_code": "\nSELECT\n    variacao_itinerario\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`)\nAND\n    variacao_itinerario is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.050813Z", "completed_at": "2024-09-30T15:23:16.056280Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.057530Z", "completed_at": "2024-09-30T15:23:16.057539Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009101390838623047, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_validador_aux", "compiled": true, "compiled_code": "\n\nSELECT\n    do.modo,\n    g.data,\n    g.hora,\n    g.data_tracking AS datetime_gps,\n    g.timestamp_captura AS datetime_captura,\n    do.id_operadora,\n    do.operadora,\n    g.codigo_linha_veiculo AS id_servico_jae,\n    -- s.servico,\n    l.nr_linha AS servico_jae,\n    l.nm_linha AS descricao_servico_jae,\n    prefixo_veiculo AS id_veiculo,\n    g.numero_serie_equipamento AS id_validador,\n    g.id AS id_transmissao_gps,\n    g.latitude_equipamento AS latitude,\n    g.longitude_equipamento AS longitude,\n    INITCAP(g.sentido_linha) AS sentido,\n    g.estado_equipamento,\n    g.temperatura,\n    g.versao_app\nFROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`gps_validador` g\nLEFT JOIN\n    `rj-smtr`.`cadastro`.`operadoras` AS do\nON\n    g.codigo_operadora = do.id_operadora_jae\nLEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha` AS l\nON\n    g.codigo_linha_veiculo = l.cd_linha\n-- LEFT JOIN\n--     `rj-smtr`.`cadastro`.`servicos` AS s\n-- ON\n--     g.codigo_linha_veiculo = s.id_servico_jae", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`gps_validador_aux`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.061331Z", "completed_at": "2024-09-30T15:23:16.073237Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.074480Z", "completed_at": "2024-09-30T15:23:16.074489Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.015553951263427734, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.integracao", "compiled": true, "compiled_code": "-- depends_on: `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`matriz_integracao`\n\n\nWITH integracao_transacao_deduplicada AS (\n  SELECT\n    * EXCEPT(rn)\n  FROM\n  (\n    SELECT\n      *,\n      ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp_captura DESC) AS rn\n    FROM\n      `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`integracao_transacao`\n    WHERE\n        DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n        AND timestamp_captura BETWEEN DATETIME(\"2022-01-01T00:00:00\") AND DATETIME(\"2022-01-01T01:00:00\")\n  )\n  WHERE\n    rn = 1\n),\nintegracao_melt AS (\n    SELECT\n      EXTRACT(DATE FROM im.data_transacao) AS data,\n      EXTRACT(HOUR FROM im.data_transacao) AS hora,\n      i.data_inclusao AS datetime_inclusao,\n      i.data_processamento AS datetime_processamento_integracao,\n      i.timestamp_captura AS datetime_captura,\n      i.id AS id_integracao,\n      im.sequencia_integracao,\n      im.data_transacao AS datetime_transacao,\n      im.id_tipo_modal,\n      im.id_consorcio,\n      im.id_operadora,\n      im.id_linha,\n      im.id_transacao,\n      im.sentido,\n      im.perc_rateio,\n      im.valor_rateio_compensacao,\n      im.valor_rateio,\n      im.valor_transacao,\n      i.valor_transacao_total,\n      i.tx_adicional AS texto_adicional\n    FROM\n      integracao_transacao_deduplicada i,\n      -- Transforma colunas com os dados de cada transa\u00e7\u00e3o da integra\u00e7\u00e3o em linhas diferentes\n      UNNEST(\n        [\n          \n            STRUCT(\n              \n                \n                  data_transacao_t0 AS data_transacao,\n                \n              \n                \n              \n                \n                  id_consorcio_t0 AS id_consorcio,\n                \n              \n                \n              \n                \n                  id_linha_t0 AS id_linha,\n                \n              \n                \n              \n                \n                  id_operadora_t0 AS id_operadora,\n                \n              \n                \n              \n                \n              \n                \n              \n                \n                  id_tipo_modal_t0 AS id_tipo_modal,\n                \n              \n                \n                  id_transacao_t0 AS id_transacao,\n                \n              \n                \n              \n                \n              \n                \n              \n                \n                  perc_rateio_t0 AS perc_rateio,\n                \n              \n                \n              \n                \n                  sentido_t0 AS sentido,\n                \n              \n                \n                  valor_rateio_compensacao_t0 AS valor_rateio_compensacao,\n                \n              \n                \n                  valor_rateio_t0 AS valor_rateio,\n                \n              \n                \n                  valor_tarifa_t0 AS valor_tarifa,\n                \n              \n                \n                  valor_transacao_t0 AS valor_transacao,\n                \n              \n                \n              \n              1 AS sequencia_integracao\n            ),\n          \n            STRUCT(\n              \n                \n                  data_transacao_t1 AS data_transacao,\n                \n              \n                \n              \n                \n                  id_consorcio_t1 AS id_consorcio,\n                \n              \n                \n              \n                \n                  id_linha_t1 AS id_linha,\n                \n              \n                \n              \n                \n                  id_operadora_t1 AS id_operadora,\n                \n              \n                \n              \n                \n              \n                \n              \n                \n                  id_tipo_modal_t1 AS id_tipo_modal,\n                \n              \n                \n                  id_transacao_t1 AS id_transacao,\n                \n              \n                \n              \n                \n              \n                \n              \n                \n                  perc_rateio_t1 AS perc_rateio,\n                \n              \n                \n              \n                \n                  sentido_t1 AS sentido,\n                \n              \n                \n                  valor_rateio_compensacao_t1 AS valor_rateio_compensacao,\n                \n              \n                \n                  valor_rateio_t1 AS valor_rateio,\n                \n              \n                \n                  valor_tarifa_t1 AS valor_tarifa,\n                \n              \n                \n                  valor_transacao_t1 AS valor_transacao,\n                \n              \n                \n              \n              2 AS sequencia_integracao\n            ),\n          \n            STRUCT(\n              \n                \n                  data_transacao_t2 AS data_transacao,\n                \n              \n                \n              \n                \n                  id_consorcio_t2 AS id_consorcio,\n                \n              \n                \n              \n                \n                  id_linha_t2 AS id_linha,\n                \n              \n                \n              \n                \n                  id_operadora_t2 AS id_operadora,\n                \n              \n                \n              \n                \n              \n                \n              \n                \n                  id_tipo_modal_t2 AS id_tipo_modal,\n                \n              \n                \n                  id_transacao_t2 AS id_transacao,\n                \n              \n                \n              \n                \n              \n                \n              \n                \n                  perc_rateio_t2 AS perc_rateio,\n                \n              \n                \n              \n                \n                  sentido_t2 AS sentido,\n                \n              \n                \n                  valor_rateio_compensacao_t2 AS valor_rateio_compensacao,\n                \n              \n                \n                  valor_rateio_t2 AS valor_rateio,\n                \n              \n                \n                  valor_tarifa_t2 AS valor_tarifa,\n                \n              \n                \n                  valor_transacao_t2 AS valor_transacao,\n                \n              \n                \n              \n              3 AS sequencia_integracao\n            ),\n          \n            STRUCT(\n              \n                \n                  data_transacao_t3 AS data_transacao,\n                \n              \n                \n              \n                \n                  id_consorcio_t3 AS id_consorcio,\n                \n              \n                \n              \n                \n                  id_linha_t3 AS id_linha,\n                \n              \n                \n              \n                \n                  id_operadora_t3 AS id_operadora,\n                \n              \n                \n              \n                \n              \n                \n              \n                \n                  id_tipo_modal_t3 AS id_tipo_modal,\n                \n              \n                \n                  id_transacao_t3 AS id_transacao,\n                \n              \n                \n              \n                \n              \n                \n              \n                \n                  perc_rateio_t3 AS perc_rateio,\n                \n              \n                \n              \n                \n                  sentido_t3 AS sentido,\n                \n              \n                \n                  valor_rateio_compensacao_t3 AS valor_rateio_compensacao,\n                \n              \n                \n                  valor_rateio_t3 AS valor_rateio,\n                \n              \n                \n                  valor_tarifa_t3 AS valor_tarifa,\n                \n              \n                \n                  valor_transacao_t3 AS valor_transacao,\n                \n              \n                \n              \n              4 AS sequencia_integracao\n            ),\n          \n            STRUCT(\n              \n                \n                  data_transacao_t4 AS data_transacao,\n                \n              \n                \n              \n                \n                  id_consorcio_t4 AS id_consorcio,\n                \n              \n                \n              \n                \n                  id_linha_t4 AS id_linha,\n                \n              \n                \n              \n                \n                  id_operadora_t4 AS id_operadora,\n                \n              \n                \n              \n                \n              \n                \n              \n                \n                  id_tipo_modal_t4 AS id_tipo_modal,\n                \n              \n                \n                  id_transacao_t4 AS id_transacao,\n                \n              \n                \n              \n                \n              \n                \n              \n                \n                  perc_rateio_t4 AS perc_rateio,\n                \n              \n                \n              \n                \n                  sentido_t4 AS sentido,\n                \n              \n                \n                  valor_rateio_compensacao_t4 AS valor_rateio_compensacao,\n                \n              \n                \n                  valor_rateio_t4 AS valor_rateio,\n                \n              \n                \n                  valor_tarifa_t4 AS valor_tarifa,\n                \n              \n                \n                  valor_transacao_t4 AS valor_transacao,\n                \n              \n                \n              \n              5 AS sequencia_integracao\n            )\n          \n        ]\n      ) AS im\n),\nintegracao_rn AS (\n  SELECT\n    i.data,\n    i.hora,\n    i.datetime_processamento_integracao,\n    i.datetime_captura,\n    i.datetime_transacao,\n    TIMESTAMP_DIFF(\n      i.datetime_transacao,\n      LAG(i.datetime_transacao) OVER(PARTITION BY i.id_integracao ORDER BY sequencia_integracao),\n      MINUTE\n    ) AS intervalo_integracao,\n    i.id_integracao,\n    i.sequencia_integracao,\n    m.modo,\n    dc.id_consorcio,\n    dc.consorcio,\n    do.id_operadora,\n    do.operadora,\n    i.id_linha AS id_servico_jae,\n    -- s.servico,\n    l.nr_linha AS servico_jae,\n    l.nm_linha AS descricao_servico_jae,\n    i.id_transacao,\n    i.sentido,\n    i.perc_rateio AS percentual_rateio,\n    i.valor_rateio_compensacao,\n    i.valor_rateio,\n    i.valor_transacao,\n    i.valor_transacao_total,\n    i.texto_adicional,\n    '' as versao,\n    ROW_NUMBER() OVER (PARTITION BY id_transacao ORDER BY datetime_processamento_integracao DESC) AS rn\n  FROM\n    integracao_melt i\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`modos` m\n  ON\n    i.id_tipo_modal = m.id_modo AND m.fonte = \"jae\"\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`operadoras` AS do\n  ON\n    i.id_operadora = do.id_operadora_jae\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`consorcios` AS dc\n  ON\n    i.id_consorcio = dc.id_consorcio_jae\n  LEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha` AS l\n  ON\n      i.id_linha = l.cd_linha\n  -- LEFT JOIN\n  --   `rj-smtr`.`cadastro`.`servicos` AS s\n  -- ON\n  --   i.id_linha = s.id_servico_jae\n  WHERE i.id_transacao IS NOT NULL\n),\nintegracoes_teste_invalidas AS (\n  SELECT DISTINCT\n    i.id_integracao\n  FROM\n    integracao_rn i\n  LEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_sem_ressarcimento` l\n  ON\n    i.id_servico_jae = l.id_linha\n  WHERE\n    l.id_linha IS NOT NULL\n    OR i.data < \"2023-07-17\"\n)\nSELECT\n  * EXCEPT(rn)\nFROM\n  integracao_rn\nWHERE rn = 1\nAND id_integracao NOT IN (SELECT id_integracao FROM integracoes_teste_invalidas)", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`integracao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.078195Z", "completed_at": "2024-09-30T15:23:16.085028Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.086300Z", "completed_at": "2024-09-30T15:23:16.086308Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010449409484863281, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_pagamento_servico_operador_dia", "compiled": true, "compiled_code": "\n\nWITH ordem_pagamento AS (\n    SELECT\n        r.data_ordem,\n        dc.id_consorcio,\n        dc.consorcio,\n        do.id_operadora,\n        do.operadora,\n        r.id_linha AS id_servico_jae,\n        -- s.servico,\n        l.nr_linha AS servico_jae,\n        l.nm_linha AS descricao_servico_jae,\n        r.id_ordem_pagamento AS id_ordem_pagamento,\n        r.id_ordem_ressarcimento AS id_ordem_ressarcimento,\n        r.qtd_debito AS quantidade_transacao_debito,\n        r.valor_debito,\n        r.qtd_vendaabordo AS quantidade_transacao_especie,\n        r.valor_vendaabordo AS valor_especie,\n        r.qtd_gratuidade AS quantidade_transacao_gratuidade,\n        r.valor_gratuidade,\n        r.qtd_integracao AS quantidade_transacao_integracao,\n        r.valor_integracao,\n        COALESCE(rat.qtd_rateio_compensacao_credito_total, r.qtd_rateio_credito) AS quantidade_transacao_rateio_credito,\n        COALESCE(rat.valor_rateio_compensacao_credito_total, r.valor_rateio_credito) AS valor_rateio_credito,\n        COALESCE(rat.qtd_rateio_compensacao_debito_total, r.qtd_rateio_debito) AS quantidade_transacao_rateio_debito,\n        COALESCE(rat.valor_rateio_compensacao_debito_total, r.valor_rateio_debito) AS valor_rateio_debito,\n        (\n            r.qtd_debito\n            + r.qtd_vendaabordo\n            + r.qtd_gratuidade\n            + r.qtd_integracao\n        ) AS quantidade_total_transacao,\n        r.valor_bruto AS valor_total_transacao_bruto,\n        r.valor_taxa AS valor_desconto_taxa,\n        r.valor_liquido AS valor_total_transacao_liquido\n    FROM\n        `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_ressarcimento` r\n    LEFT JOIN\n        `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_rateio` rat\n    USING(data_ordem, id_consorcio, id_operadora, id_linha)\n    LEFT JOIN\n        `rj-smtr`.`cadastro`.`operadoras` AS do\n    ON\n        r.id_operadora = do.id_operadora_jae\n    LEFT JOIN\n        `rj-smtr`.`cadastro`.`consorcios` AS dc\n    ON\n        r.id_consorcio = dc.id_consorcio_jae\n    LEFT JOIN\n        `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha` AS l\n    ON\n        r.id_linha = l.cd_linha\n    -- LEFT JOIN\n    --     `rj-smtr`.`cadastro`.`servicos` AS s\n    -- ON\n    --     r.id_linha = s.id_servico_jae\n    \n        WHERE\n            DATE(r.data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n    \n)\nSELECT\n    o.data_ordem,\n    o.id_consorcio,\n    o.consorcio,\n    o.id_operadora,\n    o.operadora,\n    o.id_servico_jae,\n    o.servico_jae,\n    o.descricao_servico_jae,\n    o.id_ordem_pagamento,\n    o.id_ordem_ressarcimento,\n    o.quantidade_transacao_debito,\n    o.valor_debito,\n    o.quantidade_transacao_especie,\n    o.valor_especie,\n    o.quantidade_transacao_gratuidade,\n    o.valor_gratuidade,\n    o.quantidade_transacao_integracao,\n    o.valor_integracao,\n    o.quantidade_transacao_rateio_credito,\n    o.valor_rateio_credito,\n    o.quantidade_transacao_rateio_debito,\n    o.valor_rateio_debito,\n    o.quantidade_total_transacao,\n    o.valor_total_transacao_bruto + o.valor_rateio_debito + o.valor_rateio_credito AS valor_total_transacao_bruto,\n    o.valor_desconto_taxa,\n    o.valor_total_transacao_liquido + o.valor_rateio_debito + o.valor_rateio_credito AS valor_total_transacao_liquido,\n    '' AS versao\nFROM\n    ordem_pagamento o", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_servico_operador_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.090041Z", "completed_at": "2024-09-30T15:23:16.094553Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.095819Z", "completed_at": "2024-09-30T15:23:16.095827Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00809621810913086, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.servico_operadora", "compiled": true, "compiled_code": "\n\nSELECT\n  c.id_consorcio,\n  c.consorcio,\n  o.id_operadora,\n  o.operadora,\n  lco.cd_linha AS id_servico_jae,\n  s.servico,\n  s.descricao_servico,\n  lco.dt_inicio_validade AS data_inicio_validade,\n  lco.dt_fim_validade AS data_fim_validade,\n  '' as versao\nFROM\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_consorcio_operadora_transporte` lco\nJOIN\n  `rj-smtr`.`cadastro`.`operadoras` o\nON\n  lco.cd_operadora_transporte = o.id_operadora_jae\nJOIN\n  `rj-smtr`.`cadastro`.`consorcios` c\nON\n  lco.cd_consorcio = c.id_consorcio_jae\nJOIN\n  `rj-smtr`.`cadastro`.`servicos` s\nON\n  lco.cd_linha = s.id_servico_jae", "relation_name": "`rj-smtr`.`cadastro`.`servico_operadora`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.099511Z", "completed_at": "2024-09-30T15:23:16.132260Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.133613Z", "completed_at": "2024-09-30T15:23:16.133623Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.036507606506347656, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_brt", "compiled": true, "compiled_code": "\n/*\nDescri\u00e7\u00e3o:\nJun\u00e7\u00e3o dos passos de tratamento, junta as informa\u00e7\u00f5es extras que definimos a partir dos registros\ncapturados.\nPara descri\u00e7\u00e3o detalhada de como cada coluna \u00e9 calculada, consulte a documenta\u00e7\u00e3o de cada uma das tabelas\nutilizadas abaixo.\n1. registros_filtrada: filtragem e tratamento b\u00e1sico dos dados brutos capturados.\n2. aux_registros_velocidade: estimativa da velocidade de ve\u00edculo a cada ponto registrado e identifica\u00e7\u00e3o\ndo estado de movimento ('parado', 'andando')\n3. aux_registros_parada: identifica ve\u00edculos parados em terminais ou garagens conhecidas\n4. aux_registros_flag_trajeto_correto: calcula intersec\u00e7\u00f5es das posi\u00e7\u00f5es registradas para cada ve\u00edculo\ncom o tra\u00e7ado da linha informada.\n5. As jun\u00e7\u00f5es (joins) s\u00e3o feitas sobre o id_ve\u00edculo e a timestamp_gps.\n*/\nWITH\n     __dbt__cte__brt_aux_registros_velocidade as (\n\n/*\nDescri\u00e7\u00e3o:\nEstimativa das velocidades dos ve\u00edculos nos \u00faltimos 10 minutos contados a partir da timestamp_gps atual.\nEssa metodologia serve para determinar quais carros est\u00e3o em movimento e quais est\u00e3o parados.\n1. Calculamos a velocidade do ve\u00edculo no \u00faltimo trecho de 10 minutos de opera\u00e7\u00e3o.\nA implementa\u00e7\u00e3o utiliza a fun\u00e7\u00e3o 'first_value' com uma janela (cl\u00e1usula 'over') de at\u00e9 10 minutos anteriores \u00e0\ntimestamp_gps atual e calcula a dist\u00e2ncia do ponto mais antigo (o first_value na janela) ao ponto atual (posicao_veiculo_geo).\nDividimos essa dist\u00e2ncia pela diferen\u00e7a de tempo entre a timestamp_gps atual e a timestamp_gps do ponto mais\nantigo da janela (o qual recuperamos novamente com o uso de first_value).\nEsta diferen\u00e7a de tempo (datetime_diff) \u00e9 calculada em segundos, portanto multiplicamos o resultado da divis\u00e3o por um fator\n3.6 para que a velocidade esteja em quil\u00f4metros por hora. O resultado final \u00e9 arrendondado sem casas decimais.\nPor fim, cobrimos esse c\u00e1lculo com a fun\u00e7\u00e3o 'if_null' e retornamos zero para a velocidade em casos onde a divis\u00e3o retornaria\num valor nulo.\n2. Ap\u00f3s o calculo da velocidade, definimos a coluna 'status_movimento'. Ve\u00edculos abaixo da 'velocidade_limiar_parado', s\u00e3o\nconsiderados como 'parado'. Caso contr\u00e1rio, s\u00e3o considerados 'andando'\n*/\nwith\n    t_velocidade as (\n    select\n        data,\n        id_veiculo,\n        timestamp_gps,\n        servico,\n        ST_DISTANCE(\n                posicao_veiculo_geo,\n                lag(posicao_veiculo_geo) over (\n                partition by id_veiculo, servico\n                order by timestamp_gps)\n        ) distancia,\n        IFNULL(\n            SAFE_DIVIDE(\n                ST_DISTANCE(\n                posicao_veiculo_geo,\n                lag(posicao_veiculo_geo) over (\n                partition by id_veiculo, servico\n                order by timestamp_gps)\n                ),\n                DATETIME_DIFF(\n                timestamp_gps,\n                lag(timestamp_gps) over (\n                partition by id_veiculo, servico\n                order by timestamp_gps),\n                SECOND\n                )),\n            0\n        ) * 3.6 velocidade\n    FROM  `rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_aux_registros_filtrada`\n    WHERE\n    data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"\n    \n    ),\n    medias as (\n        select\n        data,\n        id_veiculo,\n        timestamp_gps,\n        servico,\n        distancia,\n        velocidade, # velocidade do pontual\n        AVG(velocidade) OVER (\n            PARTITION BY id_veiculo, servico\n            ORDER BY unix_seconds(timestamp(timestamp_gps))\n            RANGE BETWEEN 600 PRECEDING AND CURRENT ROW\n        ) velocidade_media # velocidade com m\u00e9dia m\u00f3vel\n    from t_velocidade\n    )\nSELECT\n    timestamp_gps,\n    data,\n    id_veiculo,\n    servico,\n    distancia,\n    ROUND(\n        CASE WHEN velocidade_media > 60\n            THEN 60\n            ELSE velocidade_media\n        END,\n        1) as velocidade,\n    -- 2. Determina\u00e7\u00e3o do estado de movimento do ve\u00edculo.\n    case\n        when velocidade_media < 3 then false\n        else true\n    end flag_em_movimento,\n    -- STRUCT( AS versao_maestro,  AS versao_maestro_bq) versao\nFROM medias\n),  __dbt__cte__brt_aux_registros_parada as (\n\n/*\nDescri\u00e7\u00e3o:\nIdentifica ve\u00edculos parados em terminais ou garagens conhecidas.\n1. Selecionamos os terminais conhecidos e uma geometria do tipo pol\u00edgono (Polygon) que cont\u00e9m buracos nas\nlocaliza\u00e7\u00f5es das garagens.\n2. Calculamos as dist\u00e2ncias do ve\u00edculos em rela\u00e7\u00e3o aos terminais conhecidos. Definimos aqui a coluna 'nrow',\nque identifica qual o terminal que est\u00e1 mais pr\u00f3ximo do ponto informado. No passo final, recuperamos apenas\nos dados com nrow = 1 (menor dist\u00e2ncia em rela\u00e7\u00e3o \u00e0 posi\u00e7\u00e3o do ve\u00edculo)\n3. Definimos uma distancia_limiar_parada. Caso o ve\u00edculo esteja a uma dist\u00e2ncia menor que este valor de uma\nparada, ser\u00e1 considerado como parado no terminal com menor distancia.\n4. Caso o veiculo n\u00e3o esteja intersectando o pol\u00edgono das garagens, ele ser\u00e1 considerado como parado dentro\nde uma garagem (o pol\u00edgono \u00e9 vazado nas garagens, a n\u00e3o intersec\u00e7\u00e3o implica em estar dentro de um dos 'buracos').\n*/\nWITH\n  terminais as (\n    -- 1. Selecionamos terminais, criando uma geometria de ponto para cada.\n    select\n      ST_GEOGPOINT(longitude, latitude) ponto_parada, nome_estacao nome_parada, 'terminal' tipo_parada\n    from rj-smtr.br_rj_riodejaneiro_transporte.estacoes_e_terminais_brt\n  ),\n  garagem_polygon AS (\n    -- 1. Selecionamos o pol\u00edgono das garagens.\n    SELECT  ST_GEOGFROMTEXT(WKT,make_valid => true) AS poly\n    FROM rj-smtr.br_rj_riodejaneiro_geo.garagens_polygon\n  ),\n  distancia AS (\n    --2. Calculamos as dist\u00e2ncias e definimos nrow\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      data,\n      servico,\n      posicao_veiculo_geo,\n      nome_parada,\n      tipo_parada,\n      ROUND(ST_DISTANCE(posicao_veiculo_geo, ponto_parada), 1) distancia_parada,\n      ROW_NUMBER() OVER (PARTITION BY timestamp_gps, id_veiculo, servico ORDER BY ST_DISTANCE(posicao_veiculo_geo, ponto_parada)) nrow\n    FROM terminais p\n    JOIN (\n      SELECT *\n      FROM\n        `rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_aux_registros_filtrada`\n      WHERE\n      data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n      AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"\n      \n    ) r\n    on 1=1\n  )\nSELECT\n  data,\n  id_veiculo,\n  timestamp_gps,\n  servico,\n  /*\n  3. e 4. Identificamos o status do ve\u00edculo como 'terminal', 'garagem' (para os ve\u00edculos parados) ou\n  'nao_identificado' (para os ve\u00edculos mais distantes de uma parada que o limiar definido)\n  */\n  case\n    when distancia_parada < 250 then tipo_parada\n    when not ST_INTERSECTS(posicao_veiculo_geo, (SELECT  poly FROM garagem_polygon)) then 'garagem'\n    else null\n  end tipo_parada,\nFROM distancia\nWHERE nrow = 1\n),  __dbt__cte__brt_aux_registros_flag_trajeto_correto as (\n\n/*\nDescri\u00e7\u00e3o:\nCalcula se o ve\u00edculo est\u00e1 dentro do trajeto correto dado o tra\u00e7ado (shape) cadastrado no SIGMOB em rela\u00e7\u00e3o \u00e0 linha que est\u00e1 sendo\ntransmitida.\n1. Calcula as intersec\u00e7\u00f5es definindo um 'buffer', utilizado por st_dwithin para identificar se o ponto est\u00e1 \u00e0 uma\ndist\u00e2ncia menor ou igual ao tamanho do buffer em rela\u00e7\u00e3o ao tra\u00e7ado definido no SIGMOB.\n2. Calcula um hist\u00f3rico de intersec\u00e7\u00f5es nos ultimos 10 minutos de registros de cada carro. Definimos que o carro \u00e9\nconsiderado fora do trajeto definido se a cada 10 minutos, ele n\u00e3o esteve dentro do tra\u00e7ado planejado pelo menos uma\nvez.\n3. Identifica se a linha informada no registro capturado existe nas defini\u00e7\u00f5es presentes no SIGMOB.\n4. Definimos em outra tabela uma 'data_versao_efetiva', esse passo serve tanto para definir qual vers\u00e3o do SIGMOB utilizaremos em\ncaso de falha na captura, quanto para definir qual vers\u00e3o ser\u00e1 utilizada para o c\u00e1lculo retroativo do hist\u00f3rico de registros que temos.\n5. Como n\u00e3o conseguimos identificar o itiner\u00e1rio que o carro est\u00e1 realizando, no passo counts, os resultados de\nintersec\u00e7\u00f5es s\u00e3o dobrados, devido ao fato de cada linha apresentar dois itiner\u00e1rios poss\u00edveis (ida/volta). Portanto,\nao final, realizamos uma agrega\u00e7\u00e3o LOGICAL_OR que \u00e9 true caso o carro esteja dentro do tra\u00e7ado de algum dos itiner\u00e1rios\nposs\u00edveis para a linha informada.\n*/\nWITH\n  registros AS (\n    SELECT id_veiculo, servico as linha, latitude, longitude, data, posicao_veiculo_geo, timestamp_gps\n    FROM\n      `rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_aux_registros_filtrada` r\n    WHERE\n    data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"\n  ),\n  intersec AS (\n    SELECT\n      r.*,\n      s.data_versao,\n      s.linha_gtfs,\n      s.route_id,\n      -- 1. Buffer e intersec\u00e7\u00f5es\n      CASE\n        WHEN st_dwithin(shape, posicao_veiculo_geo, 500) THEN TRUE\n        ELSE FALSE\n      END AS flag_trajeto_correto,\n      -- 2. Hist\u00f3rico de intersec\u00e7\u00f5es nos \u00faltimos 10 minutos a partir da timestamp_gps atual\n      CASE\n        WHEN\n          COUNT(CASE WHEN st_dwithin(shape, posicao_veiculo_geo, 500) THEN 1 END)\n          OVER (PARTITION BY id_veiculo\n                ORDER BY UNIX_SECONDS(TIMESTAMP(timestamp_gps))\n                RANGE BETWEEN 600 PRECEDING AND CURRENT ROW) >= 1\n          THEN True\n        ELSE False\n      END AS flag_trajeto_correto_hist,\n      -- 3. Identifica\u00e7\u00e3o de cadastro da linha no SIGMOB\n      CASE WHEN s.linha_gtfs IS NULL THEN False ELSE True END AS flag_linha_existe_sigmob,\n    -- 4. Join com data_versao_efetiva para defini\u00e7\u00e3o de quais shapes ser\u00e3o considerados no c\u00e1lculo das flags\n    FROM registros r\n    LEFT JOIN (\n      SELECT *\n      FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\n      WHERE id_modal_smtr in ('20', 'B')\n      AND data_versao = \"2022-06-10\"\n    ) s\n    ON\n      r.linha = s.linha_gtfs\n  )\n    -- 5. Agrega\u00e7\u00e3o com LOGICAL_OR para evitar duplica\u00e7\u00e3o de registros\n    SELECT\n      id_veiculo,\n      linha as servico,\n      linha_gtfs,\n      route_id,\n      data,\n      timestamp_gps,\n      LOGICAL_OR(flag_trajeto_correto) AS flag_trajeto_correto,\n      LOGICAL_OR(flag_trajeto_correto_hist) AS flag_trajeto_correto_hist,\n      LOGICAL_OR(flag_linha_existe_sigmob) AS flag_linha_existe_sigmob,\n      -- STRUCT( AS versao_maestro,\n      --        AS versao_maestro_bq,\n      --       data_versao AS data_versao_sigmob\n      --       ) versao\n    FROM\n      intersec i\n    GROUP BY\n      id_veiculo,\n      linha,\n      linha_gtfs,\n      route_id,\n      data,\n      data_versao,\n      timestamp_gps\n), registros as (\n    -- 1. registros_filtrada\n    SELECT\n        id_veiculo,\n        timestamp_gps,\n        timestamp_captura,\n        velocidade,\n        servico,\n        latitude,\n        longitude,\n    FROM `rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_aux_registros_filtrada`\n    WHERE\n      data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n      AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"\n      AND DATETIME_DIFF(timestamp_captura, timestamp_gps, MINUTE) BETWEEN 0 AND 1),\n    velocidades AS (\n    -- 2. velocidades\n    SELECT\n        id_veiculo, timestamp_gps, servico, velocidade, distancia, flag_em_movimento\n    FROM __dbt__cte__brt_aux_registros_velocidade\n    ),\n    paradas as (\n    -- 3. paradas\n    SELECT\n        id_veiculo, timestamp_gps, servico, tipo_parada,\n    FROM __dbt__cte__brt_aux_registros_parada\n    ),\n    flags AS (\n    -- 4. flag_trajeto_correto\n    SELECT\n        id_veiculo,\n        timestamp_gps,\n        servico,\n        route_id,\n        flag_linha_existe_sigmob,\n        flag_trajeto_correto,\n        flag_trajeto_correto_hist\n    FROM __dbt__cte__brt_aux_registros_flag_trajeto_correto\n    )\n-- 5. Jun\u00e7\u00e3o final\nSELECT\n    \"BRT\" modo,\n    r.timestamp_gps,\n    date(r.timestamp_gps) data,\n    extract(time from r.timestamp_gps) hora,\n    r.id_veiculo,\n    replace(r.servico, \" \", \"\") as servico,\n    r.latitude,\n    r.longitude,\n    CASE\n        WHEN\n        flag_em_movimento IS true AND flag_trajeto_correto_hist is true\n        THEN true\n    ELSE false\n    END flag_em_operacao,\n    v.flag_em_movimento,\n    p.tipo_parada,\n    flag_linha_existe_sigmob,\n    flag_trajeto_correto,\n    flag_trajeto_correto_hist,\n    CASE\n        WHEN flag_em_movimento IS true AND flag_trajeto_correto_hist is true\n        THEN 'Em opera\u00e7\u00e3o'\n        WHEN flag_em_movimento is true and flag_trajeto_correto_hist is false\n        THEN 'Operando fora trajeto'\n        WHEN flag_em_movimento is false\n        THEN\n            CASE\n                WHEN tipo_parada is not null\n                THEN concat(\"Parado \", tipo_parada)\n            ELSE\n                CASE\n                    WHEN flag_trajeto_correto_hist is true\n                    THEN 'Parado trajeto correto'\n                ELSE 'Parado fora trajeto'\n                END\n            END\n    END status,\n    r.velocidade velocidade_instantanea,\n    v.velocidade velocidade_estimada_10_min,\n    v.distancia,\n    \"\" as versao\nFROM\n    registros r\n\nJOIN\n    flags f\nON\n    r.id_veiculo = f.id_veiculo\n    AND r.timestamp_gps = f.timestamp_gps\n    AND r.servico = f.servico\n\nJOIN\n    velocidades v\nON\n    r.id_veiculo = v.id_veiculo\n    AND  r.timestamp_gps = v.timestamp_gps\n    AND  r.servico = v.servico\n\nJOIN\n    paradas p\nON\n    r.id_veiculo = p.id_veiculo\n    AND  r.timestamp_gps = p.timestamp_gps\n    AND r.servico = p.servico\nWHERE\n  date(r.timestamp_gps) between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n  AND r.timestamp_gps > \"2022-01-01T00:00:00\" and r.timestamp_gps <=\"2022-01-01T01:00:00\"\n  AND DATETIME_DIFF(r.timestamp_captura, r.timestamp_gps, MINUTE) BETWEEN 0 AND 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_veiculos`.`gps_brt`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.137572Z", "completed_at": "2024-09-30T15:23:16.167869Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.169156Z", "completed_at": "2024-09-30T15:23:16.169166Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.03403782844543457, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_brt_15_minutos", "compiled": true, "compiled_code": "\n/*\nDescri\u00e7\u00e3o:\nJun\u00e7\u00e3o dos passos de tratamento, junta as informa\u00e7\u00f5es extras que definimos a partir dos registros\ncapturados.\nPara descri\u00e7\u00e3o detalhada de como cada coluna \u00e9 calculada, consulte a documenta\u00e7\u00e3o de cada uma das tabelas\nutilizadas abaixo.\n1. registros_filtrada: filtragem e tratamento b\u00e1sico dos dados brutos capturados.\n2. aux_registros_velocidade: estimativa da velocidade de ve\u00edculo a cada ponto registrado e identifica\u00e7\u00e3o\ndo estado de movimento ('parado', 'andando')\n3. aux_registros_parada: identifica ve\u00edculos parados em terminais ou garagens conhecidas\n4. aux_registros_flag_trajeto_correto: calcula intersec\u00e7\u00f5es das posi\u00e7\u00f5es registradas para cada ve\u00edculo\ncom o tra\u00e7ado da linha informada.\n5. As jun\u00e7\u00f5es (joins) s\u00e3o feitas sobre o id_ve\u00edculo e a timestamp_gps.\n*/\nWITH\n     __dbt__cte__brt_aux_registros_velocidade as (\n\n/*\nDescri\u00e7\u00e3o:\nEstimativa das velocidades dos ve\u00edculos nos \u00faltimos 10 minutos contados a partir da timestamp_gps atual.\nEssa metodologia serve para determinar quais carros est\u00e3o em movimento e quais est\u00e3o parados.\n1. Calculamos a velocidade do ve\u00edculo no \u00faltimo trecho de 10 minutos de opera\u00e7\u00e3o.\nA implementa\u00e7\u00e3o utiliza a fun\u00e7\u00e3o 'first_value' com uma janela (cl\u00e1usula 'over') de at\u00e9 10 minutos anteriores \u00e0\ntimestamp_gps atual e calcula a dist\u00e2ncia do ponto mais antigo (o first_value na janela) ao ponto atual (posicao_veiculo_geo).\nDividimos essa dist\u00e2ncia pela diferen\u00e7a de tempo entre a timestamp_gps atual e a timestamp_gps do ponto mais\nantigo da janela (o qual recuperamos novamente com o uso de first_value).\nEsta diferen\u00e7a de tempo (datetime_diff) \u00e9 calculada em segundos, portanto multiplicamos o resultado da divis\u00e3o por um fator\n3.6 para que a velocidade esteja em quil\u00f4metros por hora. O resultado final \u00e9 arrendondado sem casas decimais.\nPor fim, cobrimos esse c\u00e1lculo com a fun\u00e7\u00e3o 'if_null' e retornamos zero para a velocidade em casos onde a divis\u00e3o retornaria\num valor nulo.\n2. Ap\u00f3s o calculo da velocidade, definimos a coluna 'status_movimento'. Ve\u00edculos abaixo da 'velocidade_limiar_parado', s\u00e3o\nconsiderados como 'parado'. Caso contr\u00e1rio, s\u00e3o considerados 'andando'\n*/\nwith\n    t_velocidade as (\n    select\n        data,\n        id_veiculo,\n        timestamp_gps,\n        servico,\n        ST_DISTANCE(\n                posicao_veiculo_geo,\n                lag(posicao_veiculo_geo) over (\n                partition by id_veiculo, servico\n                order by timestamp_gps)\n        ) distancia,\n        IFNULL(\n            SAFE_DIVIDE(\n                ST_DISTANCE(\n                posicao_veiculo_geo,\n                lag(posicao_veiculo_geo) over (\n                partition by id_veiculo, servico\n                order by timestamp_gps)\n                ),\n                DATETIME_DIFF(\n                timestamp_gps,\n                lag(timestamp_gps) over (\n                partition by id_veiculo, servico\n                order by timestamp_gps),\n                SECOND\n                )),\n            0\n        ) * 3.6 velocidade\n    FROM  `rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_aux_registros_filtrada`\n    WHERE\n    data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"\n    \n    ),\n    medias as (\n        select\n        data,\n        id_veiculo,\n        timestamp_gps,\n        servico,\n        distancia,\n        velocidade, # velocidade do pontual\n        AVG(velocidade) OVER (\n            PARTITION BY id_veiculo, servico\n            ORDER BY unix_seconds(timestamp(timestamp_gps))\n            RANGE BETWEEN 600 PRECEDING AND CURRENT ROW\n        ) velocidade_media # velocidade com m\u00e9dia m\u00f3vel\n    from t_velocidade\n    )\nSELECT\n    timestamp_gps,\n    data,\n    id_veiculo,\n    servico,\n    distancia,\n    ROUND(\n        CASE WHEN velocidade_media > 60\n            THEN 60\n            ELSE velocidade_media\n        END,\n        1) as velocidade,\n    -- 2. Determina\u00e7\u00e3o do estado de movimento do ve\u00edculo.\n    case\n        when velocidade_media < 3 then false\n        else true\n    end flag_em_movimento,\n    -- STRUCT( AS versao_maestro,  AS versao_maestro_bq) versao\nFROM medias\n),  __dbt__cte__brt_aux_registros_parada as (\n\n/*\nDescri\u00e7\u00e3o:\nIdentifica ve\u00edculos parados em terminais ou garagens conhecidas.\n1. Selecionamos os terminais conhecidos e uma geometria do tipo pol\u00edgono (Polygon) que cont\u00e9m buracos nas\nlocaliza\u00e7\u00f5es das garagens.\n2. Calculamos as dist\u00e2ncias do ve\u00edculos em rela\u00e7\u00e3o aos terminais conhecidos. Definimos aqui a coluna 'nrow',\nque identifica qual o terminal que est\u00e1 mais pr\u00f3ximo do ponto informado. No passo final, recuperamos apenas\nos dados com nrow = 1 (menor dist\u00e2ncia em rela\u00e7\u00e3o \u00e0 posi\u00e7\u00e3o do ve\u00edculo)\n3. Definimos uma distancia_limiar_parada. Caso o ve\u00edculo esteja a uma dist\u00e2ncia menor que este valor de uma\nparada, ser\u00e1 considerado como parado no terminal com menor distancia.\n4. Caso o veiculo n\u00e3o esteja intersectando o pol\u00edgono das garagens, ele ser\u00e1 considerado como parado dentro\nde uma garagem (o pol\u00edgono \u00e9 vazado nas garagens, a n\u00e3o intersec\u00e7\u00e3o implica em estar dentro de um dos 'buracos').\n*/\nWITH\n  terminais as (\n    -- 1. Selecionamos terminais, criando uma geometria de ponto para cada.\n    select\n      ST_GEOGPOINT(longitude, latitude) ponto_parada, nome_estacao nome_parada, 'terminal' tipo_parada\n    from rj-smtr.br_rj_riodejaneiro_transporte.estacoes_e_terminais_brt\n  ),\n  garagem_polygon AS (\n    -- 1. Selecionamos o pol\u00edgono das garagens.\n    SELECT  ST_GEOGFROMTEXT(WKT,make_valid => true) AS poly\n    FROM rj-smtr.br_rj_riodejaneiro_geo.garagens_polygon\n  ),\n  distancia AS (\n    --2. Calculamos as dist\u00e2ncias e definimos nrow\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      data,\n      servico,\n      posicao_veiculo_geo,\n      nome_parada,\n      tipo_parada,\n      ROUND(ST_DISTANCE(posicao_veiculo_geo, ponto_parada), 1) distancia_parada,\n      ROW_NUMBER() OVER (PARTITION BY timestamp_gps, id_veiculo, servico ORDER BY ST_DISTANCE(posicao_veiculo_geo, ponto_parada)) nrow\n    FROM terminais p\n    JOIN (\n      SELECT *\n      FROM\n        `rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_aux_registros_filtrada`\n      WHERE\n      data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n      AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"\n      \n    ) r\n    on 1=1\n  )\nSELECT\n  data,\n  id_veiculo,\n  timestamp_gps,\n  servico,\n  /*\n  3. e 4. Identificamos o status do ve\u00edculo como 'terminal', 'garagem' (para os ve\u00edculos parados) ou\n  'nao_identificado' (para os ve\u00edculos mais distantes de uma parada que o limiar definido)\n  */\n  case\n    when distancia_parada < 250 then tipo_parada\n    when not ST_INTERSECTS(posicao_veiculo_geo, (SELECT  poly FROM garagem_polygon)) then 'garagem'\n    else null\n  end tipo_parada,\nFROM distancia\nWHERE nrow = 1\n),  __dbt__cte__brt_aux_registros_flag_trajeto_correto as (\n\n/*\nDescri\u00e7\u00e3o:\nCalcula se o ve\u00edculo est\u00e1 dentro do trajeto correto dado o tra\u00e7ado (shape) cadastrado no SIGMOB em rela\u00e7\u00e3o \u00e0 linha que est\u00e1 sendo\ntransmitida.\n1. Calcula as intersec\u00e7\u00f5es definindo um 'buffer', utilizado por st_dwithin para identificar se o ponto est\u00e1 \u00e0 uma\ndist\u00e2ncia menor ou igual ao tamanho do buffer em rela\u00e7\u00e3o ao tra\u00e7ado definido no SIGMOB.\n2. Calcula um hist\u00f3rico de intersec\u00e7\u00f5es nos ultimos 10 minutos de registros de cada carro. Definimos que o carro \u00e9\nconsiderado fora do trajeto definido se a cada 10 minutos, ele n\u00e3o esteve dentro do tra\u00e7ado planejado pelo menos uma\nvez.\n3. Identifica se a linha informada no registro capturado existe nas defini\u00e7\u00f5es presentes no SIGMOB.\n4. Definimos em outra tabela uma 'data_versao_efetiva', esse passo serve tanto para definir qual vers\u00e3o do SIGMOB utilizaremos em\ncaso de falha na captura, quanto para definir qual vers\u00e3o ser\u00e1 utilizada para o c\u00e1lculo retroativo do hist\u00f3rico de registros que temos.\n5. Como n\u00e3o conseguimos identificar o itiner\u00e1rio que o carro est\u00e1 realizando, no passo counts, os resultados de\nintersec\u00e7\u00f5es s\u00e3o dobrados, devido ao fato de cada linha apresentar dois itiner\u00e1rios poss\u00edveis (ida/volta). Portanto,\nao final, realizamos uma agrega\u00e7\u00e3o LOGICAL_OR que \u00e9 true caso o carro esteja dentro do tra\u00e7ado de algum dos itiner\u00e1rios\nposs\u00edveis para a linha informada.\n*/\nWITH\n  registros AS (\n    SELECT id_veiculo, servico as linha, latitude, longitude, data, posicao_veiculo_geo, timestamp_gps\n    FROM\n      `rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_aux_registros_filtrada` r\n    WHERE\n    data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"\n  ),\n  intersec AS (\n    SELECT\n      r.*,\n      s.data_versao,\n      s.linha_gtfs,\n      s.route_id,\n      -- 1. Buffer e intersec\u00e7\u00f5es\n      CASE\n        WHEN st_dwithin(shape, posicao_veiculo_geo, 500) THEN TRUE\n        ELSE FALSE\n      END AS flag_trajeto_correto,\n      -- 2. Hist\u00f3rico de intersec\u00e7\u00f5es nos \u00faltimos 10 minutos a partir da timestamp_gps atual\n      CASE\n        WHEN\n          COUNT(CASE WHEN st_dwithin(shape, posicao_veiculo_geo, 500) THEN 1 END)\n          OVER (PARTITION BY id_veiculo\n                ORDER BY UNIX_SECONDS(TIMESTAMP(timestamp_gps))\n                RANGE BETWEEN 600 PRECEDING AND CURRENT ROW) >= 1\n          THEN True\n        ELSE False\n      END AS flag_trajeto_correto_hist,\n      -- 3. Identifica\u00e7\u00e3o de cadastro da linha no SIGMOB\n      CASE WHEN s.linha_gtfs IS NULL THEN False ELSE True END AS flag_linha_existe_sigmob,\n    -- 4. Join com data_versao_efetiva para defini\u00e7\u00e3o de quais shapes ser\u00e3o considerados no c\u00e1lculo das flags\n    FROM registros r\n    LEFT JOIN (\n      SELECT *\n      FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\n      WHERE id_modal_smtr in ('20', 'B')\n      AND data_versao = \"2022-06-10\"\n    ) s\n    ON\n      r.linha = s.linha_gtfs\n  )\n    -- 5. Agrega\u00e7\u00e3o com LOGICAL_OR para evitar duplica\u00e7\u00e3o de registros\n    SELECT\n      id_veiculo,\n      linha as servico,\n      linha_gtfs,\n      route_id,\n      data,\n      timestamp_gps,\n      LOGICAL_OR(flag_trajeto_correto) AS flag_trajeto_correto,\n      LOGICAL_OR(flag_trajeto_correto_hist) AS flag_trajeto_correto_hist,\n      LOGICAL_OR(flag_linha_existe_sigmob) AS flag_linha_existe_sigmob,\n      -- STRUCT( AS versao_maestro,\n      --        AS versao_maestro_bq,\n      --       data_versao AS data_versao_sigmob\n      --       ) versao\n    FROM\n      intersec i\n    GROUP BY\n      id_veiculo,\n      linha,\n      linha_gtfs,\n      route_id,\n      data,\n      data_versao,\n      timestamp_gps\n), registros as (\n    -- 1. registros_filtrada\n    SELECT\n        id_veiculo,\n        timestamp_gps,\n        timestamp_captura,\n        velocidade,\n        servico,\n        latitude,\n        longitude,\n    FROM `rj-smtr`.`br_rj_riodejaneiro_brt_gps`.`brt_aux_registros_filtrada`\n    ),\n    velocidades AS (\n    -- 2. velocidades\n    SELECT\n        id_veiculo, timestamp_gps, servico, velocidade, distancia, flag_em_movimento\n    FROM __dbt__cte__brt_aux_registros_velocidade\n    ),\n    paradas as (\n    -- 3. paradas\n    SELECT\n        id_veiculo, timestamp_gps, servico, tipo_parada,\n    FROM __dbt__cte__brt_aux_registros_parada\n    ),\n    flags AS (\n    -- 4. flag_trajeto_correto\n    SELECT\n        id_veiculo,\n        timestamp_gps,\n        servico,\n        route_id,\n        flag_linha_existe_sigmob,\n        flag_trajeto_correto,\n        flag_trajeto_correto_hist\n    FROM __dbt__cte__brt_aux_registros_flag_trajeto_correto\n    )\n-- 5. Jun\u00e7\u00e3o final\nSELECT\n    \"BRT\" modo,\n    r.timestamp_gps,\n    date(r.timestamp_gps) data,\n    extract(time from r.timestamp_gps) hora,\n    r.id_veiculo,\n    replace(r.servico, \" \", \"\") as servico,\n    r.latitude,\n    r.longitude,\n    CASE\n        WHEN\n        flag_em_movimento IS true AND flag_trajeto_correto_hist is true\n        THEN true\n    ELSE false\n    END flag_em_operacao,\n    v.flag_em_movimento,\n    p.tipo_parada,\n    flag_linha_existe_sigmob,\n    flag_trajeto_correto,\n    flag_trajeto_correto_hist,\n    CASE\n        WHEN flag_em_movimento IS true AND flag_trajeto_correto_hist is true\n        THEN 'Em opera\u00e7\u00e3o'\n        WHEN flag_em_movimento is true and flag_trajeto_correto_hist is false\n        THEN 'Operando fora trajeto'\n        WHEN flag_em_movimento is false\n        THEN\n            CASE\n                WHEN tipo_parada is not null\n                THEN concat(\"Parado \", tipo_parada)\n            ELSE\n                CASE\n                    WHEN flag_trajeto_correto_hist is true\n                    THEN 'Parado trajeto correto'\n                ELSE 'Parado fora trajeto'\n                END\n            END\n    END status,\n    r.velocidade velocidade_instantanea,\n    v.velocidade velocidade_estimada_10_min,\n    v.distancia,\n    \"\" as versao\nFROM\n    registros r\n\nJOIN\n    flags f\nON\n    r.id_veiculo = f.id_veiculo\n    AND r.timestamp_gps = f.timestamp_gps\n    AND r.servico = f.servico\n\nJOIN\n    velocidades v\nON\n    r.id_veiculo = v.id_veiculo\n    AND  r.timestamp_gps = v.timestamp_gps\n    AND  r.servico = v.servico\n\nJOIN\n    paradas p\nON\n    r.id_veiculo = p.id_veiculo\n    AND  r.timestamp_gps = p.timestamp_gps\n    AND r.servico = p.servico\n", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_veiculos`.`gps_brt_15_minutos`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.172944Z", "completed_at": "2024-09-30T15:23:16.201496Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.202846Z", "completed_at": "2024-09-30T15:23:16.202856Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0323183536529541, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_sppo", "compiled": true, "compiled_code": "\n/*\nDescri\u00e7\u00e3o:\nJun\u00e7\u00e3o dos passos de tratamento, junta as informa\u00e7\u00f5es extras que definimos a partir dos registros\ncapturados.\nPara descri\u00e7\u00e3o detalhada de como cada coluna \u00e9 calculada, consulte a documenta\u00e7\u00e3o de cada uma das tabelas\nutilizadas abaixo.\n1. registros_filtrada: filtragem e tratamento b\u00e1sico dos dados brutos capturados.\n2. aux_registros_velocidade: estimativa da velocidade de ve\u00edculo a cada ponto registrado e identifica\u00e7\u00e3o\ndo estado de movimento ('parado', 'andando')\n3. aux_registros_parada: identifica ve\u00edculos parados em terminais ou garagens conhecidas\n4. aux_registros_flag_trajeto_correto: calcula intersec\u00e7\u00f5es das posi\u00e7\u00f5es registradas para cada ve\u00edculo\ncom o tra\u00e7ado da linha informada.\n5. As jun\u00e7\u00f5es (joins) s\u00e3o feitas sobre o id_ve\u00edculo e a timestamp_gps.\n*/\nWITH\n   __dbt__cte__sppo_aux_registros_velocidade as (\n\n/*\nDescri\u00e7\u00e3o:\nEstimativa das velocidades dos ve\u00edculos nos \u00faltimos 10 minutos contados a partir da timestamp_gps atual.\nEssa metodologia serve para determinar quais carros est\u00e3o em movimento e quais est\u00e3o parados.\n1. Calculamos a velocidade do ve\u00edculo no \u00faltimo trecho de 10 minutos de opera\u00e7\u00e3o.\nA implementa\u00e7\u00e3o utiliza a fun\u00e7\u00e3o 'first_value' com uma janela (cl\u00e1usula 'over') de at\u00e9 10 minutos anteriores \u00e0\ntimestamp_gps atual e calcula a dist\u00e2ncia do ponto mais antigo (o first_value na janela) ao ponto atual (posicao_veiculo_geo).\nDividimos essa dist\u00e2ncia pela diferen\u00e7a de tempo entre a timestamp_gps atual e a timestamp_gps do ponto mais\nantigo da janela (o qual recuperamos novamente com o uso de first_value).\nEsta diferen\u00e7a de tempo (datetime_diff) \u00e9 calculada em segundos, portanto multiplicamos o resultado da divis\u00e3o por um fator\n3.6 para que a velocidade esteja em quil\u00f4metros por hora. O resultado final \u00e9 arrendondado sem casas decimais.\nPor fim, cobrimos esse c\u00e1lculo com a fun\u00e7\u00e3o 'if_null' e retornamos zero para a velocidade em casos onde a divis\u00e3o retornaria\num valor nulo.\n2. Ap\u00f3s o calculo da velocidade, definimos a coluna 'status_movimento'. Ve\u00edculos abaixo da 'velocidade_limiar_parado', s\u00e3o\nconsiderados como 'parado'. Caso contr\u00e1rio, s\u00e3o considerados 'andando'\n*/\nwith\n    t_velocidade as (\n    select\n        data,\n        id_veiculo,\n        timestamp_gps,\n        linha,\n        ST_DISTANCE(\n                posicao_veiculo_geo,\n                lag(posicao_veiculo_geo) over (\n                partition by id_veiculo, linha\n                order by timestamp_gps)\n        ) distancia,\n        IFNULL(\n            SAFE_DIVIDE(\n                ST_DISTANCE(\n                posicao_veiculo_geo,\n                lag(posicao_veiculo_geo) over (\n                partition by id_veiculo, linha\n                order by timestamp_gps)\n                ),\n                DATETIME_DIFF(\n                timestamp_gps,\n                lag(timestamp_gps) over (\n                partition by id_veiculo, linha\n                order by timestamp_gps),\n                SECOND\n                )),\n            0\n        ) * 3.6 velocidade\n    FROM  `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_filtrada`\n    WHERE\n        data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"),\n    medias as (\n        select\n        data,\n        id_veiculo,\n        timestamp_gps,\n        linha,\n        distancia,\n        velocidade, # velocidade do pontual\n        AVG(velocidade) OVER (\n            PARTITION BY id_veiculo, linha\n            ORDER BY unix_seconds(timestamp(timestamp_gps))\n            RANGE BETWEEN 600 PRECEDING AND CURRENT ROW\n        ) velocidade_media # velocidade com m\u00e9dia m\u00f3vel\n    from t_velocidade\n    )\nSELECT\n    timestamp_gps,\n    data,\n    id_veiculo,\n    linha,\n    distancia,\n    ROUND(\n        CASE WHEN velocidade_media > 60\n            THEN 60\n            ELSE velocidade_media\n        END,\n        1) as velocidade,\n    -- 2. Determina\u00e7\u00e3o do estado de movimento do ve\u00edculo.\n    case\n        when velocidade_media < 3 then false\n        else true\n    end flag_em_movimento,\nFROM medias\n),  __dbt__cte__sppo_aux_registros_parada as (\n\n\n/*\nDescri\u00e7\u00e3o:\nIdentifica ve\u00edculos parados em terminais ou garagens conhecidas.\n1. Selecionamos os terminais conhecidos e uma geometria do tipo pol\u00edgono (Polygon) que cont\u00e9m buracos nas\nlocaliza\u00e7\u00f5es das garagens.\n2. Calculamos as dist\u00e2ncias do ve\u00edculos em rela\u00e7\u00e3o aos terminais conhecidos. Definimos aqui a coluna 'nrow',\nque identifica qual o terminal que est\u00e1 mais pr\u00f3ximo do ponto informado. No passo final, recuperamos apenas\nos dados com nrow = 1 (menor dist\u00e2ncia em rela\u00e7\u00e3o \u00e0 posi\u00e7\u00e3o do ve\u00edculo)\n3. Definimos uma distancia_limiar_parada. Caso o ve\u00edculo esteja a uma dist\u00e2ncia menor que este valor de uma\nparada, ser\u00e1 considerado como parado no terminal com menor distancia.\n4. Caso o veiculo n\u00e3o esteja intersectando o pol\u00edgono das garagens, ele ser\u00e1 considerado como parado dentro\nde uma garagem (o pol\u00edgono \u00e9 vazado nas garagens, a n\u00e3o intersec\u00e7\u00e3o implica em estar dentro de um dos 'buracos').\n*/\nWITH\n  terminais as (\n    -- 1. Selecionamos terminais, criando uma geometria de ponto para cada.\n    select\n      ST_GEOGPOINT(longitude, latitude) ponto_parada, nome_terminal nome_parada, 'terminal' tipo_parada\n    from rj-smtr.br_rj_riodejaneiro_transporte.terminais_onibus_coordenadas\n  ),\n  garagem_polygon AS (\n    -- 1. Selecionamos o pol\u00edgono das garagens.\n    SELECT  ST_GEOGFROMTEXT(WKT,make_valid => true) AS poly\n    FROM rj-smtr.br_rj_riodejaneiro_geo.garagens_polygon\n  ),\n  distancia AS (\n    --2. Calculamos as dist\u00e2ncias e definimos nrow\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      data,\n      linha,\n      posicao_veiculo_geo,\n      nome_parada,\n      tipo_parada,\n      ROUND(ST_DISTANCE(posicao_veiculo_geo, ponto_parada), 1) distancia_parada,\n      ROW_NUMBER() OVER (PARTITION BY timestamp_gps, id_veiculo, linha ORDER BY ST_DISTANCE(posicao_veiculo_geo, ponto_parada)) nrow\n    FROM terminais p\n    JOIN (\n      SELECT\n        id_veiculo,\n        timestamp_gps,\n        data,\n        linha,\n        posicao_veiculo_geo\n      FROM\n        `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_filtrada`\n      \n      WHERE\n        data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n      AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"\n      \n  ) r\n    on 1=1\n  )\nSELECT\n  data,\n  id_veiculo,\n  timestamp_gps,\n  linha,\n  /*\n  3. e 4. Identificamos o status do ve\u00edculo como 'terminal', 'garagem' (para os ve\u00edculos parados) ou\n  null (para os ve\u00edculos mais distantes de uma parada que o limiar definido)\n  */\n  case\n    when distancia_parada < 250 then tipo_parada\n    when not ST_INTERSECTS(posicao_veiculo_geo, (SELECT  poly FROM garagem_polygon)) then 'garagem'\n    else null\n  end tipo_parada,\nFROM distancia\nWHERE nrow = 1\n),  __dbt__cte__sppo_aux_registros_flag_trajeto_correto as (\n\n\n/*\nDescri\u00e7\u00e3o:\nCalcula se o ve\u00edculo est\u00e1 dentro do trajeto correto dado o tra\u00e7ado (shape) cadastrado no SIGMOB em rela\u00e7\u00e3o \u00e0 linha que est\u00e1 sendo\ntransmitida.\n1. Calcula as intersec\u00e7\u00f5es definindo um 'buffer', utilizado por st_dwithin para identificar se o ponto est\u00e1 \u00e0 uma\ndist\u00e2ncia menor ou igual ao tamanho do buffer em rela\u00e7\u00e3o ao tra\u00e7ado definido no SIGMOB.\n2. Calcula um hist\u00f3rico de intersec\u00e7\u00f5es nos ultimos 10 minutos de registros de cada carro. Definimos que o carro \u00e9\nconsiderado fora do trajeto definido se a cada 10 minutos, ele n\u00e3o esteve dentro do tra\u00e7ado planejado pelo menos uma\nvez.\n3. Identifica se a linha informada no registro capturado existe nas defini\u00e7\u00f5es presentes no SIGMOB.\n4. Definimos em outra tabela uma 'data_versao_efetiva', esse passo serve tanto para definir qual vers\u00e3o do SIGMOB utilizaremos em\ncaso de falha na captura, quanto para definir qual vers\u00e3o ser\u00e1 utilizada para o c\u00e1lculo retroativo do hist\u00f3rico de registros que temos.\n5. Como n\u00e3o conseguimos identificar o itiner\u00e1rio que o carro est\u00e1 realizando, no passo counts, os resultados de\nintersec\u00e7\u00f5es s\u00e3o dobrados, devido ao fato de cada linha apresentar dois itiner\u00e1rios poss\u00edveis (ida/volta). Portanto,\nao final, realizamos uma agrega\u00e7\u00e3o LOGICAL_OR que \u00e9 true caso o carro esteja dentro do tra\u00e7ado de algum dos itiner\u00e1rios\nposs\u00edveis para a linha informada.\n*/\nWITH\n  registros AS (\n    SELECT\n      id_veiculo,\n      linha,\n      latitude,\n      longitude,\n      data,\n      posicao_veiculo_geo,\n      timestamp_gps\n    FROM\n      `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_filtrada` r\n    WHERE\n      data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"),\n  intersec AS (\n    SELECT\n      r.*,\n      s.data_versao,\n      s.linha_gtfs,\n      s.route_id,\n      -- 1. Buffer e intersec\u00e7\u00f5es\n      CASE\n        WHEN st_dwithin(shape, posicao_veiculo_geo, 500) THEN TRUE\n        ELSE FALSE\n      END AS flag_trajeto_correto,\n      -- 2. Hist\u00f3rico de intersec\u00e7\u00f5es nos \u00faltimos 10 minutos a partir da timestamp_gps atual\n      CASE\n        WHEN\n          COUNT(CASE WHEN st_dwithin(shape, posicao_veiculo_geo, 500) THEN 1 END)\n          OVER (PARTITION BY id_veiculo\n                ORDER BY UNIX_SECONDS(TIMESTAMP(timestamp_gps))\n                RANGE BETWEEN 600 PRECEDING AND CURRENT ROW) >= 1\n          THEN True\n        ELSE False\n      END AS flag_trajeto_correto_hist,\n      -- 3. Identifica\u00e7\u00e3o de cadastro da linha no SIGMOB\n      CASE WHEN s.linha_gtfs IS NULL THEN False ELSE True END AS flag_linha_existe_sigmob,\n    -- 4. Join com data_versao_efetiva para defini\u00e7\u00e3o de quais shapes ser\u00e3o considerados no c\u00e1lculo das flags\n    FROM registros r\n    LEFT JOIN (\n      SELECT *\n      FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\n      WHERE id_modal_smtr in ('22', '23', 'O')\n      AND data_versao = \"2022-06-10\"\n    ) s\n    ON\n      r.linha = s.linha_gtfs\n  )\n    -- 5. Agrega\u00e7\u00e3o com LOGICAL_OR para evitar duplica\u00e7\u00e3o de registros\n    SELECT\n      id_veiculo,\n      linha,\n      linha_gtfs,\n      route_id,\n      data,\n      timestamp_gps,\n      LOGICAL_OR(flag_trajeto_correto) AS flag_trajeto_correto,\n      LOGICAL_OR(flag_trajeto_correto_hist) AS flag_trajeto_correto_hist,\n      LOGICAL_OR(flag_linha_existe_sigmob) AS flag_linha_existe_sigmob,\n    FROM intersec i\n    GROUP BY\n      id_veiculo,\n      linha,\n      linha_gtfs,\n      route_id,\n      data,\n      data_versao,\n      timestamp_gps\n), registros as (\n  -- 1. registros_filtrada\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      timestamp_captura,\n      velocidade,\n      linha,\n      latitude,\n      longitude,\n    FROM `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_filtrada`\n    WHERE\n      data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n      AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"),\n  velocidades AS (\n    -- 2. velocidades\n    SELECT\n      id_veiculo, timestamp_gps, linha, velocidade, distancia, flag_em_movimento\n    FROM\n      __dbt__cte__sppo_aux_registros_velocidade\n  ),\n  paradas as (\n    -- 3. paradas\n    SELECT\n      id_veiculo, timestamp_gps, linha, tipo_parada,\n    FROM __dbt__cte__sppo_aux_registros_parada\n  ),\n  flags AS (\n    -- 4. flag_trajeto_correto\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      linha,\n      route_id,\n      flag_linha_existe_sigmob,\n      flag_trajeto_correto,\n      flag_trajeto_correto_hist\n    FROM\n      __dbt__cte__sppo_aux_registros_flag_trajeto_correto\n  )\n-- 5. Jun\u00e7\u00e3o final\nSELECT\n  \"SPPO\" modo,\n  r.timestamp_gps,\n  date(r.timestamp_gps) data,\n  extract(time from r.timestamp_gps) hora,\n  r.id_veiculo,\n  r.linha as servico,\n  r.latitude,\n  r.longitude,\n  CASE\n    WHEN\n      flag_em_movimento IS true AND flag_trajeto_correto_hist is true\n      THEN true\n  ELSE false\n  END flag_em_operacao,\n  v.flag_em_movimento,\n  p.tipo_parada,\n  flag_linha_existe_sigmob,\n  flag_trajeto_correto,\n  flag_trajeto_correto_hist,\n  CASE\n    WHEN flag_em_movimento IS true AND flag_trajeto_correto_hist is true\n    THEN 'Em opera\u00e7\u00e3o'\n    WHEN flag_em_movimento is true and flag_trajeto_correto_hist is false\n    THEN 'Operando fora trajeto'\n    WHEN flag_em_movimento is false\n    THEN\n        CASE\n            WHEN tipo_parada is not null\n            THEN concat(\"Parado \", tipo_parada)\n        ELSE\n            CASE\n                WHEN flag_trajeto_correto_hist is true\n                THEN 'Parado trajeto correto'\n            ELSE 'Parado fora trajeto'\n            END\n        END\n    END status,\n  r.velocidade velocidade_instantanea,\n  v.velocidade velocidade_estimada_10_min,\n  v.distancia,\n  \"\" as versao\nFROM\n  registros r\n\nJOIN\n  flags f\nON\n  r.id_veiculo = f.id_veiculo\n  AND r.timestamp_gps = f.timestamp_gps\n  AND r.linha = f.linha\n\nJOIN\n  velocidades v\nON\n  r.id_veiculo = v.id_veiculo\n  AND  r.timestamp_gps = v.timestamp_gps\n  AND  r.linha = v.linha\n\nJOIN\n  paradas p\nON\n  r.id_veiculo = p.id_veiculo\n  AND  r.timestamp_gps = p.timestamp_gps\n  AND r.linha = p.linha\nWHERE\n  date(r.timestamp_gps) between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n  AND r.timestamp_gps > \"2022-01-01T00:00:00\" and r.timestamp_gps <=\"2022-01-01T01:00:00\"", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_veiculos`.`gps_sppo`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.206761Z", "completed_at": "2024-09-30T15:23:16.234752Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.236160Z", "completed_at": "2024-09-30T15:23:16.236170Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.031888484954833984, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_sppo_15_minutos", "compiled": true, "compiled_code": "\n/*\nDescri\u00e7\u00e3o:\nJun\u00e7\u00e3o dos passos de tratamento, junta as informa\u00e7\u00f5es extras que definimos a partir dos registros\ncapturados.\nPara descri\u00e7\u00e3o detalhada de como cada coluna \u00e9 calculada, consulte a documenta\u00e7\u00e3o de cada uma das tabelas\nutilizadas abaixo.\n1. registros_filtrada: filtragem e tratamento b\u00e1sico dos dados brutos capturados.\n2. aux_registros_velocidade: estimativa da velocidade de ve\u00edculo a cada ponto registrado e identifica\u00e7\u00e3o\ndo estado de movimento ('parado', 'andando')\n3. aux_registros_parada: identifica ve\u00edculos parados em terminais ou garagens conhecidas\n4. aux_registros_flag_trajeto_correto: calcula intersec\u00e7\u00f5es das posi\u00e7\u00f5es registradas para cada ve\u00edculo\ncom o tra\u00e7ado da linha informada.\n5. As jun\u00e7\u00f5es (joins) s\u00e3o feitas sobre o id_ve\u00edculo e a timestamp_gps.\n*/\nWITH\n   __dbt__cte__sppo_aux_registros_velocidade as (\n\n/*\nDescri\u00e7\u00e3o:\nEstimativa das velocidades dos ve\u00edculos nos \u00faltimos 10 minutos contados a partir da timestamp_gps atual.\nEssa metodologia serve para determinar quais carros est\u00e3o em movimento e quais est\u00e3o parados.\n1. Calculamos a velocidade do ve\u00edculo no \u00faltimo trecho de 10 minutos de opera\u00e7\u00e3o.\nA implementa\u00e7\u00e3o utiliza a fun\u00e7\u00e3o 'first_value' com uma janela (cl\u00e1usula 'over') de at\u00e9 10 minutos anteriores \u00e0\ntimestamp_gps atual e calcula a dist\u00e2ncia do ponto mais antigo (o first_value na janela) ao ponto atual (posicao_veiculo_geo).\nDividimos essa dist\u00e2ncia pela diferen\u00e7a de tempo entre a timestamp_gps atual e a timestamp_gps do ponto mais\nantigo da janela (o qual recuperamos novamente com o uso de first_value).\nEsta diferen\u00e7a de tempo (datetime_diff) \u00e9 calculada em segundos, portanto multiplicamos o resultado da divis\u00e3o por um fator\n3.6 para que a velocidade esteja em quil\u00f4metros por hora. O resultado final \u00e9 arrendondado sem casas decimais.\nPor fim, cobrimos esse c\u00e1lculo com a fun\u00e7\u00e3o 'if_null' e retornamos zero para a velocidade em casos onde a divis\u00e3o retornaria\num valor nulo.\n2. Ap\u00f3s o calculo da velocidade, definimos a coluna 'status_movimento'. Ve\u00edculos abaixo da 'velocidade_limiar_parado', s\u00e3o\nconsiderados como 'parado'. Caso contr\u00e1rio, s\u00e3o considerados 'andando'\n*/\nwith\n    t_velocidade as (\n    select\n        data,\n        id_veiculo,\n        timestamp_gps,\n        linha,\n        ST_DISTANCE(\n                posicao_veiculo_geo,\n                lag(posicao_veiculo_geo) over (\n                partition by id_veiculo, linha\n                order by timestamp_gps)\n        ) distancia,\n        IFNULL(\n            SAFE_DIVIDE(\n                ST_DISTANCE(\n                posicao_veiculo_geo,\n                lag(posicao_veiculo_geo) over (\n                partition by id_veiculo, linha\n                order by timestamp_gps)\n                ),\n                DATETIME_DIFF(\n                timestamp_gps,\n                lag(timestamp_gps) over (\n                partition by id_veiculo, linha\n                order by timestamp_gps),\n                SECOND\n                )),\n            0\n        ) * 3.6 velocidade\n    FROM  `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_filtrada`\n    WHERE\n        data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"),\n    medias as (\n        select\n        data,\n        id_veiculo,\n        timestamp_gps,\n        linha,\n        distancia,\n        velocidade, # velocidade do pontual\n        AVG(velocidade) OVER (\n            PARTITION BY id_veiculo, linha\n            ORDER BY unix_seconds(timestamp(timestamp_gps))\n            RANGE BETWEEN 600 PRECEDING AND CURRENT ROW\n        ) velocidade_media # velocidade com m\u00e9dia m\u00f3vel\n    from t_velocidade\n    )\nSELECT\n    timestamp_gps,\n    data,\n    id_veiculo,\n    linha,\n    distancia,\n    ROUND(\n        CASE WHEN velocidade_media > 60\n            THEN 60\n            ELSE velocidade_media\n        END,\n        1) as velocidade,\n    -- 2. Determina\u00e7\u00e3o do estado de movimento do ve\u00edculo.\n    case\n        when velocidade_media < 3 then false\n        else true\n    end flag_em_movimento,\nFROM medias\n),  __dbt__cte__sppo_aux_registros_parada as (\n\n\n/*\nDescri\u00e7\u00e3o:\nIdentifica ve\u00edculos parados em terminais ou garagens conhecidas.\n1. Selecionamos os terminais conhecidos e uma geometria do tipo pol\u00edgono (Polygon) que cont\u00e9m buracos nas\nlocaliza\u00e7\u00f5es das garagens.\n2. Calculamos as dist\u00e2ncias do ve\u00edculos em rela\u00e7\u00e3o aos terminais conhecidos. Definimos aqui a coluna 'nrow',\nque identifica qual o terminal que est\u00e1 mais pr\u00f3ximo do ponto informado. No passo final, recuperamos apenas\nos dados com nrow = 1 (menor dist\u00e2ncia em rela\u00e7\u00e3o \u00e0 posi\u00e7\u00e3o do ve\u00edculo)\n3. Definimos uma distancia_limiar_parada. Caso o ve\u00edculo esteja a uma dist\u00e2ncia menor que este valor de uma\nparada, ser\u00e1 considerado como parado no terminal com menor distancia.\n4. Caso o veiculo n\u00e3o esteja intersectando o pol\u00edgono das garagens, ele ser\u00e1 considerado como parado dentro\nde uma garagem (o pol\u00edgono \u00e9 vazado nas garagens, a n\u00e3o intersec\u00e7\u00e3o implica em estar dentro de um dos 'buracos').\n*/\nWITH\n  terminais as (\n    -- 1. Selecionamos terminais, criando uma geometria de ponto para cada.\n    select\n      ST_GEOGPOINT(longitude, latitude) ponto_parada, nome_terminal nome_parada, 'terminal' tipo_parada\n    from rj-smtr.br_rj_riodejaneiro_transporte.terminais_onibus_coordenadas\n  ),\n  garagem_polygon AS (\n    -- 1. Selecionamos o pol\u00edgono das garagens.\n    SELECT  ST_GEOGFROMTEXT(WKT,make_valid => true) AS poly\n    FROM rj-smtr.br_rj_riodejaneiro_geo.garagens_polygon\n  ),\n  distancia AS (\n    --2. Calculamos as dist\u00e2ncias e definimos nrow\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      data,\n      linha,\n      posicao_veiculo_geo,\n      nome_parada,\n      tipo_parada,\n      ROUND(ST_DISTANCE(posicao_veiculo_geo, ponto_parada), 1) distancia_parada,\n      ROW_NUMBER() OVER (PARTITION BY timestamp_gps, id_veiculo, linha ORDER BY ST_DISTANCE(posicao_veiculo_geo, ponto_parada)) nrow\n    FROM terminais p\n    JOIN (\n      SELECT\n        id_veiculo,\n        timestamp_gps,\n        data,\n        linha,\n        posicao_veiculo_geo\n      FROM\n        `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_filtrada`\n      \n      WHERE\n        data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n      AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"\n      \n  ) r\n    on 1=1\n  )\nSELECT\n  data,\n  id_veiculo,\n  timestamp_gps,\n  linha,\n  /*\n  3. e 4. Identificamos o status do ve\u00edculo como 'terminal', 'garagem' (para os ve\u00edculos parados) ou\n  null (para os ve\u00edculos mais distantes de uma parada que o limiar definido)\n  */\n  case\n    when distancia_parada < 250 then tipo_parada\n    when not ST_INTERSECTS(posicao_veiculo_geo, (SELECT  poly FROM garagem_polygon)) then 'garagem'\n    else null\n  end tipo_parada,\nFROM distancia\nWHERE nrow = 1\n),  __dbt__cte__sppo_aux_registros_flag_trajeto_correto as (\n\n\n/*\nDescri\u00e7\u00e3o:\nCalcula se o ve\u00edculo est\u00e1 dentro do trajeto correto dado o tra\u00e7ado (shape) cadastrado no SIGMOB em rela\u00e7\u00e3o \u00e0 linha que est\u00e1 sendo\ntransmitida.\n1. Calcula as intersec\u00e7\u00f5es definindo um 'buffer', utilizado por st_dwithin para identificar se o ponto est\u00e1 \u00e0 uma\ndist\u00e2ncia menor ou igual ao tamanho do buffer em rela\u00e7\u00e3o ao tra\u00e7ado definido no SIGMOB.\n2. Calcula um hist\u00f3rico de intersec\u00e7\u00f5es nos ultimos 10 minutos de registros de cada carro. Definimos que o carro \u00e9\nconsiderado fora do trajeto definido se a cada 10 minutos, ele n\u00e3o esteve dentro do tra\u00e7ado planejado pelo menos uma\nvez.\n3. Identifica se a linha informada no registro capturado existe nas defini\u00e7\u00f5es presentes no SIGMOB.\n4. Definimos em outra tabela uma 'data_versao_efetiva', esse passo serve tanto para definir qual vers\u00e3o do SIGMOB utilizaremos em\ncaso de falha na captura, quanto para definir qual vers\u00e3o ser\u00e1 utilizada para o c\u00e1lculo retroativo do hist\u00f3rico de registros que temos.\n5. Como n\u00e3o conseguimos identificar o itiner\u00e1rio que o carro est\u00e1 realizando, no passo counts, os resultados de\nintersec\u00e7\u00f5es s\u00e3o dobrados, devido ao fato de cada linha apresentar dois itiner\u00e1rios poss\u00edveis (ida/volta). Portanto,\nao final, realizamos uma agrega\u00e7\u00e3o LOGICAL_OR que \u00e9 true caso o carro esteja dentro do tra\u00e7ado de algum dos itiner\u00e1rios\nposs\u00edveis para a linha informada.\n*/\nWITH\n  registros AS (\n    SELECT\n      id_veiculo,\n      linha,\n      latitude,\n      longitude,\n      data,\n      posicao_veiculo_geo,\n      timestamp_gps\n    FROM\n      `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_filtrada` r\n    WHERE\n      data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"),\n  intersec AS (\n    SELECT\n      r.*,\n      s.data_versao,\n      s.linha_gtfs,\n      s.route_id,\n      -- 1. Buffer e intersec\u00e7\u00f5es\n      CASE\n        WHEN st_dwithin(shape, posicao_veiculo_geo, 500) THEN TRUE\n        ELSE FALSE\n      END AS flag_trajeto_correto,\n      -- 2. Hist\u00f3rico de intersec\u00e7\u00f5es nos \u00faltimos 10 minutos a partir da timestamp_gps atual\n      CASE\n        WHEN\n          COUNT(CASE WHEN st_dwithin(shape, posicao_veiculo_geo, 500) THEN 1 END)\n          OVER (PARTITION BY id_veiculo\n                ORDER BY UNIX_SECONDS(TIMESTAMP(timestamp_gps))\n                RANGE BETWEEN 600 PRECEDING AND CURRENT ROW) >= 1\n          THEN True\n        ELSE False\n      END AS flag_trajeto_correto_hist,\n      -- 3. Identifica\u00e7\u00e3o de cadastro da linha no SIGMOB\n      CASE WHEN s.linha_gtfs IS NULL THEN False ELSE True END AS flag_linha_existe_sigmob,\n    -- 4. Join com data_versao_efetiva para defini\u00e7\u00e3o de quais shapes ser\u00e3o considerados no c\u00e1lculo das flags\n    FROM registros r\n    LEFT JOIN (\n      SELECT *\n      FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\n      WHERE id_modal_smtr in ('22', '23', 'O')\n      AND data_versao = \"2022-06-10\"\n    ) s\n    ON\n      r.linha = s.linha_gtfs\n  )\n    -- 5. Agrega\u00e7\u00e3o com LOGICAL_OR para evitar duplica\u00e7\u00e3o de registros\n    SELECT\n      id_veiculo,\n      linha,\n      linha_gtfs,\n      route_id,\n      data,\n      timestamp_gps,\n      LOGICAL_OR(flag_trajeto_correto) AS flag_trajeto_correto,\n      LOGICAL_OR(flag_trajeto_correto_hist) AS flag_trajeto_correto_hist,\n      LOGICAL_OR(flag_linha_existe_sigmob) AS flag_linha_existe_sigmob,\n    FROM intersec i\n    GROUP BY\n      id_veiculo,\n      linha,\n      linha_gtfs,\n      route_id,\n      data,\n      data_versao,\n      timestamp_gps\n), registros as (\n  -- 1. registros_filtrada\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      timestamp_captura,\n      velocidade,\n      linha,\n      latitude,\n      longitude,\n    FROM `rj-smtr`.`br_rj_riodejaneiro_onibus_gps`.`sppo_aux_registros_filtrada`\n    WHERE\n      data = DATE(\"2022-01-01T01:00:00\")\n      AND timestamp_gps > DATETIME_SUB(\"2022-01-01T01:00:00\", INTERVAL 75 MINUTE)\n      AND timestamp_gps <= \"2022-01-01T01:00:00\"\n  ),\n  velocidades AS (\n    -- 2. velocidades\n    SELECT\n      id_veiculo, timestamp_gps, linha, velocidade, distancia, flag_em_movimento\n    FROM\n      __dbt__cte__sppo_aux_registros_velocidade\n  ),\n  paradas as (\n    -- 3. paradas\n    SELECT\n      id_veiculo, timestamp_gps, linha, tipo_parada,\n    FROM __dbt__cte__sppo_aux_registros_parada\n  ),\n  flags AS (\n    -- 4. flag_trajeto_correto\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      linha,\n      route_id,\n      flag_linha_existe_sigmob,\n      flag_trajeto_correto,\n      flag_trajeto_correto_hist\n    FROM\n      __dbt__cte__sppo_aux_registros_flag_trajeto_correto\n  )\n-- 5. Jun\u00e7\u00e3o final\nSELECT\n  \"SPPO\" modo,\n  r.timestamp_gps,\n  date(r.timestamp_gps) data,\n  extract(time from r.timestamp_gps) hora,\n  r.id_veiculo,\n  r.linha as servico,\n  r.latitude,\n  r.longitude,\n  CASE\n    WHEN\n      flag_em_movimento IS true AND flag_trajeto_correto_hist is true\n      THEN true\n  ELSE false\n  END flag_em_operacao,\n  v.flag_em_movimento,\n  p.tipo_parada,\n  flag_linha_existe_sigmob,\n  flag_trajeto_correto,\n  flag_trajeto_correto_hist,\n  CASE\n    WHEN flag_em_movimento IS true AND flag_trajeto_correto_hist is true\n    THEN 'Em opera\u00e7\u00e3o'\n    WHEN flag_em_movimento is true and flag_trajeto_correto_hist is false\n    THEN 'Operando fora trajeto'\n    WHEN flag_em_movimento is false\n    THEN\n        CASE\n            WHEN tipo_parada is not null\n            THEN concat(\"Parado \", tipo_parada)\n        ELSE\n            CASE\n                WHEN flag_trajeto_correto_hist is true\n                THEN 'Parado trajeto correto'\n            ELSE 'Parado fora trajeto'\n            END\n        END\n    END status,\n  r.velocidade velocidade_instantanea,\n  v.velocidade velocidade_estimada_10_min,\n  v.distancia,\n  \"\" as versao\nFROM\n  registros r\n\nJOIN\n  flags f\nON\n  r.id_veiculo = f.id_veiculo\n  AND r.timestamp_gps = f.timestamp_gps\n  AND r.linha = f.linha\n\nJOIN\n  velocidades v\nON\n  r.id_veiculo = v.id_veiculo\n  AND  r.timestamp_gps = v.timestamp_gps\n  AND  r.linha = v.linha\n\nJOIN\n  paradas p\nON\n  r.id_veiculo = p.id_veiculo\n  AND  r.timestamp_gps = p.timestamp_gps\n  AND r.linha = p.linha\nWHERE\n  DATE(r.timestamp_gps) = DATE(\"2022-01-01T01:00:00\")\n  AND r.timestamp_gps > DATETIME_SUB(\"2022-01-01T01:00:00\", INTERVAL 75 MINUTE)\n  AND r.timestamp_gps <= \"2022-01-01T01:00:00\"", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_veiculos`.`gps_sppo_15_minutos`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.242408Z", "completed_at": "2024-09-30T15:23:16.269564Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.270941Z", "completed_at": "2024-09-30T15:23:16.270951Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.03264880180358887, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_sppo_zirix", "compiled": true, "compiled_code": "\n/*\nDescri\u00e7\u00e3o:\nJun\u00e7\u00e3o dos passos de tratamento, junta as informa\u00e7\u00f5es extras que definimos a partir dos registros\ncapturados.\nPara descri\u00e7\u00e3o detalhada de como cada coluna \u00e9 calculada, consulte a documenta\u00e7\u00e3o de cada uma das tabelas\nutilizadas abaixo.\n1. registros_filtrada: filtragem e tratamento b\u00e1sico dos dados brutos capturados.\n2. aux_registros_velocidade: estimativa da velocidade de ve\u00edculo a cada ponto registrado e identifica\u00e7\u00e3o\ndo estado de movimento ('parado', 'andando')\n3. aux_registros_parada: identifica ve\u00edculos parados em terminais ou garagens conhecidas\n4. aux_registros_flag_trajeto_correto: calcula intersec\u00e7\u00f5es das posi\u00e7\u00f5es registradas para cada ve\u00edculo\ncom o tra\u00e7ado da linha informada.\n5. As jun\u00e7\u00f5es (joins) s\u00e3o feitas sobre o id_ve\u00edculo e a timestamp_gps.\n*/\nWITH\n   __dbt__cte__sppo_aux_registros_velocidade_zirix as (\n\n/*\nDescri\u00e7\u00e3o:\nEstimativa das velocidades dos ve\u00edculos nos \u00faltimos 10 minutos contados a partir da timestamp_gps atual.\nEssa metodologia serve para determinar quais carros est\u00e3o em movimento e quais est\u00e3o parados.\n1. Calculamos a velocidade do ve\u00edculo no \u00faltimo trecho de 10 minutos de opera\u00e7\u00e3o.\nA implementa\u00e7\u00e3o utiliza a fun\u00e7\u00e3o 'first_value' com uma janela (cl\u00e1usula 'over') de at\u00e9 10 minutos anteriores \u00e0\ntimestamp_gps atual e calcula a dist\u00e2ncia do ponto mais antigo (o first_value na janela) ao ponto atual (posicao_veiculo_geo).\nDividimos essa dist\u00e2ncia pela diferen\u00e7a de tempo entre a timestamp_gps atual e a timestamp_gps do ponto mais\nantigo da janela (o qual recuperamos novamente com o uso de first_value).\nEsta diferen\u00e7a de tempo (datetime_diff) \u00e9 calculada em segundos, portanto multiplicamos o resultado da divis\u00e3o por um fator\n3.6 para que a velocidade esteja em quil\u00f4metros por hora. O resultado final \u00e9 arrendondado sem casas decimais.\nPor fim, cobrimos esse c\u00e1lculo com a fun\u00e7\u00e3o 'if_null' e retornamos zero para a velocidade em casos onde a divis\u00e3o retornaria\num valor nulo.\n2. Ap\u00f3s o calculo da velocidade, definimos a coluna 'status_movimento'. Ve\u00edculos abaixo da 'velocidade_limiar_parado', s\u00e3o\nconsiderados como 'parado'. Caso contr\u00e1rio, s\u00e3o considerados 'andando'\n*/\nwith\n    t_velocidade as (\n    select\n        data,\n        id_veiculo,\n        timestamp_gps,\n        linha,\n        ST_DISTANCE(\n                posicao_veiculo_geo,\n                lag(posicao_veiculo_geo) over (\n                partition by id_veiculo, linha\n                order by timestamp_gps)\n        ) distancia,\n        IFNULL(\n            SAFE_DIVIDE(\n                ST_DISTANCE(\n                posicao_veiculo_geo,\n                lag(posicao_veiculo_geo) over (\n                partition by id_veiculo, linha\n                order by timestamp_gps)\n                ),\n                DATETIME_DIFF(\n                timestamp_gps,\n                lag(timestamp_gps) over (\n                partition by id_veiculo, linha\n                order by timestamp_gps),\n                SECOND\n                )),\n            0\n        ) * 3.6 velocidade\n    FROM  `rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_aux_registro_filtrada`\n    WHERE\n        data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"),\n    medias as (\n        select\n        data,\n        id_veiculo,\n        timestamp_gps,\n        linha,\n        distancia,\n        velocidade, # velocidade do pontual\n        AVG(velocidade) OVER (\n            PARTITION BY id_veiculo, linha\n            ORDER BY unix_seconds(timestamp(timestamp_gps))\n            RANGE BETWEEN 600 PRECEDING AND CURRENT ROW\n        ) velocidade_media # velocidade com m\u00e9dia m\u00f3vel\n    from t_velocidade\n    )\nSELECT\n    timestamp_gps,\n    data,\n    id_veiculo,\n    linha,\n    distancia,\n    ROUND(\n        CASE WHEN velocidade_media > 60\n            THEN 60\n            ELSE velocidade_media\n        END,\n        1) as velocidade,\n    -- 2. Determina\u00e7\u00e3o do estado de movimento do ve\u00edculo.\n    case\n        when velocidade_media < 3 then false\n        else true\n    end flag_em_movimento,\nFROM medias\n),  __dbt__cte__sppo_aux_registros_parada_zirix as (\n\n\n/*\nDescri\u00e7\u00e3o:\nIdentifica ve\u00edculos parados em terminais ou garagens conhecidas.\n1. Selecionamos os terminais conhecidos e uma geometria do tipo pol\u00edgono (Polygon) que cont\u00e9m buracos nas\nlocaliza\u00e7\u00f5es das garagens.\n2. Calculamos as dist\u00e2ncias do ve\u00edculos em rela\u00e7\u00e3o aos terminais conhecidos. Definimos aqui a coluna 'nrow',\nque identifica qual o terminal que est\u00e1 mais pr\u00f3ximo do ponto informado. No passo final, recuperamos apenas\nos dados com nrow = 1 (menor dist\u00e2ncia em rela\u00e7\u00e3o \u00e0 posi\u00e7\u00e3o do ve\u00edculo)\n3. Definimos uma distancia_limiar_parada. Caso o ve\u00edculo esteja a uma dist\u00e2ncia menor que este valor de uma\nparada, ser\u00e1 considerado como parado no terminal com menor distancia.\n4. Caso o veiculo n\u00e3o esteja intersectando o pol\u00edgono das garagens, ele ser\u00e1 considerado como parado dentro\nde uma garagem (o pol\u00edgono \u00e9 vazado nas garagens, a n\u00e3o intersec\u00e7\u00e3o implica em estar dentro de um dos 'buracos').\n*/\nWITH\n  terminais as (\n    -- 1. Selecionamos terminais, criando uma geometria de ponto para cada.\n    select\n      ST_GEOGPOINT(longitude, latitude) ponto_parada, nome_terminal nome_parada, 'terminal' tipo_parada\n    from rj-smtr.br_rj_riodejaneiro_transporte.terminais_onibus_coordenadas\n  ),\n  garagem_polygon AS (\n    -- 1. Selecionamos o pol\u00edgono das garagens.\n    SELECT  ST_GEOGFROMTEXT(WKT,make_valid => true) AS poly\n    FROM rj-smtr.br_rj_riodejaneiro_geo.garagens_polygon\n  ),\n  distancia AS (\n    --2. Calculamos as dist\u00e2ncias e definimos nrow\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      data,\n      linha,\n      posicao_veiculo_geo,\n      nome_parada,\n      tipo_parada,\n      ROUND(ST_DISTANCE(posicao_veiculo_geo, ponto_parada), 1) distancia_parada,\n      ROW_NUMBER() OVER (PARTITION BY timestamp_gps, id_veiculo, linha ORDER BY ST_DISTANCE(posicao_veiculo_geo, ponto_parada)) nrow\n    FROM terminais p\n    JOIN (\n      SELECT\n        id_veiculo,\n        timestamp_gps,\n        data,\n        linha,\n        posicao_veiculo_geo\n      FROM\n        `rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_aux_registro_filtrada`\n      \n      WHERE\n        data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n      AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"\n      \n  ) r\n    on 1=1\n  )\nSELECT\n  data,\n  id_veiculo,\n  timestamp_gps,\n  linha,\n  /*\n  3. e 4. Identificamos o status do ve\u00edculo como 'terminal', 'garagem' (para os ve\u00edculos parados) ou\n  null (para os ve\u00edculos mais distantes de uma parada que o limiar definido)\n  */\n  case\n    when distancia_parada < 250 then tipo_parada\n    when not ST_INTERSECTS(posicao_veiculo_geo, (SELECT  poly FROM garagem_polygon)) then 'garagem'\n    else null\n  end tipo_parada,\nFROM distancia\nWHERE nrow = 1\n),  __dbt__cte__sppo_aux_registros_flag_trajeto_correto_zirix as (\n\n\n/*\nDescri\u00e7\u00e3o:\nCalcula se o ve\u00edculo est\u00e1 dentro do trajeto correto dado o tra\u00e7ado (shape) cadastrado no SIGMOB em rela\u00e7\u00e3o \u00e0 linha que est\u00e1 sendo\ntransmitida.\n1. Calcula as intersec\u00e7\u00f5es definindo um 'buffer', utilizado por st_dwithin para identificar se o ponto est\u00e1 \u00e0 uma\ndist\u00e2ncia menor ou igual ao tamanho do buffer em rela\u00e7\u00e3o ao tra\u00e7ado definido no SIGMOB.\n2. Calcula um hist\u00f3rico de intersec\u00e7\u00f5es nos ultimos 10 minutos de registros de cada carro. Definimos que o carro \u00e9\nconsiderado fora do trajeto definido se a cada 10 minutos, ele n\u00e3o esteve dentro do tra\u00e7ado planejado pelo menos uma\nvez.\n3. Identifica se a linha informada no registro capturado existe nas defini\u00e7\u00f5es presentes no SIGMOB.\n4. Definimos em outra tabela uma 'data_versao_efetiva', esse passo serve tanto para definir qual vers\u00e3o do SIGMOB utilizaremos em\ncaso de falha na captura, quanto para definir qual vers\u00e3o ser\u00e1 utilizada para o c\u00e1lculo retroativo do hist\u00f3rico de registros que temos.\n5. Como n\u00e3o conseguimos identificar o itiner\u00e1rio que o carro est\u00e1 realizando, no passo counts, os resultados de\nintersec\u00e7\u00f5es s\u00e3o dobrados, devido ao fato de cada linha apresentar dois itiner\u00e1rios poss\u00edveis (ida/volta). Portanto,\nao final, realizamos uma agrega\u00e7\u00e3o LOGICAL_OR que \u00e9 true caso o carro esteja dentro do tra\u00e7ado de algum dos itiner\u00e1rios\nposs\u00edveis para a linha informada.\n*/\nWITH\n  registros AS (\n    SELECT\n      id_veiculo,\n      linha,\n      latitude,\n      longitude,\n      data,\n      posicao_veiculo_geo,\n      timestamp_gps\n    FROM\n      `rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_aux_registro_filtrada` r\n    WHERE\n      data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n    AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"),\n  intersec AS (\n    SELECT\n      r.*,\n      s.data_versao,\n      s.linha_gtfs,\n      s.route_id,\n      -- 1. Buffer e intersec\u00e7\u00f5es\n      CASE\n        WHEN st_dwithin(shape, posicao_veiculo_geo, 500) THEN TRUE\n        ELSE FALSE\n      END AS flag_trajeto_correto,\n      -- 2. Hist\u00f3rico de intersec\u00e7\u00f5es nos \u00faltimos 10 minutos a partir da timestamp_gps atual\n      CASE\n        WHEN\n          COUNT(CASE WHEN st_dwithin(shape, posicao_veiculo_geo, 500) THEN 1 END)\n          OVER (PARTITION BY id_veiculo\n                ORDER BY UNIX_SECONDS(TIMESTAMP(timestamp_gps))\n                RANGE BETWEEN 600 PRECEDING AND CURRENT ROW) >= 1\n          THEN True\n        ELSE False\n      END AS flag_trajeto_correto_hist,\n      -- 3. Identifica\u00e7\u00e3o de cadastro da linha no SIGMOB\n      CASE WHEN s.linha_gtfs IS NULL THEN False ELSE True END AS flag_linha_existe_sigmob,\n    -- 4. Join com data_versao_efetiva para defini\u00e7\u00e3o de quais shapes ser\u00e3o considerados no c\u00e1lculo das flags\n    FROM registros r\n    LEFT JOIN (\n      SELECT *\n      FROM `rj-smtr`.`br_rj_riodejaneiro_sigmob`.`shapes_geom`\n      WHERE id_modal_smtr in ('22', '23', 'O')\n      AND data_versao = \"2022-06-10\"\n    ) s\n    ON\n      r.linha = s.linha_gtfs\n  )\n    -- 5. Agrega\u00e7\u00e3o com LOGICAL_OR para evitar duplica\u00e7\u00e3o de registros\n    SELECT\n      id_veiculo,\n      linha,\n      linha_gtfs,\n      route_id,\n      data,\n      timestamp_gps,\n      LOGICAL_OR(flag_trajeto_correto) AS flag_trajeto_correto,\n      LOGICAL_OR(flag_trajeto_correto_hist) AS flag_trajeto_correto_hist,\n      LOGICAL_OR(flag_linha_existe_sigmob) AS flag_linha_existe_sigmob,\n    FROM intersec i\n    GROUP BY\n      id_veiculo,\n      linha,\n      linha_gtfs,\n      route_id,\n      data,\n      data_versao,\n      timestamp_gps\n), registros as (\n  -- 1. registros_filtrada\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      timestamp_captura,\n      velocidade,\n      linha,\n      latitude,\n      longitude,\n    FROM `rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`sppo_aux_registro_filtrada`\n    WHERE\n      data between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n      AND timestamp_gps > \"2022-01-01T00:00:00\" and timestamp_gps <=\"2022-01-01T01:00:00\"),\n  velocidades AS (\n    -- 2. velocidades\n    SELECT\n      id_veiculo, timestamp_gps, linha, velocidade, distancia, flag_em_movimento\n    FROM\n      __dbt__cte__sppo_aux_registros_velocidade_zirix\n  ),\n  paradas as (\n    -- 3. paradas\n    SELECT\n      id_veiculo, timestamp_gps, linha, tipo_parada,\n    FROM __dbt__cte__sppo_aux_registros_parada_zirix\n  ),\n  flags AS (\n    -- 4. flag_trajeto_correto\n    SELECT\n      id_veiculo,\n      timestamp_gps,\n      linha,\n      route_id,\n      flag_linha_existe_sigmob,\n      flag_trajeto_correto,\n      flag_trajeto_correto_hist\n    FROM\n      __dbt__cte__sppo_aux_registros_flag_trajeto_correto_zirix\n  )\n-- 5. Jun\u00e7\u00e3o final\nSELECT\n  \"SPPO\" modo,\n  r.timestamp_gps,\n  date(r.timestamp_gps) data,\n  extract(time from r.timestamp_gps) hora,\n  r.id_veiculo,\n  r.linha as servico,\n  r.latitude,\n  r.longitude,\n  CASE\n    WHEN\n      flag_em_movimento IS true AND flag_trajeto_correto_hist is true\n      THEN true\n  ELSE false\n  END flag_em_operacao,\n  v.flag_em_movimento,\n  p.tipo_parada,\n  flag_linha_existe_sigmob,\n  flag_trajeto_correto,\n  flag_trajeto_correto_hist,\n  CASE\n    WHEN flag_em_movimento IS true AND flag_trajeto_correto_hist is true\n    THEN 'Em opera\u00e7\u00e3o'\n    WHEN flag_em_movimento is true and flag_trajeto_correto_hist is false\n    THEN 'Operando fora trajeto'\n    WHEN flag_em_movimento is false\n    THEN\n        CASE\n            WHEN tipo_parada is not null\n            THEN concat(\"Parado \", tipo_parada)\n        ELSE\n            CASE\n                WHEN flag_trajeto_correto_hist is true\n                THEN 'Parado trajeto correto'\n            ELSE 'Parado fora trajeto'\n            END\n        END\n    END status,\n  r.velocidade velocidade_instantanea,\n  v.velocidade velocidade_estimada_10_min,\n  v.distancia,\n  \"\" as versao\nFROM\n  registros r\n\nJOIN\n  flags f\nON\n  r.id_veiculo = f.id_veiculo\n  AND r.timestamp_gps = f.timestamp_gps\n  AND r.linha = f.linha\n\nJOIN\n  velocidades v\nON\n  r.id_veiculo = v.id_veiculo\n  AND  r.timestamp_gps = v.timestamp_gps\n  AND  r.linha = v.linha\n\nJOIN\n  paradas p\nON\n  r.id_veiculo = p.id_veiculo\n  AND  r.timestamp_gps = p.timestamp_gps\n  AND r.linha = p.linha\nWHERE\n  date(r.timestamp_gps) between DATE(\"2022-01-01T00:00:00\") and DATE(\"2022-01-01T01:00:00\")\n  AND r.timestamp_gps > \"2022-01-01T00:00:00\" and r.timestamp_gps <=\"2022-01-01T01:00:00\"", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_onibus_gps_zirix`.`gps_sppo`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.274868Z", "completed_at": "2024-09-30T15:23:16.334752Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.336118Z", "completed_at": "2024-09-30T15:23:16.336128Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.06371855735778809, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_servico_trips_shapes_gtfs", "compiled": true, "compiled_code": "\n\nWITH\n   __dbt__cte__trips_filtrada_aux_gtfs as (\n-- depends_on: `rj-smtr`.`gtfs`.`ordem_servico_trajeto_alternativo`\n/*\nIdentifica\u00e7\u00e3o de um trip de refer\u00eancia para cada servi\u00e7o e sentido regular\nIdentifica\u00e7\u00e3o de todas as trips de refer\u00eancia para os trajetos alternativos\n*/\n\n\n\n\n\nWITH\n  -- 1. Busca os shapes em formato geogr\u00e1fico\n  shapes AS (\n    SELECT\n      *\n    FROM\n      `rj-smtr`.`gtfs`.`shapes_geom`\n    ),\n  -- 2. Busca as trips\n  trips_all AS (\n    SELECT\n      *,\n      CASE\n        WHEN indicador_trajeto_alternativo = TRUE THEN CONCAT(feed_version, trip_short_name, tipo_dia, direction_id, shape_id)\n        ELSE CONCAT(feed_version, trip_short_name, tipo_dia, direction_id)\n      END AS trip_partition\n    FROM\n    (\n      SELECT\n        service_id,\n        trip_id,\n        trip_headsign,\n        trip_short_name,\n        direction_id,\n        shape_id,\n        feed_version,\n        shape_distance,\n        start_pt,\n        end_pt,\n        CASE\n          WHEN service_id LIKE \"%U_%\" THEN \"Dia \u00datil\"\n          WHEN service_id LIKE \"%S_%\" THEN \"Sabado\"\n          WHEN service_id LIKE \"%D_%\" THEN \"Domingo\"\n        ELSE\n        service_id\n      END\n        AS tipo_dia,\n        CASE WHEN (\n          \n          trip_headsign LIKE \"%[revers\u00edvel]%\" OR\n          \n          trip_headsign LIKE \"%[excepcionalidade]%\" OR\n          \n          trip_headsign LIKE \"%[desvio_feira]%\" OR\n          \n          trip_headsign LIKE \"%[excepcionalidade_1]%\" OR\n          \n          trip_headsign LIKE \"%[excepcionalidade_2]%\" OR\n          \n          trip_headsign LIKE \"%[desvio] [feira]%\" OR\n          \n          trip_headsign LIKE \"%[excepcionalidade] 1%\" OR\n          \n          trip_headsign LIKE \"%[excepcionalidade] 2%\" OR\n          \n          trip_headsign LIKE \"%[madonna]%\" OR\n          \n          trip_headsign LIKE \"%[madonna 3]%\" OR\n          \n          trip_headsign LIKE \"%[madonna 2]%\" OR\n          \n          trip_headsign LIKE \"%[madonna 1]%\" OR\n          \n          trip_headsign LIKE \"%[desvio_t\u00fanel]%\" OR\n          \n          trip_headsign LIKE \"%[desvio_lazer]%\" OR\n          \n          trip_headsign LIKE \"%[rock_in_rio]%\" OR\n          \n          trip_headsign LIKE \"%[desvio_maracan\u00e3]%\" OR\n          \n          trip_headsign LIKE \"%[desvio_janu\u00e1rio]%\" OR\n          \n          service_id = \"EXCEP\") THEN TRUE\n        ELSE FALSE\n      END\n        AS indicador_trajeto_alternativo,\n      FROM\n        `rj-smtr`.`gtfs`.`trips`\n      LEFT JOIN\n        shapes\n      USING\n        (feed_start_date,\n        feed_version,\n        shape_id)\n      WHERE\n        \n        service_id NOT LIKE \"%_DESAT_%\"  -- Desconsidera service_ids desativados\n    )\n  )\n-- 3. Busca as trips de refer\u00eancia para cada servi\u00e7o, sentido, e tipo_dia\nSELECT\n    * EXCEPT(rn)\nFROM\n(\n    SELECT\n    * EXCEPT(shape_distance),\n    ROW_NUMBER() OVER (PARTITION BY trip_partition ORDER BY feed_version, trip_short_name, tipo_dia, direction_id, shape_distance DESC) AS rn\n    FROM\n    trips_all\n)\nWHERE\n    rn = 1\n),  __dbt__cte__ordem_servico_sentido_atualizado_aux_gtfs as (\n/*\n  ordem_servico_gtfs com sentidos despivotados, ajustes nos hor\u00e1rios e com atualiza\u00e7\u00e3o dos sentidos circulares\n*/\n\n\nWITH\n  -- 1. Identifica o sentido de cada servi\u00e7o\n  servico_trips_sentido AS (\n    SELECT\n      DISTINCT *\n    FROM\n      (\n        SELECT\n          feed_version,\n          trip_short_name AS servico,\n          CASE\n            WHEN ROUND(ST_Y(start_pt),4) = ROUND(ST_Y(end_pt),4) AND ROUND(ST_X(start_pt),4) = ROUND(ST_X(end_pt),4) THEN \"C\"\n            WHEN direction_id = \"0\" THEN \"I\"\n            WHEN direction_id = \"1\" THEN \"V\"\n        END\n          AS sentido\n        FROM\n          __dbt__cte__trips_filtrada_aux_gtfs\n        WHERE\n          indicador_trajeto_alternativo IS FALSE\n      )\n    WHERE\n      sentido = \"C\"\n  ),\n  -- 2. Busca principais informa\u00e7\u00f5es na Ordem de Servi\u00e7o (OS)\n  ordem_servico AS (\n    SELECT\n      * EXCEPT(horario_inicio, horario_fim),\n      horario_inicio AS inicio_periodo,\n      horario_fim  AS fim_periodo,\n    FROM\n      `rj-smtr`.`gtfs`.`ordem_servico`\n    \n  ),\n  -- 3. Despivota ordem de servi\u00e7o por sentido\n  ordem_servico_sentido AS (\n    SELECT\n      *\n    FROM\n      ordem_servico\n    UNPIVOT\n    (\n      (\n        distancia_planejada,\n        partidas\n      ) FOR sentido IN (\n        (\n          extensao_ida,\n          partidas_ida\n        ) AS \"I\",\n        (\n          extensao_volta,\n          partidas_volta\n        ) AS \"V\"\n      )\n    )\n  )\n  -- 4. Atualiza sentido dos servi\u00e7os circulares na ordem de servi\u00e7o\nSELECT\n    o.* EXCEPT(sentido),\n    COALESCE(s.sentido, o.sentido) AS sentido\nFROM\n    ordem_servico_sentido AS o\nLEFT JOIN\n    servico_trips_sentido AS s\nUSING\n    (feed_version, servico)\nWHERE\n    distancia_planejada != 0\n    AND\n      (\n        (\n          feed_start_date < '2024-08-16'\n          AND\n            (\n              distancia_total_planejada != 0\n              AND (partidas != 0 OR partidas IS NULL)\n            )\n        )\n      OR\n        feed_start_date >= '2024-08-16'\n      )\n),  __dbt__cte__ordem_servico_trajeto_alternativo_sentido_atualizado_aux_gtfs as (\n/*\n  ordem_servico_trajeto_alternativo_gtfs com sentidos despivotados e com atualiza\u00e7\u00e3o dos sentidos circulares\n*/\n\n\n\n-- 1. Busca anexo de trajetos alternativos\nWITH\n  ordem_servico_trajeto_alternativo AS (\n    SELECT\n      *\n    FROM\n      `rj-smtr`.`gtfs`.`ordem_servico_trajeto_alternativo`\n    \n  ),\n  -- 2. Despivota anexo de trajetos alternativos\n  ordem_servico_trajeto_alternativo_sentido AS (\n    SELECT\n      *\n    FROM\n      ordem_servico_trajeto_alternativo\n    UNPIVOT\n    (\n      (\n        distancia_planejada\n      ) FOR sentido IN (\n        (\n          extensao_ida\n        ) AS \"I\",\n        (\n          extensao_volta\n        ) AS \"V\"\n      )\n    )\n  )\n-- 3. Atualiza sentido dos servi\u00e7os circulares no anexo de trajetos alternativos\nSELECT\n    * EXCEPT(sentido),\n    CASE\n        WHEN \"C\" IN UNNEST(sentido_array) THEN \"C\"\n        ELSE o.sentido\n    END AS sentido,\nFROM\n    ordem_servico_trajeto_alternativo_sentido AS o\nLEFT JOIN\n(\n    SELECT\n        feed_start_date,\n        servico,\n        ARRAY_AGG(DISTINCT sentido) AS sentido_array,\n    FROM\n        __dbt__cte__ordem_servico_sentido_atualizado_aux_gtfs\n    GROUP BY\n        1,\n        2\n) AS s\nUSING\n    (feed_start_date, servico)\nWHERE\n    distancia_planejada != 0\n), -- 1. Busca os shapes em formato geogr\u00e1fico\n  shapes AS (\n    SELECT\n      *\n    FROM\n      `rj-smtr`.`gtfs`.`shapes_geom`\n    WHERE\n      feed_start_date = '2024-05-03'\n    ),\n  -- 2. Trata a OS, inclui trip_ids e ajusta nomes das colunas\n  ordem_servico_tratada AS (\n  SELECT\n    *\n  FROM\n    (\n      (\n      SELECT\n        o.feed_version,\n        o.feed_start_date,\n        o.feed_end_date,\n        o.tipo_os,\n        o.tipo_dia,\n        servico,\n        vista,\n        consorcio,\n        sentido,\n        distancia_planejada,\n        distancia_total_planejada,\n        inicio_periodo,\n        fim_periodo,\n        trip_id,\n        shape_id,\n        indicador_trajeto_alternativo\n      FROM\n        __dbt__cte__ordem_servico_sentido_atualizado_aux_gtfs AS o\n      LEFT JOIN\n        __dbt__cte__trips_filtrada_aux_gtfs AS t\n      ON\n        t.feed_version = o.feed_version\n        AND o.servico = t.trip_short_name\n        AND\n          ((o.tipo_dia = t.tipo_dia AND o.tipo_os != \"CNU\")\n          OR (o.tipo_dia = \"Ponto Facultativo\" AND t.tipo_dia = \"Dia \u00datil\" AND o.tipo_os != \"CNU\")\n          OR (o.feed_start_date = \"2024-08-16\" AND o.tipo_os = \"CNU\" AND o.tipo_dia = \"Domingo\" AND t.tipo_dia = \"Sabado\")) -- Domingo CNU\n        AND\n          ((o.sentido IN (\"I\", \"C\") AND t.direction_id = \"0\")\n          OR (o.sentido = \"V\" AND t.direction_id = \"1\"))\n      WHERE\n        indicador_trajeto_alternativo IS FALSE\n      )\n    UNION ALL\n      (\n      SELECT\n        o.feed_version,\n        o.feed_start_date,\n        o.feed_end_date,\n        o.tipo_os,\n        o.tipo_dia,\n        servico,\n        o.vista || \" \" || ot.evento AS vista,\n        o.consorcio,\n        sentido,\n        ot.distancia_planejada,\n        distancia_total_planejada,\n        COALESCE(ot.inicio_periodo, o.inicio_periodo) AS inicio_periodo,\n        COALESCE(ot.fim_periodo, o.fim_periodo) AS fim_periodo,\n        trip_id,\n        shape_id,\n        indicador_trajeto_alternativo\n      FROM\n        __dbt__cte__ordem_servico_trajeto_alternativo_sentido_atualizado_aux_gtfs AS ot\n      LEFT JOIN\n        __dbt__cte__ordem_servico_sentido_atualizado_aux_gtfs AS o\n      USING\n        (feed_version,\n          tipo_os,\n          servico,\n          sentido)\n      LEFT JOIN\n        __dbt__cte__trips_filtrada_aux_gtfs AS t\n      ON\n        t.feed_version = o.feed_version\n        AND o.servico = t.trip_short_name\n        AND\n          (o.tipo_dia = t.tipo_dia\n          OR (o.tipo_dia = \"Ponto Facultativo\" AND t.tipo_dia = \"Dia \u00datil\")\n          OR (t.tipo_dia = \"EXCEP\")) -- Inclui trips do service_id/tipo_dia \"EXCEP\"\n        AND\n          ((o.sentido IN (\"I\", \"C\") AND t.direction_id = \"0\")\n          OR (o.sentido = \"V\" AND t.direction_id = \"1\"))\n        AND t.trip_headsign LIKE CONCAT(\"%\", ot.evento, \"%\")\n      WHERE\n        indicador_trajeto_alternativo IS TRUE\n        AND trip_id IS NOT NULL -- Remove servi\u00e7os de tipo_dia sem planejamento\n      )\n    )\n  ),\n  -- 3. Inclui trip_ids de ida e volta para trajetos circulares, ajusta shape_id para trajetos circulares e inclui id_tipo_trajeto\n  ordem_servico_trips AS (\n    SELECT\n      * EXCEPT(shape_id, indicador_trajeto_alternativo),\n      shape_id AS shape_id_planejado,\n      CASE\n        WHEN sentido = \"C\" THEN shape_id || \"_\" || SPLIT(trip_id, \"_\")[OFFSET(1)]\n      ELSE\n      shape_id\n    END\n      AS shape_id,\n      CASE\n        WHEN indicador_trajeto_alternativo IS FALSE THEN 0 -- Trajeto regular\n        WHEN indicador_trajeto_alternativo IS TRUE THEN 1 -- Trajeto alternativo\n    END\n      AS id_tipo_trajeto,\n    FROM\n    (\n      (\n        SELECT\n          DISTINCT * EXCEPT(trip_id),\n          trip_id AS trip_id_planejado,\n          trip_id\n        FROM\n          ordem_servico_tratada\n        WHERE\n          sentido = \"I\"\n          OR sentido = \"V\"\n      )\n      UNION ALL\n      (\n        SELECT\n          * EXCEPT(trip_id),\n          trip_id AS trip_id_planejado,\n          CONCAT(trip_id, \"_0\") AS trip_id,\n        FROM\n          ordem_servico_tratada\n        WHERE\n          sentido = \"C\"\n      )\n      UNION ALL\n      (\n        SELECT\n          * EXCEPT(trip_id),\n          trip_id AS trip_id_planejado,\n          CONCAT(trip_id, \"_1\") AS trip_id,\n        FROM\n          ordem_servico_tratada\n        WHERE\n          sentido = \"C\"\n      )\n    )\n  )\nSELECT\n  feed_version,\n  feed_start_date,\n  o.feed_end_date,\n  tipo_os,\n  tipo_dia,\n  servico,\n  vista,\n  o.consorcio,\n  sentido,\n  CASE\n    WHEN feed_start_date >= '2024-08-16' THEN fh.partidas\n    ELSE NULL\n  END AS partidas_total_planejada,\n  distancia_planejada,\n  CASE\n    WHEN feed_start_date >= '2024-08-16' THEN fh.quilometragem\n    ELSE distancia_total_planejada\n  END AS distancia_total_planejada,\n  inicio_periodo,\n  fim_periodo,\n  CASE\n    WHEN feed_start_date >= '2024-08-16' THEN fh.faixa_horaria_inicio\n    ELSE \"00:00:00\"\n  END AS faixa_horaria_inicio,\n  CASE\n    WHEN feed_start_date >= '2024-08-16' THEN fh.faixa_horaria_fim\n    ELSE \"23:59:59\"\n  END AS faixa_horaria_fim,\n  trip_id_planejado,\n  trip_id,\n  shape_id,\n  shape_id_planejado,\n  shape,\n  CASE\n    WHEN sentido = \"C\" AND SPLIT(shape_id, \"_\")[OFFSET(1)] = \"0\" THEN \"I\"\n    WHEN sentido = \"C\" AND SPLIT(shape_id, \"_\")[OFFSET(1)] = \"1\" THEN \"V\"\n    WHEN sentido = \"I\" OR sentido = \"V\" THEN sentido\nEND\n  AS sentido_shape,\n  s.start_pt,\n  s.end_pt,\n  id_tipo_trajeto,\nFROM\n  ordem_servico_trips AS o\nLEFT JOIN\n  shapes AS s\nUSING\n  (feed_version,\n    feed_start_date,\n    shape_id)\nLEFT JOIN\n  `rj-smtr`.`planejamento`.`ordem_servico_faixa_horaria` AS fh\n  -- rj-smtr-dev.gtfs.ordem_servico_faixa_horaria AS fh\nUSING\n  (feed_version, feed_start_date, tipo_os, tipo_dia, servico)\nWHERE\nfeed_start_date = '2024-05-03' AND\n(\n    (\n    feed_start_date >= '2024-08-16'\n    AND\n      (\n        fh.quilometragem != 0\n        AND (fh.partidas != 0 OR fh.partidas IS NULL)\n      )\n    )\n    OR\n      feed_start_date < '2024-08-16'\n  )", "relation_name": "`rj-smtr`.`gtfs`.`ordem_servico_trips_shapes`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.339993Z", "completed_at": "2024-09-30T15:23:16.345832Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.347082Z", "completed_at": "2024-09-30T15:23:16.347090Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009497404098510742, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_validador", "compiled": true, "compiled_code": "\n\nSELECT\n    modo,\n    EXTRACT(DATE FROM datetime_gps) AS data,\n    EXTRACT(HOUR FROM datetime_gps) AS hora,\n    datetime_gps,\n    datetime_captura,\n    id_operadora,\n    operadora,\n    id_servico_jae,\n    -- s.servico,\n    servico_jae,\n    descricao_servico_jae,\n    CASE\n      WHEN modo = \"VLT\" THEN SUBSTRING(id_veiculo, 1, 3)\n      WHEN modo = \"BRT\" THEN NULL\n      ELSE id_veiculo\n    END AS id_veiculo,\n    id_validador,\n    id_transmissao_gps,\n    latitude,\n    longitude,\n    sentido,\n    estado_equipamento,\n    temperatura,\n    versao_app,\n    '' as versao\nFROM\n(\n    SELECT\n        *,\n        ROW_NUMBER() OVER(PARTITION BY id_transmissao_gps ORDER BY datetime_captura DESC) AS rn\n    FROM\n        `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`gps_validador_aux`\n\n    \n      WHERE\n          DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n          AND datetime_captura > DATETIME(\"2022-01-01T00:00:00\") AND datetime_captura <= DATETIME(\"2022-01-01T01:00:00\")\n    \n)\nWHERE\n    rn = 1\n    AND modo != \"Van\"", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`gps_validador`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.350935Z", "completed_at": "2024-09-30T15:23:16.356881Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:16.358134Z", "completed_at": "2024-09-30T15:23:16.358142Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009685516357421875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_validador_van", "compiled": true, "compiled_code": "\n\nSELECT\n    modo,\n    EXTRACT(DATE FROM datetime_gps) AS data,\n    EXTRACT(HOUR FROM datetime_gps) AS hora,\n    datetime_gps,\n    datetime_captura,\n    id_operadora,\n    operadora,\n    id_servico_jae,\n    -- s.servico,\n    servico_jae,\n    descricao_servico_jae,\n    id_veiculo,\n    id_validador,\n    id_transmissao_gps,\n    latitude,\n    longitude,\n    sentido,\n    estado_equipamento,\n    temperatura,\n    versao_app,\n    '' as versao\nFROM\n(\n    SELECT\n        *,\n        ROW_NUMBER() OVER(PARTITION BY id_transmissao_gps ORDER BY datetime_captura DESC) AS rn\n    FROM\n        `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`gps_validador_aux`\n    \n        WHERE\n            DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n            AND datetime_captura > DATETIME(\"2022-01-01T00:00:00\") AND datetime_captura <= DATETIME(\"2022-01-01T01:00:00\")\n    \n)\nWHERE\n    rn = 1\n    AND modo = \"Van\"", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`gps_validador_van`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:16.362083Z", "completed_at": "2024-09-30T15:23:18.523821Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:18.529423Z", "completed_at": "2024-09-30T15:23:18.529460Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.172910213470459, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.integracao_invalida", "compiled": true, "compiled_code": "\n\n\n\n  \n\n    \n\n    \n    \n\n    \n    \n  \n\n\nWITH sequencias_validas AS (\n  SELECT\n    id_matriz_integracao,\n    STRING_AGG(modo, ', ' ORDER BY sequencia_integracao) AS modos\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`matriz_integracao`\n  GROUP BY\n    id_matriz_integracao\n),\nintegracao_agg AS (\n  SELECT\n    DATE(datetime_processamento_integracao) AS data,\n    id_integracao,\n    STRING_AGG(modo, ', ' ORDER BY sequencia_integracao) AS modos,\n    MIN(datetime_transacao) AS datetime_primeira_transacao,\n    MAX(datetime_transacao) AS datetime_ultima_transacao,\n    MIN(intervalo_integracao) AS menor_intervalo\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`integracao`\n    \n      WHERE\n      \n        data = \"2000-01-01\"\n      \n    \n  GROUP BY\n    1,\n    2\n),\nindicadores AS (\n  SELECT\n    data,\n    id_integracao,\n    modos,\n    modos NOT IN (SELECT DISTINCT modos FROM sequencias_validas) AS indicador_fora_matriz,\n    TIMESTAMP_DIFF(datetime_ultima_transacao, datetime_primeira_transacao, MINUTE) > 180 AS indicador_tempo_integracao_invalido,\n    menor_intervalo < 5 AS indicador_intervalo_transacao_suspeito\n  FROM\n    integracao_agg\n)\nSELECT\n  *,\n  '' as versao\nFROM\n  indicadores\nWHERE\n  indicador_fora_matriz = TRUE\n  OR indicador_tempo_integracao_invalido = TRUE\n  OR indicador_intervalo_transacao_suspeito = TRUE", "relation_name": "`rj-smtr`.`validacao_dados_jae`.`integracao_invalida`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:18.542902Z", "completed_at": "2024-09-30T15:23:18.556350Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:18.558014Z", "completed_at": "2024-09-30T15:23:18.558027Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.020180225372314453, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.view_integracao", "compiled": true, "compiled_code": "WITH servicos AS (\n    SELECT\n        * EXCEPT(rn)\n    FROM\n        (\n            SELECT\n                *,\n                ROW_NUMBER() OVER (PARTITION BY id_servico_jae ORDER BY data_inicio_vigencia) AS rn\n            FROM\n                `rj-smtr`.`cadastro`.`servicos`\n        )\n    WHERE\n        rn = 1\n),\ndados_filtrados AS (\n    SELECT\n        i.data,\n        i.hora,\n        i.id_integracao,\n        i.sequencia_integracao,\n        i.modo,\n        s.descricao_servico,\n        i.consorcio,\n        i.datetime_transacao\n    FROM\n        `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`integracao` i\n    LEFT JOIN\n        servicos s\n    USING(id_servico_jae)\n    WHERE\n        data >= \"2024-02-24\"\n        AND servico NOT IN (\"888888\", \"999999\")\n        AND id_operadora != \"2\"\n)\nSELECT\n    a.data,\n    a.hora,\n    a.id_integracao,\n    a.sequencia_integracao AS perna_origem,\n    a.modo AS modo_origem,\n    CONCAT(a.modo, '(', a.sequencia_integracao, ')') AS modo_origem_perna,\n    a.consorcio AS consorcio_origem,\n    a.descricao_servico AS descricao_servico_origem,\n    CONCAT(a.descricao_servico, '(', a.sequencia_integracao, ')') AS descricao_servico_origem_perna,\n    b.sequencia_integracao AS perna_destino,\n    b.modo AS modo_destino,\n    CONCAT(b.modo, '(', b.sequencia_integracao, ')') AS modo_destino_perna,\n    b.consorcio AS consorcio_destino,\n    b.descricao_servico AS descricao_servico_destino,\n    CONCAT(b.descricao_servico, '(', b.sequencia_integracao, ')') AS descricao_servico_destino_perna,\n    TIMESTAMP_DIFF(b.datetime_transacao, a.datetime_transacao, MINUTE) AS tempo_integracao_minutos\nFROM\n    dados_filtrados a\nJOIN\n    dados_filtrados b\nON\n    a.id_integracao = b.id_integracao\n    AND a.sequencia_integracao = b.sequencia_integracao - 1", "relation_name": "`rj-smtr`.`dashboard_bilhetagem_jae`.`view_integracao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:18.566410Z", "completed_at": "2024-09-30T15:23:22.623428Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:22.629107Z", "completed_at": "2024-09-30T15:23:22.629143Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.071105241775513, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_pagamento_consorcio_operador_dia", "compiled": true, "compiled_code": "\n-- depends_on: `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_servico_operador_dia`\n\n\n\n\n  \n    -- Verifica as ordens de pagamento capturadas\n    \n\n    \n  \n\n\nWITH pagamento AS (\n  SELECT\n    data_pagamento,\n    data_ordem,\n    id_consorcio,\n    id_operadora,\n    valor_pago\n  FROM\n    `rj-smtr`.`controle_financeiro_staging`.`aux_retorno_ordem_pagamento`\n    -- `rj-smtr.controle_financeiro_staging.aux_retorno_ordem_pagamento`\n  \n    WHERE\n    \n      data_ordem = '2000-01-01'\n    \n  \n),\nordem_pagamento AS (\n  SELECT\n  o.data_ordem,\n  o.id_ordem_pagamento_consorcio_operadora AS id_ordem_pagamento_consorcio_operador_dia,\n  dc.id_consorcio,\n  dc.consorcio,\n  do.id_operadora,\n  do.operadora,\n  op.id_ordem_pagamento AS id_ordem_pagamento,\n  o.qtd_debito AS quantidade_transacao_debito,\n  o.valor_debito,\n  o.qtd_vendaabordo AS quantidade_transacao_especie,\n  o.valor_vendaabordo AS valor_especie,\n  o.qtd_gratuidade AS quantidade_transacao_gratuidade,\n  o.valor_gratuidade,\n  o.qtd_integracao AS quantidade_transacao_integracao,\n  o.valor_integracao,\n  o.qtd_rateio_credito AS quantidade_transacao_rateio_credito,\n  o.valor_rateio_credito AS valor_rateio_credito,\n  o.qtd_rateio_debito AS quantidade_transacao_rateio_debito,\n  o.valor_rateio_debito AS valor_rateio_debito,\n  (\n    o.qtd_debito\n    + o.qtd_vendaabordo\n    + o.qtd_gratuidade\n    + o.qtd_integracao\n  ) AS quantidade_total_transacao,\n  o.valor_bruto AS valor_total_transacao_bruto,\n  o.valor_taxa AS valor_desconto_taxa,\n  o.valor_liquido AS valor_total_transacao_liquido_ordem\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_pagamento_consorcio_operadora` o\n    -- `rj-smtr.br_rj_riodejaneiro_bilhetagem_staging.ordem_pagamento_consorcio_operadora` o\n  JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_pagamento` op\n    -- `rj-smtr.br_rj_riodejaneiro_bilhetagem_staging.ordem_pagamento` op\n  ON\n    o.data_ordem = op.data_ordem\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`operadoras` do\n    -- `rj-smtr.cadastro.operadoras` do\n  ON\n    o.id_operadora = do.id_operadora_jae\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`consorcios` dc\n    -- `rj-smtr.cadastro.consorcios` dc\n  ON\n    o.id_consorcio = dc.id_consorcio_jae\n  \n    WHERE\n      DATE(o.data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n  \n),\nordem_pagamento_completa AS (\n  SELECT\n    *,\n    0 AS priority\n  FROM\n    ordem_pagamento\n\n  \n),\nordem_valor_pagamento AS (\n  SELECT\n    data_ordem,\n    id_ordem_pagamento_consorcio_operador_dia,\n    id_consorcio,\n    o.consorcio,\n    id_operadora,\n    o.operadora,\n    o.id_ordem_pagamento,\n    o.quantidade_transacao_debito,\n    o.valor_debito,\n    o.quantidade_transacao_especie,\n    o.valor_especie,\n    o.quantidade_transacao_gratuidade,\n    o.valor_gratuidade,\n    o.quantidade_transacao_integracao,\n    o.valor_integracao,\n    o.quantidade_transacao_rateio_credito,\n    o.valor_rateio_credito,\n    o.quantidade_transacao_rateio_debito,\n    o.valor_rateio_debito,\n    o.quantidade_total_transacao,\n    o.valor_total_transacao_bruto,\n    o.valor_desconto_taxa,\n    o.valor_total_transacao_liquido_ordem,\n    p.data_pagamento,\n    p.valor_pago,\n    ROW_NUMBER() OVER (PARTITION BY data_ordem, id_consorcio, id_operadora ORDER BY priority) AS rn\n  FROM\n    ordem_pagamento_completa o\n  LEFT JOIN\n    pagamento p\n  USING(data_ordem, id_consorcio, id_operadora)\n)\nSELECT\n  data_ordem,\n  id_ordem_pagamento_consorcio_operador_dia,\n  id_consorcio,\n  consorcio,\n  id_operadora,\n  operadora,\n  id_ordem_pagamento,\n  quantidade_transacao_debito,\n  valor_debito,\n  quantidade_transacao_especie,\n  valor_especie,\n  quantidade_transacao_gratuidade,\n  valor_gratuidade,\n  quantidade_transacao_integracao,\n  valor_integracao,\n  quantidade_transacao_rateio_credito,\n  valor_rateio_credito,\n  quantidade_transacao_rateio_debito,\n  valor_rateio_debito,\n  quantidade_total_transacao,\n  valor_total_transacao_bruto,\n  valor_desconto_taxa,\n  valor_total_transacao_liquido_ordem,\n  CASE\n    WHEN\n      data_ordem = '2024-06-07'\n      AND id_consorcio = '2'\n      AND id_operadora = '8'\n    THEN\n      valor_total_transacao_liquido_ordem - 1403.4532 -- Corrigir valor pago incorretamente ao VLT na ordem do dia 2024-05-31\n    ELSE valor_total_transacao_liquido_ordem\n  END AS valor_total_transacao_liquido,\n  data_pagamento,\n  valor_pago,\n  '' AS versao\nFROM\n  ordem_valor_pagamento\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_consorcio_operador_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:22.642261Z", "completed_at": "2024-09-30T15:23:24.663302Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:24.666763Z", "completed_at": "2024-09-30T15:23:24.666783Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.0298573970794678, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.aux_registros_status_trajeto", "compiled": true, "compiled_code": "-- depends_on: `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_data_versao_efetiva`\n\n    \n    \n\n\n\n    \n\n\n\n\n-- 1. Seleciona sinais de GPS registrados no per\u00edodo\nwith gps as (\n    select\n        g.* except(longitude, latitude, servico),\n        \n        servico,\n        \n        substr(id_veiculo, 2, 3) as id_empresa,\n        ST_GEOGPOINT(longitude, latitude) posicao_veiculo_geo,\n        \n    from\n        -- `rj-smtr.br_rj_riodejaneiro_veiculos.gps_sppo` g\n        `rj-smtr`.`br_rj_riodejaneiro_veiculos`.`gps_sppo` g\n    where (\n        data between date_sub(date(\"2022-01-01T01:00:00\"), interval 1 day) and date(\"2022-01-01T01:00:00\")\n    )\n    -- Limita range de busca do gps de D-2 \u00e0s 00h at\u00e9 D-1 \u00e0s 3h\n    and (\n        timestamp_gps between datetime_sub(datetime_trunc(\"2022-01-01T01:00:00\", day), interval 1 day)\n        and datetime_add(datetime_trunc(\"2022-01-01T01:00:00\", day), interval 3 hour)\n    )\n    and status != \"Parado garagem\"\n    \n),\n-- 2. Classifica a posi\u00e7\u00e3o do ve\u00edculo em todos os shapes poss\u00edveis de\n--    servi\u00e7os de uma mesma empresa\nstatus_viagem as (\n    select\n        \n        g.data,\n        \n        g.id_veiculo,\n        g.id_empresa,\n        g.timestamp_gps,\n        timestamp_trunc(g.timestamp_gps, minute) as timestamp_minuto_gps,\n        g.posicao_veiculo_geo,\n        TRIM(g.servico, \" \") as servico_informado,\n        s.servico as servico_realizado,\n        s.shape_id,\n        s.sentido_shape,\n        s.shape_id_planejado,\n        s.trip_id,\n        s.trip_id_planejado,\n        s.sentido,\n        s.start_pt,\n        s.end_pt,\n        s.distancia_planejada,\n        ifnull(g.distancia,0) as distancia,\n        case\n            when ST_DWITHIN(g.posicao_veiculo_geo, start_pt, 500)\n            then 'start'\n            when ST_DWITHIN(g.posicao_veiculo_geo, end_pt, 500)\n            then 'end'\n            when ST_DWITHIN(g.posicao_veiculo_geo, shape, 500)\n            then 'middle'\n        else 'out'\n        end status_viagem\n    from\n        gps g\n    inner join (\n        select\n            *\n        from\n            `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n        where\n            \n            data between date_sub(date(\"2022-01-01T01:00:00\"), interval 1 day) and date(\"2022-01-01T01:00:00\")\n            \n    ) s\n    on\n        \n        g.data = s.data\n        \n        and g.servico = s.servico\n)\nselect\n    *,\n    '' as versao_modelo\nfrom\n    status_viagem\n\n", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:24.674645Z", "completed_at": "2024-09-30T15:23:31.831182Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.837377Z", "completed_at": "2024-09-30T15:23:31.837426Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 7.170123338699341, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sppo_veiculo_dia", "compiled": true, "compiled_code": "-- depends_on: `rj-smtr`.`veiculo_staging`.`sppo_licenciamento_stu`\n\n\n\n  \n\n\nWITH\n  licenciamento AS (\n  SELECT\n    DATE(\"2022-01-01T01:00:00\") AS data,\n    id_veiculo,\n    placa,\n    tipo_veiculo,\n    indicador_ar_condicionado,\n    TRUE AS indicador_licenciado,\n    CASE\n    WHEN ano_ultima_vistoria_atualizado >= CAST(EXTRACT(YEAR FROM DATE_SUB(DATE(\"2022-01-01T01:00:00\"), INTERVAL 1 YEAR)) AS INT64) THEN TRUE -- \u00daltima vistoria realizada dentro do per\u00edodo v\u00e1lido\n    WHEN data_ultima_vistoria IS NULL AND DATE_DIFF(DATE(\"2022-01-01T01:00:00\"), data_inicio_vinculo, DAY) <=  15 THEN TRUE -- Caso o ve\u00edculo seja novo, existe a toler\u00e2ncia de 15 dias para a primeira vistoria\n    WHEN ano_fabricacao IN (2023, 2024) AND CAST(EXTRACT(YEAR FROM DATE(\"2022-01-01T01:00:00\")) AS INT64) = 2024 THEN TRUE -- Caso o ve\u00edculo tiver ano de fabrica\u00e7\u00e3o 2023 ou 2024, ser\u00e1 considerado como vistoriado apenas em 2024 (regra de transi\u00e7\u00e3o)\n  ELSE FALSE\n  END AS indicador_vistoriado,\n  FROM\n    `rj-smtr`.`veiculo`.`sppo_licenciamento` --`rj-smtr`.`veiculo`.`sppo_licenciamento`\n  WHERE\n    data = DATE(\"2023-02-01\")\n  ),\n  gps AS (\n  SELECT\n    DISTINCT data,\n    id_veiculo\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_veiculos`.`gps_sppo`\n    -- rj-smtr.br_rj_riodejaneiro_veiculos.gps_sppo\n  WHERE\n    data = DATE(\"2022-01-01T01:00:00\") ),\n  autuacoes AS (\n  SELECT\n    DISTINCT data_infracao AS data,\n    placa,\n    id_infracao\n  FROM\n    `rj-smtr`.`veiculo`.`sppo_infracao`\n  WHERE\n    \n  data = DATE(\"2023-02-10\")\n    AND data_infracao = DATE(\"2022-01-01T01:00:00\")\n    AND modo = \"ONIBUS\"),\n  registros_agente_verao AS (\n    SELECT\n      DISTINCT data,\n      id_veiculo,\n      TRUE AS indicador_registro_agente_verao_ar_condicionado\n    FROM\n      `rj-smtr`.`veiculo`.`sppo_registro_agente_verao`\n      -- rj-smtr.veiculo.sppo_registro_agente_verao\n    WHERE\n      data = DATE(\"2022-01-01T01:00:00\") ),\n  autuacao_ar_condicionado AS (\n  SELECT\n    data,\n    placa,\n    TRUE AS indicador_autuacao_ar_condicionado\n  FROM\n    autuacoes\n  WHERE\n    id_infracao = \"023.II\" ),\n  autuacao_seguranca AS (\n  SELECT\n    data,\n    placa,\n    TRUE AS indicador_autuacao_seguranca\n  FROM\n    autuacoes\n  WHERE\n    id_infracao IN (\n      \"016.VI\",\n      \"023.VII\",\n      \"024.II\",\n      \"024.III\",\n      \"024.IV\",\n      \"024.V\",\n      \"024.VI\",\n      \"024.VII\",\n      \"024.VIII\",\n      \"024.IX\",\n      \"024.XII\",\n      \"024.XIV\",\n      \"024.XV\",\n      \"025.II\",\n      \"025.XII\",\n      \"025.XIII\",\n      \"025.XIV\",\n      \"026.X\") ),\n  autuacao_equipamento AS (\n  SELECT\n    data,\n    placa,\n    TRUE AS indicador_autuacao_equipamento\n  FROM\n    autuacoes\n  WHERE\n    id_infracao IN (\n      \"023.IV\",\n      \"023.V\",\n      \"023.VI\",\n      \"023.VIII\",\n      \"024.XIII\",\n      \"024.XI\",\n      \"024.XVIII\",\n      \"024.XXI\",\n      \"025.III\",\n      \"025.IV\",\n      \"025.V\",\n      \"025.VI\",\n      \"025.VII\",\n      \"025.VIII\",\n      \"025.IX\",\n      \"025.X\",\n      \"025.XI\") ),\n  autuacao_limpeza AS (\n  SELECT\n    data,\n    placa,\n    TRUE AS indicador_autuacao_limpeza\n  FROM\n    autuacoes\n  WHERE\n    id_infracao IN (\n      \"023.IX\",\n      \"024.X\") ),\n  autuacoes_agg AS (\n  SELECT\n    DISTINCT *\n  FROM\n    autuacao_ar_condicionado\n  FULL JOIN\n    autuacao_seguranca\n  USING\n    (data,\n      placa)\n  FULL JOIN\n    autuacao_equipamento\n  USING\n    (data,\n      placa)\n  FULL JOIN\n    autuacao_limpeza\n  USING\n    (data,\n      placa) ),\n  gps_licenciamento_autuacao AS (\n  SELECT\n    data,\n    id_veiculo,\n    \n      STRUCT( COALESCE(l.indicador_licenciado, FALSE)                     AS indicador_licenciado,\n              COALESCE(l.indicador_ar_condicionado, FALSE)                AS indicador_ar_condicionado,\n              COALESCE(a.indicador_autuacao_ar_condicionado, FALSE)       AS indicador_autuacao_ar_condicionado,\n              COALESCE(a.indicador_autuacao_seguranca, FALSE)             AS indicador_autuacao_seguranca,\n              COALESCE(a.indicador_autuacao_limpeza, FALSE)               AS indicador_autuacao_limpeza,\n              COALESCE(a.indicador_autuacao_equipamento, FALSE)           AS indicador_autuacao_equipamento,\n              COALESCE(r.indicador_registro_agente_verao_ar_condicionado, FALSE)   AS indicador_registro_agente_verao_ar_condicionado)\n    \n    AS indicadores\n  FROM\n    gps g\n  LEFT JOIN\n    licenciamento AS l\n  USING\n    (data,\n      id_veiculo)\n  LEFT JOIN\n    autuacoes_agg AS a\n  USING\n    (data,\n      placa)\n  LEFT JOIN\n    registros_agente_verao AS r\n  USING\n    (data,\n      id_veiculo))\n\nSELECT\n  gla.* EXCEPT(indicadores),\n  TO_JSON(indicadores) AS indicadores,\n  status,\n  \"\" AS versao\nFROM\n  gps_licenciamento_autuacao AS gla\nLEFT JOIN\n  `rj-smtr`.`dashboard_subsidio_sppo`.`subsidio_parametros` AS p --`rj-smtr.dashboard_subsidio_sppo.subsidio_parametros`\nON\n  gla.indicadores.indicador_licenciado = p.indicador_licenciado\n  AND gla.indicadores.indicador_ar_condicionado = p.indicador_ar_condicionado\n  AND gla.indicadores.indicador_autuacao_ar_condicionado = p.indicador_autuacao_ar_condicionado\n  AND gla.indicadores.indicador_autuacao_seguranca = p.indicador_autuacao_seguranca\n  AND gla.indicadores.indicador_autuacao_limpeza = p.indicador_autuacao_limpeza\n  AND gla.indicadores.indicador_autuacao_equipamento = p.indicador_autuacao_equipamento\n  AND gla.indicadores.indicador_registro_agente_verao_ar_condicionado = p.indicador_registro_agente_verao_ar_condicionado\n  AND (data BETWEEN p.data_inicio AND p.data_fim)\n", "relation_name": "`rj-smtr`.`veiculo`.`sppo_veiculo_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.851060Z", "completed_at": "2024-09-30T15:23:31.862482Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.864352Z", "completed_at": "2024-09-30T15:23:31.864367Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.018602371215820312, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_agregado_brt", "compiled": true, "compiled_code": "\n\nWITH gps_agregado AS (\n    SELECT\n        data,\n        servico_jae AS servico,\n        id_validador,\n        latitude,\n        longitude,\n        estado_equipamento,\n        primeiro_datetime_gps,\n        ultimo_datetime_gps,\n        TIMESTAMP_DIFF(\n            ultimo_datetime_gps,\n            primeiro_datetime_gps,\n            MINUTE\n        ) + 1 AS qtde_min_entre_a_prim_e_ultima_transmissao,\n        COUNT(*) OVER (PARTITION BY servico_jae, id_validador) AS qtde_registros_gps,\n        COUNT(DISTINCT FORMAT_TIMESTAMP(\"%F %H:%M\", datetime_gps)) OVER (PARTITION BY servico_jae, id_validador) AS qtde_min_distintos_houve_transmissao,\n        SUM(\n            CASE\n                WHEN latitude != 0 AND longitude != 0 AND latitude IS NOT NULL AND longitude IS NOT NULL THEN 1\n                ELSE 0 END\n        ) OVER (PARTITION BY servico_jae, id_validador) AS qtde_registros_gps_georreferenciados,\n        ROW_NUMBER() OVER (PARTITION BY servico_jae, id_validador ORDER BY datetime_gps) AS rn\n    FROM\n        (\n            SELECT\n                *,\n                MIN(datetime_gps) OVER (PARTITION BY servico_jae, id_validador) AS primeiro_datetime_gps,\n                MAX(datetime_gps) OVER (PARTITION BY servico_jae, id_validador) AS ultimo_datetime_gps,\n                ROW_NUMBER() OVER (PARTITION BY id_transmissao_gps ORDER BY datetime_captura DESC) AS rn\n            FROM\n                `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`gps_validador`\n            WHERE\n                data = current_date(\"America/Sao_Paulo\")\n                AND modo = \"BRT\"\n        )\n    WHERE\n        rn = 1\n)\nSELECT\n    servico,\n    id_validador,\n    latitude,\n    longitude,\n    data,\n    estado_equipamento,\n    primeiro_datetime_gps,\n    ultimo_datetime_gps,\n    qtde_min_entre_a_prim_e_ultima_transmissao,\n    qtde_min_distintos_houve_transmissao,\n    qtde_registros_gps,\n    qtde_registros_gps_georreferenciados,\n    IFNULL(SAFE_DIVIDE(qtde_registros_gps_georreferenciados, qtde_registros_gps), 0) AS percentual_registros_gps_georreferenciados,\n    IFNULL(SAFE_DIVIDE(qtde_min_distintos_houve_transmissao, qtde_min_entre_a_prim_e_ultima_transmissao), 0) AS percentual_transmissao_a_cada_min\nFROM\n    gps_agregado\nWHERE\n    rn = 1", "relation_name": "`rj-smtr`.`dashboard_bilhetagem_implantacao_jae`.`gps_agregado_brt`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.869755Z", "completed_at": "2024-09-30T15:23:31.874305Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.875777Z", "completed_at": "2024-09-30T15:23:31.875790Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009224176406860352, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_agregado_onibus", "compiled": true, "compiled_code": "\n\nWITH gps_agregado AS (\n    SELECT\n        data,\n        operadora,\n        id_validador,\n        latitude,\n        longitude,\n        estado_equipamento,\n        primeiro_datetime_gps,\n        ultimo_datetime_gps,\n        TIMESTAMP_DIFF(\n            ultimo_datetime_gps,\n            primeiro_datetime_gps,\n            MINUTE\n        ) + 1 AS qtde_min_entre_a_prim_e_ultima_transmissao,\n        COUNT(*) OVER (PARTITION BY operadora, id_validador) AS qtde_registros_gps,\n        COUNT(DISTINCT FORMAT_TIMESTAMP(\"%F %H:%M\", datetime_gps)) OVER (PARTITION BY operadora, id_validador) AS qtde_min_distintos_houve_transmissao,\n        SUM(\n            CASE\n                WHEN latitude != 0 AND longitude != 0 AND latitude IS NOT NULL AND longitude IS NOT NULL THEN 1\n                ELSE 0 END\n        ) OVER (PARTITION BY operadora, id_validador) AS qtde_registros_gps_georreferenciados,\n        ROW_NUMBER() OVER (PARTITION BY operadora, id_validador ORDER BY datetime_gps) AS rn\n    FROM\n        (\n            SELECT\n                *,\n                MIN(datetime_gps) OVER (PARTITION BY operadora, id_validador) AS primeiro_datetime_gps,\n                MAX(datetime_gps) OVER (PARTITION BY operadora, id_validador) AS ultimo_datetime_gps,\n                ROW_NUMBER() OVER (PARTITION BY id_transmissao_gps ORDER BY datetime_captura DESC) AS rn\n            FROM\n                `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`gps_validador`\n            WHERE\n                data = current_date(\"America/Sao_Paulo\")\n                AND modo = \"\u00d4nibus\"\n        )\n    WHERE\n        rn = 1\n)\nSELECT\n    operadora,\n    id_validador,\n    latitude,\n    longitude,\n    data,\n    estado_equipamento,\n    primeiro_datetime_gps,\n    ultimo_datetime_gps,\n    qtde_min_entre_a_prim_e_ultima_transmissao,\n    qtde_min_distintos_houve_transmissao,\n    qtde_registros_gps,\n    qtde_registros_gps_georreferenciados,\n    IFNULL(SAFE_DIVIDE(qtde_registros_gps_georreferenciados, qtde_registros_gps), 0) AS percentual_registros_gps_georreferenciados,\n    IFNULL(SAFE_DIVIDE(qtde_min_distintos_houve_transmissao, qtde_min_entre_a_prim_e_ultima_transmissao), 0) AS percentual_transmissao_a_cada_min\nFROM\n    gps_agregado\nWHERE\n    rn = 1", "relation_name": "`rj-smtr`.`dashboard_bilhetagem_implantacao_jae`.`gps_agregado_onibus`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.880978Z", "completed_at": "2024-09-30T15:23:31.884963Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.886230Z", "completed_at": "2024-09-30T15:23:31.886241Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008357763290405273, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_agregado_vlt", "compiled": true, "compiled_code": "\n\nWITH gps_agregado AS (\n    SELECT\n        data,\n        servico_jae AS servico,\n        id_validador,\n        latitude,\n        longitude,\n        estado_equipamento,\n        primeiro_datetime_gps,\n        ultimo_datetime_gps,\n        TIMESTAMP_DIFF(\n            ultimo_datetime_gps,\n            primeiro_datetime_gps,\n            MINUTE\n        ) + 1 AS qtde_min_entre_a_prim_e_ultima_transmissao,\n        COUNT(*) OVER (PARTITION BY servico_jae, id_validador) AS qtde_registros_gps,\n        COUNT(DISTINCT FORMAT_TIMESTAMP(\"%F %H:%M\", datetime_gps)) OVER (PARTITION BY servico_jae, id_validador) AS qtde_min_distintos_houve_transmissao,\n        SUM(\n            CASE\n                WHEN latitude != 0 AND longitude != 0 AND latitude IS NOT NULL AND longitude IS NOT NULL THEN 1\n                ELSE 0 END\n        ) OVER (PARTITION BY servico_jae, id_validador) AS qtde_registros_gps_georreferenciados,\n        ROW_NUMBER() OVER (PARTITION BY servico_jae, id_validador ORDER BY datetime_gps) AS rn\n    FROM\n        (\n            SELECT\n                *,\n                MIN(datetime_gps) OVER (PARTITION BY servico_jae, id_validador) AS primeiro_datetime_gps,\n                MAX(datetime_gps) OVER (PARTITION BY servico_jae, id_validador) AS ultimo_datetime_gps,\n                ROW_NUMBER() OVER (PARTITION BY id_transmissao_gps ORDER BY datetime_captura DESC) AS rn\n            FROM\n                `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`gps_validador`\n            WHERE\n                data = current_date(\"America/Sao_Paulo\")\n                AND modo = \"VLT\"\n        )\n    WHERE\n        rn = 1\n)\nSELECT\n    servico,\n    id_validador,\n    latitude,\n    longitude,\n    data,\n    estado_equipamento,\n    primeiro_datetime_gps,\n    ultimo_datetime_gps,\n    qtde_min_entre_a_prim_e_ultima_transmissao,\n    qtde_min_distintos_houve_transmissao,\n    qtde_registros_gps,\n    qtde_registros_gps_georreferenciados,\n    IFNULL(SAFE_DIVIDE(qtde_registros_gps_georreferenciados, qtde_registros_gps), 0) AS percentual_registros_gps_georreferenciados,\n    IFNULL(SAFE_DIVIDE(qtde_min_distintos_houve_transmissao, qtde_min_entre_a_prim_e_ultima_transmissao), 0) AS percentual_transmissao_a_cada_min\nFROM\n    gps_agregado\nWHERE\n    rn = 1", "relation_name": "`rj-smtr`.`dashboard_bilhetagem_implantacao_jae`.`gps_agregado_vlt`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.890125Z", "completed_at": "2024-09-30T15:23:31.896507Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.897803Z", "completed_at": "2024-09-30T15:23:31.897815Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010136127471923828, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.veiculo_indicadores_dia", "compiled": true, "compiled_code": "\n\nWITH gps_sppo AS (\n  SELECT\n    data,\n    SUBSTR(id_veiculo, 2) AS id_veiculo,\n    COUNT(DISTINCT timestamp_gps) AS quantidade_gps_sppo\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_veiculos`.`gps_sppo`\n  WHERE\n    DATA = DATE_SUB(DATE('2022-01-01T01:00:00'), INTERVAL 1 DAY)\n  GROUP BY\n    1,\n    2\n),\nplanilha_ronald AS (\n  SELECT DISTINCT\n    TRIM(numero_ordem_veiculo) AS numero_ordem_veiculo,\n    TRIM(numero_serie_validador) AS id_validador,\n    empresa\n  FROM\n    `rj-smtr-staging`.`dashboard_controle_vinculo_jae_riocard_staging`.`relatorio_instalacao_jae`\n  WHERE\n    LENGTH(numero_ordem_veiculo) = 5\n    AND numero_ordem_veiculo != '99999'\n),\ngps_sppo_planilha AS (\n  SELECT\n    COALESCE(g.data, DATE_SUB(DATE('2022-01-01T01:00:00'), INTERVAL 1 DAY)) AS data,\n    COALESCE(g.id_veiculo, TRIM(r.numero_ordem_veiculo)) AS id_veiculo,\n    COALESCE(g.quantidade_gps_sppo, 0) AS quantidade_gps_sppo,\n    TRIM(r.id_validador) AS id_validador,\n    r.empresa,\n    g.id_veiculo IS NOT NULL AS indicador_veiculo_gps_sppo,\n    r.numero_ordem_veiculo IS NOT NULL AS indicador_veiculo_controle_ronald\n  FROM\n    gps_sppo g\n  FULL OUTER JOIN\n    planilha_ronald r\n  ON\n    g.id_veiculo = TRIM(r.numero_ordem_veiculo)\n),\nsppo_licenciamento AS (\n  SELECT DISTINCT\n    SUBSTR(id_veiculo, 2) AS id_veiculo\n  FROM\n    `rj-smtr`.`veiculo`.`sppo_licenciamento`\n  WHERE\n    data = \"2024-03-25\"\n),\ngps_sppo_licenciamento AS (\n  SELECT\n    COALESCE(g.data, DATE_SUB(DATE('2022-01-01T01:00:00'), INTERVAL 1 DAY)) AS data,\n    COALESCE(g.id_veiculo, l.id_veiculo) AS id_veiculo,\n    COALESCE(g.quantidade_gps_sppo, 0) AS quantidade_gps_sppo,\n    g.id_validador,\n    g.empresa,\n    l.id_veiculo IS NOT NULL AS indicador_veiculo_licenciamento,\n    COALESCE(g.indicador_veiculo_gps_sppo, FALSE) AS indicador_veiculo_gps_sppo,\n    COALESCE(g.indicador_veiculo_controle_ronald, FALSE) AS indicador_veiculo_controle_ronald\n  FROM\n    gps_sppo_planilha g\n  FULL OUTER JOIN\n    sppo_licenciamento l\n  ON\n    l.id_veiculo = g.id_veiculo\n),\ngps_validador AS (\n  SELECT\n    data,\n    id_validador,\n    COUNT(DISTINCT id_transmissao_gps) AS quantidade_gps_validador\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`gps_validador`\n  WHERE\n    data = DATE_SUB(DATE('2022-01-01T01:00:00'), INTERVAL 1 DAY)\n  GROUP BY\n    1,\n    2\n),\ntransacao_riocard AS (\n  SELECT DISTINCT\n    data,\n    id_transacao,\n    id_validador\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao_riocard`\n  WHERE\n    data = DATE_SUB(DATE('2022-01-01T01:00:00'), INTERVAL 1 DAY)\n),\ntransacao_agg AS (\n  SELECT\n    data,\n    id_validador,\n    COUNT(*) AS quantidade_transacao\n  FROM\n    transacao_riocard\n  GROUP BY\n    1,\n    2\n)\nSELECT\n  gs.data,\n  gs.id_veiculo,\n  gs.empresa,\n  gs.id_validador AS numero_serie_validador,\n  gs.indicador_veiculo_licenciamento,\n  gs.indicador_veiculo_gps_sppo,\n  gs.indicador_veiculo_controle_ronald,\n  gv.id_validador IS NOT NULL AS indicador_validador_ativo,\n  IFNULL(t.quantidade_transacao, 0) AS quantidade_transacao_riocard,\n  IFNULL(quantidade_gps_sppo, 0) AS quantidade_gps_sppo,\n  IFNULL(quantidade_gps_validador, 0) AS quantidade_gps_validador,\n  SAFE_DIVIDE(quantidade_gps_validador, quantidade_gps_sppo) AS percentual_gps_validador_sppo\nFROM\n  gps_sppo_licenciamento gs\nLEFT JOIN\n  gps_validador gv\nON\n  gs.id_validador = gv.id_validador\n  AND gs.data = gv.data\nLEFT JOIN\n  transacao_agg t\nON\n  gs.id_validador = t.id_validador\n  AND gs.data = t.data", "relation_name": "`rj-smtr`.`dashboard_controle_vinculo_jae_riocard`.`veiculo_indicadores_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.901676Z", "completed_at": "2024-09-30T15:23:31.905466Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.906761Z", "completed_at": "2024-09-30T15:23:31.906771Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007548809051513672, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.gps_agregado_van", "compiled": true, "compiled_code": "\n\nWITH gps_agregado AS (\n    SELECT\n        data,\n        id_operadora,\n        id_validador,\n        estado_equipamento,\n        primeiro_datetime_gps,\n        ultimo_datetime_gps,\n        TIMESTAMP_DIFF(\n            ultimo_datetime_gps,\n            primeiro_datetime_gps,\n            MINUTE\n        ) + 1 AS qtde_min_entre_a_prim_e_ultima_transmissao,\n        COUNT(*) OVER (PARTITION BY id_operadora, id_validador) AS qtde_registros_gps,\n        COUNT(DISTINCT FORMAT_TIMESTAMP(\"%F %H:%M\", datetime_gps)) OVER (PARTITION BY id_operadora, id_validador) AS qtde_min_distintos_houve_transmissao,\n        SUM(\n            CASE\n                WHEN latitude != 0 AND longitude != 0 AND latitude IS NOT NULL AND longitude IS NOT NULL THEN 1\n                ELSE 0 END\n        ) OVER (PARTITION BY id_operadora, id_validador) AS qtde_registros_gps_georreferenciados,\n        ROW_NUMBER() OVER (PARTITION BY id_operadora, id_validador ORDER BY datetime_gps) AS rn\n    FROM\n        (\n            SELECT\n                *,\n                MIN(datetime_gps) OVER (PARTITION BY id_operadora, id_validador) AS primeiro_datetime_gps,\n                MAX(datetime_gps) OVER (PARTITION BY id_operadora, id_validador) AS ultimo_datetime_gps,\n                ROW_NUMBER() OVER (PARTITION BY id_transmissao_gps ORDER BY datetime_captura DESC) AS rn\n            FROM\n                `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`gps_validador_van`\n            WHERE\n                data = current_date(\"America/Sao_Paulo\")\n        )\n    WHERE\n        rn = 1\n)\nSELECT\n    id_operadora,\n    id_validador,\n    data,\n    estado_equipamento,\n    primeiro_datetime_gps,\n    ultimo_datetime_gps,\n    qtde_min_entre_a_prim_e_ultima_transmissao,\n    qtde_min_distintos_houve_transmissao,\n    qtde_registros_gps,\n    qtde_registros_gps_georreferenciados,\n    IFNULL(SAFE_DIVIDE(qtde_registros_gps_georreferenciados, qtde_registros_gps), 0) AS percentual_registros_gps_georreferenciados,\n    IFNULL(SAFE_DIVIDE(qtde_min_distintos_houve_transmissao, qtde_min_entre_a_prim_e_ultima_transmissao), 0) AS percentual_transmissao_a_cada_min\nFROM\n    gps_agregado\nWHERE\n    rn = 1", "relation_name": "`rj-smtr`.`dashboard_bilhetagem_implantacao_jae`.`gps_agregado_van`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.912242Z", "completed_at": "2024-09-30T15:23:31.919350Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.920639Z", "completed_at": "2024-09-30T15:23:31.920652Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012219905853271484, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_pagamento_consorcio_dia", "compiled": true, "compiled_code": "\n\n-- depends_on: `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_consorcio_operador_dia`\nSELECT\n    o.data_ordem,\n    dc.id_consorcio,\n    dc.consorcio,\n    o.id_ordem_pagamento AS id_ordem_pagamento,\n    o.qtd_debito AS quantidade_transacao_debito,\n    o.valor_debito,\n    o.qtd_vendaabordo AS quantidade_transacao_especie,\n    o.valor_vendaabordo AS valor_especie,\n    o.qtd_gratuidade AS quantidade_transacao_gratuidade,\n    o.valor_gratuidade,\n    o.qtd_integracao AS quantidade_transacao_integracao,\n    o.valor_integracao,\n    o.qtd_rateio_credito AS quantidade_transacao_rateio_credito,\n    o.valor_rateio_credito AS valor_rateio_credito,\n    o.qtd_rateio_debito AS quantidade_transacao_rateio_debito,\n    o.valor_rateio_debito AS valor_rateio_debito,\n    (\n      o.qtd_debito\n      + o.qtd_vendaabordo\n      + o.qtd_gratuidade\n      + o.qtd_integracao\n    ) AS quantidade_total_transacao,\n    o.valor_bruto AS valor_total_transacao_bruto,\n    o.valor_taxa AS valor_desconto_taxa,\n    o.valor_liquido AS valor_total_transacao_liquido,\n    '' AS versao\nFROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_pagamento_consorcio` o\nLEFT JOIN\n    `rj-smtr`.`cadastro`.`consorcios` dc\nON\n    o.id_consorcio = dc.id_consorcio_jae\n\n    WHERE\n        DATE(o.data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_consorcio_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.924559Z", "completed_at": "2024-09-30T15:23:31.930026Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.931323Z", "completed_at": "2024-09-30T15:23:31.931335Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009279966354370117, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.aux_viagem_inicio_fim", "compiled": true, "compiled_code": "-- 1. Cria colunas identificadoras de in\u00edcio (starts) e fim (ends) de viagens\nwith aux_status as (\n    select\n        *,\n        string_agg(status_viagem,\"\") over (\n            partition by id_veiculo, shape_id\n            order by id_veiculo, shape_id, timestamp_gps\n            rows between current row and 1 following) = 'startmiddle' starts,\n        string_agg(status_viagem,\"\") over (\n            partition by id_veiculo, shape_id\n            order by id_veiculo, shape_id, timestamp_gps\n            rows between 1 preceding and current row) = 'middleend' ends\n    from\n        `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\n),\n-- 2. Classifica in\u00edcio-fim consecutivos como partida-chegada da viagem\naux_inicio_fim AS (\n    select\n        *,\n        case\n            when\n            string_agg(status_viagem,\"\") over (\n                partition by id_veiculo, shape_id\n                order by id_veiculo, shape_id, timestamp_gps\n                rows between CURRENT row and 1 following) = 'startend'\n            then timestamp_gps\n        end datetime_partida,\n        case\n            when string_agg(status_viagem,\"\") over (\n                partition by id_veiculo, shape_id\n                order by id_veiculo, shape_id, timestamp_gps\n                rows between 1 preceding and CURRENT row) = 'startend'\n            then timestamp_gps\n        end datetime_chegada\n    from\n        aux_status\n    where\n        starts = true OR ends = true\n),\n-- 3. Junta partida-chegada da viagem na mesma linha\ninicio_fim AS (\n    select\n        * except(datetime_chegada, posicao_veiculo_geo),\n        posicao_veiculo_geo as posicao_partida,\n        lead(datetime_chegada) over(\n            partition by id_veiculo, shape_id\n            order by id_veiculo, shape_id, timestamp_gps\n        ) as datetime_chegada,\n        lead(posicao_veiculo_geo) over(\n            partition by id_veiculo, shape_id\n            order by id_veiculo, shape_id, timestamp_gps\n        ) as posicao_chegada,\n    from aux_inicio_fim\n)\n-- 4. Filtra colunas e cria campo identificador da viagem (id_viagem)\nselect distinct\n    concat(id_veiculo, \"-\", servico_realizado ,\"-\", sentido, \"-\", shape_id_planejado, \"-\", FORMAT_DATETIME(\"%Y%m%d%H%M%S\", datetime_partida)) as id_viagem,\n    data,\n    id_empresa,\n    id_veiculo,\n    servico_informado, -- no momento da partida\n    servico_realizado,\n    trip_id,\n    shape_id,\n    sentido_shape,\n    round((st_distance(start_pt, posicao_partida) + st_distance(end_pt, posicao_chegada))/1000, 3) as distancia_inicio_fim,\n    distancia_planejada,\n    shape_id_planejado,\n    trip_id_planejado,\n    sentido,\n    datetime_partida,\n    datetime_chegada,\n    '' as versao_modelo\nfrom\n    inicio_fim\nwhere\n    datetime_partida is not null\n    ", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.935485Z", "completed_at": "2024-09-30T15:23:31.940550Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.941829Z", "completed_at": "2024-09-30T15:23:31.941840Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008946418762207031, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_aux_registros_status_trajeto_sentido__I__V__C.2082fbe17f", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\n    group by sentido\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.945738Z", "completed_at": "2024-09-30T15:23:31.950538Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.951839Z", "completed_at": "2024-09-30T15:23:31.951851Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008591175079345703, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_aux_registros_status_trajeto_sentido_shape__I__V__C.5b82f18cbf", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido_shape as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\n    group by sentido_shape\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.955765Z", "completed_at": "2024-09-30T15:23:31.961082Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.962422Z", "completed_at": "2024-09-30T15:23:31.962433Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009221076965332031, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_negative_aux_registros_status_trajeto_distancia.b4cb13122d", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\n    where distancia < 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.966363Z", "completed_at": "2024-09-30T15:23:31.972411Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.973709Z", "completed_at": "2024-09-30T15:23:31.973721Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009841203689575195, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_data.652ad0c445", "compiled": true, "compiled_code": "\nSELECT\n    data\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    data is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.978171Z", "completed_at": "2024-09-30T15:23:31.983367Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:31.984675Z", "completed_at": "2024-09-30T15:23:31.984686Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009388208389282227, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_distancia.703c10aaaf", "compiled": true, "compiled_code": "\nSELECT\n    distancia\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    distancia is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:31.988638Z", "completed_at": "2024-09-30T15:23:31.997106Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.000144Z", "completed_at": "2024-09-30T15:23:32.000168Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.015347003936767578, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_distancia_planejada.39e1e1d472", "compiled": true, "compiled_code": "\nSELECT\n    distancia_planejada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    distancia_planejada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.007798Z", "completed_at": "2024-09-30T15:23:32.014577Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.016286Z", "completed_at": "2024-09-30T15:23:32.016300Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012358903884887695, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_id_veiculo.101e6b5227", "compiled": true, "compiled_code": "\nSELECT\n    id_veiculo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    id_veiculo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.022267Z", "completed_at": "2024-09-30T15:23:32.027116Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.028549Z", "completed_at": "2024-09-30T15:23:32.028561Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010068893432617188, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_posicao_veiculo_geo.33c0d51e40", "compiled": true, "compiled_code": "\nSELECT\n    posicao_veiculo_geo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    posicao_veiculo_geo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.032573Z", "completed_at": "2024-09-30T15:23:32.040009Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.041279Z", "completed_at": "2024-09-30T15:23:32.041290Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011303424835205078, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_sentido.6291e69d70", "compiled": true, "compiled_code": "\nSELECT\n    sentido\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    sentido is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.045402Z", "completed_at": "2024-09-30T15:23:32.050079Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.051375Z", "completed_at": "2024-09-30T15:23:32.051387Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008614540100097656, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_sentido_shape.a14a95f5e8", "compiled": true, "compiled_code": "\nSELECT\n    sentido_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    sentido_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.055284Z", "completed_at": "2024-09-30T15:23:32.059827Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.061428Z", "completed_at": "2024-09-30T15:23:32.061440Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00867462158203125, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_servico_informado.11333dadfe", "compiled": true, "compiled_code": "\nSELECT\n    servico_informado\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    servico_informado is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.065338Z", "completed_at": "2024-09-30T15:23:32.069899Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.071167Z", "completed_at": "2024-09-30T15:23:32.071177Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008281707763671875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_shape_id.586a1a0d47", "compiled": true, "compiled_code": "\nSELECT\n    shape_id\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    shape_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.075864Z", "completed_at": "2024-09-30T15:23:32.080869Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.082155Z", "completed_at": "2024-09-30T15:23:32.082166Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009390830993652344, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_status_viagem.24b7f26346", "compiled": true, "compiled_code": "\nSELECT\n    status_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    status_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.085999Z", "completed_at": "2024-09-30T15:23:32.091776Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.093063Z", "completed_at": "2024-09-30T15:23:32.093074Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00952291488647461, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_timestamp_gps.703590c517", "compiled": true, "compiled_code": "\nSELECT\n    timestamp_gps\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    timestamp_gps is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.096957Z", "completed_at": "2024-09-30T15:23:32.101543Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.102826Z", "completed_at": "2024-09-30T15:23:32.102836Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008573770523071289, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_timestamp_minuto_gps.d2799a61bf", "compiled": true, "compiled_code": "\nSELECT\n    timestamp_minuto_gps\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    timestamp_minuto_gps is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.107005Z", "completed_at": "2024-09-30T15:23:32.111680Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.112953Z", "completed_at": "2024-09-30T15:23:32.112964Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008429765701293945, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_registros_status_trajeto_versao_modelo.22de27b835", "compiled": true, "compiled_code": "\nSELECT\n    versao_modelo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto`)\nAND\n    versao_modelo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.116836Z", "completed_at": "2024-09-30T15:23:32.122373Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.123739Z", "completed_at": "2024-09-30T15:23:32.123749Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009344816207885742, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_pagamento_dia", "compiled": true, "compiled_code": "\n\n-- depends_on: `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_consorcio_dia`\nSELECT\n    o.data_ordem,\n    o.data_pagamento,\n    o.id_ordem_pagamento AS id_ordem_pagamento,\n    o.qtd_debito AS quantidade_transacao_debito,\n    o.valor_debito,\n    o.qtd_vendaabordo AS quantidade_transacao_especie,\n    o.valor_vendaabordo AS valor_especie,\n    o.qtd_gratuidade AS quantidade_transacao_gratuidade,\n    o.valor_gratuidade,\n    o.qtd_integracao AS quantidade_transacao_integracao,\n    o.valor_integracao,\n    o.qtd_rateio_credito AS quantidade_transacao_rateio_credito,\n    o.valor_rateio_credito AS valor_rateio_credito,\n    o.qtd_rateio_debito AS quantidade_transacao_rateio_debito,\n    o.valor_rateio_debito AS valor_rateio_debito,\n    (\n      o.qtd_debito\n      + o.qtd_vendaabordo\n      + o.qtd_gratuidade\n      + o.qtd_integracao\n    ) AS quantidade_total_transacao,\n    o.valor_bruto AS valor_total_transacao_bruto,\n    o.valor_taxa AS valor_desconto_taxa,\n    o.valor_liquido AS valor_total_transacao_liquido,\n    '' AS versao\nFROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`ordem_pagamento` o\n\n    WHERE\n        DATE(o.data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.127885Z", "completed_at": "2024-09-30T15:23:32.132046Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.133315Z", "completed_at": "2024-09-30T15:23:32.133325Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008139610290527344, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.aux_viagem_circular", "compiled": true, "compiled_code": "-- 1. Identifica viagens circulares de ida que possuem volta\n--    consecutiva. Junta numa \u00fanica linha a datetime_partida (ida) + datetime_chegada_volta\nwith ida_volta_circular as (\n    select\n        t.*\n    from (\n        select\n            *,\n            lead(datetime_partida) over (\n                partition by id_veiculo, servico_realizado order by id_veiculo, servico_realizado, datetime_partida, sentido_shape) as datetime_partida_volta,\n            lead(datetime_chegada) over (\n                partition by id_veiculo, servico_realizado order by id_veiculo, servico_realizado, datetime_partida, sentido_shape) as datetime_chegada_volta,\n            lead(shape_id) over (\n                partition by id_veiculo, servico_realizado order by id_veiculo, servico_realizado, datetime_partida, sentido_shape) as shape_id_volta,\n            lead(sentido_shape) over (\n                partition by id_veiculo, servico_realizado order by id_veiculo, servico_realizado, datetime_partida, sentido_shape) = \"V\" as flag_proximo_volta -- possui volta\n        from\n            `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim` v\n        where\n            sentido = \"C\"\n    ) t\n    where\n        flag_proximo_volta = TRUE\n        and sentido_shape = \"I\"\n        and datetime_chegada <= datetime_partida_volta\n),\n-- 2. Filtra apenas viagens circulares de ida e volta consecutivas\n--    (mantem ida e volta separadas, mas com o mesmo id)\nviagem_circular as (\n    select distinct\n        *\n    from (\n        select\n            case\n                when (\n                    v.sentido_shape = \"I\"\n                    and v.datetime_partida = c.datetime_partida\n                ) then c.id_viagem\n                when (\n                    v.sentido_shape = \"V\"\n                    and v.datetime_chegada = c.datetime_chegada_volta\n                ) then c.id_viagem\n            end as id_viagem,\n            v.* except(id_viagem)\n        from\n            `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim` v\n        inner join\n            ida_volta_circular c\n        on\n            c.id_veiculo = v.id_veiculo\n            and c.servico_realizado = v.servico_realizado\n            and c.sentido = v.sentido\n    ) v\n    where\n        id_viagem is not null\n)\n-- 3. Junta viagens circulares tratadas \u00e0s viagens n\u00e3o circulares j\u00e1 identificadas\nselect\n    *\nfrom\n    viagem_circular v\nunion all (\n    select\n        *\n    from\n        `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim` v\n    where\n        sentido = \"I\" or sentido = \"V\"\n)", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.137356Z", "completed_at": "2024-09-30T15:23:32.143529Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.144813Z", "completed_at": "2024-09-30T15:23:32.144824Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010028600692749023, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_aux_viagem_inicio_fim_sentido__I__V__C.4f2096c560", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\n    group by sentido\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.148770Z", "completed_at": "2024-09-30T15:23:32.153463Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.154713Z", "completed_at": "2024-09-30T15:23:32.154724Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008412599563598633, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_aux_viagem_inicio_fim_sentido_shape__I__V__C.9af2f7b6e0", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido_shape as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\n    group by sentido_shape\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.159953Z", "completed_at": "2024-09-30T15:23:32.165202Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.166440Z", "completed_at": "2024-09-30T15:23:32.166452Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010118246078491211, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_data.3ef5737e0d", "compiled": true, "compiled_code": "\nSELECT\n    data\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    data is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.170351Z", "completed_at": "2024-09-30T15:23:32.174909Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.176229Z", "completed_at": "2024-09-30T15:23:32.176240Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008318662643432617, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_datetime_chegada.2e883813e8", "compiled": true, "compiled_code": "\nSELECT\n    datetime_chegada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    datetime_chegada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.180115Z", "completed_at": "2024-09-30T15:23:32.184776Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.186018Z", "completed_at": "2024-09-30T15:23:32.186028Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008316516876220703, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_datetime_partida.c668ec6882", "compiled": true, "compiled_code": "\nSELECT\n    datetime_partida\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    datetime_partida is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.190087Z", "completed_at": "2024-09-30T15:23:32.195849Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.197108Z", "completed_at": "2024-09-30T15:23:32.197118Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009662151336669922, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_distancia_planejada.a26e748226", "compiled": true, "compiled_code": "\nSELECT\n    distancia_planejada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    distancia_planejada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.202353Z", "completed_at": "2024-09-30T15:23:32.206876Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.208181Z", "completed_at": "2024-09-30T15:23:32.208192Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008890867233276367, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_id_veiculo.c69fdfc708", "compiled": true, "compiled_code": "\nSELECT\n    id_veiculo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    id_veiculo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.212215Z", "completed_at": "2024-09-30T15:23:32.216886Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.218123Z", "completed_at": "2024-09-30T15:23:32.218133Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008403539657592773, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_id_viagem.9cfe2e3fdd", "compiled": true, "compiled_code": "\nSELECT\n    id_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    id_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.221925Z", "completed_at": "2024-09-30T15:23:32.226529Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.227828Z", "completed_at": "2024-09-30T15:23:32.227840Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00826883316040039, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_sentido.976bd6a11f", "compiled": true, "compiled_code": "\nSELECT\n    sentido\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    sentido is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.231791Z", "completed_at": "2024-09-30T15:23:32.238155Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.239421Z", "completed_at": "2024-09-30T15:23:32.239430Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010437250137329102, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_sentido_shape.4c3ec0996b", "compiled": true, "compiled_code": "\nSELECT\n    sentido_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    sentido_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.244442Z", "completed_at": "2024-09-30T15:23:32.249928Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.251169Z", "completed_at": "2024-09-30T15:23:32.251178Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010977983474731445, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_servico_informado.7adb7ebfd7", "compiled": true, "compiled_code": "\nSELECT\n    servico_informado\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    servico_informado is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.256566Z", "completed_at": "2024-09-30T15:23:32.261353Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.262955Z", "completed_at": "2024-09-30T15:23:32.262968Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009537935256958008, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_servico_realizado.60bf591717", "compiled": true, "compiled_code": "\nSELECT\n    servico_realizado\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    servico_realizado is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.269781Z", "completed_at": "2024-09-30T15:23:32.275136Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.276398Z", "completed_at": "2024-09-30T15:23:32.276408Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010166645050048828, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_shape_id.9b971af0ae", "compiled": true, "compiled_code": "\nSELECT\n    shape_id\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    shape_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.280155Z", "completed_at": "2024-09-30T15:23:32.285511Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.286751Z", "completed_at": "2024-09-30T15:23:32.286759Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00895380973815918, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_inicio_fim_versao_modelo.7bace7cce8", "compiled": true, "compiled_code": "\nSELECT\n    versao_modelo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`)\nAND\n    versao_modelo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.290453Z", "completed_at": "2024-09-30T15:23:32.295325Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.296735Z", "completed_at": "2024-09-30T15:23:32.296746Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008666038513183594, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_aux_viagem_inicio_fim_id_viagem.321f77f756", "compiled": true, "compiled_code": "\n    \n    \n\nwith dbt_test__target as (\n\n  select id_viagem as unique_field\n  from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_inicio_fim`\n  where id_viagem is not null\n\n)\n\nselect\n    unique_field,\n    count(*) as n_records\n\nfrom dbt_test__target\ngroup by unique_field\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.300587Z", "completed_at": "2024-09-30T15:23:32.307663Z"}, {"name": "execute", "started_at": "2024-09-30T15:23:32.308978Z", "completed_at": "2024-09-30T15:23:32.308987Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010825634002685547, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_pagamento_dia_invalida", "compiled": true, "compiled_code": "\n\nWITH ordem_pagamento_consorcio_dia AS (\n  SELECT\n    data_ordem,\n    id_ordem_pagamento,\n    SUM(quantidade_total_transacao) AS quantidade_total_transacao,\n    SUM(valor_total_transacao_liquido) AS valor_total_transacao_liquido\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_consorcio_dia`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n  GROUP BY\n    1,\n    2\n),\nordem_pagamento_dia AS (\n  SELECT\n    data_ordem,\n    id_ordem_pagamento,\n    quantidade_total_transacao,\n    valor_total_transacao_liquido\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_dia`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n),\nindicadores AS (\nSELECT\n  d.data_ordem,\n  d.id_ordem_pagamento,\n  d.quantidade_total_transacao,\n  cd.quantidade_total_transacao AS quantidade_total_transacao_agregacao,\n  d.valor_total_transacao_liquido,\n  cd.valor_total_transacao_liquido AS valor_total_transacao_liquido_agregacao,\n  ROUND(cd.valor_total_transacao_liquido, 2) != ROUND(d.valor_total_transacao_liquido, 2) OR cd.quantidade_total_transacao != d.quantidade_total_transacao AS indicador_agregacao_invalida\nFROM\n  ordem_pagamento_dia d\nLEFT JOIN\n  ordem_pagamento_consorcio_dia cd\nUSING(data_ordem, id_ordem_pagamento)\n)\nSELECT\n  *,\n  '' AS versao\nFROM\n  indicadores\nWHERE\n  indicador_agregacao_invalida = TRUE", "relation_name": "`rj-smtr`.`validacao_dados_jae_staging`.`ordem_pagamento_dia_invalida`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:23:32.312996Z", "completed_at": "2024-09-30T15:24:00.920041Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:00.926042Z", "completed_at": "2024-09-30T15:24:00.926080Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 28.618929147720337, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.transacao", "compiled": true, "compiled_code": "-- depends_on: `rj-smtr`.`cadastro`.`operadoras_contato`\n-- depends_on: `rj-smtr`.`cadastro`.`servico_operadora`\n-- depends_on: `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao_riocard`\n\n\n-- TODO: Usar vari\u00e1vel de run_date_hour para otimizar o numero de parti\u00e7\u00f5es lidas em staging\n\n\n\n\n\n  \n    \n\n    \n\n    \n  \n\n\nWITH transacao AS (\n  SELECT\n    *\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`transacao`\n    -- `rj-smtr.br_rj_riodejaneiro_bilhetagem_staging.transacao`\n  \n      WHERE\n        \n  DATE(data) BETWEEN DATE(\"2022-01-01T00:00:00\") AND DATE(\"2022-01-01T01:00:00\")\n  AND timestamp_captura BETWEEN DATETIME(\"2022-01-01T00:00:00\") AND DATETIME(\"2022-01-01T01:00:00\")\n\n  \n),\ntipo_transacao AS (\n  SELECT\n    chave AS id_tipo_transacao,\n    valor AS tipo_transacao,\n  FROM\n    `rj-smtr.br_rj_riodejaneiro_bilhetagem.dicionario`\n  WHERE\n    id_tabela = \"transacao\"\n    AND coluna = \"id_tipo_transacao\"\n),\ngratuidade AS (\n  SELECT\n    CAST(id_cliente AS STRING) AS id_cliente,\n    tipo_gratuidade,\n    data_inicio_validade,\n    data_fim_validade\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`gratuidade_aux`\n    -- `rj-smtr.br_rj_riodejaneiro_bilhetagem_staging.gratuidade_aux`\n  -- TODO: FILTRAR PARTI\u00c7\u00d5ES DE FORMA EFICIENTE\n),\ntipo_pagamento AS (\n  SELECT\n    chave AS id_tipo_pagamento,\n    valor AS tipo_pagamento\n  FROM\n    `rj-smtr.br_rj_riodejaneiro_bilhetagem.dicionario`\n  WHERE\n    id_tabela = \"transacao\"\n    AND coluna = \"id_tipo_pagamento\"\n),\nintegracao AS (\n  SELECT\n    id_transacao,\n    valor_rateio,\n    datetime_processamento_integracao\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`integracao`\n    -- `rj-smtr.br_rj_riodejaneiro_bilhetagem.integracao`\n  \n    WHERE\n    \n      data = \"2000-01-01\"\n    \n  \n),\nnew_data AS (\n  SELECT\n    EXTRACT(DATE FROM data_transacao) AS data,\n    EXTRACT(HOUR FROM data_transacao) AS hora,\n    data_transacao AS datetime_transacao,\n    data_processamento AS datetime_processamento,\n    t.timestamp_captura AS datetime_captura,\n    m.modo,\n    dc.id_consorcio,\n    dc.consorcio,\n    do.id_operadora,\n    do.operadora,\n    t.cd_linha AS id_servico_jae,\n    -- s.servico,\n    l.nr_linha AS servico_jae,\n    l.nm_linha AS descricao_servico_jae,\n    sentido,\n    CASE\n      WHEN m.modo = \"VLT\" THEN SUBSTRING(t.veiculo_id, 1, 3)\n      WHEN m.modo = \"BRT\" THEN NULL\n      ELSE t.veiculo_id\n    END AS id_veiculo,\n    t.numero_serie_validador AS id_validador,\n    COALESCE(t.id_cliente, t.pan_hash) AS id_cliente,\n    id AS id_transacao,\n    tp.tipo_pagamento,\n    tt.tipo_transacao,\n    g.tipo_gratuidade,\n    tipo_integracao AS id_tipo_integracao,\n    NULL AS id_integracao,\n    latitude_trx AS latitude,\n    longitude_trx AS longitude,\n    ST_GEOGPOINT(longitude_trx, latitude_trx) AS geo_point_transacao,\n    NULL AS stop_id,\n    NULL AS stop_lat,\n    NULL AS stop_lon,\n    valor_transacao\n  FROM\n    transacao AS t\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`modos` m\n    -- `rj-smtr.cadastro.modos` m\n  ON\n    t.id_tipo_modal = m.id_modo AND m.fonte = \"jae\"\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`operadoras` do\n    -- `rj-smtr.cadastro.operadoras` do\n  ON\n    t.cd_operadora = do.id_operadora_jae\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`consorcios` dc\n    -- `rj-smtr.cadastro.consorcios` dc\n  ON\n    t.cd_consorcio = dc.id_consorcio_jae\n  LEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha` l\n    -- `rj-smtr.br_rj_riodejaneiro_bilhetagem_staging.linha` l\n  ON\n    t.cd_linha = l.cd_linha\n  -- LEFT JOIN\n  --     `rj-smtr`.`cadastro`.`servicos` AS s\n  -- ON\n  --     t.cd_linha = s.id_servico_jae\n  LEFT JOIN\n    tipo_transacao tt\n  ON\n    tt.id_tipo_transacao = t.tipo_transacao\n  LEFT JOIN\n    tipo_pagamento tp\n  ON\n    t.id_tipo_midia = tp.id_tipo_pagamento\n  LEFT JOIN\n    gratuidade g\n  ON\n    t.tipo_transacao = \"21\"\n    AND t.id_cliente = g.id_cliente\n    AND t.data_transacao >= g.data_inicio_validade\n    AND (t.data_transacao < g.data_fim_validade OR g.data_fim_validade IS NULL)\n  LEFT JOIN\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_sem_ressarcimento` lsr\n    -- `rj-smtr.br_rj_riodejaneiro_bilhetagem_staging.linha_sem_ressarcimento` lsr\n  ON\n    t.cd_linha = lsr.id_linha\n  WHERE\n    lsr.id_linha IS NULL\n    AND DATE(data_transacao) >= \"2023-07-17\"\n),\ncomplete_partitions AS (\n  SELECT\n    data,\n    hora,\n    datetime_transacao,\n    datetime_processamento,\n    datetime_captura,\n    modo,\n    id_consorcio,\n    consorcio,\n    id_operadora,\n    operadora,\n    id_servico_jae,\n    servico_jae,\n    descricao_servico_jae,\n    sentido,\n    id_veiculo,\n    id_validador,\n    id_cliente,\n    id_transacao,\n    tipo_pagamento,\n    tipo_transacao,\n    tipo_gratuidade,\n    id_tipo_integracao,\n    id_integracao,\n    latitude,\n    longitude,\n    geo_point_transacao,\n    stop_id,\n    stop_lat,\n    stop_lon,\n    valor_transacao,\n    0 AS priority\n  FROM\n    new_data\n\n  \n    UNION ALL\n\n    SELECT\n      data,\n      hora,\n      datetime_transacao,\n      datetime_processamento,\n      datetime_captura,\n      modo,\n      id_consorcio,\n      consorcio,\n      id_operadora,\n      operadora,\n      id_servico_jae,\n      servico_jae,\n      descricao_servico_jae,\n      sentido,\n      id_veiculo,\n      id_validador,\n      id_cliente,\n      id_transacao,\n      tipo_pagamento,\n      tipo_transacao,\n      tipo_gratuidade,\n      id_tipo_integracao,\n      id_integracao,\n      latitude,\n      longitude,\n      geo_point_transacao,\n      stop_id,\n      stop_lat,\n      stop_lon,\n      valor_transacao,\n      1 AS priority\n    FROM\n      `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao`\n    WHERE\n      \n        data = \"2000-01-01\"\n      \n  \n),\ntransacao_deduplicada AS (\n  SELECT\n    * EXCEPT(rn)\n  FROM\n  (\n    SELECT\n      *,\n      ROW_NUMBER() OVER (PARTITION BY id_transacao ORDER BY datetime_captura DESC, priority) AS rn\n    FROM\n      complete_partitions\n  )\n  WHERE\n    rn = 1\n)\nSELECT\n  t.data,\n  t.hora,\n  t.datetime_transacao,\n  t.datetime_processamento,\n  t.datetime_captura,\n  t.modo,\n  t.id_consorcio,\n  t.consorcio,\n  t.id_operadora,\n  t.operadora,\n  t.id_servico_jae,\n  t.servico_jae,\n  t.descricao_servico_jae,\n  t.sentido,\n  t.id_veiculo,\n  t.id_validador,\n  t.id_cliente,\n  SHA256(t.id_cliente) AS hash_cliente,\n  t.id_transacao,\n  t.tipo_pagamento,\n  t.tipo_transacao,\n  CASE\n    WHEN t.tipo_transacao = \"Integra\u00e7\u00e3o\" OR i.id_transacao IS NOT NULL THEN \"Integra\u00e7\u00e3o\"\n    WHEN t.tipo_transacao IN (\"D\u00e9bito\", \"Botoeira\") THEN \"Integral\"\n    ELSE t.tipo_transacao\n  END AS tipo_transacao_smtr,\n  CASE\n    WHEN t.tipo_transacao = \"Gratuidade\" AND t.tipo_gratuidade IS NULL THEN \"N\u00e3o Identificado\"\n    ELSE t.tipo_gratuidade\n  END AS tipo_gratuidade,\n  t.id_tipo_integracao,\n  t.id_integracao,\n  t.latitude,\n  t.longitude,\n  t.geo_point_transacao,\n  t.stop_id,\n  t.stop_lat,\n  t.stop_lon,\n  t.valor_transacao,\n  CASE\n    WHEN\n      i.id_transacao IS NOT NULL\n      OR DATE(t.datetime_processamento) < (SELECT MAX(data_ordem) FROM `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_dia`)\n      THEN COALESCE(i.valor_rateio, t.valor_transacao) * 0.96\n  END AS valor_pagamento,\n  '' AS versao\nFROM\n  transacao_deduplicada t\nLEFT JOIN\n  integracao i\nUSING(id_transacao)", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:00.939373Z", "completed_at": "2024-09-30T15:24:00.951942Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:00.954025Z", "completed_at": "2024-09-30T15:24:00.954039Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.019814729690551758, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.registros_status_viagem", "compiled": true, "compiled_code": "\n\n-- 1. Identifica registros pertencentes a viagens\nwith registros_viagem as (\n    select\n    s.* except(versao_modelo),\n    datetime_partida,\n    datetime_chegada,\n    distancia_inicio_fim,\n    id_viagem\n    from\n        `rj-smtr`.`projeto_subsidio_sppo`.`aux_registros_status_trajeto` s\n    left join (\n    select\n        id_veiculo,\n        trip_id,\n        servico_realizado,\n        sentido_shape,\n        id_viagem,\n        datetime_partida,\n        datetime_chegada,\n        distancia_inicio_fim\n    from\n        `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\n    ) v\n    on\n    s.id_veiculo = v.id_veiculo\n    and s.trip_id = v.trip_id\n    and s.timestamp_gps between v.datetime_partida and v.datetime_chegada\n)\n-- 2. Filtra apenas registros de viagens identificadas\nselect\n    *,\n    '' as versao_modelo\nfrom\n    registros_viagem\nwhere\n    id_viagem is not null", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:00.960133Z", "completed_at": "2024-09-30T15:24:00.965734Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:00.967332Z", "completed_at": "2024-09-30T15:24:00.967342Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010591268539428711, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_aux_viagem_circular_sentido__I__V__C.70c058ec81", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\n    group by sentido\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:00.971527Z", "completed_at": "2024-09-30T15:24:00.976186Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:00.977442Z", "completed_at": "2024-09-30T15:24:00.977450Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008544921875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_aux_viagem_circular_sentido_shape__I__V__C.39a2bf1eea", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido_shape as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\n    group by sentido_shape\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:00.981162Z", "completed_at": "2024-09-30T15:24:00.989464Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:00.991889Z", "completed_at": "2024-09-30T15:24:00.991901Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013343334197998047, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_data.9696b69d2f", "compiled": true, "compiled_code": "\nSELECT\n    data\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    data is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:00.996754Z", "completed_at": "2024-09-30T15:24:01.002280Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.003627Z", "completed_at": "2024-09-30T15:24:01.003637Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009650468826293945, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_datetime_chegada.129de567e2", "compiled": true, "compiled_code": "\nSELECT\n    datetime_chegada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    datetime_chegada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.007505Z", "completed_at": "2024-09-30T15:24:01.012071Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.013318Z", "completed_at": "2024-09-30T15:24:01.013326Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008159160614013672, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_datetime_partida.44f6ea1a28", "compiled": true, "compiled_code": "\nSELECT\n    datetime_partida\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    datetime_partida is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.017118Z", "completed_at": "2024-09-30T15:24:01.021654Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.022903Z", "completed_at": "2024-09-30T15:24:01.022912Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00817418098449707, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_distancia_planejada.5baf640cb6", "compiled": true, "compiled_code": "\nSELECT\n    distancia_planejada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    distancia_planejada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.026958Z", "completed_at": "2024-09-30T15:24:01.031546Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.032830Z", "completed_at": "2024-09-30T15:24:01.032839Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008527517318725586, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_id_veiculo.f928466090", "compiled": true, "compiled_code": "\nSELECT\n    id_veiculo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    id_veiculo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.037018Z", "completed_at": "2024-09-30T15:24:01.042796Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.044543Z", "completed_at": "2024-09-30T15:24:01.044555Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010883331298828125, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_id_viagem.48bb460a25", "compiled": true, "compiled_code": "\nSELECT\n    id_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    id_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.049553Z", "completed_at": "2024-09-30T15:24:01.054221Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.055494Z", "completed_at": "2024-09-30T15:24:01.055502Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00830531120300293, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_sentido.d255c2ea5c", "compiled": true, "compiled_code": "\nSELECT\n    sentido\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    sentido is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.059284Z", "completed_at": "2024-09-30T15:24:01.063832Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.065069Z", "completed_at": "2024-09-30T15:24:01.065077Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008116960525512695, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_sentido_shape.ca74a5e3f0", "compiled": true, "compiled_code": "\nSELECT\n    sentido_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    sentido_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.071320Z", "completed_at": "2024-09-30T15:24:01.077247Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.078610Z", "completed_at": "2024-09-30T15:24:01.078623Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012310266494750977, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_servico_informado.e43d2419a6", "compiled": true, "compiled_code": "\nSELECT\n    servico_informado\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    servico_informado is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.082874Z", "completed_at": "2024-09-30T15:24:01.087662Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.088934Z", "completed_at": "2024-09-30T15:24:01.088943Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008578777313232422, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_shape_id.d4509226b0", "compiled": true, "compiled_code": "\nSELECT\n    shape_id\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    shape_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.093099Z", "completed_at": "2024-09-30T15:24:01.098927Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.100310Z", "completed_at": "2024-09-30T15:24:01.100319Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009638309478759766, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_circular_versao_modelo.5c199c2365", "compiled": true, "compiled_code": "\nSELECT\n    versao_modelo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`)\nAND\n    versao_modelo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.104269Z", "completed_at": "2024-09-30T15:24:01.109111Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:01.112578Z", "completed_at": "2024-09-30T15:24:01.112603Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012705087661743164, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_aux_viagem_circular_id_viagem.1ee2d25705", "compiled": true, "compiled_code": "\n    \n    \n\nwith dbt_test__target as (\n\n  select id_viagem as unique_field\n  from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular`\n  where id_viagem is not null\n\n)\n\nselect\n    unique_field,\n    count(*) as n_records\n\nfrom dbt_test__target\ngroup by unique_field\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:01.134020Z", "completed_at": "2024-09-30T15:24:03.239504Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:03.245218Z", "completed_at": "2024-09-30T15:24:03.245254Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.1164517402648926, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.integracao_nao_realizada", "compiled": true, "compiled_code": "\n\n\n\n  \n\n    \n\n    \n    \n\n    \n    \n  \n\n\n -- N\u00famero m\u00e1ximo de pernas em uma integra\u00e7\u00e3o\n\n\n\nWITH matriz AS (\n  SELECT\n    STRING_AGG(modo order by sequencia_integracao) AS sequencia_valida\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`matriz_integracao`\n    -- `rj-smtr.br_rj_riodejaneiro_bilhetagem.matriz_integracao`\n  group by id_matriz_integracao\n),\ntransacao AS (\n  SELECT\n    id_cliente,\n    \n      \n        datetime_transacao,\n      \n    \n      \n        id_transacao,\n      \n    \n      \n        modo,\n      \n    \n      \n        CONCAT(id_servico_jae, '_', sentido) AS servico_sentido,\n      \n    \n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao`\n    -- `rj-smtr.br_rj_riodejaneiro_bilhetagem.transacao`\n  WHERE\n    data < CURRENT_DATE(\"America/Sao_Paulo\")\n    AND tipo_transacao != \"Gratuidade\"\n    \n      AND\n      \n  \n    data = \"2000-01-01\"\n  \n\n    \n),\ntransacao_agrupada AS (\n  SELECT\n    id_cliente,\n    -- Cria o conjunto de colunas para a transa\u00e7\u00e3o atual e as 4 pr\u00f3ximas transa\u00e7\u00f5es do cliente\n    \n      \n        \n          datetime_transacao AS datetime_transacao_0,\n        \n      \n        \n          LEAD(datetime_transacao, 1) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS datetime_transacao_1,\n        \n      \n        \n          LEAD(datetime_transacao, 2) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS datetime_transacao_2,\n        \n      \n        \n          LEAD(datetime_transacao, 3) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS datetime_transacao_3,\n        \n      \n        \n          LEAD(datetime_transacao, 4) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS datetime_transacao_4,\n        \n      \n    \n      \n        \n          id_transacao AS id_transacao_0,\n        \n      \n        \n          LEAD(id_transacao, 1) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS id_transacao_1,\n        \n      \n        \n          LEAD(id_transacao, 2) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS id_transacao_2,\n        \n      \n        \n          LEAD(id_transacao, 3) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS id_transacao_3,\n        \n      \n        \n          LEAD(id_transacao, 4) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS id_transacao_4,\n        \n      \n    \n      \n        \n          modo AS modo_0,\n        \n      \n        \n          LEAD(modo, 1) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS modo_1,\n        \n      \n        \n          LEAD(modo, 2) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS modo_2,\n        \n      \n        \n          LEAD(modo, 3) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS modo_3,\n        \n      \n        \n          LEAD(modo, 4) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS modo_4,\n        \n      \n    \n      \n        \n          servico_sentido AS servico_sentido_0,\n        \n      \n        \n          LEAD(servico_sentido, 1) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS servico_sentido_1,\n        \n      \n        \n          LEAD(servico_sentido, 2) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS servico_sentido_2,\n        \n      \n        \n          LEAD(servico_sentido, 3) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS servico_sentido_3,\n        \n      \n        \n          LEAD(servico_sentido, 4) OVER (PARTITION BY id_cliente ORDER BY datetime_transacao) AS servico_sentido_4,\n        \n      \n    \n  FROM\n    transacao\n),\nintegracao_possivel AS (\n  SELECT\n    *,\n    \n    \n    \n      \n      (\n        DATETIME_DIFF(datetime_transacao_1, datetime_transacao_0, MINUTE) <= 180\n        AND CONCAT(modo_0, ',', modo_1) IN (SELECT sequencia_valida FROM matriz)\n        \n          AND servico_sentido_1 != servico_sentido_0\n        \n      ) AS indicador_integracao_1,\n      \n\n    \n      \n      (\n        DATETIME_DIFF(datetime_transacao_2, datetime_transacao_0, MINUTE) <= 180\n        AND CONCAT(modo_0, ',', modo_1, ',', modo_2) IN (SELECT sequencia_valida FROM matriz)\n        \n          AND servico_sentido_2 NOT IN (servico_sentido_0, ',', servico_sentido_1)\n        \n      ) AS indicador_integracao_2,\n      \n\n    \n      \n      (\n        DATETIME_DIFF(datetime_transacao_3, datetime_transacao_0, MINUTE) <= 180\n        AND CONCAT(modo_0, ',', modo_1, ',', modo_2, ',', modo_3) IN (SELECT sequencia_valida FROM matriz)\n        \n          AND servico_sentido_3 NOT IN (servico_sentido_0, ',', servico_sentido_1, ',', servico_sentido_2)\n        \n      ) AS indicador_integracao_3,\n      \n\n    \n      \n      (\n        DATETIME_DIFF(datetime_transacao_4, datetime_transacao_0, MINUTE) <= 180\n        AND CONCAT(modo_0, ',', modo_1, ',', modo_2, ',', modo_3, ',', modo_4) IN (SELECT sequencia_valida FROM matriz)\n        \n          AND servico_sentido_4 NOT IN (servico_sentido_0, ',', servico_sentido_1, ',', servico_sentido_2, ',', servico_sentido_3)\n        \n      ) AS indicador_integracao_4,\n      \n\n    \n  FROM\n    transacao_agrupada\n  WHERE\n    id_transacao_1 IS NOT NULL\n),\ntransacao_filtrada AS (\n  SELECT\n    id_cliente,\n    \n      \n        \n          datetime_transacao_0,\n        \n      \n        \n          datetime_transacao_1,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_2 THEN datetime_transacao_2\n            END AS datetime_transacao_2,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_3 THEN datetime_transacao_3\n            END AS datetime_transacao_3,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_4 THEN datetime_transacao_4\n            END AS datetime_transacao_4,\n        \n      \n    \n      \n        \n          id_transacao_0,\n        \n      \n        \n          id_transacao_1,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_2 THEN id_transacao_2\n            END AS id_transacao_2,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_3 THEN id_transacao_3\n            END AS id_transacao_3,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_4 THEN id_transacao_4\n            END AS id_transacao_4,\n        \n      \n    \n      \n        \n          modo_0,\n        \n      \n        \n          modo_1,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_2 THEN modo_2\n            END AS modo_2,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_3 THEN modo_3\n            END AS modo_3,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_4 THEN modo_4\n            END AS modo_4,\n        \n      \n    \n      \n        \n          servico_sentido_0,\n        \n      \n        \n          servico_sentido_1,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_2 THEN servico_sentido_2\n            END AS servico_sentido_2,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_3 THEN servico_sentido_3\n            END AS servico_sentido_3,\n        \n      \n        \n          CASE\n            WHEN\n              indicador_integracao_4 THEN servico_sentido_4\n            END AS servico_sentido_4,\n        \n      \n    \n    indicador_integracao_1,\n    indicador_integracao_2,\n    indicador_integracao_3,\n    indicador_integracao_4\n  FROM\n    integracao_possivel\n  WHERE\n    indicador_integracao_1\n),\ntransacao_listada AS (\n  SELECT\n    *,\n    ARRAY_TO_STRING(\n      [\n        \n          id_transacao_1 ,\n        \n          id_transacao_2 ,\n        \n          id_transacao_3 ,\n        \n          id_transacao_4 \n        \n      ],\n      \", \"\n    ) AS transacoes\n  FROM\n    transacao_filtrada\n),\n\n  validacao_integracao_5_pernas AS (\n    SELECT\n      (\n        id_transacao_4 IS NOT NULL\n        \n        AND id_transacao_0 IN UNNEST(\n          SPLIT(\n            STRING_AGG(transacoes, \", \") OVER (PARTITION BY id_cliente ORDER BY datetime_transacao_0 ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING),\n            ', ')\n        )\n      ) AS remover_5,\n      *\n    FROM\n      \n        transacao_listada\n      \n  ),\n\n  validacao_integracao_4_pernas AS (\n    SELECT\n      (\n        id_transacao_3 IS NOT NULL\n        \n          AND id_transacao_4 IS NULL\n        \n        AND id_transacao_0 IN UNNEST(\n          SPLIT(\n            STRING_AGG(transacoes, \", \") OVER (PARTITION BY id_cliente ORDER BY datetime_transacao_0 ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING),\n            ', ')\n        )\n      ) AS remover_4,\n      *\n    FROM\n      \n        validacao_integracao_5_pernas\n        WHERE\n          NOT remover_5\n      \n  ),\n\n  validacao_integracao_3_pernas AS (\n    SELECT\n      (\n        id_transacao_2 IS NOT NULL\n        \n          AND id_transacao_3 IS NULL\n        \n        AND id_transacao_0 IN UNNEST(\n          SPLIT(\n            STRING_AGG(transacoes, \", \") OVER (PARTITION BY id_cliente ORDER BY datetime_transacao_0 ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING),\n            ', ')\n        )\n      ) AS remover_3,\n      *\n    FROM\n      \n        validacao_integracao_4_pernas\n        WHERE\n          NOT remover_4\n      \n  ),\n\n  validacao_integracao_2_pernas AS (\n    SELECT\n      (\n        id_transacao_1 IS NOT NULL\n        \n          AND id_transacao_2 IS NULL\n        \n        AND id_transacao_0 IN UNNEST(\n          SPLIT(\n            STRING_AGG(transacoes, \", \") OVER (PARTITION BY id_cliente ORDER BY datetime_transacao_0 ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING),\n            ', ')\n        )\n      ) AS remover_2,\n      *\n    FROM\n      \n        validacao_integracao_3_pernas\n        WHERE\n          NOT remover_3\n      \n  ),\n\nintegracoes_validas AS (\n  SELECT\n    DATE(datetime_transacao_0) AS data,\n    id_transacao_0 AS id_integracao,\n    *\n  FROM\n    validacao_integracao_2_pernas\n  WHERE\n    NOT remover_2\n),\nmelted AS (\n  SELECT\n    data,\n    id_integracao,\n    sequencia_integracao,\n    datetime_transacao,\n    id_transacao,\n    modo,\n    SPLIT(servico_sentido, '_')[0] AS id_servico_jae,\n    SPLIT(servico_sentido, '_')[1] AS sentido,\n    COUNTIF(modo = \"BRT\") OVER(PARTITION BY id_integracao) > 1 AS indicador_transferencia\n  FROM\n    integracoes_validas,\n    UNNEST(\n      [\n        \n          STRUCT(\n            \n              datetime_transacao_0 AS datetime_transacao,\n            \n              id_transacao_0 AS id_transacao,\n            \n              modo_0 AS modo,\n            \n              servico_sentido_0 AS servico_sentido,\n            \n            1 AS sequencia_integracao\n          ),\n      \n          STRUCT(\n            \n              datetime_transacao_1 AS datetime_transacao,\n            \n              id_transacao_1 AS id_transacao,\n            \n              modo_1 AS modo,\n            \n              servico_sentido_1 AS servico_sentido,\n            \n            2 AS sequencia_integracao\n          ),\n      \n          STRUCT(\n            \n              datetime_transacao_2 AS datetime_transacao,\n            \n              id_transacao_2 AS id_transacao,\n            \n              modo_2 AS modo,\n            \n              servico_sentido_2 AS servico_sentido,\n            \n            3 AS sequencia_integracao\n          ),\n      \n          STRUCT(\n            \n              datetime_transacao_3 AS datetime_transacao,\n            \n              id_transacao_3 AS id_transacao,\n            \n              modo_3 AS modo,\n            \n              servico_sentido_3 AS servico_sentido,\n            \n            4 AS sequencia_integracao\n          ),\n      \n          STRUCT(\n            \n              datetime_transacao_4 AS datetime_transacao,\n            \n              id_transacao_4 AS id_transacao,\n            \n              modo_4 AS modo,\n            \n              servico_sentido_4 AS servico_sentido,\n            \n            5 AS sequencia_integracao\n          )\n      \n      ]\n    )\n),\nintegracao_nao_realizada AS (\n  SELECT DISTINCT\n    id_integracao\n  FROM\n    melted\n  WHERE\n    NOT indicador_transferencia\n    AND id_transacao NOT IN (\n      SELECT\n        id_transacao\n      FROM\n        `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`integracao`\n        -- `rj-smtr.br_rj_riodejaneiro_bilhetagem.integracao`\n      \n        WHERE\n          \n  \n    data = \"2000-01-01\"\n  \n\n      \n    )\n)\nSELECT\n  * EXCEPT(indicador_transferencia),\n  '' as versao\nFROM\n  melted\nWHERE\n  id_integracao IN (SELECT id_integracao FROM integracao_nao_realizada)\n  AND id_transacao IS NOT NULL", "relation_name": "`rj-smtr`.`validacao_dados_jae`.`integracao_nao_realizada`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:03.256732Z", "completed_at": "2024-09-30T15:24:05.629458Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.635994Z", "completed_at": "2024-09-30T15:24:05.636030Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.386115789413452, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.transacao_invalida", "compiled": true, "compiled_code": "\n\n\n  \n\n    \n\n    \n    \n\n    \n    \n  \n\n\nWITH transacao AS (\n  SELECT\n    t.data,\n    t.hora,\n    t.datetime_transacao,\n    t.datetime_processamento,\n    t.datetime_captura,\n    t.modo,\n    t.id_consorcio,\n    t.consorcio,\n    t.id_operadora,\n    t.operadora,\n    t.id_servico_jae,\n    t.servico_jae,\n    t.descricao_servico_jae,\n    t.id_transacao,\n    t.longitude,\n    t.latitude,\n    IFNULL(t.longitude, 0) AS longitude_tratada,\n    IFNULL(t.latitude, 0) AS latitude_tratada,\n    s.longitude AS longitude_servico,\n    s.latitude AS latitude_servico,\n    s.id_servico_gtfs,\n    s.id_servico_jae AS id_servico_jae_cadastro\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao` t\n  LEFT JOIN\n    `rj-smtr`.`cadastro`.`servicos` s\n  ON\n    t.id_servico_jae = s.id_servico_jae\n    AND t.data >= s.data_inicio_vigencia AND (t.data <= s.data_fim_vigencia OR s.data_fim_vigencia IS NULL)\n    \n      WHERE\n      \n        data = \"2000-01-01\"\n      \n    \n),\nindicadores AS (\n  SELECT\n    * EXCEPT(id_servico_gtfs, latitude_tratada, longitude_tratada, id_servico_jae_cadastro),\n    latitude_tratada = 0 OR longitude_tratada = 0 AS indicador_geolocalizacao_zerada,\n    (\n      (latitude_tratada != 0 OR longitude_tratada != 0)\n      AND NOT ST_INTERSECTSBOX(ST_GEOGPOINT(longitude_tratada, latitude_tratada), -43.87, -23.13, -43.0, -22.59)\n    ) AS indicador_geolocalizacao_fora_rio,\n    (\n      latitude_tratada != 0\n      AND longitude_tratada != 0\n      AND latitude_servico IS NOT NULL\n      AND longitude_servico IS NOT NULL\n      AND modo = \"BRT\"\n      AND ST_DISTANCE(ST_GEOGPOINT(longitude_tratada, latitude_tratada), ST_GEOGPOINT(longitude_servico, latitude_servico)) > 100\n    ) AS indicador_geolocalizacao_fora_stop,\n    id_servico_gtfs IS NULL AND id_servico_jae_cadastro IS NOT NULL AND modo IN (\"\u00d4nibus\", \"BRT\") AS indicador_servico_fora_gtfs,\n    id_servico_jae_cadastro IS NULL AS indicador_servico_fora_vigencia\n  FROM\n    transacao\n)\nSELECT\n  * EXCEPT(indicador_servico_fora_gtfs, indicador_servico_fora_vigencia),\n  CASE\n    WHEN indicador_geolocalizacao_zerada = TRUE THEN \"Geolocaliza\u00e7\u00e3o zerada\"\n    WHEN indicador_geolocalizacao_fora_rio = TRUE THEN \"Geolocaliza\u00e7\u00e3o fora do munic\u00edpio\"\n    WHEN indicador_geolocalizacao_fora_stop = TRUE THEN \"Geolocaliza\u00e7\u00e3o fora do stop\"\n  END AS descricao_geolocalizacao_invalida,\n  indicador_servico_fora_gtfs,\n  indicador_servico_fora_vigencia,\n  '' as versao\nFROM\n  indicadores\nWHERE\n  indicador_geolocalizacao_zerada = TRUE\n  OR indicador_geolocalizacao_fora_rio = TRUE\n  OR indicador_geolocalizacao_fora_stop = TRUE\n  OR indicador_servico_fora_gtfs = TRUE\n  OR indicador_servico_fora_vigencia = TRUE", "relation_name": "`rj-smtr`.`validacao_dados_jae`.`transacao_invalida`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.649257Z", "completed_at": "2024-09-30T15:24:05.662797Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.664406Z", "completed_at": "2024-09-30T15:24:05.664418Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.020662784576416016, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.aux_viagem_registros", "compiled": true, "compiled_code": "-- 1. Calcula a dist\u00e2ncia total percorrida por viagem, separada por\n--    shape. Adiciona dist\u00e2ncia do 1o/\u00faltimo sinal de gps ao in\u00edcio/final do\n--    shape. Isso \u00e9 necess\u00e1rio pois o 1o/ultimo sinal \u00e9 contabilizado\n--    apenas quando o veiculo sai/chega dentro do raio de 500m ao redor\n--    do ponto inicial/final. Contabiliza tamb\u00e9m o n\u00famero de registros\n--    em cada tapa da viagem (inicio, meio, fim, fora), total de\n--    registros de gps e total de minutos da viagem com registros de gps.\nwith distancia as (\n    select\n        *,\n        n_registros_middle + n_registros_start + n_registros_end as n_registros_shape\n    from (\n        select distinct\n            id_viagem,\n            trip_id,\n            max(distancia_inicio_fim) as distancia_inicio_fim,\n            round(sum(distancia)/1000 + max(distancia_inicio_fim), 3) as distancia_aferida,\n            sum(case when status_viagem = \"middle\" then 1 else 0 end) as n_registros_middle,\n            sum(case when status_viagem = \"start\" then 1 else 0 end) as n_registros_start,\n            sum(case when status_viagem = \"end\" then 1 else 0 end) as n_registros_end,\n            sum(case when status_viagem = \"out\" then 1 else 0 end) as n_registros_out,\n            count(timestamp_gps) as n_registros_total,\n            count(distinct timestamp_minuto_gps) as n_registros_minuto\n        from (\n            select distinct * except(posicao_veiculo_geo, start_pt, end_pt)\n            from `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\n            where\n                \n                data between date_sub(date(\"2022-01-01T01:00:00\"), interval 1 day) and date(\"2022-01-01T01:00:00\")\n                \n        )\n        group by 1,2\n    )\n)\n-- 2. Calcula distancia total por viagem - junta distancias corrigidas\n--    de ida e volta de viagens circulares.\nselect\n    id_viagem,\n    sum(distancia_aferida) as distancia_aferida,\n    sum(distancia_inicio_fim) as distancia_inicio_fim,\n    sum(n_registros_middle) as n_registros_middle,\n    sum(n_registros_start) as n_registros_start,\n    sum(n_registros_end) as n_registros_end,\n    sum(n_registros_out) as n_registros_out,\n    sum(n_registros_total) as n_registros_total,\n    sum(n_registros_minuto) as n_registros_minuto,\n    sum(n_registros_shape) as n_registros_shape,\n    '' as versao_modelo\nfrom\n    distancia\ngroup by 1", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.669037Z", "completed_at": "2024-09-30T15:24:05.674623Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.675913Z", "completed_at": "2024-09-30T15:24:05.675921Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009663105010986328, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_registros_status_viagem_sentido__I__V__C.8b8fa70da7", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\n    group by sentido\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.679658Z", "completed_at": "2024-09-30T15:24:05.684766Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.686041Z", "completed_at": "2024-09-30T15:24:05.686051Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008765697479248047, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_registros_status_viagem_sentido_shape__I__V__C.a6ccf195ec", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido_shape as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\n    group by sentido_shape\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.691056Z", "completed_at": "2024-09-30T15:24:05.695998Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.697240Z", "completed_at": "2024-09-30T15:24:05.697249Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009636878967285156, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_negative_registros_status_viagem_distancia.34c62e5708", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\n    where distancia < 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.701473Z", "completed_at": "2024-09-30T15:24:05.707414Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.708966Z", "completed_at": "2024-09-30T15:24:05.708976Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010067462921142578, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_data.fc562948d5", "compiled": true, "compiled_code": "\nSELECT\n    data\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    data is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.712715Z", "completed_at": "2024-09-30T15:24:05.717479Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.718726Z", "completed_at": "2024-09-30T15:24:05.718734Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008481740951538086, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_datetime_chegada.5dbeb5b878", "compiled": true, "compiled_code": "\nSELECT\n    datetime_chegada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    datetime_chegada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.722589Z", "completed_at": "2024-09-30T15:24:05.727396Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.728648Z", "completed_at": "2024-09-30T15:24:05.728656Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008410453796386719, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_datetime_partida.15c5410b28", "compiled": true, "compiled_code": "\nSELECT\n    datetime_partida\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    datetime_partida is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.732499Z", "completed_at": "2024-09-30T15:24:05.737247Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.738491Z", "completed_at": "2024-09-30T15:24:05.738499Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008407831192016602, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_distancia.85f4f41092", "compiled": true, "compiled_code": "\nSELECT\n    distancia\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    distancia is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.742243Z", "completed_at": "2024-09-30T15:24:05.746943Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.748223Z", "completed_at": "2024-09-30T15:24:05.748233Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008380651473999023, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_distancia_planejada.97e1779cf0", "compiled": true, "compiled_code": "\nSELECT\n    distancia_planejada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    distancia_planejada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.751979Z", "completed_at": "2024-09-30T15:24:05.757775Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.759026Z", "completed_at": "2024-09-30T15:24:05.759035Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009429693222045898, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_id_empresa.3108e4aab8", "compiled": true, "compiled_code": "\nSELECT\n    id_empresa\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    id_empresa is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.763388Z", "completed_at": "2024-09-30T15:24:05.768220Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.769551Z", "completed_at": "2024-09-30T15:24:05.769561Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010115385055541992, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_id_veiculo.3c008a9ac4", "compiled": true, "compiled_code": "\nSELECT\n    id_veiculo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    id_veiculo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.779060Z", "completed_at": "2024-09-30T15:24:05.788941Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.790619Z", "completed_at": "2024-09-30T15:24:05.790631Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.017188549041748047, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_id_viagem.b81547c9af", "compiled": true, "compiled_code": "\nSELECT\n    id_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    id_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.848755Z", "completed_at": "2024-09-30T15:24:05.858922Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.862181Z", "completed_at": "2024-09-30T15:24:05.862201Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01868152618408203, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_posicao_veiculo_geo.78b9ad4651", "compiled": true, "compiled_code": "\nSELECT\n    posicao_veiculo_geo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    posicao_veiculo_geo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.870900Z", "completed_at": "2024-09-30T15:24:05.876738Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.878167Z", "completed_at": "2024-09-30T15:24:05.878177Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010902881622314453, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_sentido.85a3d01213", "compiled": true, "compiled_code": "\nSELECT\n    sentido\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    sentido is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.882435Z", "completed_at": "2024-09-30T15:24:05.888426Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.889662Z", "completed_at": "2024-09-30T15:24:05.889671Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009621858596801758, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_sentido_shape.88347d2c2f", "compiled": true, "compiled_code": "\nSELECT\n    sentido_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    sentido_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.895655Z", "completed_at": "2024-09-30T15:24:05.900502Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.901778Z", "completed_at": "2024-09-30T15:24:05.901788Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009531736373901367, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_servico_informado.dd60d17ad8", "compiled": true, "compiled_code": "\nSELECT\n    servico_informado\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    servico_informado is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.905517Z", "completed_at": "2024-09-30T15:24:05.910147Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.911411Z", "completed_at": "2024-09-30T15:24:05.911420Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008236408233642578, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_servico_realizado.5376b0386b", "compiled": true, "compiled_code": "\nSELECT\n    servico_realizado\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    servico_realizado is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.915228Z", "completed_at": "2024-09-30T15:24:05.920126Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.921370Z", "completed_at": "2024-09-30T15:24:05.921379Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008495092391967773, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_shape_id.1d4aad9d42", "compiled": true, "compiled_code": "\nSELECT\n    shape_id\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    shape_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.925094Z", "completed_at": "2024-09-30T15:24:05.929547Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.930780Z", "completed_at": "2024-09-30T15:24:05.930788Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008061408996582031, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_status_viagem.d00cac767b", "compiled": true, "compiled_code": "\nSELECT\n    status_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    status_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.934804Z", "completed_at": "2024-09-30T15:24:05.939623Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.940868Z", "completed_at": "2024-09-30T15:24:05.940877Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008448123931884766, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_timestamp_gps.01b64d27a5", "compiled": true, "compiled_code": "\nSELECT\n    timestamp_gps\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    timestamp_gps is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.944558Z", "completed_at": "2024-09-30T15:24:05.950672Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.951958Z", "completed_at": "2024-09-30T15:24:05.951970Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009819984436035156, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_timestamp_minuto_gps.1157bb9203", "compiled": true, "compiled_code": "\nSELECT\n    timestamp_minuto_gps\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    timestamp_minuto_gps is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.955909Z", "completed_at": "2024-09-30T15:24:05.960469Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.961701Z", "completed_at": "2024-09-30T15:24:05.961709Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008194208145141602, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_registros_status_viagem_versao_modelo.86225e08a6", "compiled": true, "compiled_code": "\nSELECT\n    versao_modelo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`)\nAND\n    versao_modelo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.965543Z", "completed_at": "2024-09-30T15:24:05.974039Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:05.976035Z", "completed_at": "2024-09-30T15:24:05.976047Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013352394104003906, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_registros_status_viagem_id_viagem.5e7788f7bf", "compiled": true, "compiled_code": "\n    \n    \n\nwith dbt_test__target as (\n\n  select id_viagem as unique_field\n  from `rj-smtr`.`projeto_subsidio_sppo`.`registros_status_viagem`\n  where id_viagem is not null\n\n)\n\nselect\n    unique_field,\n    count(*) as n_records\n\nfrom dbt_test__target\ngroup by unique_field\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:05.981453Z", "completed_at": "2024-09-30T15:24:08.922514Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:08.925489Z", "completed_at": "2024-09-30T15:24:08.925509Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.9482576847076416, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.passageiros_hora", "compiled": true, "compiled_code": "\n\nwith __dbt__cte__aux_passageiros_hora as (\n\n\nSELECT\n  data,\n  hora,\n  modo,\n  consorcio,\n  id_servico_jae,\n  servico_jae,\n  descricao_servico_jae,\n  sentido,\n  id_transacao,\n  tipo_transacao_smtr,\n  CASE\n    WHEN tipo_transacao_smtr = \"Gratuidade\" THEN tipo_gratuidade\n    WHEN tipo_transacao_smtr = \"Integra\u00e7\u00e3o\" THEN \"Integra\u00e7\u00e3o\"\n    WHEN tipo_transacao_smtr = \"Transfer\u00eancia\" THEN \"Transfer\u00eancia\"\n    ELSE tipo_pagamento\n  END AS tipo_transacao_detalhe_smtr,\n  tipo_gratuidade,\n  tipo_pagamento,\n  geo_point_transacao\nFROM\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao`\nWHERE\n  id_servico_jae NOT IN (\"140\", \"142\")\n  AND id_operadora != \"2\"\n  AND (\n    modo = \"BRT\"\n    OR (modo = \"VLT\" AND data >= DATE(\"2024-02-24\"))\n    OR (modo = \"\u00d4nibus\" AND data >= DATE(\"2024-04-19\"))\n    OR (modo = \"Van\" AND consorcio = \"STPC\" AND data >= DATE(\"2024-07-01\"))\n    OR (modo = \"Van\" AND consorcio = \"STPL\" AND data >= DATE(\"2024-07-15\"))\n  )\n  AND tipo_transacao IS NOT NULL\n\nUNION ALL\n\nSELECT\n  data,\n  hora,\n  modo,\n  consorcio,\n  id_servico_jae,\n  servico_jae,\n  descricao_servico_jae,\n  sentido,\n  id_transacao,\n  \"RioCard\" AS tipo_transacao_smtr,\n  \"RioCard\" AS tipo_transacao_detalhe_smtr,\n  NULL AS tipo_gratuidade,\n  \"RioCard\" AS tipo_pagamento,\n  ST_GEOGPOINT(longitude, latitude) AS geo_point_transacao\nFROM\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao_riocard`\nWHERE\n  (id_servico_jae NOT IN (\"140\", \"142\") OR id_servico_jae IS NULL)\n  AND (id_operadora != \"2\" OR id_operadora IS NULL)\n  AND (\n    modo = \"BRT\"\n    OR (modo = \"VLT\" AND data >= DATE(\"2024-02-24\"))\n    OR (modo = \"\u00d4nibus\" AND data >= DATE(\"2024-04-19\"))\n    OR (modo = \"Van\" AND consorcio = \"STPC\" AND data >= DATE(\"2024-07-01\"))\n    OR (modo = \"Van\" AND consorcio = \"STPL\" AND data >= DATE(\"2024-07-15\"))\n    OR modo IS NULL\n  )\n) /*\nconsulta as parti\u00e7\u00f5es a serem atualizadas com base nas transa\u00e7\u00f5es capturadas entre date_range_start e date_range_end\ne as integra\u00e7\u00f5es capturadas entre date_range_start e date_range_end\n*/\n\n\n\n  \n    -- Transa\u00e7\u00f5es Ja\u00e9\n    \n\n    \n\n    \n  \n\n\nSELECT\n  * EXCEPT(id_transacao, geo_point_transacao),\n  COUNT(id_transacao) AS quantidade_passageiros,\n  '' AS versao\nFROM\n  __dbt__cte__aux_passageiros_hora\nWHERE\n\n  \n    data = \"2000-01-01\"\n  \n\nGROUP BY\n  data,\n  hora,\n  modo,\n  consorcio,\n  id_servico_jae,\n  servico_jae,\n  descricao_servico_jae,\n  sentido,\n  tipo_transacao_smtr,\n  tipo_transacao_detalhe_smtr,\n  tipo_gratuidade,\n  tipo_pagamento", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`passageiros_hora`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:08.932976Z", "completed_at": "2024-09-30T15:24:11.379054Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:11.382584Z", "completed_at": "2024-09-30T15:24:11.382606Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.455209255218506, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.passageiros_tile_hora", "compiled": true, "compiled_code": "\n\nwith __dbt__cte__aux_passageiros_hora as (\n\n\nSELECT\n  data,\n  hora,\n  modo,\n  consorcio,\n  id_servico_jae,\n  servico_jae,\n  descricao_servico_jae,\n  sentido,\n  id_transacao,\n  tipo_transacao_smtr,\n  CASE\n    WHEN tipo_transacao_smtr = \"Gratuidade\" THEN tipo_gratuidade\n    WHEN tipo_transacao_smtr = \"Integra\u00e7\u00e3o\" THEN \"Integra\u00e7\u00e3o\"\n    WHEN tipo_transacao_smtr = \"Transfer\u00eancia\" THEN \"Transfer\u00eancia\"\n    ELSE tipo_pagamento\n  END AS tipo_transacao_detalhe_smtr,\n  tipo_gratuidade,\n  tipo_pagamento,\n  geo_point_transacao\nFROM\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao`\nWHERE\n  id_servico_jae NOT IN (\"140\", \"142\")\n  AND id_operadora != \"2\"\n  AND (\n    modo = \"BRT\"\n    OR (modo = \"VLT\" AND data >= DATE(\"2024-02-24\"))\n    OR (modo = \"\u00d4nibus\" AND data >= DATE(\"2024-04-19\"))\n    OR (modo = \"Van\" AND consorcio = \"STPC\" AND data >= DATE(\"2024-07-01\"))\n    OR (modo = \"Van\" AND consorcio = \"STPL\" AND data >= DATE(\"2024-07-15\"))\n  )\n  AND tipo_transacao IS NOT NULL\n\nUNION ALL\n\nSELECT\n  data,\n  hora,\n  modo,\n  consorcio,\n  id_servico_jae,\n  servico_jae,\n  descricao_servico_jae,\n  sentido,\n  id_transacao,\n  \"RioCard\" AS tipo_transacao_smtr,\n  \"RioCard\" AS tipo_transacao_detalhe_smtr,\n  NULL AS tipo_gratuidade,\n  \"RioCard\" AS tipo_pagamento,\n  ST_GEOGPOINT(longitude, latitude) AS geo_point_transacao\nFROM\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao_riocard`\nWHERE\n  (id_servico_jae NOT IN (\"140\", \"142\") OR id_servico_jae IS NULL)\n  AND (id_operadora != \"2\" OR id_operadora IS NULL)\n  AND (\n    modo = \"BRT\"\n    OR (modo = \"VLT\" AND data >= DATE(\"2024-02-24\"))\n    OR (modo = \"\u00d4nibus\" AND data >= DATE(\"2024-04-19\"))\n    OR (modo = \"Van\" AND consorcio = \"STPC\" AND data >= DATE(\"2024-07-01\"))\n    OR (modo = \"Van\" AND consorcio = \"STPL\" AND data >= DATE(\"2024-07-15\"))\n    OR modo IS NULL\n  )\n) /*\nconsulta as parti\u00e7\u00f5es a serem atualizadas com base nas transa\u00e7\u00f5es capturadas entre date_range_start e date_range_end\ne as integra\u00e7\u00f5es capturadas entre date_range_start e date_range_end\n*/\n\n\n\n  \n    -- Transa\u00e7\u00f5es Ja\u00e9\n    \n\n    \n\n    \n  \n\n\nSELECT\n  p.* EXCEPT(id_transacao, geo_point_transacao),\n  geo.tile_id,\n  COUNT(id_transacao) AS quantidade_passageiros,\n  '' AS versao\nFROM\n  __dbt__cte__aux_passageiros_hora p\nJOIN\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`aux_h3_res9` geo\nON\n  ST_CONTAINS(geo.geometry, geo_point_transacao)\nWHERE\n\n  \n    data = \"2000-01-01\"\n  \n\nGROUP BY\n  data,\n  hora,\n  modo,\n  consorcio,\n  id_servico_jae,\n  servico_jae,\n  descricao_servico_jae,\n  sentido,\n  tipo_transacao_smtr,\n  tipo_transacao_detalhe_smtr,\n  tipo_gratuidade,\n  tipo_pagamento,\n  tile_id", "relation_name": "`rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`passageiros_tile_hora`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:11.391298Z", "completed_at": "2024-09-30T15:24:13.523492Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.524814Z", "completed_at": "2024-09-30T15:24:13.524824Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.1369729042053223, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_pagamento_servico_operador_dia_invalida", "compiled": true, "compiled_code": "\n\n\n\n  \n  \n\n\nWITH transacao_invalida AS (\n  SELECT\n    id_transacao,\n    indicador_servico_fora_vigencia\n  FROM\n    `rj-smtr`.`validacao_dados_jae`.`transacao_invalida`\n  WHERE\n    indicador_servico_fora_vigencia = TRUE\n  \n    AND\n    \n      data = \"2000-01-01\"\n    \n  \n),\ntransacao_agg AS (\n  SELECT\n    t.data_ordem,\n    ANY_VALUE(t.id_consorcio) AS id_consorcio,\n    t.id_servico_jae,\n    t.id_operadora,\n    COUNT(*) AS quantidade_total_transacao_captura,\n    SUM(t.valor_transacao) AS valor_total_transacao_captura,\n    MAX(ti.indicador_servico_fora_vigencia) IS NOT NULL AS indicador_servico_fora_vigencia\n  FROM\n    `rj-smtr`.`validacao_dados_jae_staging`.`aux_transacao_ordem` t\n  LEFT JOIN\n    transacao_invalida ti\n  USING(id_transacao)\n  GROUP BY\n    data_ordem,\n    id_servico_jae,\n    id_operadora\n),\nordem_pagamento AS (\n  SELECT\n    *\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_servico_operador_dia`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n),\nid_ordem_pagamento AS (\n  SELECT\n    data_ordem,\n    id_ordem_pagamento\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_dia`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n),\ntransacao_ordem AS (\n  SELECT\n    COALESCE(op.data_ordem, t.data_ordem) AS data_ordem,\n    COALESCE(op.id_consorcio, t.id_consorcio) AS id_consorcio,\n    COALESCE(op.id_operadora, t.id_operadora) AS id_operadora,\n    COALESCE(op.id_servico_jae, t.id_servico_jae) AS id_servico_jae,\n    op.quantidade_total_transacao,\n    op.valor_total_transacao_bruto,\n    op.valor_total_transacao_liquido,\n    t.quantidade_total_transacao_captura,\n    SAFE_CAST(t.valor_total_transacao_captura + op.valor_rateio_credito + op.valor_rateio_debito AS NUMERIC) AS valor_total_transacao_captura,\n    t.indicador_servico_fora_vigencia\n  FROM\n    ordem_pagamento op\n  FULL OUTER JOIN\n    transacao_agg t\n  USING(data_ordem, id_servico_jae, id_operadora)\n),\nindicadores AS (\n  SELECT\n    o.data_ordem,\n    id.id_ordem_pagamento,\n    o.id_consorcio,\n    o.id_operadora,\n    o.id_servico_jae,\n    o.quantidade_total_transacao,\n    o.valor_total_transacao_bruto,\n    o.valor_total_transacao_liquido,\n    o.quantidade_total_transacao_captura,\n    o.valor_total_transacao_captura,\n    COALESCE(\n      (\n        quantidade_total_transacao_captura != quantidade_total_transacao\n        OR ROUND(valor_total_transacao_captura, 2) != ROUND(valor_total_transacao_bruto, 2)\n      ),\n      TRUE\n    ) AS indicador_captura_invalida,\n    o.indicador_servico_fora_vigencia\n  FROM\n    transacao_ordem o\n  JOIN\n    id_ordem_pagamento id\n  USING(data_ordem)\n)\nSELECT\n  *,\n  '' AS versao\nFROM\n  indicadores\nWHERE\n  indicador_servico_fora_vigencia = TRUE\n  OR indicador_captura_invalida = TRUE\n  AND id_servico_jae NOT IN (SELECT id_linha FROM `rj-smtr`.`br_rj_riodejaneiro_bilhetagem_staging`.`linha_sem_ressarcimento`)", "relation_name": "`rj-smtr`.`validacao_dados_jae_staging`.`ordem_pagamento_servico_operador_dia_invalida`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.528894Z", "completed_at": "2024-09-30T15:24:13.534757Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.536016Z", "completed_at": "2024-09-30T15:24:13.536025Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009778976440429688, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.viagem_conformidade", "compiled": true, "compiled_code": "\n\n-- 1. Agrega informa\u00e7\u00f5es de viagens circulares: ajusta\n--    datetime_chegada, calcula tempo total de\n--    viagem e distancia total planejada. Mantem o shape planejado (\"C\")\n--    como padr\u00e3o da viagem.\nwith viagem as (\n    select\n        *,\n        datetime_diff(datetime_chegada, datetime_partida, minute) + 1 as tempo_viagem\n    from (\n        select\n            *\n        from (\n            select\n                * except(sentido_shape, distancia_inicio_fim, shape_id, shape_id_planejado, trip_id, trip_id_planejado, datetime_chegada),\n                datetime_chegada,\n                trip_id_planejado as trip_id,\n                shape_id_planejado as shape_id\n            from\n                `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular` v\n            where\n                sentido = \"I\" or sentido = \"V\"\n        )\n        union all (\n            select\n                * except(sentido_shape, distancia_inicio_fim, shape_id, shape_id_planejado, trip_id, trip_id_planejado),\n                trip_id_planejado as trip_id,\n                shape_id_planejado as shape_id,\n            from\n                (select\n                    v.* except(datetime_chegada),\n                    lead(datetime_chegada) over (\n                        partition by id_viagem order by sentido_shape)\n                    as datetime_chegada,\n                    -- TODO: mudar se tiver distancia planejada separada\n                    -- por shape (ida/volta)\n                    -- distancia_planejada,\n                    -- round(distancia_planejada + lead(distancia_planejada) over (\n                    --     partition by id_viagem order by sentido_shape), 3)\n                    -- as distancia_planejada,\n                from\n                    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_circular` v\n                where\n                    sentido = \"C\"\n                ) c\n            where sentido_shape = \"I\"\n        )\n    )\n)\n-- 2. Calcula os percentuais de conformidade da distancia, trajeto e GPS\nselect distinct\n    v.* except(versao_modelo),\n    d.* except(id_viagem, versao_modelo),\n    round(100 * n_registros_shape/n_registros_total, 2) as perc_conformidade_shape,\n    round(100 * d.distancia_aferida/v.distancia_planejada, 2) as perc_conformidade_distancia,\n    round(100 * n_registros_minuto/tempo_viagem, 2) as perc_conformidade_registros,\n    '' as versao_modelo\nfrom\n    viagem v\ninner join\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros` d\non\n    v.id_viagem = d.id_viagem", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.539747Z", "completed_at": "2024-09-30T15:24:13.545145Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.546541Z", "completed_at": "2024-09-30T15:24:13.546552Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009288311004638672, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_aux_viagem_registros_distancia_aferida.3f4f58b67a", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\n    where distancia_aferida <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.550389Z", "completed_at": "2024-09-30T15:24:13.559433Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.560821Z", "completed_at": "2024-09-30T15:24:13.560830Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012753725051879883, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_aux_viagem_registros_distancia_planejada.ad85bf839a", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\n    where distancia_planejada <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.564881Z", "completed_at": "2024-09-30T15:24:13.569514Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.571129Z", "completed_at": "2024-09-30T15:24:13.571144Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01000213623046875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_aux_viagem_registros_n_registros_end.e1ccb9c563", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\n    where n_registros_end <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.576515Z", "completed_at": "2024-09-30T15:24:13.581504Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.582789Z", "completed_at": "2024-09-30T15:24:13.582801Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009046316146850586, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_aux_viagem_registros_n_registros_middle.6fda2c93f2", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\n    where n_registros_middle <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.586680Z", "completed_at": "2024-09-30T15:24:13.591260Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.592544Z", "completed_at": "2024-09-30T15:24:13.592555Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008309602737426758, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_aux_viagem_registros_n_registros_minuto.82864933b3", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\n    where n_registros_minuto <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.596699Z", "completed_at": "2024-09-30T15:24:13.601417Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.602714Z", "completed_at": "2024-09-30T15:24:13.602722Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008698225021362305, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_aux_viagem_registros_n_registros_start.6777af50be", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\n    where n_registros_start <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.606463Z", "completed_at": "2024-09-30T15:24:13.612230Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.615177Z", "completed_at": "2024-09-30T15:24:13.615188Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01137995719909668, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_aux_viagem_registros_n_registros_total.c812b681b0", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\n    where n_registros_total <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.619611Z", "completed_at": "2024-09-30T15:24:13.624229Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.625530Z", "completed_at": "2024-09-30T15:24:13.625539Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008360624313354492, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_negative_aux_viagem_registros_n_registros_out.16cc121f84", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\n    where n_registros_out < 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.629377Z", "completed_at": "2024-09-30T15:24:13.634384Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.635640Z", "completed_at": "2024-09-30T15:24:13.635649Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008597373962402344, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_negative_aux_viagem_registros_n_registros_shape.d8d479f025", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\n    where n_registros_shape < 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.639363Z", "completed_at": "2024-09-30T15:24:13.643704Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.644927Z", "completed_at": "2024-09-30T15:24:13.644934Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00792551040649414, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_distancia_aferida.af703eccfb", "compiled": true, "compiled_code": "\nSELECT\n    distancia_aferida\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    distancia_aferida is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.648886Z", "completed_at": "2024-09-30T15:24:13.653339Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.655492Z", "completed_at": "2024-09-30T15:24:13.655516Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010532140731811523, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_distancia_planejada.a779141cf5", "compiled": true, "compiled_code": "\nSELECT\n    distancia_planejada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    distancia_planejada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.663769Z", "completed_at": "2024-09-30T15:24:13.670288Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.671646Z", "completed_at": "2024-09-30T15:24:13.671655Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011276960372924805, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_id_viagem.a786e08594", "compiled": true, "compiled_code": "\nSELECT\n    id_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    id_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.675430Z", "completed_at": "2024-09-30T15:24:13.679992Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.681233Z", "completed_at": "2024-09-30T15:24:13.681241Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008186578750610352, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_n_registros_end.6be4269aee", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_end\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    n_registros_end is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.684949Z", "completed_at": "2024-09-30T15:24:13.689417Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.690656Z", "completed_at": "2024-09-30T15:24:13.690663Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008156061172485352, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_n_registros_middle.32807232ce", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_middle\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    n_registros_middle is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.694937Z", "completed_at": "2024-09-30T15:24:13.700088Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.701348Z", "completed_at": "2024-09-30T15:24:13.701357Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009218215942382812, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_n_registros_minuto.157ae1cdaf", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_minuto\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    n_registros_minuto is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.705669Z", "completed_at": "2024-09-30T15:24:13.710726Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.711985Z", "completed_at": "2024-09-30T15:24:13.711994Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008964300155639648, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_n_registros_out.0e8817c0b4", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_out\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    n_registros_out is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.716159Z", "completed_at": "2024-09-30T15:24:13.723225Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.724602Z", "completed_at": "2024-09-30T15:24:13.724612Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011572122573852539, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_n_registros_shape.e354f14169", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    n_registros_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.729540Z", "completed_at": "2024-09-30T15:24:13.734380Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.735651Z", "completed_at": "2024-09-30T15:24:13.735660Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008554935455322266, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_n_registros_start.4e1ace515e", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_start\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    n_registros_start is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.740164Z", "completed_at": "2024-09-30T15:24:13.746556Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.748700Z", "completed_at": "2024-09-30T15:24:13.748713Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011757850646972656, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_n_registros_total.0a1be4060f", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_total\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    n_registros_total is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.752787Z", "completed_at": "2024-09-30T15:24:13.757540Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.758790Z", "completed_at": "2024-09-30T15:24:13.758799Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008524894714355469, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_aux_viagem_registros_versao_modelo.4e6a36e817", "compiled": true, "compiled_code": "\nSELECT\n    versao_modelo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`)\nAND\n    versao_modelo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.762616Z", "completed_at": "2024-09-30T15:24:13.767538Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.768774Z", "completed_at": "2024-09-30T15:24:13.768783Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008512735366821289, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_aux_viagem_registros_id_viagem.f0eebfdeac", "compiled": true, "compiled_code": "\n    \n    \n\nwith dbt_test__target as (\n\n  select id_viagem as unique_field\n  from `rj-smtr`.`projeto_subsidio_sppo`.`aux_viagem_registros`\n  where id_viagem is not null\n\n)\n\nselect\n    unique_field,\n    count(*) as n_records\n\nfrom dbt_test__target\ngroup by unique_field\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.772480Z", "completed_at": "2024-09-30T15:24:13.776123Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.777341Z", "completed_at": "2024-09-30T15:24:13.777349Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007178068161010742, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.view_passageiros_tile_hora", "compiled": true, "compiled_code": "WITH servicos AS (\n  SELECT\n    * EXCEPT(rn)\n  FROM\n    (\n      SELECT\n        *,\n        ROW_NUMBER() OVER (PARTITION BY id_servico_jae ORDER BY data_inicio_vigencia) AS rn\n      FROM\n        `rj-smtr`.`cadastro`.`servicos`\n    )\n  WHERE\n    rn = 1\n)\nSELECT\n  p.data,\n  p.hora,\n  p.modo,\n  p.consorcio,\n  p.id_servico_jae,\n  s.servico,\n  s.descricao_servico,\n  CONCAT(s.servico, ' - ' ,s.descricao_servico) AS nome_completo_servico,\n  p.sentido,\n  CASE\n    WHEN p.tipo_transacao_smtr = \"Integral\" THEN \"Tarifa Integral\"\n    ELSE p.tipo_transacao_smtr\n  END AS tipo_transacao_smtr,\n  p.tipo_transacao_detalhe_smtr,\n  p.tile_id,\n  p.quantidade_passageiros\nFROM\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`passageiros_tile_hora` p\nLEFT JOIN\n  servicos s\nUSING(id_servico_jae)", "relation_name": "`rj-smtr`.`dashboard_bilhetagem_jae`.`view_passageiros_tile_hora`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.783464Z", "completed_at": "2024-09-30T15:24:13.797114Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.798806Z", "completed_at": "2024-09-30T15:24:13.798818Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.020104408264160156, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_pagamento_consorcio_operador_dia_invalida", "compiled": true, "compiled_code": "-- depends_on: `rj-smtr`.`validacao_dados_jae_staging`.`ordem_pagamento_servico_operador_dia_invalida`\n\n\nWITH ordem_pagamento_servico_operador_dia AS (\n  SELECT\n    data_ordem,\n    id_consorcio,\n    id_operadora,\n    id_ordem_pagamento,\n    SUM(quantidade_total_transacao) AS quantidade_total_transacao,\n    SUM(valor_total_transacao_liquido) AS valor_total_transacao_liquido,\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_servico_operador_dia`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n  GROUP BY\n    1,\n    2,\n    3,\n    4\n),\nordem_pagamento_consorcio_operador_dia AS (\n  SELECT\n    data_ordem,\n    id_consorcio,\n    id_operadora,\n    id_ordem_pagamento,\n    quantidade_total_transacao,\n    valor_total_transacao_liquido_ordem AS valor_total_transacao_liquido\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_consorcio_operador_dia`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n),\nindicadores AS (\n  SELECT\n    cod.data_ordem,\n    cod.id_consorcio,\n    cod.id_operadora,\n    cod.id_ordem_pagamento,\n    cod.quantidade_total_transacao,\n    sod.quantidade_total_transacao AS quantidade_total_transacao_agregacao,\n    cod.valor_total_transacao_liquido,\n    sod.valor_total_transacao_liquido AS valor_total_transacao_liquido_agregacao,\n    ROUND(cod.valor_total_transacao_liquido, 2) != ROUND(sod.valor_total_transacao_liquido, 2) OR cod.quantidade_total_transacao != sod.quantidade_total_transacao AS indicador_agregacao_invalida\n  FROM\n    ordem_pagamento_consorcio_operador_dia cod\n  LEFT JOIN\n    ordem_pagamento_servico_operador_dia sod\n  USING(\n    data_ordem,\n    id_consorcio,\n    id_operadora,\n    id_ordem_pagamento\n  )\n)\nSELECT\n  *,\n  '' AS versao\nFROM\n  indicadores\nWHERE\n  indicador_agregacao_invalida = TRUE", "relation_name": "`rj-smtr`.`validacao_dados_jae_staging`.`ordem_pagamento_consorcio_operador_dia_invalida`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.803656Z", "completed_at": "2024-09-30T15:24:13.814409Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.815671Z", "completed_at": "2024-09-30T15:24:13.815680Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.014780521392822266, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.viagem_completa", "compiled": true, "compiled_code": "\n-- 1. Identifica viagens que est\u00e3o dentro do quadro planejado (por\n--    enquanto, consideramos o dia todo).\nwith viagem_periodo as (\n    select distinct\n        p.consorcio,\n        p.vista,\n        p.tipo_dia,\n        v.*,\n        p.inicio_periodo,\n        p.fim_periodo,\n        p.id_tipo_trajeto,\n        0 as tempo_planejado,\n    from (\n        select distinct\n            consorcio,\n            vista,\n            data,\n            tipo_dia,\n            trip_id_planejado as trip_id,\n            servico,\n            inicio_periodo,\n            fim_periodo,\n            id_tipo_trajeto\n        from\n            `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n        \n        WHERE\n            data = date_sub(date(\"2022-01-01T01:00:00\"), interval 1 day)\n        \n    ) p\n    inner join (\n        select distinct * from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n        \n        WHERE\n            data = date_sub(date(\"2022-01-01T01:00:00\"), interval 1 day)\n        \n    ) v\n    on\n        v.trip_id = p.trip_id\n        and v.data = p.data\n),\n-- 2. Seleciona viagens completas de acordo com a conformidade\nviagem_comp_conf as (\nselect distinct\n    consorcio,\n    data,\n    tipo_dia,\n    id_empresa,\n    id_veiculo,\n    id_viagem,\n    servico_informado,\n    servico_realizado,\n    vista,\n    trip_id,\n    shape_id,\n    sentido,\n    datetime_partida,\n    datetime_chegada,\n    inicio_periodo,\n    fim_periodo,\n    case\n        when servico_realizado = servico_informado\n        then \"Completa linha correta\"\n        else \"Completa linha incorreta\"\n        end as tipo_viagem,\n    tempo_viagem,\n    tempo_planejado,\n    distancia_planejada,\n    distancia_aferida,\n    n_registros_shape,\n    n_registros_total,\n    n_registros_minuto,\n    perc_conformidade_shape,\n    perc_conformidade_distancia,\n    perc_conformidade_registros,\n    0 as perc_conformidade_tempo,\n    -- round(100 * tempo_viagem/tempo_planejado, 2) as perc_conformidade_tempo,\n    id_tipo_trajeto,\n    '' as versao_modelo,\n    CURRENT_DATETIME(\"America/Sao_Paulo\") as datetime_ultima_atualizacao\nfrom\n    viagem_periodo v\nwhere (\n    perc_conformidade_shape >= 80\n)\nand (\n    perc_conformidade_distancia >= 0\n)\nand (\n    perc_conformidade_registros >= 50\n)\n\n),\n-- 3. Filtra viagens com mesma chegada e partida pelo maior % de conformidade do shape\nfiltro_desvio as (\n  SELECT\n    \n    * EXCEPT(rn)\n    \nFROM (\n  SELECT\n    *,\n    \n    ROW_NUMBER() OVER(PARTITION BY id_veiculo, datetime_partida, datetime_chegada ORDER BY perc_conformidade_shape DESC) AS rn\n    \n  FROM\n    viagem_comp_conf )\nWHERE\n  rn = 1\n),\n-- 4. Filtra viagens com partida ou chegada diferentes pela maior distancia percorrida\nfiltro_partida AS (\n  SELECT\n    * EXCEPT(rn)\n  FROM (\n    SELECT\n      *,\n      ROW_NUMBER() OVER(PARTITION BY id_veiculo, datetime_partida ORDER BY distancia_planejada DESC) AS rn\n    FROM\n      filtro_desvio )\n  WHERE\n    rn = 1 )\n-- filtro_chegada\nSELECT\n  * EXCEPT(rn)\nFROM (\n  SELECT\n    *,\n    ROW_NUMBER() OVER(PARTITION BY id_veiculo, datetime_chegada ORDER BY distancia_planejada DESC) AS rn\n  FROM\n    filtro_partida )\nWHERE\n  rn = 1", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.819419Z", "completed_at": "2024-09-30T15:24:13.826865Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.828432Z", "completed_at": "2024-09-30T15:24:13.828442Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011836528778076172, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_viagem_conformidade_sentido__I__V__C.37e4bf801f", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    group by sentido\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.833401Z", "completed_at": "2024-09-30T15:24:13.838095Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.839349Z", "completed_at": "2024-09-30T15:24:13.839357Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008654356002807617, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_viagem_conformidade_sentido_shape__I__V__C.1c6ae2b41d", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido_shape as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    group by sentido_shape\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.843252Z", "completed_at": "2024-09-30T15:24:13.849313Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.850570Z", "completed_at": "2024-09-30T15:24:13.850579Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009797334671020508, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_distancia_aferida.14ac42d258", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where distancia_aferida <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.854280Z", "completed_at": "2024-09-30T15:24:13.858908Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.860292Z", "completed_at": "2024-09-30T15:24:13.860300Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008379697799682617, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_distancia_planejada.399d334601", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where distancia_planejada <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.864438Z", "completed_at": "2024-09-30T15:24:13.869086Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.870353Z", "completed_at": "2024-09-30T15:24:13.870361Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00837564468383789, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_n_registros_end.2e79c19e44", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where n_registros_end <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.874210Z", "completed_at": "2024-09-30T15:24:13.879314Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.880967Z", "completed_at": "2024-09-30T15:24:13.880978Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009259939193725586, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_n_registros_middle.794c022bd1", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where n_registros_middle <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.884804Z", "completed_at": "2024-09-30T15:24:13.889444Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.890676Z", "completed_at": "2024-09-30T15:24:13.890684Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008216142654418945, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_n_registros_minuto.44dcb2a328", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where n_registros_minuto <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.894467Z", "completed_at": "2024-09-30T15:24:13.900391Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.901626Z", "completed_at": "2024-09-30T15:24:13.901635Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009527921676635742, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_n_registros_start.3b4d5df527", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where n_registros_start <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.905789Z", "completed_at": "2024-09-30T15:24:13.911759Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.913264Z", "completed_at": "2024-09-30T15:24:13.913277Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010394811630249023, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_n_registros_total.845a3f5e81", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where n_registros_total <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.917559Z", "completed_at": "2024-09-30T15:24:13.923277Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.924597Z", "completed_at": "2024-09-30T15:24:13.924606Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009814977645874023, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_perc_conformidade_distancia.947723cc56", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where perc_conformidade_distancia <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.928373Z", "completed_at": "2024-09-30T15:24:13.933495Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.934748Z", "completed_at": "2024-09-30T15:24:13.934757Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008733510971069336, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_perc_conformidade_registros.078f53372c", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where perc_conformidade_registros <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.938500Z", "completed_at": "2024-09-30T15:24:13.942934Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.944179Z", "completed_at": "2024-09-30T15:24:13.944187Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008015632629394531, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_perc_conformidade_shape.672bafc4f5", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where perc_conformidade_shape <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.948873Z", "completed_at": "2024-09-30T15:24:13.956511Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.957815Z", "completed_at": "2024-09-30T15:24:13.957824Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012040376663208008, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_conformidade_tempo_viagem.94e16edeba", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where tempo_viagem <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.961900Z", "completed_at": "2024-09-30T15:24:13.966862Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.968234Z", "completed_at": "2024-09-30T15:24:13.968243Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008633136749267578, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_negative_viagem_conformidade_n_registros_out.05ed52b76e", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where n_registros_out < 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.971962Z", "completed_at": "2024-09-30T15:24:13.977272Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.978505Z", "completed_at": "2024-09-30T15:24:13.978513Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009336471557617188, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_negative_viagem_conformidade_n_registros_shape.fa86a62956", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n    where n_registros_shape < 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.982758Z", "completed_at": "2024-09-30T15:24:13.987634Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:13.988933Z", "completed_at": "2024-09-30T15:24:13.988944Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009352445602416992, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_data.dba44f5b88", "compiled": true, "compiled_code": "\nSELECT\n    data\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    data is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:13.994367Z", "completed_at": "2024-09-30T15:24:13.999360Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.000588Z", "completed_at": "2024-09-30T15:24:14.000596Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008537769317626953, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_datetime_chegada.72c3aa8bba", "compiled": true, "compiled_code": "\nSELECT\n    datetime_chegada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    datetime_chegada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.004538Z", "completed_at": "2024-09-30T15:24:14.009107Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.010359Z", "completed_at": "2024-09-30T15:24:14.010368Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008358955383300781, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_datetime_partida.fd79047671", "compiled": true, "compiled_code": "\nSELECT\n    datetime_partida\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    datetime_partida is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.014585Z", "completed_at": "2024-09-30T15:24:14.020610Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.021830Z", "completed_at": "2024-09-30T15:24:14.021839Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009559392929077148, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_distancia_aferida.f7b56d4343", "compiled": true, "compiled_code": "\nSELECT\n    distancia_aferida\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    distancia_aferida is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.025480Z", "completed_at": "2024-09-30T15:24:14.030048Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.031617Z", "completed_at": "2024-09-30T15:24:14.031625Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00842595100402832, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_distancia_planejada.9a5bf3230e", "compiled": true, "compiled_code": "\nSELECT\n    distancia_planejada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    distancia_planejada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.035368Z", "completed_at": "2024-09-30T15:24:14.039812Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.041258Z", "completed_at": "2024-09-30T15:24:14.041266Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008523941040039062, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_id_veiculo.4dc76608fb", "compiled": true, "compiled_code": "\nSELECT\n    id_veiculo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    id_veiculo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.047210Z", "completed_at": "2024-09-30T15:24:14.052341Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.053576Z", "completed_at": "2024-09-30T15:24:14.053585Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009590387344360352, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_id_viagem.52f7dd7469", "compiled": true, "compiled_code": "\nSELECT\n    id_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    id_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.057290Z", "completed_at": "2024-09-30T15:24:14.061940Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.063498Z", "completed_at": "2024-09-30T15:24:14.063507Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008557319641113281, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_n_registros_end.accb64d6bd", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_end\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    n_registros_end is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.067336Z", "completed_at": "2024-09-30T15:24:14.073126Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.074930Z", "completed_at": "2024-09-30T15:24:14.074964Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012512922286987305, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_n_registros_middle.7965304122", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_middle\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    n_registros_middle is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.086695Z", "completed_at": "2024-09-30T15:24:14.095418Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.097600Z", "completed_at": "2024-09-30T15:24:14.097612Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.015619277954101562, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_n_registros_minuto.a1804e8458", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_minuto\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    n_registros_minuto is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.102677Z", "completed_at": "2024-09-30T15:24:14.107854Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.109248Z", "completed_at": "2024-09-30T15:24:14.109257Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009307861328125, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_n_registros_out.6dac645a68", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_out\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    n_registros_out is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.113158Z", "completed_at": "2024-09-30T15:24:14.119694Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.121787Z", "completed_at": "2024-09-30T15:24:14.121798Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011590957641601562, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_n_registros_shape.567191d3b2", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    n_registros_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.128769Z", "completed_at": "2024-09-30T15:24:14.136482Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.138058Z", "completed_at": "2024-09-30T15:24:14.138070Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013383865356445312, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_n_registros_start.53a2b2e530", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_start\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    n_registros_start is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.142571Z", "completed_at": "2024-09-30T15:24:14.148660Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.149894Z", "completed_at": "2024-09-30T15:24:14.149903Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009860515594482422, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_n_registros_total.8514b50af0", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_total\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    n_registros_total is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.153724Z", "completed_at": "2024-09-30T15:24:14.161279Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.163857Z", "completed_at": "2024-09-30T15:24:14.163877Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013377666473388672, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_perc_conformidade_distancia.e95ad3d84b", "compiled": true, "compiled_code": "\nSELECT\n    perc_conformidade_distancia\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    perc_conformidade_distancia is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.169105Z", "completed_at": "2024-09-30T15:24:14.174722Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.177789Z", "completed_at": "2024-09-30T15:24:14.177803Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012624025344848633, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_perc_conformidade_registros.5889951b7b", "compiled": true, "compiled_code": "\nSELECT\n    perc_conformidade_registros\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    perc_conformidade_registros is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.184471Z", "completed_at": "2024-09-30T15:24:14.189787Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.191038Z", "completed_at": "2024-09-30T15:24:14.191047Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009806156158447266, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_perc_conformidade_shape.c779adcc22", "compiled": true, "compiled_code": "\nSELECT\n    perc_conformidade_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    perc_conformidade_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.194755Z", "completed_at": "2024-09-30T15:24:14.199659Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.201048Z", "completed_at": "2024-09-30T15:24:14.201057Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00863194465637207, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_sentido.9ff9017055", "compiled": true, "compiled_code": "\nSELECT\n    sentido\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    sentido is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.204855Z", "completed_at": "2024-09-30T15:24:14.327382Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.329440Z", "completed_at": "2024-09-30T15:24:14.329453Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.1276392936706543, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_sentido_shape.e828f58e76", "compiled": true, "compiled_code": "\nSELECT\n    sentido_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    sentido_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.334707Z", "completed_at": "2024-09-30T15:24:14.339945Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.341248Z", "completed_at": "2024-09-30T15:24:14.341256Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009751081466674805, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_servico_informado.d130583ad1", "compiled": true, "compiled_code": "\nSELECT\n    servico_informado\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    servico_informado is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.345793Z", "completed_at": "2024-09-30T15:24:14.350402Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.351649Z", "completed_at": "2024-09-30T15:24:14.351658Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008311986923217773, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_servico_realizado.3bd70666f8", "compiled": true, "compiled_code": "\nSELECT\n    servico_realizado\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    servico_realizado is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.355356Z", "completed_at": "2024-09-30T15:24:14.359640Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.360853Z", "completed_at": "2024-09-30T15:24:14.360860Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007803678512573242, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_shape_id.2fd4863204", "compiled": true, "compiled_code": "\nSELECT\n    shape_id\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    shape_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.364608Z", "completed_at": "2024-09-30T15:24:14.369173Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.370411Z", "completed_at": "2024-09-30T15:24:14.370420Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008239507675170898, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_tempo_viagem.9d731143cc", "compiled": true, "compiled_code": "\nSELECT\n    tempo_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    tempo_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.374706Z", "completed_at": "2024-09-30T15:24:14.382365Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.384225Z", "completed_at": "2024-09-30T15:24:14.384238Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012584924697875977, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_conformidade_versao_modelo.ddf040eb5f", "compiled": true, "compiled_code": "\nSELECT\n    versao_modelo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`)\nAND\n    versao_modelo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.389312Z", "completed_at": "2024-09-30T15:24:14.394541Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.395919Z", "completed_at": "2024-09-30T15:24:14.395929Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009277820587158203, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_viagem_conformidade_id_viagem.5aa802e5bf", "compiled": true, "compiled_code": "\n    \n    \n\nwith dbt_test__target as (\n\n  select id_viagem as unique_field\n  from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_conformidade`\n  where id_viagem is not null\n\n)\n\nselect\n    unique_field,\n    count(*) as n_records\n\nfrom dbt_test__target\ngroup by unique_field\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.399658Z", "completed_at": "2024-09-30T15:24:14.403613Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.405147Z", "completed_at": "2024-09-30T15:24:14.405156Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007899999618530273, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.view_passageiros_hora", "compiled": true, "compiled_code": "-- depends_on: `rj-smtr`.`dashboard_bilhetagem_jae`.`view_passageiros_tile_hora`\nWITH servicos AS (\n  SELECT\n    * EXCEPT(rn)\n  FROM\n    (\n      SELECT\n        *,\n        ROW_NUMBER() OVER (PARTITION BY id_servico_jae ORDER BY data_inicio_vigencia) AS rn\n      FROM\n        `rj-smtr`.`cadastro`.`servicos`\n    )\n  WHERE\n    rn = 1\n)\nSELECT\n  p.data,\n  p.hora,\n  p.modo,\n  p.consorcio,\n  p.id_servico_jae,\n  s.servico,\n  s.descricao_servico,\n  CONCAT(s.servico, ' - ' ,s.descricao_servico) AS nome_completo_servico,\n  s.latitude AS latitude_servico,\n  s.longitude AS longitude_servico,\n  p.sentido,\n  CASE\n    WHEN p.tipo_transacao_smtr = \"Integral\" THEN \"Tarifa Integral\"\n    ELSE p.tipo_transacao_smtr\n  END AS tipo_transacao_smtr,\n  p.tipo_transacao_detalhe_smtr,\n  p.quantidade_passageiros\nFROM\n  `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`passageiros_hora` p\nLEFT JOIN\n  servicos s\nUSING(id_servico_jae)", "relation_name": "`rj-smtr`.`dashboard_bilhetagem_jae`.`view_passageiros_hora`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.409890Z", "completed_at": "2024-09-30T15:24:14.427762Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.431522Z", "completed_at": "2024-09-30T15:24:14.431536Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.025342941284179688, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_pagamento_consorcio_dia_invalida", "compiled": true, "compiled_code": "-- depends_on: `rj-smtr`.`validacao_dados_jae_staging`.`ordem_pagamento_consorcio_operador_dia_invalida`\n\n\nWITH ordem_pagamento_consorcio_operador_dia AS (\n  SELECT\n    data_ordem,\n    id_consorcio,\n    id_ordem_pagamento,\n    SUM(quantidade_total_transacao) AS quantidade_total_transacao,\n    SUM(valor_total_transacao_liquido_ordem) AS valor_total_transacao_liquido,\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_consorcio_operador_dia`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n  GROUP BY\n    1,\n    2,\n    3\n),\nordem_pagamento_consorcio_dia AS (\n  SELECT\n    data_ordem,\n    id_consorcio,\n    id_ordem_pagamento,\n    quantidade_total_transacao,\n    valor_total_transacao_liquido\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`ordem_pagamento_consorcio_dia`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n),\nindicadores AS (\n  SELECT\n    cd.data_ordem,\n    cd.id_consorcio,\n    cd.id_ordem_pagamento,\n    cd.quantidade_total_transacao,\n    cod.quantidade_total_transacao AS quantidade_total_transacao_agregacao,\n    cd.valor_total_transacao_liquido,\n    cod.valor_total_transacao_liquido AS valor_total_transacao_liquido_agregacao,\n    ROUND(cd.valor_total_transacao_liquido, 2) != ROUND(cod.valor_total_transacao_liquido, 2) OR cd.quantidade_total_transacao != cod.quantidade_total_transacao AS indicador_agregacao_invalida\n  FROM\n    ordem_pagamento_consorcio_dia cd\n  LEFT JOIN\n    ordem_pagamento_consorcio_operador_dia cod\n  USING(\n    data_ordem,\n    id_consorcio,\n    id_ordem_pagamento\n  )\n)\nSELECT\n  *,\n  '' AS versao\nFROM\n  indicadores\nWHERE\n  indicador_agregacao_invalida = TRUE", "relation_name": "`rj-smtr`.`validacao_dados_jae_staging`.`ordem_pagamento_consorcio_dia_invalida`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.438230Z", "completed_at": "2024-09-30T15:24:14.445752Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.447024Z", "completed_at": "2024-09-30T15:24:14.447033Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01230764389038086, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.frota_operante", "compiled": true, "compiled_code": "\n\nSELECT\n  MIN(data) AS data,\n  EXTRACT(YEAR FROM data) AS ano,\n  EXTRACT(MONTH FROM data) AS mes,\n  \"\u00d4nibus\" AS modo,\n  COUNT(DISTINCT id_veiculo) AS quantidade_veiculo_mes,\n  CURRENT_DATE(\"America/Sao_Paulo\") AS data_ultima_atualizacao,\n  '' as versao\nFROM\n  `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n  --rj-smtr.projeto_subsidio_sppo.viagem_completa\nWHERE\n\n  data BETWEEN DATE_TRUNC(DATE(\"2022-01-01T01:00:00\"), MONTH)\n  AND LAST_DAY(DATE(\"2022-01-01T01:00:00\"), MONTH)\n  AND data < DATE_TRUNC(CURRENT_DATE(\"America/Sao_Paulo\"), MONTH)\n\nGROUP BY\n  2,\n  3", "relation_name": "`rj-smtr`.`indicadores_continuados_egp_staging`.`frota_operante`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.450782Z", "completed_at": "2024-09-30T15:24:14.466777Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.469051Z", "completed_at": "2024-09-30T15:24:14.469067Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.021351099014282227, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.idade_media_frota_operante_onibus", "compiled": true, "compiled_code": "\n\nWITH\n  -- 1. Seleciona a \u00faltima data dispon\u00edvel de cada m\u00eas\n  datas AS (\n  SELECT\n    EXTRACT(MONTH FROM data) AS mes,\n    EXTRACT(YEAR FROM data) AS ano,\n    MAX(data) AS data\n  FROM\n    `rj-smtr`.`veiculo`.`sppo_licenciamento`\n    --rj-smtr.veiculo.sppo_licenciamento\n  WHERE\n  \n    data BETWEEN DATE_TRUNC(DATE(\"2022-01-01T01:00:00\"), MONTH)\n    AND LAST_DAY(DATE(\"2022-01-01T01:00:00\"), MONTH)\n    AND data < DATE_TRUNC(CURRENT_DATE(\"America/Sao_Paulo\"), MONTH)\n  \n  GROUP BY\n    1,\n    2),\n  -- 2. Verifica frota operante\n  frota_operante AS (\n  SELECT\n    DISTINCT id_veiculo,\n    EXTRACT(MONTH FROM data) AS mes,\n    EXTRACT(YEAR FROM data) AS ano,\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    --rj-smtr.projeto_subsidio_sppo.viagem_completa\n  WHERE\n  \n    data BETWEEN DATE_TRUNC(DATE(\"2022-01-01T01:00:00\"), MONTH)\n    AND LAST_DAY(DATE(\"2022-01-01T01:00:00\"), MONTH)\n    AND data < DATE_TRUNC(CURRENT_DATE(\"America/Sao_Paulo\"), MONTH)\n  \n  ),\n  -- 3. Calcula a idade de todos os ve\u00edculos para a data de refer\u00eancia\n  idade_frota AS (\n  SELECT\n    data,\n    EXTRACT(YEAR FROM data) - CAST(ano_fabricacao AS INT64) AS idade\n  FROM\n    datas AS d\n  LEFT JOIN\n    `rj-smtr`.`veiculo`.`sppo_licenciamento`\n    --rj-smtr.veiculo.sppo_licenciamento AS l\n  USING\n    (data)\n  LEFT JOIN\n    frota_operante AS f\n  USING\n    (id_veiculo, mes, ano)\n  WHERE\n    f.id_veiculo IS NOT NULL\n  )\n-- 4. Calcula a idade m\u00e9dia\nSELECT\n  data,\n  EXTRACT(YEAR FROM data) AS ano,\n  EXTRACT(MONTH FROM data) AS mes,\n  \"\u00d4nibus\" AS modo,\n  ROUND(AVG(idade),2) AS idade_media_veiculo_mes,\n  CURRENT_DATE(\"America/Sao_Paulo\") AS data_ultima_atualizacao,\n  '' as versao\nFROM\n  idade_frota\nGROUP BY\n  1,\n  2,\n  3", "relation_name": "`rj-smtr`.`indicadores_continuados_egp_staging`.`idade_media_frota_operante_onibus`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.475282Z", "completed_at": "2024-09-30T15:24:14.481153Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.482574Z", "completed_at": "2024-09-30T15:24:14.482585Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010671377182006836, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sumario_dia", "compiled": true, "compiled_code": "WITH\n  planejado AS (\n  SELECT\n    consorcio,\n    data,\n    tipo_dia,\n    trip_id_planejado AS trip_id,\n    servico,\n    sentido,\n    CASE\n      WHEN sentido = \"C\" THEN MAX(distancia_planejada)\n    ELSE\n      SUM(distancia_planejada)\n    END\n    AS distancia_planejada,\n    CASE\n      WHEN sentido = \"C\" THEN MAX(distancia_total_planejada)\n    ELSE\n      SUM(distancia_total_planejada)\n    END AS distancia_total_planejada,\n    NULL AS viagens_planejadas\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n    -- `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n  WHERE\n    data >= \"2022-06-01\"\n    AND data < DATE( \"2023-01-16\" )\n    AND distancia_total_planejada > 0\n  GROUP BY\n    1,\n    2,\n    3,\n    4,\n    5,\n    6),\n  viagem AS (\n  SELECT\n    data,\n    trip_id,\n    COUNT(id_viagem) AS viagens_realizadas\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    -- `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n  WHERE\n    data >= \"2022-06-01\"\n    AND data < DATE( \"2023-01-16\" )\n  GROUP BY\n    1,\n    2),\n  sumario AS (\n  SELECT\n    consorcio,\n    data,\n    tipo_dia,\n    servico,\n    distancia_planejada,\n    NULL AS viagens_planejadas,\n    IFNULL(SUM(v.viagens_realizadas), 0) AS viagens_subsidio,\n    distancia_total_planejada,\n    (IFNULL(SUM(v.viagens_realizadas), 0) * distancia_planejada) AS distancia_total_subsidio\n  FROM\n    planejado AS p\n  LEFT JOIN\n    viagem AS v\n  USING\n    (trip_id,\n      data)\n  GROUP BY\n    1,\n    2,\n    3,\n    4,\n    5,\n    8 ),\n  sumario_agg AS (\n  SELECT\n    consorcio,\n    data,\n    tipo_dia,\n    servico,\n    NULL AS viagens_planejadas,\n    IFNULL(SUM(viagens_subsidio), 0) AS viagens_subsidio,\n    distancia_total_planejada,\n    ROUND(SUM(distancia_total_subsidio), 3) AS distancia_total_subsidio\n  FROM\n    sumario\n  GROUP BY\n    1,\n    2,\n    3,\n    4,\n    5,\n    7 ),\n  valor AS (\n  SELECT\n    s.*,\n    v.valor_subsidio_por_km,\n    ROUND(distancia_total_subsidio * v.valor_subsidio_por_km, 2) AS valor_total_aferido,\n  IF\n    (distancia_total_planejada = 0, NULL, ROUND(100*distancia_total_subsidio/distancia_total_planejada, 2)) AS perc_distancia_total_subsidio\n  FROM\n    sumario_agg s\n  LEFT JOIN (\n    SELECT\n      *\n    FROM\n      `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_data_versao_efetiva`\n      -- `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_data_versao_efetiva`\n    WHERE\n      data >= \"2022-06-01\"\n      AND data < DATE( \"2023-01-16\" )) AS v\n  ON\n    v.data = s.data )\nSELECT\n  *,\n  CASE\n    WHEN (perc_distancia_total_subsidio < 80) OR (perc_distancia_total_subsidio IS NULL) THEN 0\n  ELSE\n  valor_total_aferido\nEND\n  AS valor_total_subsidio\nFROM\n  valor", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo`.`sumario_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.486695Z", "completed_at": "2024-09-30T15:24:14.495700Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.497123Z", "completed_at": "2024-09-30T15:24:14.497134Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0129241943359375, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.viagem_transacao", "compiled": true, "compiled_code": "\n\nWITH\n  -- 1. Transa\u00e7\u00f5es Ja\u00e9\n  transacao AS (\n    SELECT\n      id_veiculo,\n      datetime_transacao\n    FROM\n      `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao`\n      -- rj-smtr.br_rj_riodejaneiro_bilhetagem.transacao\n    WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE_ADD(DATE(\"2022-01-01T01:00:00\"), INTERVAL 1 DAY)\n  ),\n  -- 2. Transa\u00e7\u00f5es RioCard\n  transacao_riocard AS (\n    SELECT\n      id_veiculo,\n      datetime_transacao\n    FROM\n      `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`transacao_riocard`\n      -- rj-smtr.br_rj_riodejaneiro_bilhetagem.transacao_riocard\n    WHERE\n      data BETWEEN DATE(\"2022-01-01T01:00:00\")\n      AND DATE_ADD(DATE(\"2022-01-01T01:00:00\"), INTERVAL 1 DAY)\n  ),\n  -- 3. GPS Validador\n  gps_validador AS (\n    SELECT\n      data,\n      datetime_gps,\n      id_veiculo,\n      id_validador,\n      estado_equipamento,\n      latitude,\n      longitude\n    FROM\n      `rj-smtr`.`br_rj_riodejaneiro_bilhetagem`.`gps_validador`\n      -- rj-smtr.br_rj_riodejaneiro_bilhetagem.gps_validador\n    WHERE\n      data BETWEEN DATE(\"2022-01-01T01:00:00\")\n      AND DATE_ADD(DATE(\"2022-01-01T01:00:00\"), INTERVAL 1 DAY)\n      AND (latitude != 0 OR longitude != 0)\n  ),\n  -- 4. Viagens realizadas\n  viagem AS (\n  SELECT\n    data,\n    servico_realizado AS servico,\n    datetime_partida,\n    datetime_chegada,\n    id_veiculo,\n    id_viagem,\n    distancia_planejada\n FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    -- rj-smtr.projeto_subsidio_sppo.viagem_completa\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE( \"2022-01-01T01:00:00\" ) ),\n  -- 5. Status dos ve\u00edculos\n  veiculos AS (\n  SELECT\n    data,\n    id_veiculo,\n    status\n  FROM\n    `rj-smtr`.`veiculo`.`sppo_veiculo_dia`\n    -- rj-smtr.veiculo.sppo_veiculo_dia\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\") ),\n  -- 6. Viagem, para fins de contagem de passageiros, com toler\u00e2ncia de 30 minutos, limitada pela viagem anterior\n  viagem_com_tolerancia AS (\n    SELECT\n      v.*,\n      LAG(v.datetime_chegada) OVER (PARTITION BY v.id_veiculo ORDER BY v.datetime_partida) AS viagem_anterior_chegada,\n      CASE\n        WHEN LAG(v.datetime_chegada) OVER (PARTITION BY v.id_veiculo ORDER BY v.datetime_partida) IS NULL THEN\n          DATETIME(TIMESTAMP_SUB(datetime_partida, INTERVAL 30 MINUTE))\n        ELSE\n          DATETIME(TIMESTAMP_ADD(GREATEST(\n            TIMESTAMP_SUB(datetime_partida, INTERVAL 30 MINUTE),\n            LAG(v.datetime_chegada) OVER (PARTITION BY v.id_veiculo ORDER BY v.datetime_partida)\n          ), INTERVAL 1 SECOND))\n      END AS datetime_partida_com_tolerancia\n    FROM\n      viagem AS v\n  ),\n  -- 7. Contagem de transa\u00e7\u00f5es Ja\u00e9\n  transacao_contagem AS (\n    SELECT\n      v.data,\n      v.id_viagem,\n      COUNT(t.datetime_transacao) AS quantidade_transacao\n    FROM\n      transacao AS t\n    JOIN\n      viagem_com_tolerancia AS v\n    ON\n      t.id_veiculo = SUBSTR(v.id_veiculo, 2)\n      AND t.datetime_transacao BETWEEN v.datetime_partida_com_tolerancia AND v.datetime_chegada\n    GROUP BY\n      v.data, v.id_viagem\n  ),\n  -- 5. Contagem de transa\u00e7\u00f5es RioCard\n  transacao_riocard_contagem AS (\n    SELECT\n      v.data,\n      v.id_viagem,\n      COUNT(tr.datetime_transacao) AS quantidade_transacao_riocard\n    FROM\n      transacao_riocard AS tr\n    JOIN\n      viagem_com_tolerancia AS v\n    ON\n      tr.id_veiculo = SUBSTR(v.id_veiculo, 2)\n      AND tr.datetime_transacao BETWEEN v.datetime_partida_com_tolerancia AND v.datetime_chegada\n    GROUP BY\n      v.data, v.id_viagem\n  ),\n  -- 6. Ajusta estado do equipamento\n  -- Agrupa mesma posi\u00e7\u00e3o para mesmo validador e ve\u00edculo, mantendo preferencialmente o estado do equipamento \"ABERTO\"\n  estado_equipamento_aux AS (\n    SELECT\n      data,\n      id_validador,\n      id_veiculo,\n      latitude,\n      longitude,\n      IF(COUNT(CASE WHEN estado_equipamento = \"ABERTO\" THEN 1 END) >= 1, \"ABERTO\", \"FECHADO\") AS estado_equipamento,\n      MIN(datetime_gps) AS datetime_gps,\n    FROM\n      gps_validador\n    GROUP BY\n      1,\n      2,\n      3,\n      4,\n      5\n  ),\n  -- 7. Relacionamento entre estado do equipamento e viagem\n  gps_validador_viagem AS (\n    SELECT\n      v.data,\n      e.datetime_gps,\n      v.id_viagem,\n      e.id_validador,\n      e.estado_equipamento,\n      e.latitude,\n      e.longitude\n    FROM\n      estado_equipamento_aux AS e\n    JOIN\n      viagem AS v\n    ON\n      e.id_veiculo = SUBSTR(v.id_veiculo, 2)\n      AND e.datetime_gps BETWEEN v.datetime_partida AND v.datetime_chegada\n  ),\n  -- 8. Calcula a porcentagem de estado do equipamento \"ABERTO\" por validador e viagem\n  estado_equipamento_perc AS (\n    SELECT\n      data,\n      id_viagem,\n      id_validador,\n      COUNTIF(estado_equipamento = \"ABERTO\") / COUNT(*) AS percentual_estado_equipamento_aberto\n    FROM\n      gps_validador_viagem\n    GROUP BY\n      1,\n      2,\n      3\n  ),\n  -- 9. Considera o validador com maior porcentagem de estado do equipamento \"ABERTO\" por viagem\n  estado_equipamento_max_perc AS (\n    SELECT\n      data,\n      id_viagem,\n      MAX_BY(id_validador, percentual_estado_equipamento_aberto) AS id_validador,\n      MAX(percentual_estado_equipamento_aberto) AS percentual_estado_equipamento_aberto\n    FROM\n      estado_equipamento_perc\n    GROUP BY\n      1,\n      2\n  ),\n  -- 10. Verifica se a viagem possui estado do equipamento \"ABERTO\" em pelo menos 80% dos registros\n  estado_equipamento_verificacao AS (\n    SELECT\n      data,\n      id_viagem,\n      id_validador,\n      percentual_estado_equipamento_aberto,\n      IF(percentual_estado_equipamento_aberto >= 0.8 OR percentual_estado_equipamento_aberto IS NULL, TRUE, FALSE) AS indicador_estado_equipamento_aberto\n    FROM\n      viagem\n    LEFT JOIN\n      estado_equipamento_max_perc\n    USING\n      (data, id_viagem)\n  )\nSELECT\n  v.data,\n  v.id_viagem,\n  v.id_veiculo,\n  v.servico,\n  eev.id_validador,\n  CASE\n    WHEN v.data >= DATE(\"2024-07-19\")\n      AND (COALESCE(tr.quantidade_transacao_riocard, 0) = 0\n        OR COALESCE(eev.indicador_estado_equipamento_aberto, FALSE) = FALSE)\n      AND ve.status IN (\"Licenciado com ar e n\u00e3o autuado\", \"Licenciado sem ar e n\u00e3o autuado\")\n      THEN \"Sem transa\u00e7\u00e3o\"\n    ELSE ve.status\n  END AS tipo_viagem,\n  v.distancia_planejada,\n  COALESCE(t.quantidade_transacao, 0) AS quantidade_transacao,\n  COALESCE(tr.quantidade_transacao_riocard, 0) AS quantidade_transacao_riocard,\n  eev.percentual_estado_equipamento_aberto,\n  eev.indicador_estado_equipamento_aberto,\n  v.datetime_partida_com_tolerancia AS datetime_partida_bilhetagem,\n  v.datetime_partida,\n  v.datetime_chegada,\n  CURRENT_DATETIME(\"America/Sao_Paulo\") AS datetime_ultima_atualizacao\nFROM\n  viagem_com_tolerancia AS v\nLEFT JOIN\n  veiculos AS ve\nUSING\n  (data, id_veiculo)\nLEFT JOIN\n  transacao_contagem AS t\nUSING\n  (data, id_viagem)\nLEFT JOIN\n  transacao_riocard_contagem AS tr\nUSING\n  (data, id_viagem)\nLEFT JOIN\n  estado_equipamento_verificacao AS eev\nUSING\n  (data, id_viagem)", "relation_name": "`rj-smtr`.`subsidio`.`viagem_transacao`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.501104Z", "completed_at": "2024-09-30T15:24:14.504822Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.506050Z", "completed_at": "2024-09-30T15:24:14.506057Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0073146820068359375, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.viagens_realizadas", "compiled": true, "compiled_code": "SELECT\n  *\nFROM\n  `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n  data BETWEEN \"2022-06-01\" AND DATE(\"2022-01-01T01:00:00\")", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo`.`viagens_realizadas`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.509981Z", "completed_at": "2024-09-30T15:24:14.514843Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.516105Z", "completed_at": "2024-09-30T15:24:14.516114Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008483171463012695, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_viagem_completa_sentido__I__V__C.14734d12d7", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        sentido as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    group by sentido\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'I','V','C'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.519950Z", "completed_at": "2024-09-30T15:24:14.528539Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.531412Z", "completed_at": "2024-09-30T15:24:14.531426Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.014357566833496094, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_viagem_completa_tipo_dia__Dia_til__Sabado__Domingo.be741d00ee", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        tipo_dia as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    group by tipo_dia\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'Dia \u00datil','Sabado','Domingo'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.536369Z", "completed_at": "2024-09-30T15:24:14.545246Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.547043Z", "completed_at": "2024-09-30T15:24:14.547057Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013668537139892578, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.accepted_values_viagem_completa_tipo_viagem__Completa_linha_correta__Completa_linha_incorreta.d7777aca98", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        tipo_viagem as value_field,\n        count(*) as n_records\n\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    group by tipo_viagem\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'Completa linha correta','Completa linha incorreta'\n)\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.551299Z", "completed_at": "2024-09-30T15:24:14.555861Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.557311Z", "completed_at": "2024-09-30T15:24:14.557321Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008634090423583984, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_completa_distancia_aferida.f5d805262a", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    where distancia_aferida <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.561822Z", "completed_at": "2024-09-30T15:24:14.566415Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.567674Z", "completed_at": "2024-09-30T15:24:14.567683Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00824427604675293, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_completa_distancia_planejada.a4e65fb078", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    where distancia_planejada <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.571389Z", "completed_at": "2024-09-30T15:24:14.575932Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.577956Z", "completed_at": "2024-09-30T15:24:14.577966Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009114742279052734, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_completa_n_registros_minuto.1fa0ffac2f", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    where n_registros_minuto <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.582135Z", "completed_at": "2024-09-30T15:24:14.587920Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.589164Z", "completed_at": "2024-09-30T15:24:14.589174Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009393692016601562, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_completa_n_registros_shape.8fb346344d", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    where n_registros_shape <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.592902Z", "completed_at": "2024-09-30T15:24:14.597461Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.598697Z", "completed_at": "2024-09-30T15:24:14.598705Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008289098739624023, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_completa_n_registros_total.25967100b1", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    where n_registros_total <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.602625Z", "completed_at": "2024-09-30T15:24:14.607092Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.608396Z", "completed_at": "2024-09-30T15:24:14.608403Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008118867874145508, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_completa_perc_conformidade_distancia.7087a86b2d", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    where perc_conformidade_distancia <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.612302Z", "completed_at": "2024-09-30T15:24:14.616776Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.618493Z", "completed_at": "2024-09-30T15:24:14.618508Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010498046875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_completa_perc_conformidade_registros.8cc9a28202", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    where perc_conformidade_registros <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.624346Z", "completed_at": "2024-09-30T15:24:14.629162Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.630441Z", "completed_at": "2024-09-30T15:24:14.630451Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008546829223632812, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_completa_perc_conformidade_shape.1ad412b569", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    where perc_conformidade_shape <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.634192Z", "completed_at": "2024-09-30T15:24:14.638699Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.639960Z", "completed_at": "2024-09-30T15:24:14.639967Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008077621459960938, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.greater_than_zero_viagem_completa_tempo_viagem.6c4c35eea7", "compiled": true, "compiled_code": "\n\n    select *\n    from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    where tempo_viagem <= 0\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.643912Z", "completed_at": "2024-09-30T15:24:14.649729Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.651016Z", "completed_at": "2024-09-30T15:24:14.651025Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009575843811035156, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_consorcio.ef41dcab9b", "compiled": true, "compiled_code": "\nSELECT\n    consorcio\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    consorcio is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.654694Z", "completed_at": "2024-09-30T15:24:14.659955Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.664046Z", "completed_at": "2024-09-30T15:24:14.664065Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012852668762207031, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_data.60008eec9c", "compiled": true, "compiled_code": "\nSELECT\n    data\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    data is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.671474Z", "completed_at": "2024-09-30T15:24:14.677976Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.679663Z", "completed_at": "2024-09-30T15:24:14.679674Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011901140213012695, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_datetime_chegada.fac30fe07a", "compiled": true, "compiled_code": "\nSELECT\n    datetime_chegada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    datetime_chegada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.684469Z", "completed_at": "2024-09-30T15:24:14.689331Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.690641Z", "completed_at": "2024-09-30T15:24:14.690649Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009053707122802734, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_datetime_partida.a62e5f9eac", "compiled": true, "compiled_code": "\nSELECT\n    datetime_partida\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    datetime_partida is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.694333Z", "completed_at": "2024-09-30T15:24:14.698762Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.700189Z", "completed_at": "2024-09-30T15:24:14.700199Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008238792419433594, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_distancia_aferida.0edb9adb33", "compiled": true, "compiled_code": "\nSELECT\n    distancia_aferida\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    distancia_aferida is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.703992Z", "completed_at": "2024-09-30T15:24:14.709677Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.710917Z", "completed_at": "2024-09-30T15:24:14.710924Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009257316589355469, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_distancia_planejada.bbd49d7634", "compiled": true, "compiled_code": "\nSELECT\n    distancia_planejada\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    distancia_planejada is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.714739Z", "completed_at": "2024-09-30T15:24:14.719370Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.724527Z", "completed_at": "2024-09-30T15:24:14.724536Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012195825576782227, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_id_veiculo.4b31ddd12f", "compiled": true, "compiled_code": "\nSELECT\n    id_veiculo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    id_veiculo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.728507Z", "completed_at": "2024-09-30T15:24:14.733230Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.734471Z", "completed_at": "2024-09-30T15:24:14.734479Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008518457412719727, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_id_viagem.c4481cf0da", "compiled": true, "compiled_code": "\nSELECT\n    id_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    id_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.738157Z", "completed_at": "2024-09-30T15:24:14.745395Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.746669Z", "completed_at": "2024-09-30T15:24:14.746680Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010909795761108398, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_n_registros_minuto.4c23c345c5", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_minuto\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    n_registros_minuto is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.750481Z", "completed_at": "2024-09-30T15:24:14.754975Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.756234Z", "completed_at": "2024-09-30T15:24:14.756243Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008088111877441406, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_n_registros_shape.9d239e7953", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    n_registros_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.760082Z", "completed_at": "2024-09-30T15:24:14.765769Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.767012Z", "completed_at": "2024-09-30T15:24:14.767021Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00931239128112793, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_n_registros_total.4a103f1249", "compiled": true, "compiled_code": "\nSELECT\n    n_registros_total\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    n_registros_total is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.770881Z", "completed_at": "2024-09-30T15:24:14.775500Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.776739Z", "completed_at": "2024-09-30T15:24:14.776747Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008314371109008789, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_perc_conformidade_distancia.837283bcfc", "compiled": true, "compiled_code": "\nSELECT\n    perc_conformidade_distancia\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    perc_conformidade_distancia is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.782242Z", "completed_at": "2024-09-30T15:24:14.788710Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.790191Z", "completed_at": "2024-09-30T15:24:14.790202Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012207746505737305, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_perc_conformidade_registros.0d86da0376", "compiled": true, "compiled_code": "\nSELECT\n    perc_conformidade_registros\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    perc_conformidade_registros is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.794283Z", "completed_at": "2024-09-30T15:24:14.798908Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.800154Z", "completed_at": "2024-09-30T15:24:14.800163Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008290767669677734, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_perc_conformidade_shape.25bb80e526", "compiled": true, "compiled_code": "\nSELECT\n    perc_conformidade_shape\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    perc_conformidade_shape is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.803866Z", "completed_at": "2024-09-30T15:24:14.808278Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.809495Z", "completed_at": "2024-09-30T15:24:14.809502Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007935047149658203, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_sentido.a8ba9e34e6", "compiled": true, "compiled_code": "\nSELECT\n    sentido\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    sentido is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.813368Z", "completed_at": "2024-09-30T15:24:14.819013Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.820346Z", "completed_at": "2024-09-30T15:24:14.820358Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009649991989135742, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_servico_informado.3aa58feb5f", "compiled": true, "compiled_code": "\nSELECT\n    servico_informado\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    servico_informado is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.825800Z", "completed_at": "2024-09-30T15:24:14.830437Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.831706Z", "completed_at": "2024-09-30T15:24:14.831716Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008597612380981445, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_servico_realizado.7433281d87", "compiled": true, "compiled_code": "\nSELECT\n    servico_realizado\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    servico_realizado is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.835516Z", "completed_at": "2024-09-30T15:24:14.840398Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.841648Z", "completed_at": "2024-09-30T15:24:14.841657Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008492469787597656, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_shape_id.cfa5f99155", "compiled": true, "compiled_code": "\nSELECT\n    shape_id\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    shape_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.845464Z", "completed_at": "2024-09-30T15:24:14.849967Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.851204Z", "completed_at": "2024-09-30T15:24:14.851213Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008135318756103516, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_tempo_viagem.2d2a673c5b", "compiled": true, "compiled_code": "\nSELECT\n    tempo_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    tempo_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.854890Z", "completed_at": "2024-09-30T15:24:14.859555Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.860786Z", "completed_at": "2024-09-30T15:24:14.860793Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008192777633666992, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_tipo_dia.1718470616", "compiled": true, "compiled_code": "\nSELECT\n    tipo_dia\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    tipo_dia is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.864977Z", "completed_at": "2024-09-30T15:24:14.870696Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.872499Z", "completed_at": "2024-09-30T15:24:14.872508Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009963750839233398, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_tipo_viagem.6bda4a1de6", "compiled": true, "compiled_code": "\nSELECT\n    tipo_viagem\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    tipo_viagem is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.876344Z", "completed_at": "2024-09-30T15:24:14.881207Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.882459Z", "completed_at": "2024-09-30T15:24:14.882469Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00857686996459961, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_trip_id.b9d8d1d6fd", "compiled": true, "compiled_code": "\nSELECT\n    trip_id\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    trip_id is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.886156Z", "completed_at": "2024-09-30T15:24:14.890679Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.891910Z", "completed_at": "2024-09-30T15:24:14.891918Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008049726486206055, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_versao_modelo.08474ee6c1", "compiled": true, "compiled_code": "\nSELECT\n    versao_modelo\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    versao_modelo is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.895562Z", "completed_at": "2024-09-30T15:24:14.903747Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.907331Z", "completed_at": "2024-09-30T15:24:14.907351Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.015486955642700195, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.not_null_viagem_completa_vista.ace89b5843", "compiled": true, "compiled_code": "\nSELECT\n    vista\nFROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\nWHERE\n     = (SELECT MAX() FROM `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`)\nAND\n    vista is null\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.915590Z", "completed_at": "2024-09-30T15:24:14.922610Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.924339Z", "completed_at": "2024-09-30T15:24:14.924350Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012919902801513672, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.rj_smtr.unique_viagem_completa_id_viagem.e7a957c7b9", "compiled": true, "compiled_code": "\n    \n    \n\nwith dbt_test__target as (\n\n  select id_viagem as unique_field\n  from `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n  where id_viagem is not null\n\n)\n\nselect\n    unique_field,\n    count(*) as n_records\n\nfrom dbt_test__target\ngroup by unique_field\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.929117Z", "completed_at": "2024-09-30T15:24:14.939465Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.941823Z", "completed_at": "2024-09-30T15:24:14.941837Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.015937328338623047, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.ordem_pagamento_invalida", "compiled": true, "compiled_code": "\n\nWITH servico_operador_dia_invalida AS (\n  SELECT\n    data_ordem,\n    id_ordem_pagamento,\n    MAX(indicador_captura_invalida) AS indicador_captura_invalida,\n    MAX(indicador_servico_fora_vigencia) AS indicador_servico_fora_vigencia\n  FROM\n    `rj-smtr`.`validacao_dados_jae_staging`.`ordem_pagamento_servico_operador_dia_invalida`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n  GROUP BY\n    1,\n    2\n),\nconsorcio_operador_dia_invalida AS (\n  SELECT DISTINCT\n    data_ordem,\n    id_ordem_pagamento\n  FROM\n    `rj-smtr`.`validacao_dados_jae_staging`.`ordem_pagamento_consorcio_operador_dia_invalida`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n),\nconsorcio_dia_invalida AS (\n  SELECT DISTINCT\n    data_ordem,\n    id_ordem_pagamento\n  FROM\n    `rj-smtr`.`validacao_dados_jae_staging`.`ordem_pagamento_consorcio_dia_invalida`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n),\ndia_invalida AS (\n  SELECT\n    data_ordem,\n    id_ordem_pagamento\n  FROM\n    `rj-smtr`.`validacao_dados_jae_staging`.`ordem_pagamento_dia_invalida`\n  \n    WHERE\n      data_ordem = DATE(\"2022-01-01T01:00:00\")\n  \n),\nindicadores AS (\n  SELECT\n    data_ordem,\n    id_ordem_pagamento,\n    CASE\n      WHEN sod.id_ordem_pagamento IS NOT NULL THEN sod.indicador_captura_invalida\n      ELSE FALSE\n    END AS indicador_captura_invalida,\n    CASE\n      WHEN sod.id_ordem_pagamento IS NOT NULL THEN sod.indicador_servico_fora_vigencia\n      ELSE FALSE\n    END AS indicador_servico_fora_vigencia,\n    cod.id_ordem_pagamento IS NOT NULL AS indicador_agregacao_consorcio_operador_dia_invalida,\n    cd.id_ordem_pagamento IS NOT NULL AS indicador_agregacao_consorcio_dia_invalida,\n    d.id_ordem_pagamento IS NOT NULL AS indicador_agregacao_dia_invalida,\n  FROM\n    dia_invalida d\n  FULL OUTER JOIN\n    servico_operador_dia_invalida sod\n  USING(data_ordem, id_ordem_pagamento)\n  FULL OUTER JOIN\n    consorcio_operador_dia_invalida cod\n  USING(data_ordem, id_ordem_pagamento)\n  FULL OUTER JOIN\n    consorcio_dia_invalida cd\n  USING(data_ordem, id_ordem_pagamento)\n)\nSELECT\n  *,\n  '' AS versao\nFROM\n  indicadores\nWHERE\n  indicador_captura_invalida\n  OR indicador_servico_fora_vigencia\n  OR indicador_agregacao_consorcio_operador_dia_invalida\n  OR indicador_agregacao_consorcio_dia_invalida\n  OR indicador_agregacao_dia_invalida", "relation_name": "`rj-smtr`.`validacao_dados_jae`.`ordem_pagamento_invalida`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.947517Z", "completed_at": "2024-09-30T15:24:14.954516Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.955918Z", "completed_at": "2024-09-30T15:24:14.955927Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011303901672363281, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.indicadores_mes", "compiled": true, "compiled_code": "\n\n\nSELECT\n    ano,\n    mes,\n    modo AS modo,\n    \"Passageiros pagantes por m\u00eas\" AS nome_indicador,\n    quantidade_passageiro_pagante_mes AS valor,\n    data_ultima_atualizacao\nFROM `rj-smtr`.`indicadores_continuados_egp_staging`.`passageiro_pagante`\nUNION ALL\n\nSELECT\n    ano,\n    mes,\n    modo AS modo,\n    \"Gratuidades por m\u00eas\" AS nome_indicador,\n    quantidade_passageiro_gratuidade_mes AS valor,\n    data_ultima_atualizacao\nFROM `rj-smtr`.`indicadores_continuados_egp_staging`.`passageiro_gratuidade`\nUNION ALL\n\nSELECT\n    ano,\n    mes,\n    modo AS modo,\n    \"Frota operante por m\u00eas\" AS nome_indicador,\n    quantidade_veiculo_mes AS valor,\n    data_ultima_atualizacao\nFROM `rj-smtr`.`indicadores_continuados_egp_staging`.`frota_operante`\nUNION ALL\n\nSELECT\n    ano,\n    mes,\n    modo AS modo,\n    \"Idade m\u00e9dia da frota operante por m\u00eas\" AS nome_indicador,\n    idade_media_veiculo_mes AS valor,\n    data_ultima_atualizacao\nFROM `rj-smtr`.`indicadores_continuados_egp_staging`.`idade_media_frota_operante_onibus`\n\n", "relation_name": "`rj-smtr`.`indicadores_continuados_egp`.`indicadores_mes`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.959738Z", "completed_at": "2024-09-30T15:24:14.965210Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:14.966470Z", "completed_at": "2024-09-30T15:24:14.966477Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009133100509643555, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.subsidio_faixa_servico_dia", "compiled": true, "compiled_code": "\n\nWITH\n-- 1. Viagens planejadas\n  planejado AS (\n  SELECT\n    DISTINCT data,\n    tipo_dia,\n    consorcio,\n    servico,\n    faixa_horaria_inicio,\n    faixa_horaria_fim,\n    distancia_total_planejada AS km_planejada\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n    -- rj-smtr.projeto_subsidio_sppo.viagem_planejada\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n    AND distancia_total_planejada > 0\n  ),\n-- 2. Viagens realizadas\n  viagem AS (\n  SELECT\n    data,\n    servico,\n    id_viagem,\n    tipo_viagem,\n    datetime_partida,\n    distancia_planejada\n FROM\n    `rj-smtr`.`subsidio`.`viagem_transacao`\n    -- rj-smtr.subsidio.viagem_transacao\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  ),\n-- 3. Apura\u00e7\u00e3o de km realizado e Percentual de Opera\u00e7\u00e3o por faixa\n  servico_km_apuracao AS (\n  SELECT\n    p.data,\n    p.tipo_dia,\n    p.faixa_horaria_inicio,\n    p.faixa_horaria_fim,\n    p.consorcio,\n    p.servico,\n    SAFE_CAST(p.km_planejada AS NUMERIC) AS km_planejada_faixa,\n    SAFE_CAST(COALESCE(COUNT(v.id_viagem), 0) AS INT64) AS viagens_faixa,\n    SAFE_CAST(COALESCE(SUM(v.distancia_planejada), 0) AS NUMERIC) AS km_apurada_faixa,\n    SAFE_CAST(COALESCE(ROUND(100 * SUM(IF(v.tipo_viagem NOT IN (\"N\u00e3o licenciado\",\"N\u00e3o vistoriado\"),v.distancia_planejada, 0)) / p.km_planejada,2), 0) AS NUMERIC) AS pof\n  FROM\n    planejado AS p\n  LEFT JOIN\n    viagem AS v\n  ON\n    p.data = v.data\n    AND p.servico = v.servico\n    AND v.datetime_partida BETWEEN p.faixa_horaria_inicio\n    AND p.faixa_horaria_fim\n  GROUP BY\n    p.data, p.tipo_dia, p.faixa_horaria_inicio, p.faixa_horaria_fim, p.consorcio, p.servico, p.km_planejada\n)\nSELECT\n  data,\n  tipo_dia,\n  faixa_horaria_inicio,\n  faixa_horaria_fim,\n  consorcio,\n  servico,\n  viagens_faixa,\n  km_apurada_faixa,\n  km_planejada_faixa,\n  pof,\n  '' as versao,\n  CURRENT_DATETIME(\"America/Sao_Paulo\") as datetime_ultima_atualizacao\nFROM\n  servico_km_apuracao", "relation_name": "`rj-smtr`.`financeiro_staging`.`subsidio_faixa_servico_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:14.970198Z", "completed_at": "2024-09-30T15:24:17.508406Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:17.515650Z", "completed_at": "2024-09-30T15:24:17.515691Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.551697254180908, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.viagens_remuneradas", "compiled": true, "compiled_code": "\n  WITH\n-- 1. Viagens planejadas (agrupadas por data e servi\u00e7o)\n  planejado AS (\n  SELECT\n    DISTINCT data,\n    tipo_dia,\n    consorcio,\n    servico,\n    faixa_horaria_inicio,\n    faixa_horaria_fim,\n    partidas_total_planejada,\n    distancia_total_planejada AS km_planejada,\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n    -- rj-smtr.projeto_subsidio_sppo.viagem_planejada\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE( \"2022-01-01T01:00:00\" )\n    AND ( distancia_total_planejada > 0\n      OR distancia_total_planejada IS NULL )\n    AND (id_tipo_trajeto = 0\n      OR id_tipo_trajeto IS NULL)\n  ),\n  viagens_planejadas AS (\n  SELECT\n    feed_start_date,\n    servico,\n    tipo_dia,\n    viagens_planejadas,\n    partidas_ida,\n    partidas_volta,\n    tipo_os,\n  FROM\n      `rj-smtr`.`gtfs`.`ordem_servico`\n      -- rj-smtr.gtfs.ordem_servico\n  WHERE\n    feed_start_date IN ('')\n  ),\n  data_versao_efetiva AS (\n  SELECT\n    data,\n    tipo_dia,\n    tipo_os,\n    COALESCE(feed_start_date, data_versao_trips, data_versao_shapes, data_versao_frequencies) AS feed_start_date\n  FROM\n      `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_data_versao_efetiva`\n      -- rj-smtr.projeto_subsidio_sppo.subsidio_data_versao_efetiva -- (alterar tamb\u00e9m query no bloco execute)\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE( \"2022-01-01T01:00:00\" )\n  ),\n  viagem_planejada AS (\n  SELECT\n    p.data,\n    p.tipo_dia,\n    p.consorcio,\n    p.servico,\n    p.faixa_horaria_inicio,\n    p.faixa_horaria_fim,\n    v.viagens_planejadas,\n    p.km_planejada,\n    IF(p.data >= DATE(\"2024-08-16\"), p.partidas_total_planejada, v.partidas_ida + v.partidas_volta) AS viagens_planejadas_ida_volta\n  FROM\n    planejado AS p\n  LEFT JOIN\n    data_versao_efetiva AS d\n  USING\n    (data, tipo_dia)\n  LEFT JOIN\n    viagens_planejadas AS v\n  ON\n    d.feed_start_date = v.feed_start_date\n    AND p.tipo_dia = v.tipo_dia\n    AND p.servico = v.servico\n    AND (d.tipo_os = v.tipo_os\n      OR (d.tipo_os IS NULL AND v.tipo_os = \"Regular\"))\n  ),\n-- 2. Par\u00e2metros de subs\u00eddio\n  subsidio_parametros AS (\n  SELECT\n    DISTINCT data_inicio,\n    data_fim,\n    status,\n    subsidio_km,\n    MAX(subsidio_km) OVER (PARTITION BY DATE_TRUNC(data_inicio, YEAR), data_fim) AS subsidio_km_teto,\n    indicador_penalidade_judicial\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo_staging`.`subsidio_valor_km_tipo_viagem`\n    -- rj-smtr-staging.dashboard_subsidio_sppo_staging.subsidio_valor_km_tipo_viagem\n),\n-- 3. Viagens com quantidades de transa\u00e7\u00f5es\n  viagem_transacao AS (\n  SELECT\n    *\n FROM\n    `rj-smtr`.`subsidio`.`viagem_transacao`\n    -- rj-smtr.subsidio.viagem_transacao\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE( \"2022-01-01T01:00:00\" )\n  ),\n-- 4. Viagens com tipo e valor de subs\u00eddio por km\n  viagem_km_tipo AS (\n  SELECT\n    vt.data,\n    vt.servico,\n    vt.tipo_viagem,\n    vt.id_viagem,\n    vt.datetime_partida,\n    vt.distancia_planejada,\n    t.subsidio_km,\n    t.subsidio_km_teto,\n    t.indicador_penalidade_judicial\n  FROM\n    viagem_transacao AS vt\n  LEFT JOIN\n    subsidio_parametros AS t\n  ON\n    vt.data BETWEEN t.data_inicio\n    AND t.data_fim\n    AND vt.tipo_viagem = t.status ),\n-- 5. Apura\u00e7\u00e3o de km realizado e Percentual de Opera\u00e7\u00e3o Di\u00e1rio (POD)\n  servico_faixa_km_apuracao AS (\n  SELECT\n    p.data,\n    p.tipo_dia,\n    p.faixa_horaria_inicio,\n    p.faixa_horaria_fim,\n    p.consorcio,\n    p.servico,\n    p.km_planejada AS km_planejada,\n    COALESCE(ROUND(100 * SUM(IF(v.tipo_viagem NOT IN (\"N\u00e3o licenciado\",\"N\u00e3o vistoriado\"),v.distancia_planejada, 0)) / p.km_planejada,2), 0) AS pof\n  FROM\n    viagem_planejada AS p\n  LEFT JOIN\n    viagem_km_tipo AS v\n  ON\n    p.data = v.data\n    AND p.servico = v.servico\n    AND v.datetime_partida BETWEEN p.faixa_horaria_inicio\n    AND p.faixa_horaria_fim\n  GROUP BY\n    1, 2, 3, 4, 5, 6, 7\n  )\n-- 6. Flag de viagens que ser\u00e3o consideradas ou n\u00e3o para fins de remunera\u00e7\u00e3o (apura\u00e7\u00e3o de valor de subs\u00eddio) - RESOLU\u00c7\u00c3O SMTR N\u00ba 3645/2023\nSELECT\n  v.* EXCEPT(rn, datetime_partida, viagens_planejadas, viagens_planejadas_ida_volta, km_planejada, tipo_dia, consorcio, faixa_horaria_inicio, faixa_horaria_fim),\n  CASE\n    WHEN v.data >= DATE(\"2023-09-16\")\n        AND v.tipo_dia = \"Dia \u00datil\"\n        AND viagens_planejadas > 10\n        AND pof > 120\n        AND rn > viagens_planejadas_ida_volta*1.2\n        THEN FALSE\n    WHEN v.data >= DATE(\"2023-09-16\")\n        AND v.tipo_dia = \"Dia \u00datil\"\n        AND viagens_planejadas <= 10\n        AND pof > 200\n        AND rn > viagens_planejadas_ida_volta*2\n        THEN FALSE\n    WHEN v.data >= DATE(\"2023-09-16\")\n        AND (v.tipo_dia = \"Dia \u00datil\"\n          AND (viagens_planejadas IS NULL\n            OR pof IS NULL\n            OR rn IS NULL\n          )\n        )\n      THEN NULL\n    ELSE\n        TRUE\n    END AS indicador_viagem_dentro_limite\nFROM (\nSELECT\n  v.*,\n  p.* EXCEPT(data, servico),\n  ROW_NUMBER() OVER(PARTITION BY v.data, v.servico, faixa_horaria_inicio, faixa_horaria_fim ORDER BY subsidio_km*distancia_planejada DESC) AS rn\nFROM\n  viagem_km_tipo AS v\nLEFT JOIN\n  viagem_planejada AS p\nON\n  p.data = v.data\n  AND p.servico = v.servico\n  AND v.datetime_partida BETWEEN p.faixa_horaria_inicio\n  AND p.faixa_horaria_fim\n) AS v\nLEFT JOIN\n  servico_faixa_km_apuracao AS s\nON\n  s.data = v.data\n  AND s.servico = v.servico\n  AND v.datetime_partida BETWEEN s.faixa_horaria_inicio\n  AND s.faixa_horaria_fim", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo`.`viagens_remuneradas`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:17.533752Z", "completed_at": "2024-09-30T15:24:20.750746Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.754619Z", "completed_at": "2024-09-30T15:24:20.754645Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.229308605194092, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.indicadores_mes_pivot", "compiled": true, "compiled_code": "\n\n\n    \n    \n    \n    \n        \n        \n        \n            \n        \n        \n    \n        \n        \n        \n            \n        \n        \n    \n        \n        \n        \n            \n        \n        \n    \n        \n        \n        \n            \n        \n        \n    \n        \n        \n        \n            \n        \n        \n    \n        \n        \n        \n            \n        \n        \n    \n\n    \n\n\n\n\n    \n    \n    SELECT\n        \"Idade m\u00e9dia da frota operante por m\u00eas\" AS indicador,\n        \"\u00d4nibus\" AS modo,\n        *\n    FROM (\n        SELECT\n            *\n        FROM (\n            SELECT\n                ano,\n                mes,\n                valor\n            FROM\n                `rj-smtr`.`indicadores_continuados_egp`.`indicadores_mes`\n                --rj-smtr.indicadores_continuados_egp.indicadores_mes\n            WHERE\n                nome_indicador = \"Idade m\u00e9dia da frota operante por m\u00eas\"\n                AND modo = \"\u00d4nibus\"\n        ) PIVOT ( MAX(valor) FOR mes IN (\n            1 Janeiro,\n            2 Fevereiro,\n            3 Marco,\n            4 Abril,\n            5 Maio,\n            6 Junho,\n            7 Julho,\n            8 Agosto,\n            9 Setembro,\n            10 Outubro,\n            11 Novembro,\n            12 Dezembro )\n        )\n    )\n    UNION ALL\n    \n\n    \n    \n    SELECT\n        \"Passageiros pagantes por m\u00eas\" AS indicador,\n        \"BRT\" AS modo,\n        *\n    FROM (\n        SELECT\n            *\n        FROM (\n            SELECT\n                ano,\n                mes,\n                valor\n            FROM\n                `rj-smtr`.`indicadores_continuados_egp`.`indicadores_mes`\n                --rj-smtr.indicadores_continuados_egp.indicadores_mes\n            WHERE\n                nome_indicador = \"Passageiros pagantes por m\u00eas\"\n                AND modo = \"BRT\"\n        ) PIVOT ( MAX(valor) FOR mes IN (\n            1 Janeiro,\n            2 Fevereiro,\n            3 Marco,\n            4 Abril,\n            5 Maio,\n            6 Junho,\n            7 Julho,\n            8 Agosto,\n            9 Setembro,\n            10 Outubro,\n            11 Novembro,\n            12 Dezembro )\n        )\n    )\n    UNION ALL\n    \n    \n    SELECT\n        \"Passageiros pagantes por m\u00eas\" AS indicador,\n        \"\u00d4nibus\" AS modo,\n        *\n    FROM (\n        SELECT\n            *\n        FROM (\n            SELECT\n                ano,\n                mes,\n                valor\n            FROM\n                `rj-smtr`.`indicadores_continuados_egp`.`indicadores_mes`\n                --rj-smtr.indicadores_continuados_egp.indicadores_mes\n            WHERE\n                nome_indicador = \"Passageiros pagantes por m\u00eas\"\n                AND modo = \"\u00d4nibus\"\n        ) PIVOT ( MAX(valor) FOR mes IN (\n            1 Janeiro,\n            2 Fevereiro,\n            3 Marco,\n            4 Abril,\n            5 Maio,\n            6 Junho,\n            7 Julho,\n            8 Agosto,\n            9 Setembro,\n            10 Outubro,\n            11 Novembro,\n            12 Dezembro )\n        )\n    )\n    UNION ALL\n    \n\n    \n    \n    SELECT\n        \"Gratuidades por m\u00eas\" AS indicador,\n        \"BRT\" AS modo,\n        *\n    FROM (\n        SELECT\n            *\n        FROM (\n            SELECT\n                ano,\n                mes,\n                valor\n            FROM\n                `rj-smtr`.`indicadores_continuados_egp`.`indicadores_mes`\n                --rj-smtr.indicadores_continuados_egp.indicadores_mes\n            WHERE\n                nome_indicador = \"Gratuidades por m\u00eas\"\n                AND modo = \"BRT\"\n        ) PIVOT ( MAX(valor) FOR mes IN (\n            1 Janeiro,\n            2 Fevereiro,\n            3 Marco,\n            4 Abril,\n            5 Maio,\n            6 Junho,\n            7 Julho,\n            8 Agosto,\n            9 Setembro,\n            10 Outubro,\n            11 Novembro,\n            12 Dezembro )\n        )\n    )\n    UNION ALL\n    \n    \n    SELECT\n        \"Gratuidades por m\u00eas\" AS indicador,\n        \"\u00d4nibus\" AS modo,\n        *\n    FROM (\n        SELECT\n            *\n        FROM (\n            SELECT\n                ano,\n                mes,\n                valor\n            FROM\n                `rj-smtr`.`indicadores_continuados_egp`.`indicadores_mes`\n                --rj-smtr.indicadores_continuados_egp.indicadores_mes\n            WHERE\n                nome_indicador = \"Gratuidades por m\u00eas\"\n                AND modo = \"\u00d4nibus\"\n        ) PIVOT ( MAX(valor) FOR mes IN (\n            1 Janeiro,\n            2 Fevereiro,\n            3 Marco,\n            4 Abril,\n            5 Maio,\n            6 Junho,\n            7 Julho,\n            8 Agosto,\n            9 Setembro,\n            10 Outubro,\n            11 Novembro,\n            12 Dezembro )\n        )\n    )\n    UNION ALL\n    \n\n    \n    \n    SELECT\n        \"Frota operante por m\u00eas\" AS indicador,\n        \"\u00d4nibus\" AS modo,\n        *\n    FROM (\n        SELECT\n            *\n        FROM (\n            SELECT\n                ano,\n                mes,\n                valor\n            FROM\n                `rj-smtr`.`indicadores_continuados_egp`.`indicadores_mes`\n                --rj-smtr.indicadores_continuados_egp.indicadores_mes\n            WHERE\n                nome_indicador = \"Frota operante por m\u00eas\"\n                AND modo = \"\u00d4nibus\"\n        ) PIVOT ( MAX(valor) FOR mes IN (\n            1 Janeiro,\n            2 Fevereiro,\n            3 Marco,\n            4 Abril,\n            5 Maio,\n            6 Junho,\n            7 Julho,\n            8 Agosto,\n            9 Setembro,\n            10 Outubro,\n            11 Novembro,\n            12 Dezembro )\n        )\n    )\n    \n    \n", "relation_name": "`rj-smtr`.`indicadores_continuados_egp`.`indicadores_mes_pivot`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.763082Z", "completed_at": "2024-09-30T15:24:20.773442Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.775196Z", "completed_at": "2024-09-30T15:24:20.775208Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.015901565551757812, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.subsidio_penalidade_servico_dia", "compiled": true, "compiled_code": "\n\nWITH\n  subsidio_dia AS (\n  SELECT\n    data,\n    tipo_dia,\n    consorcio,\n    servico,\n    MIN(pof) AS min_pof\n  FROM\n    `rj-smtr`.`financeiro_staging`.`subsidio_faixa_servico_dia`\n    -- rj-smtr.financeiro_staging.subsidio_faixa_servico_dia\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  GROUP BY\n    data,\n    tipo_dia,\n    consorcio,\n    servico\n  ),\n  penalidade AS (\n  SELECT\n    data_inicio,\n    data_fim,\n    perc_km_inferior,\n    perc_km_superior,\n    IFNULL(-valor, 0) AS valor_penalidade\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo`.`valor_tipo_penalidade`\n    -- rj-smtr.dashboard_subsidio_sppo.valor_tipo_penalidade\n  )\nSELECT\n    s.data,\n    s.tipo_dia,\n    s.consorcio,\n    s.servico,\n    SAFE_CAST(COALESCE(pe.valor_penalidade, 0) AS NUMERIC) AS valor_penalidade,\n    '' as versao,\n    CURRENT_DATETIME(\"America/Sao_Paulo\") as datetime_ultima_atualizacao\nFROM\n  subsidio_dia AS s\nLEFT JOIN\n  penalidade AS pe\nON\n  s.data BETWEEN pe.data_inicio\n  AND pe.data_fim\n  AND s.min_pof >= pe.perc_km_inferior\n  AND s.min_pof < pe.perc_km_superior", "relation_name": "`rj-smtr`.`financeiro`.`subsidio_penalidade_servico_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.780893Z", "completed_at": "2024-09-30T15:24:20.787993Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.789372Z", "completed_at": "2024-09-30T15:24:20.789383Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.012115001678466797, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.subsidio_faixa_servico_dia_tipo_viagem", "compiled": true, "compiled_code": "\n\nWITH\n  subsidio_faixa_dia AS (\n  SELECT\n    data,\n    tipo_dia,\n    faixa_horaria_inicio,\n    faixa_horaria_fim,\n    consorcio,\n    servico,\n    pof\n  FROM\n    `rj-smtr`.`financeiro_staging`.`subsidio_faixa_servico_dia`\n    -- rj-smtr.financeiro_staging.subsidio_faixa_servico_dia\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  ),\n  servico_km_apuracao AS (\n  SELECT\n    data,\n    servico,\n    CASE\n      WHEN tipo_viagem = \"Nao licenciado\" THEN \"N\u00e3o licenciado\"\n      WHEN tipo_viagem = \"Licenciado com ar e autuado (023.II)\" THEN \"Autuado por ar inoperante\"\n      WHEN tipo_viagem = \"Licenciado sem ar\" THEN \"Licenciado sem ar e n\u00e3o autuado\"\n      WHEN tipo_viagem = \"Licenciado com ar e n\u00e3o autuado (023.II)\" THEN \"Licenciado com ar e n\u00e3o autuado\"\n      ELSE tipo_viagem\n    END AS tipo_viagem,\n    id_viagem,\n    distancia_planejada,\n    subsidio_km,\n    subsidio_km_teto,\n    indicador_penalidade_judicial,\n    indicador_viagem_dentro_limite\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo`.`viagens_remuneradas`\n    -- rj-smtr.dashboard_subsidio_sppo.viagens_remuneradas\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  ),\n  indicador_ar AS (\n  SELECT\n    data,\n    id_veiculo,\n    status,\n    SAFE_CAST(JSON_VALUE(indicadores,\"$.indicador_ar_condicionado\") AS BOOL) AS indicador_ar_condicionado\n  FROM\n    `rj-smtr`.`veiculo`.`sppo_veiculo_dia`\n    -- rj-smtr.veiculo.sppo_veiculo_dia\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  ),\n  viagem AS (\n  SELECT\n    data,\n    servico_realizado AS servico,\n    id_veiculo,\n    id_viagem,\n    datetime_partida\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    -- rj-smtr.projeto_subsidio_sppo.viagem_completa\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  ),\n  ar_viagem AS (\n  SELECT\n    v.data,\n    v.servico,\n    v.id_viagem,\n    v.datetime_partida,\n    COALESCE(ia.indicador_ar_condicionado, FALSE) AS indicador_ar_condicionado\n  FROM\n    viagem v\n  LEFT JOIN\n    indicador_ar ia\n  ON\n    ia.data = v.data\n    AND ia.id_veiculo = v.id_veiculo\n  ),\n  subsidio_servico_ar AS (\n    SELECT\n      sfd.data,\n      sfd.tipo_dia,\n      sfd.faixa_horaria_inicio,\n      sfd.faixa_horaria_fim,\n      sfd.consorcio,\n      sfd.servico,\n      sfd.pof,\n      COALESCE(s.tipo_viagem, \"Sem viagem apurada\") AS tipo_viagem,\n      s.id_viagem,\n      SAFE_CAST(s.distancia_planejada AS NUMERIC) AS distancia_planejada,\n      SAFE_CAST(s.subsidio_km AS NUMERIC) AS subsidio_km,\n      SAFE_CAST(s.subsidio_km_teto AS NUMERIC) AS subsidio_km_teto,\n      s.indicador_viagem_dentro_limite,\n      CASE\n        WHEN sfd.pof < 60 THEN TRUE\n        ELSE s.indicador_penalidade_judicial\n      END AS indicador_penalidade_judicial,\n      COALESCE(av.indicador_ar_condicionado, FALSE) AS indicador_ar_condicionado\n    FROM\n      subsidio_faixa_dia AS sfd\n    LEFT JOIN\n      ar_viagem AS av\n    ON\n      sfd.data = av.data\n      AND sfd.servico = av.servico\n      AND av.datetime_partida BETWEEN sfd.faixa_horaria_inicio\n      AND sfd.faixa_horaria_fim\n    LEFT JOIN\n      servico_km_apuracao AS s\n    ON\n      sfd.data = s.data\n      AND sfd.servico = s.servico\n      AND s.id_viagem = av.id_viagem\n  )\nSELECT\n  data,\n  tipo_dia,\n  faixa_horaria_inicio,\n  faixa_horaria_fim,\n  consorcio,\n  servico,\n  indicador_ar_condicionado,\n  indicador_penalidade_judicial,\n  indicador_viagem_dentro_limite,\n  tipo_viagem,\n  SAFE_CAST(COALESCE(COUNT(id_viagem), 0) AS INT64) AS viagens_faixa,\n  SAFE_CAST(COALESCE(SUM(distancia_planejada), 0) AS NUMERIC) AS km_apurada_faixa,\n  SAFE_CAST(COALESCE(SUM(IF(indicador_viagem_dentro_limite = TRUE AND pof >= 80 AND subsidio_km > 0, distancia_planejada, 0)), 0) AS NUMERIC) AS km_subsidiada_faixa,\n  SAFE_CAST(SUM(IF(indicador_viagem_dentro_limite = TRUE AND pof >= 80, distancia_planejada*subsidio_km, 0)) AS NUMERIC) AS valor_apurado,\n  SAFE_CAST(-COALESCE(SUM(IF(indicador_viagem_dentro_limite = TRUE, 0, distancia_planejada*subsidio_km)), 0) AS NUMERIC) AS valor_acima_limite,\n  SAFE_CAST(SUM(IF(pof >= 80 AND tipo_viagem != \"N\u00e3o licenciado\", distancia_planejada*subsidio_km_teto, 0)) - COALESCE(SUM(IF(indicador_viagem_dentro_limite = TRUE, 0, distancia_planejada*subsidio_km)), 0) AS NUMERIC) AS valor_total_sem_glosa,\n  '' as versao,\n  CURRENT_DATETIME(\"America/Sao_Paulo\") as datetime_ultima_atualizacao\nFROM\n  subsidio_servico_ar\nGROUP BY\n  data,\n  tipo_dia,\n  faixa_horaria_inicio,\n  faixa_horaria_fim,\n  consorcio,\n  servico,\n  indicador_ar_condicionado,\n  indicador_penalidade_judicial,\n  indicador_viagem_dentro_limite,\n  tipo_viagem", "relation_name": "`rj-smtr`.`financeiro`.`subsidio_faixa_servico_dia_tipo_viagem`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.793911Z", "completed_at": "2024-09-30T15:24:20.800035Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.801277Z", "completed_at": "2024-09-30T15:24:20.801285Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009708404541015625, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sumario_servico_dia", "compiled": true, "compiled_code": "\n\n\nWITH\n-- 1. Viagens planejadas (agrupadas por data e servi\u00e7o)\n  planejado AS (\n  SELECT\n    DISTINCT DATA,\n    tipo_dia,\n    consorcio,\n    servico,\n    distancia_total_planejada AS km_planejada,\n  FROM\n    -- `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n  WHERE\n    DATA BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE( \"2022-01-01T01:00:00\" )\n    AND ( distancia_total_planejada > 0\n      OR distancia_total_planejada IS NULL )\n  ),\n-- 2. Viagens realizadas\n  viagem AS (\n  SELECT\n    DATA,\n    servico_realizado AS servico,\n    id_veiculo,\n    id_viagem,\n    distancia_planejada\n FROM\n    -- `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n  WHERE\n    DATA BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE( \"2022-01-01T01:00:00\" ) ),\n-- 3. Apura\u00e7\u00e3o de km realizado e Percentual de Opera\u00e7\u00e3o Di\u00e1rio (POD)\n  servico_km_apuracao AS (\n  SELECT\n    p.data,\n    p.tipo_dia,\n    p.consorcio,\n    p.servico,\n    p.km_planejada AS km_planejada,\n    COALESCE(COUNT(v.id_viagem), 0) AS viagens,\n    COALESCE(SUM(v.distancia_planejada), 0) AS km_apurada,\n    COALESCE(ROUND(100 * SUM(v.distancia_planejada) / p.km_planejada,2), 0) AS perc_km_planejada\n  FROM\n    planejado AS p\n  LEFT JOIN\n    viagem AS v\n  USING\n    (DATA,\n      servico)\n  GROUP BY\n    1,\n    2,\n    3,\n    4,\n    5 ),\n-- 4. Apura\u00e7\u00e3o de valor de subs\u00eddio por data e servi\u00e7o\n  viagens_remuneradas AS (\n    SELECT\n      DATA,\n      servico,\n      distancia_planejada,\n      subsidio_km\n    FROM\n      `rj-smtr`.`dashboard_subsidio_sppo`.`viagens_remuneradas`\n      -- `rj-smtr.dashboard_subsidio_sppo.viagens_remuneradas`\n    WHERE\n      DATA BETWEEN DATE(\"2022-01-01T01:00:00\")\n      AND DATE( \"2022-01-01T01:00:00\" )\n      AND indicador_viagem_dentro_limite IS TRUE),\n  servico_subsidio_apuracao AS (\n  SELECT\n    DATA,\n    servico,\n    SUM(distancia_planejada*subsidio_km) AS valor_subsidio_apurado\n  FROM\n    viagens_remuneradas\n  GROUP BY\n    1,\n    2)\nSELECT\n  s.*,\n  IF(p.valor IS NULL, COALESCE(st.valor_subsidio_apurado, 0), 0) AS valor_subsidio_pago,\n  IFNULL(-p.valor, 0) AS valor_penalidade\nFROM\n  servico_km_apuracao AS s\nLEFT JOIN\n  `rj-smtr`.`dashboard_subsidio_sppo`.`valor_tipo_penalidade` AS p\n  -- `rj-smtr`.`dashboard_subsidio_sppo`.`valor_tipo_penalidade` AS p\nON\n  s.data BETWEEN p.data_inicio\n  AND p.data_fim\n  AND s.perc_km_planejada >= p.perc_km_inferior\n  AND s.perc_km_planejada < p.perc_km_superior\nLEFT JOIN\n  servico_subsidio_apuracao AS st\nUSING\n  (DATA,\n    servico)", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.804983Z", "completed_at": "2024-09-30T15:24:20.810793Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.812278Z", "completed_at": "2024-09-30T15:24:20.812286Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009618043899536133, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.subsidio_sumario_servico_dia_pagamento", "compiled": true, "compiled_code": "\n\nWITH\n  subsidio_dia AS (\n  SELECT\n    data,\n    tipo_dia,\n    consorcio,\n    servico,\n    SUM(viagens_faixa) AS viagens_dia,\n    SUM(km_planejada_faixa) AS km_planejada_dia\n  FROM\n    `rj-smtr`.`financeiro_staging`.`subsidio_faixa_servico_dia`\n    -- rj-smtr.financeiro_staging.subsidio_faixa_servico_dia\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  GROUP BY\n    data,\n    tipo_dia,\n    consorcio,\n    servico\n  ),\n  subsidio_parametros AS (\n  SELECT\n    DISTINCT data_inicio,\n    data_fim,\n    status,\n    subsidio_km,\n    MAX(subsidio_km) OVER (PARTITION BY data_inicio, data_fim) AS subsidio_km_teto\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo_staging`.`subsidio_valor_km_tipo_viagem`\n    -- rj-smtr.dashboard_subsidio_sppo_staging.subsidio_valor_km_tipo_viagem\n),\n  penalidade AS (\n  SELECT\n    data,\n    tipo_dia,\n    consorcio,\n    servico,\n    valor_penalidade\n  FROM\n    `rj-smtr`.`financeiro`.`subsidio_penalidade_servico_dia`\n  ),\n  subsidio_dia_tipo_viagem AS (\n  SELECT\n    *\n  FROM\n    `rj-smtr`.`financeiro`.`subsidio_faixa_servico_dia_tipo_viagem`\n    -- rj-smtr.financeiro.subsidio_faixa_servico_dia_tipo_viagem\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  ),\n  valores_calculados AS (\n  SELECT\n    s.data,\n    s.tipo_dia,\n    s.consorcio,\n    s.servico,\n    pe.valor_penalidade,\n    SUM(s.km_apurada_faixa) AS km_apurada_dia,\n    SUM(s.km_subsidiada_faixa) AS km_subsidiada_dia,\n    COALESCE(SUM(s.valor_acima_limite), 0) AS valor_acima_limite,\n    COALESCE(SUM(s.valor_total_sem_glosa), 0) AS valor_total_sem_glosa,\n    SUM(s.valor_apurado) + pe.valor_penalidade AS valor_total_com_glosa,\n    CASE\n      WHEN pe.valor_penalidade != 0 THEN -pe.valor_penalidade\n      ELSE SAFE_CAST((SUM(IF(indicador_viagem_dentro_limite = TRUE AND indicador_penalidade_judicial = TRUE, km_apurada_faixa*subsidio_km_teto, 0))\n           - SUM(IF(indicador_viagem_dentro_limite = TRUE AND indicador_penalidade_judicial = TRUE, km_apurada_faixa*subsidio_km, 0))) AS NUMERIC)\n    END AS valor_judicial,\n  FROM\n    subsidio_dia_tipo_viagem AS s\n  LEFT JOIN\n    penalidade AS pe\n  USING(data, tipo_dia, consorcio, servico)\n  LEFT JOIN\n    subsidio_parametros AS sp\n  ON\n    s.data BETWEEN sp.data_inicio\n    AND sp.data_fim\n    AND s.tipo_viagem = sp.status\n  GROUP BY\n    s.data,\n    s.tipo_dia,\n    s.consorcio,\n    s.servico,\n    pe.valor_penalidade\n  )\nSELECT\n  sd.data,\n  sd.tipo_dia,\n  sd.consorcio,\n  sd.servico,\n  sd.viagens_dia,\n  vc.km_apurada_dia,\n  vc.km_subsidiada_dia,\n  sd.km_planejada_dia,\n  vc.valor_total_com_glosa AS valor_a_pagar,\n  vc.valor_total_com_glosa - vc.valor_total_sem_glosa AS valor_glosado,\n  vc.valor_acima_limite,\n  vc.valor_total_sem_glosa,\n  vc.valor_acima_limite + vc.valor_penalidade + vc.valor_total_sem_glosa AS valor_total_apurado,\n  vc.valor_judicial,\n  vc.valor_penalidade,\n  '' as versao,\n  CURRENT_DATETIME(\"America/Sao_Paulo\") as datetime_ultima_atualizacao\nFROM\n  subsidio_dia AS sd\nLEFT JOIN\n  valores_calculados AS vc\nUSING(data, tipo_dia, consorcio, servico)", "relation_name": "`rj-smtr`.`financeiro`.`subsidio_sumario_servico_dia_pagamento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.815984Z", "completed_at": "2024-09-30T15:24:20.823254Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.824506Z", "completed_at": "2024-09-30T15:24:20.824514Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010846853256225586, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sumario_faixa_servico_dia", "compiled": true, "compiled_code": "\n\nWITH\n  subsidio_faixa AS (\n  SELECT\n    data,\n    tipo_dia,\n    faixa_horaria_inicio,\n    faixa_horaria_fim,\n    consorcio,\n    servico,\n    viagens_faixa,\n    km_planejada_faixa,\n    pof\n  FROM\n    `rj-smtr`.`financeiro_staging`.`subsidio_faixa_servico_dia`\n    -- rj-smtr.financeiro_staging.subsidio_faixa_servico_dia\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  ),\n  subsidio_faixa_agg AS (\n  SELECT\n    data,\n    tipo_dia,\n    faixa_horaria_inicio,\n    faixa_horaria_fim,\n    consorcio,\n    servico,\n    SUM(km_apurada_faixa) AS km_apurada_faixa,\n    SUM(km_subsidiada_faixa) AS km_subsidiada_faixa,\n    SUM(valor_apurado) AS valor_apurado,\n    SUM(valor_acima_limite) AS valor_acima_limite,\n    SUM(valor_total_sem_glosa) AS valor_total_sem_glosa\n  FROM\n    `rj-smtr`.`financeiro`.`subsidio_faixa_servico_dia_tipo_viagem`\n    -- rj-smtr.financeiro.subsidio_faixa_servico_dia_tipo_viagem\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  GROUP BY\n    data,\n    tipo_dia,\n    faixa_horaria_inicio,\n    faixa_horaria_fim,\n    consorcio,\n    servico\n  ),\n  pivot_data AS (\n  SELECT\n    *\n  FROM (\n    SELECT\n      data,\n      tipo_dia,\n      faixa_horaria_inicio,\n      faixa_horaria_fim,\n      consorcio,\n      servico,\n      tipo_viagem,\n      km_apurada_faixa\n    FROM\n      `rj-smtr`.`financeiro`.`subsidio_faixa_servico_dia_tipo_viagem`\n      -- rj-smtr.financeiro.subsidio_faixa_servico_dia_tipo_viagem\n    WHERE\n      data BETWEEN DATE(\"2022-01-01T01:00:00\")\n      AND DATE(\"2022-01-01T01:00:00\")\n    )\n    PIVOT(SUM(km_apurada_faixa) AS km_apurada FOR tipo_viagem IN (\n      \"Registrado com ar inoperante\" AS registrado_com_ar_inoperante,\n      \"N\u00e3o licenciado\" AS n_licenciado,\n      \"Autuado por ar inoperante\" AS autuado_ar_inoperante,\n      \"Autuado por seguran\u00e7a\" AS autuado_seguranca,\n      \"Autuado por limpeza/equipamento\" AS autuado_limpezaequipamento,\n      \"Licenciado sem ar e n\u00e3o autuado\" AS licenciado_sem_ar_n_autuado,\n      \"Licenciado com ar e n\u00e3o autuado\" AS licenciado_com_ar_n_autuado,\n      \"N\u00e3o vistoriado\" AS n_vistoriado,\n      \"Sem transa\u00e7\u00e3o\" AS sem_transacao))\n  )\nSELECT\n  s.data,\n  s.tipo_dia,\n  s.faixa_horaria_inicio,\n  s.faixa_horaria_fim,\n  s.consorcio,\n  s.servico,\n  s.viagens_faixa,\n  agg.km_apurada_faixa,\n  agg.km_subsidiada_faixa,\n  s.km_planejada_faixa,\n  s.pof,\n  COALESCE(km_apurada_registrado_com_ar_inoperante, 0) AS km_apurada_registrado_com_ar_inoperante,\n  COALESCE(km_apurada_n_licenciado, 0) AS km_apurada_n_licenciado,\n  COALESCE(km_apurada_autuado_ar_inoperante, 0) AS km_apurada_autuado_ar_inoperante,\n  COALESCE(km_apurada_autuado_seguranca, 0) AS km_apurada_autuado_seguranca,\n  COALESCE(km_apurada_autuado_limpezaequipamento, 0) AS km_apurada_autuado_limpezaequipamento,\n  COALESCE(km_apurada_licenciado_sem_ar_n_autuado, 0) AS km_apurada_licenciado_sem_ar_n_autuado,\n  COALESCE(km_apurada_licenciado_com_ar_n_autuado, 0) AS km_apurada_licenciado_com_ar_n_autuado,\n  COALESCE(km_apurada_n_vistoriado, 0) AS km_apurada_n_vistoriado,\n  COALESCE(km_apurada_sem_transacao, 0) AS km_apurada_sem_transacao,\n  agg.valor_apurado,\n  agg.valor_acima_limite,\n  agg.valor_total_sem_glosa,\n  '' as versao,\n  CURRENT_DATETIME(\"America/Sao_Paulo\") as datetime_ultima_atualizacao\nFROM\n  subsidio_faixa AS s\nLEFT JOIN\n  subsidio_faixa_agg AS agg\nUSING(data, tipo_dia, faixa_horaria_inicio, faixa_horaria_fim, consorcio, servico)\nLEFT JOIN\n  pivot_data AS pd\nUSING(data, tipo_dia, faixa_horaria_inicio, faixa_horaria_fim, consorcio, servico)", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo_v2`.`sumario_faixa_servico_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.829120Z", "completed_at": "2024-09-30T15:24:20.837782Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.839044Z", "completed_at": "2024-09-30T15:24:20.839053Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013697624206542969, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sumario_servico_dia_tipo", "compiled": true, "compiled_code": "\n\nWITH\n  planejado AS (\n  SELECT\n    DISTINCT DATA,\n    tipo_dia,\n    consorcio,\n    servico,\n    sentido,\n    distancia_total_planejada AS km_planejada\n  FROM\n    -- rj-smtr.projeto_subsidio_sppo.viagem_planejada\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n  WHERE\n    DATA >= DATE( \"2023-01-16\" )\n    \n      AND DATA BETWEEN DATE(\"2022-01-01T01:00:00\" )\n      AND DATE( \"2022-01-01T01:00:00\" )\n    \n    AND (distancia_total_planejada > 0\n    OR distancia_total_planejada IS NOT NULL)\n  ),\n  viagem AS (\n  SELECT\n    data,\n    servico,\n    id_veiculo,\n    id_viagem,\n    tipo_viagem,\n    distancia_planejada\n  FROM\n    -- rj-smtr.subsidio.viagem_transacao\n    `rj-smtr`.`subsidio`.`viagem_transacao`\n  WHERE\n    DATA >= DATE( \"2023-01-16\" )\n    \n      AND DATA BETWEEN DATE(\"2022-01-01T01:00:00\" )\n      AND DATE( \"2022-01-01T01:00:00\" )\n    \n  ),\n  servico_km_tipo AS (\n  SELECT\n    data,\n    servico,\n    tipo_viagem,\n    COUNT(id_viagem) AS viagens,\n    ROUND(SUM(distancia_planejada), 2) AS km_apurada\n  FROM\n    viagem v\n  GROUP BY\n    1,\n    2,\n    3 ),\n  servico_km_tipo_atualizado AS (\n  SELECT\n    * EXCEPT(tipo_viagem),\n    CASE\n      WHEN tipo_viagem = \"Nao licenciado\" THEN \"N\u00e3o licenciado\"\n      WHEN tipo_viagem = \"Licenciado com ar e autuado (023.II)\" THEN \"Autuado por ar inoperante\"\n      WHEN tipo_viagem = \"Licenciado sem ar\" THEN \"Licenciado sem ar e n\u00e3o autuado\"\n      WHEN tipo_viagem = \"Licenciado com ar e n\u00e3o autuado (023.II)\" THEN \"Licenciado com ar e n\u00e3o autuado\"\n    ELSE tipo_viagem\n    END AS tipo_viagem\n  FROM\n    servico_km_tipo\n  ),\n  servico_km AS (\n  SELECT\n    p.data,\n    p.tipo_dia,\n    p.consorcio,\n    p.servico,\n    v.tipo_viagem,\n    IFNULL(v.viagens, 0) AS viagens,\n    IFNULL(v.km_apurada, 0) AS km_apurada,\n  FROM\n    planejado AS p\n  LEFT JOIN\n    servico_km_tipo_atualizado v\n  ON\n    p.data = v.data\n    AND p.servico = v.servico ),\n  pivot_data AS (\n  SELECT\n    *\n  FROM (\n    SELECT\n      data,\n      tipo_dia,\n      consorcio,\n      servico,\n      tipo_viagem,\n      viagens,\n      km_apurada,\n    FROM\n      servico_km ) PIVOT(SUM(viagens) AS viagens,\n      SUM(km_apurada) AS km_apurada FOR tipo_viagem IN (\n          \"Registrado com ar inoperante\" AS registrado_com_ar_inoperante,\n          \"N\u00e3o licenciado\" AS n_licenciado,\n          \"Autuado por ar inoperante\" AS autuado_ar_inoperante,\n          \"Autuado por seguran\u00e7a\" AS autuado_seguranca,\n          \"Autuado por limpeza/equipamento\" AS autuado_limpezaequipamento,\n          \"Licenciado sem ar e n\u00e3o autuado\" AS licenciado_sem_ar_n_autuado,\n          \"Licenciado com ar e n\u00e3o autuado\" AS licenciado_com_ar_n_autuado,\n          \"N\u00e3o vistoriado\" AS n_vistoriado,\n          \"Sem transa\u00e7\u00e3o\" AS sem_transacao\n        )))\nSELECT\n  sd.*,\n  pd.* EXCEPT(data,\n    tipo_dia,\n    servico,\n    consorcio)\nFROM\n  `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia` AS sd\n  -- rj-smtr.dashboard_subsidio_sppo.sumario_servico_dia AS sd\nLEFT JOIN\n  pivot_data AS pd\nON\n  sd.data = pd.data\n  AND sd.servico = pd.servico\n\n  WHERE\n    sd.data BETWEEN DATE(\"2022-01-01T01:00:00\" )\n    AND DATE( \"2022-01-01T01:00:00\" )\n", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_tipo`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.843756Z", "completed_at": "2024-09-30T15:24:20.849824Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.851081Z", "completed_at": "2024-09-30T15:24:20.851089Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009716272354125977, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sumario_servico_dia_pagamento", "compiled": true, "compiled_code": "\n\nWITH\n  subsidio_dia AS (\n  SELECT\n    data,\n    tipo_dia,\n    consorcio,\n    servico,\n    SAFE_CAST(AVG(pof) AS NUMERIC) AS media_pof,\n    SAFE_CAST(COALESCE(STDDEV(pof), 0) AS NUMERIC) AS desvp_pof\n  FROM\n    `rj-smtr`.`financeiro_staging`.`subsidio_faixa_servico_dia`\n    -- rj-smtr.financeiro_staging.subsidio_faixa_servico_dia\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  GROUP BY\n    data,\n    tipo_dia,\n    consorcio,\n    servico\n  ),\n  valores_subsidio AS (\n  SELECT\n    *\n  FROM\n    `rj-smtr`.`financeiro`.`subsidio_sumario_servico_dia_pagamento`\n    -- rj-smtr.financeiro.subsidio_sumario_servico_dia_pagamento\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\")\n    AND DATE(\"2022-01-01T01:00:00\")\n  ),\n  pivot_data AS (\n  SELECT\n    *\n  FROM (\n    SELECT\n      data,\n      tipo_dia,\n      consorcio,\n      servico,\n      tipo_viagem,\n      km_apurada_faixa\n    FROM\n      `rj-smtr`.`financeiro`.`subsidio_faixa_servico_dia_tipo_viagem`\n      -- rj-smtr.financeiro.subsidio_faixa_servico_dia_tipo_viagem\n    WHERE\n      data BETWEEN DATE(\"2022-01-01T01:00:00\")\n      AND DATE(\"2022-01-01T01:00:00\")\n    )\n    PIVOT(SUM(km_apurada_faixa) AS km_apurada FOR tipo_viagem IN (\n      \"Registrado com ar inoperante\" AS registrado_com_ar_inoperante,\n      \"N\u00e3o licenciado\" AS n_licenciado,\n      \"Autuado por ar inoperante\" AS autuado_ar_inoperante,\n      \"Autuado por seguran\u00e7a\" AS autuado_seguranca,\n      \"Autuado por limpeza/equipamento\" AS autuado_limpezaequipamento,\n      \"Licenciado sem ar e n\u00e3o autuado\" AS licenciado_sem_ar_n_autuado,\n      \"Licenciado com ar e n\u00e3o autuado\" AS licenciado_com_ar_n_autuado,\n      \"N\u00e3o vistoriado\" AS n_vistoriado,\n      \"Sem transa\u00e7\u00e3o\" AS sem_transacao))\n  )\nSELECT\n  vs.data,\n  vs.tipo_dia,\n  vs.consorcio,\n  vs.servico,\n  vs.viagens_dia,\n  vs.km_apurada_dia,\n  vs.km_subsidiada_dia,\n  vs.km_planejada_dia,\n  sd.media_pof,\n  sd.desvp_pof,\n  COALESCE(km_apurada_registrado_com_ar_inoperante, 0) AS km_apurada_registrado_com_ar_inoperante,\n  COALESCE(km_apurada_n_licenciado, 0) AS km_apurada_n_licenciado,\n  COALESCE(km_apurada_autuado_ar_inoperante, 0) AS km_apurada_autuado_ar_inoperante,\n  COALESCE(km_apurada_autuado_seguranca, 0) AS km_apurada_autuado_seguranca,\n  COALESCE(km_apurada_autuado_limpezaequipamento, 0) AS km_apurada_autuado_limpezaequipamento,\n  COALESCE(km_apurada_licenciado_sem_ar_n_autuado, 0) AS km_apurada_licenciado_sem_ar_n_autuado,\n  COALESCE(km_apurada_licenciado_com_ar_n_autuado, 0) AS km_apurada_licenciado_com_ar_n_autuado,\n  COALESCE(km_apurada_n_vistoriado, 0) AS km_apurada_n_vistoriado,\n  COALESCE(km_apurada_sem_transacao, 0) AS km_apurada_sem_transacao,\n  vs.valor_a_pagar,\n  vs.valor_glosado,\n  vs.valor_acima_limite,\n  vs.valor_total_sem_glosa,\n  vs.valor_total_apurado,\n  vs.valor_judicial,\n  vs.valor_penalidade,\n  '' as versao,\n  CURRENT_DATETIME(\"America/Sao_Paulo\") as datetime_ultima_atualizacao\nFROM\n  valores_subsidio AS vs\nLEFT JOIN\n  subsidio_dia AS sd\nUSING(data, tipo_dia, consorcio, servico)\nLEFT JOIN\n  pivot_data AS pd\nUSING(data, tipo_dia, consorcio, servico)", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo_v2`.`sumario_servico_dia_pagamento`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.855889Z", "completed_at": "2024-09-30T15:24:20.863677Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.865816Z", "completed_at": "2024-09-30T15:24:20.865832Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.013299226760864258, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sumario_servico_dia_historico", "compiled": true, "compiled_code": "\n\nWITH\n  viagem_planejada AS (\n    (\n      SELECT\n        DISTINCT v.data,\n        v.servico,\n        o.vista\n      FROM\n        `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada` AS v\n        -- `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada` AS v\n      LEFT JOIN\n        `rj-smtr`.`projeto_subsidio_sppo`.`subsidio_data_versao_efetiva`\n        -- rj-smtr.projeto_subsidio_sppo.subsidio_data_versao_efetiva\n      USING\n        (data)\n      LEFT JOIN\n        `rj-smtr`.`gtfs`.`ordem_servico` AS o\n        -- rj-smtr.gtfs.ordem_servico AS o\n      USING\n        (feed_start_date, servico, tipo_os)\n      WHERE\n        data >= \"2024-05-01\"\n    )\n  UNION ALL\n    (\n      SELECT\n        DISTINCT `data`,\n        servico,\n        vista\n      FROM\n        `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n        -- `rj-smtr`.`projeto_subsidio_sppo`.`viagem_planejada`\n      WHERE\n        (id_tipo_trajeto = 0\n        OR id_tipo_trajeto IS NULL)\n        AND data < \"2024-05-01\"\n    )\n  ),\n  -- v1: Valor do subs\u00eddio pr\u00e9 glosa por tipos de viagem (Antes de 2023-01-16)\n  sumario_sem_glosa AS (\n  SELECT\n    `data`,\n    tipo_dia,\n    consorcio,\n    servico,\n    vista,\n    viagens_subsidio AS viagens,\n    distancia_total_subsidio AS km_apurada,\n    distancia_total_planejada AS km_planejada,\n    perc_distancia_total_subsidio AS perc_km_planejada,\n    valor_total_subsidio AS valor_subsidio_pago,\n    NULL AS valor_penalidade\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_dia`\n    -- `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_dia`\n  LEFT JOIN\n    viagem_planejada\n  USING\n    ( `data`,\n      servico ) ),\n  -- v2: Valor do subs\u00eddio p\u00f3s glosa por tipos de viagem (2023-01-16 a 2023-07-15 e ap\u00f3s de 2023-09-01)\n  sumario_com_glosa AS (\n  SELECT\n    `data`,\n    tipo_dia,\n    consorcio,\n    servico,\n    vista,\n    viagens,\n    km_apurada,\n    km_planejada,\n    perc_km_planejada,\n    valor_subsidio_pago,\n    valor_penalidade\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia`\n    -- `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia`\n  LEFT JOIN\n    viagem_planejada\n  USING\n    ( `data`,\n      servico )),\n  -- Valor do subs\u00eddio sem glosas - Suspenso por Decis\u00e3o Judicial (Entre 2023-07-16 e 2023-08-31) (R$ 2.81/km em 2023)\n  subsidio_total_glosa_suspensa AS (\n  SELECT\n    DATA,\n    servico,\n    CASE\n      WHEN perc_km_planejada >= 80 THEN ROUND((COALESCE(km_apurada_autuado_ar_inoperante, 0) + COALESCE(km_apurada_autuado_seguranca, 0) + COALESCE(km_apurada_autuado_limpezaequipamento, 0) + COALESCE(km_apurada_licenciado_sem_ar_n_autuado, 0) + COALESCE(km_apurada_licenciado_com_ar_n_autuado, 0)) * 2.81, 2)\n    ELSE\n    0\n  END\n    AS valor_subsidio_pago,\n    0 AS valor_penalidade\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_tipo`\n    -- `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_tipo`\n  WHERE\n    DATA BETWEEN \"2023-07-16\"\n    AND \"2023-08-31\"),\n  -- v3: Sum\u00e1rio subs\u00eddio sem glosas - Suspenso por Decis\u00e3o Judicial (Entre 2023-07-16 e 2023-08-31)\n  sumario_glosa_suspensa AS (\n  SELECT\n    s.* EXCEPT (valor_subsidio_pago,\n      valor_penalidade),\n    g.valor_subsidio_pago,\n    g.valor_penalidade\n  FROM\n    subsidio_total_glosa_suspensa AS g\n  LEFT JOIN\n    sumario_com_glosa AS s\n  USING\n    ( `data`,\n      servico )),\ndados_completos AS (\n  SELECT\n  *\n  FROM\n    sumario_sem_glosa\n  UNION ALL (\n    SELECT\n      *\n    FROM\n      sumario_com_glosa\n    WHERE\n      `data` < \"2023-07-16\"\n      OR `data` > \"2023-08-31\" )\n  UNION ALL (\n    SELECT\n      *\n    FROM\n      sumario_glosa_suspensa )\n)\nSELECT\n  *,\n  CURRENT_DATETIME(\"America/Sao_Paulo\") as datetime_ultima_atualizacao\nFROM\n  dados_completos\n\n  WHERE\n    data BETWEEN DATE(\"2022-01-01T01:00:00\" )\n    AND DATE( \"2022-01-01T01:00:00\" )\n", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_historico`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.869900Z", "completed_at": "2024-09-30T15:24:20.875144Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.876508Z", "completed_at": "2024-09-30T15:24:20.876518Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009020566940307617, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sumario_servico_dia_tipo_sem_glosa", "compiled": true, "compiled_code": "WITH\n  parametros AS (\n  SELECT\n    data_inicio,\n    data_fim,\n    MAX(IF(status = \"Licenciado sem ar e n\u00e3o autuado\", subsidio_km, NULL)) AS subsidio_km_sem_ar_n_autuado,\n    MAX(IF(status = \"Licenciado com ar e n\u00e3o autuado\", subsidio_km, NULL)) AS subsidio_km_sem_glosa\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo_staging`.`subsidio_valor_km_tipo_viagem`\n  WHERE\n    data_inicio >= \"2023-07-04\"\n    AND status IN (\"Licenciado sem ar e n\u00e3o autuado\", \"Licenciado com ar e n\u00e3o autuado\")\n  GROUP BY\n    1,\n    2 )\nSELECT\n  consorcio,\n  data,\n  tipo_dia,\n  servico,\n  viagens AS viagens_subsidio,\n  km_planejada AS distancia_total_planejada,\n  km_apurada AS distancia_total_subsidio,\n  NULL AS valor_total_aferido, -- TODO: Excluir essa coluna? \u00e9 utilizada?\n  perc_km_planejada AS perc_distancia_total_subsidio,\n  -- Valor total sem glosas: quando existe subsidio (POD>80%),  adiciona o valor glosado por tipo de viagem ao total\n  CASE\n    WHEN perc_km_planejada >= 80 THEN ROUND(COALESCE(valor_subsidio_pago, 0) + COALESCE(km_apurada_registrado_com_ar_inoperante * subsidio_km_sem_glosa, 0) + COALESCE(km_apurada_autuado_ar_inoperante * subsidio_km_sem_glosa, 0) + COALESCE(km_apurada_autuado_seguranca * subsidio_km_sem_glosa, 0) + COALESCE(km_apurada_autuado_limpezaequipamento * subsidio_km_sem_glosa, 0) + COALESCE(km_apurada_licenciado_sem_ar_n_autuado * (subsidio_km_sem_glosa - subsidio_km_sem_ar_n_autuado), 0) + COALESCE(km_apurada_n_vistoriado * subsidio_km_sem_glosa, 0) + COALESCE(km_apurada_sem_transacao * subsidio_km_sem_glosa, 0), 2)\n  ELSE\n  0\nEND\n  AS valor_total_subsidio,\n  COALESCE(viagens_n_licenciado, 0) AS viagens_n_licenciado,\n  COALESCE(km_apurada_n_licenciado, 0) AS km_apurada_n_licenciado,\n  COALESCE(viagens_autuado_ar_inoperante, 0) AS viagens_autuado_ar_inoperante,\n  COALESCE(km_apurada_autuado_ar_inoperante, 0) AS km_apurada_autuado_ar_inoperante,\n  COALESCE(viagens_autuado_seguranca, 0) AS viagens_autuado_seguranca,\n  COALESCE(km_apurada_autuado_seguranca, 0) AS km_apurada_autuado_seguranca,\n  COALESCE(viagens_autuado_limpezaequipamento, 0) AS viagens_autuado_limpezaequipamento,\n  COALESCE(km_apurada_autuado_limpezaequipamento, 0) AS km_apurada_autuado_limpezaequipamento,\n  COALESCE(viagens_licenciado_sem_ar_n_autuado, 0) AS viagens_licenciado_sem_ar_n_autuado,\n  COALESCE(km_apurada_licenciado_sem_ar_n_autuado, 0) AS km_apurada_licenciado_sem_ar_n_autuado,\n  COALESCE(viagens_licenciado_com_ar_n_autuado, 0) AS viagens_licenciado_com_ar_n_autuado,\n  COALESCE(km_apurada_licenciado_com_ar_n_autuado, 0) AS km_apurada_licenciado_com_ar_n_autuado,\n  COALESCE(viagens_registrado_com_ar_inoperante, 0) AS viagens_registrado_com_ar_inoperante,\n  COALESCE(km_apurada_registrado_com_ar_inoperante, 0) AS km_apurada_registrado_com_ar_inoperante,\n  COALESCE(viagens_n_vistoriado, 0) AS viagens_n_vistoriado,\n  COALESCE(km_apurada_n_vistoriado, 0) AS km_apurada_n_vistoriado,\n  COALESCE(viagens_sem_transacao, 0) AS viagens_sem_transacao,\n  COALESCE(km_apurada_sem_transacao, 0) AS km_apurada_sem_transacao\nFROM\n  `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_tipo` -- `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_tipo`\nLEFT JOIN\n  parametros\nON\n  DATA BETWEEN data_inicio\n  AND data_fim", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_tipo_sem_glosa`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.880500Z", "completed_at": "2024-09-30T15:24:20.887201Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.888531Z", "completed_at": "2024-09-30T15:24:20.888539Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.010482549667358398, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.balanco_servico_dia", "compiled": true, "compiled_code": "\n-- 0. Lista servicos e dias at\u00edpicos (pagos por recurso)\nWITH\n  recursos AS (\n  SELECT\n    data,\n    id_recurso,\n    tipo_recurso,\n    -- consorcio,\n    servico,\n    SUM(valor_pago) AS valor_pago\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_recursos`.`recursos_sppo_servico_dia_pago`\n    -- `rj-smtr`.`br_rj_riodejaneiro_recursos`.`recursos_sppo_servico_dia_pago`\n  GROUP BY\n    1,\n    2,\n    3,\n    4),\nservico_dia_atipico as (\nSELECT\n  DISTINCT data, servico\nFROM\n  recursos\nWHERE\n  -- Quando o valor do recurso pago for R$ 0, desconsidera-se o recurso, pois:\n    -- Recurso pode ter sido cancelado (pago e depois revertido)\n    -- Problema reporto n\u00e3o gerou impacto na opera\u00e7\u00e3o (quando aparece apenas 1 vez)\n  valor_pago != 0\n  -- Desconsideram-se recursos do tipo \"Algoritmo\" (igual a apura\u00e7\u00e3o em produ\u00e7\u00e3o, levantado pela TR/SUBTT/CMO)\n  -- Desconsideram-se recursos do tipo \"Viagem Individual\" (n\u00e3o afeta servi\u00e7o-dia)\n  AND tipo_recurso NOT IN (\"Algoritmo\", \"Viagem Individual\")\n  -- Desconsideram-se recursos de reprocessamento que j\u00e1 constam em produ\u00e7\u00e3o\n  AND NOT (data BETWEEN \"2022-06-01\" AND \"2022-06-30\"\n            AND tipo_recurso = \"Reprocessamento\")\n),\n\n-- 1. Calcula a km subsidiada por servico e dia\nsumario_dia AS (  -- Km apurada por servico e dia\n  SELECT\n    DATA,\n    consorcio,\n    servico,\n    SUM(km_apurada) AS km_subsidiada,\n    sum(valor_subsidio_pago) as subsidio_pago\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_historico`\n    -- `rj-smtr.dashboard_subsidio_sppo.sumario_servico_dia_historico`\n  WHERE\n    DATA BETWEEN \"2022-06-01\"\n    AND \"2023-12-31\"\n    and valor_subsidio_pago > 0\n  GROUP BY\n    1,\n    2,\n    3),\n  viagem_remunerada AS ( -- Km subsidiada pos regra do teto de 120% por servico e dia\n  SELECT\n    DATA,\n    servico,\n    SUM(distancia_planejada) AS km_subsidiada\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo`.`viagens_remuneradas`\n    -- `rj-smtr.dashboard_subsidio_sppo.viagens_remuneradas`\n  WHERE\n    DATA BETWEEN \"2023-09-16\"\n    AND \"2023-12-31\"\n    AND indicador_viagem_dentro_limite = TRUE -- useless\n  GROUP BY\n    1,\n    2 ),\nkm_subsidiada_dia as (\n  SELECT\n  sd.* except(km_subsidiada),\n    ifnull(case when data >= \"2023-09-16\" then vr.km_subsidiada else sd.km_subsidiada end, 0) as km_subsidiada\n  FROM\n    sumario_dia sd\n  LEFT JOIN\n    viagem_remunerada as vr\n  using\n    (data, servico)\n),\n\n-- 2. Filtra km subsidiada apenas em dias t\u00edpicos (remove servicos e dias pagos por recurso)\nkm_subsidiada_filtrada as (\n  select\n    ksd.*\n  from km_subsidiada_dia ksd\n  left join servico_dia_atipico sda\n  using (data, servico)\n  where sda.data is null\n  -- Demais dias que n\u00e3o foi considerada a km apurada via GPS:\n  and ksd.data NOT IN (\"2022-10-02\", \"2022-10-30\", '2023-02-07', '2023-02-08', '2023-02-10', '2023-02-13', '2023-02-17', '2023-02-18', '2023-02-19', '2023-02-20', '2023-02-21', '2023-02-22')\n),\n\n\n-- 3. Calcula a receita tarifaria por servico e dia\nrdo AS (\n  SELECT\n    data,\n    consorcio,\n    CASE\n      WHEN LENGTH(linha) < 3 THEN LPAD(linha, 3, \"0\")\n    ELSE\n    CONCAT( IFNULL(REGEXP_EXTRACT(linha, r\"[B-Z]+\"), \"\"), IFNULL(REGEXP_EXTRACT(linha, r\"[0-9]+\"), \"\") )\n  END\n    AS servico,\n    round(SUM(receita_buc) + SUM(receita_buc_supervia) + SUM(receita_cartoes_perna_unica_e_demais) + SUM(receita_especie), 0) AS receita_tarifaria_aferida\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_rdo`.`rdo40_registros`\n    -- `rj-smtr`.`br_rj_riodejaneiro_rdo`.`rdo40_registros`\n  WHERE\n    DATA BETWEEN \"2022-06-01\" AND \"2023-12-31\"\n    AND DATA NOT IN (\"2022-10-02\", \"2022-10-30\", '2023-02-07', '2023-02-08', '2023-02-10', '2023-02-13', '2023-02-17', '2023-02-18', '2023-02-19', '2023-02-20', '2023-02-21', '2023-02-22')\n    and consorcio in (\"Internorte\", \"Intersul\", \"Santa Cruz\", \"Transcarioca\")\n  group by 1,2,3\n),\nparametros as (\n  SELECT\n    DISTINCT data_inicio,\n    data_fim,\n    irk,\n    case\n      when data_fim <= \"2022-12-31\" then irk - subsidio_km  -- subsidio varia ao longo dos meses\n      else coalesce(irk_tarifa_publica, irk - (subsidio_km + desconto_subsidio_km)) end as irk_tarifa_publica,\n    (subsidio_km + desconto_subsidio_km) as subsidio_km\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`parametros_km`\n  where data_inicio >= \"2022-06-01\" and data_fim <= \"2023-12-31\"\n)\n  select\n    *,\n    ifnull(receita_total_aferida, 0) - ifnull(receita_total_esperada - subsidio_glosado, 0) as saldo\n  from (\n    select\n      ks.* except(subsidio_pago),\n      ks.km_subsidiada * par.irk as receita_total_esperada,\n      ks.km_subsidiada * par.irk_tarifa_publica as receita_tarifaria_esperada,\n      ks.km_subsidiada * par.subsidio_km as subsidio_esperado,\n      case when data >= \"2023-01-01\" then (ks.km_subsidiada * par.subsidio_km - subsidio_pago) else 0 end as subsidio_glosado,\n      ifnull(rdo.receita_tarifaria_aferida, 0) + ifnull(ks.subsidio_pago, 0) as receita_total_aferida,\n      rdo.receita_tarifaria_aferida,\n      ks.subsidio_pago\n    from\n      km_subsidiada_filtrada ks\n    left join\n      rdo\n    using\n      (data, servico, consorcio)\n    left join\n      parametros par\n    on\n      ks.data between data_inicio and data_fim\n  )\n", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`balanco_servico_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.892259Z", "completed_at": "2024-09-30T15:24:20.898192Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.899448Z", "completed_at": "2024-09-30T15:24:20.899456Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00953221321105957, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.sumario_servico_tipo_viagem_dia", "compiled": true, "compiled_code": "WITH\n  planejado AS (\n  SELECT\n    DISTINCT `data`,\n    tipo_dia,\n    consorcio,\n    servico\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_historico`\n  WHERE\n    `data` <= DATE( \"2022-01-01T01:00:00\" )),\n  sumario_v1 AS ( -- Viagens v1\n  SELECT\n    `data`,\n    servico,\n    \"N\u00e3o classificado\" AS tipo_viagem,\n    NULL AS indicador_ar_condicionado,\n    viagens,\n    km_apurada\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_historico`\n  WHERE\n    `data` < DATE( \"2023-01-16\" ) ),\n  tipo_viagem_v2 AS ( -- Classifica os tipos de viagem (v2)\n  SELECT\n    `data`,\n    id_veiculo,\n    status,\n    SAFE_CAST(JSON_VALUE(indicadores,\"$.indicador_ar_condicionado\") AS BOOL) AS indicador_ar_condicionado\n  FROM\n    `rj-smtr`.`veiculo`.`sppo_veiculo_dia` -- `rj-smtr`.`veiculo`.`sppo_veiculo_dia`\n  WHERE\n    `data` BETWEEN DATE( \"2023-01-16\" )\n    AND DATE( \"2022-01-01T01:00:00\" ) ),\n  viagem_v2 AS (\n  SELECT\n    `data`,\n    servico_realizado AS servico,\n    id_veiculo,\n    id_viagem,\n    distancia_planejada\n  FROM\n    `rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa` --`rj-smtr`.`projeto_subsidio_sppo`.`viagem_completa`\n  WHERE\n    `data` BETWEEN DATE( \"2023-01-16\" )\n    AND DATE( \"2022-01-01T01:00:00\" ) ),\n  tipo_viagem_v2_atualizado AS (\n  SELECT\n    * EXCEPT(status),\n    CASE\n      WHEN status = \"Nao licenciado\" THEN \"N\u00e3o licenciado\"\n      WHEN status = \"Licenciado com ar e autuado (023.II)\" THEN \"Autuado por ar inoperante\"\n      WHEN status = \"Licenciado sem ar\" THEN \"Licenciado sem ar e n\u00e3o autuado\"\n      WHEN status = \"Licenciado com ar e n\u00e3o autuado (023.II)\" THEN \"Licenciado com ar e n\u00e3o autuado\"\n    ELSE status\n    END AS status\n  FROM\n    tipo_viagem_v2),\n  sumario_v2 AS (\n  SELECT\n    v.`data`,\n    v.servico,\n    ve.status AS tipo_viagem,\n    ve.indicador_ar_condicionado,\n    COUNT(id_viagem) AS viagens,\n    ROUND(SUM(distancia_planejada), 2) AS km_apurada\n  FROM\n    viagem_v2 v\n  LEFT JOIN\n    tipo_viagem_v2_atualizado ve\n  ON\n    ve.`data` = v.`data`\n    AND ve.id_veiculo = v.id_veiculo\n  GROUP BY\n    1,\n    2,\n    3,\n    4 )\n(\nSELECT\n  v1.`data`,\n  p.tipo_dia,\n  p.consorcio,\n  v1.servico,\n  COALESCE(v1.tipo_viagem, \"Sem viagem apurada\") AS tipo_viagem,\n  SAFE_CAST(indicador_ar_condicionado AS BOOL) AS indicador_ar_condicionado,\n  COALESCE(v1.viagens, 0) AS viagens,\n  COALESCE(v1.km_apurada, 0) AS km_apurada\nFROM\n  sumario_v1 v1\nINNER JOIN\n  planejado p\nON\n  p.`data` = v1.`data`\n  AND p.servico = v1.servico\nWHERE\n  p.`data` < DATE( \"2023-01-16\" ))\nUNION ALL (\nSELECT\n  v2.`data`,\n  p.tipo_dia,\n  p.consorcio,\n  v2.servico,\n  COALESCE(v2.tipo_viagem, \"Sem viagem apurada\") AS tipo_viagem,\n  v2.indicador_ar_condicionado,\n  COALESCE(v2.viagens, 0) AS viagens,\n  COALESCE(v2.km_apurada, 0) AS km_apurada\nFROM\n  sumario_v2 v2\nINNER JOIN\n  planejado p\nON\n  p.`data` = v2.`data`\n  AND p.servico = v2.servico\nWHERE\n  p.`data` >= DATE( \"2023-01-16\" ))", "relation_name": "`rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_tipo_viagem_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.917405Z", "completed_at": "2024-09-30T15:24:20.923454Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.925640Z", "completed_at": "2024-09-30T15:24:20.925651Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011824369430541992, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.balanco_consorcio_ano", "compiled": true, "compiled_code": "\n\nselect\n  extract(year from data) as ano,\n  consorcio,\n  sum(km_subsidiada) as km_subsidiada,\n  sum(receita_total_esperada) as receita_total_esperada,\n  sum(receita_tarifaria_esperada) as receita_tarifaria_esperada,\n  sum(subsidio_esperado) as subsidio_esperado,\n  sum(subsidio_glosado) as subsidio_glosado,\n  sum(receita_total_aferida) as receita_total_aferida,\n  sum(receita_tarifaria_aferida) as receita_tarifaria_aferida,\n  sum(subsidio_pago) as subsidio_pago,\n  sum(saldo) as saldo\nfrom `rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`balanco_servico_dia`\ngroup by 1,2\norder by 1,2", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`balanco_consorcio_ano`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.930021Z", "completed_at": "2024-09-30T15:24:20.934437Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.935715Z", "completed_at": "2024-09-30T15:24:20.935724Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008490800857543945, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.balanco_consorcio_dia", "compiled": true, "compiled_code": "\n\nselect\n  data,\n  consorcio,\n  sum(km_subsidiada) as km_subsidiada,\n  sum(receita_total_esperada) as receita_total_esperada,\n  sum(receita_tarifaria_esperada) as receita_tarifaria_esperada,\n  sum(subsidio_esperado) as subsidio_esperado,\n  sum(subsidio_glosado) as subsidio_glosado,\n  sum(receita_total_aferida) as receita_total_aferida,\n  sum(receita_tarifaria_aferida) as receita_tarifaria_aferida,\n  sum(subsidio_pago) as subsidio_pago,\n  sum(saldo) as saldo\nfrom `rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`balanco_servico_dia`\ngroup by 1,2\norder by 1,2", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`balanco_consorcio_dia`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.941318Z", "completed_at": "2024-09-30T15:24:20.950355Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.952940Z", "completed_at": "2024-09-30T15:24:20.952953Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01586294174194336, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.balanco_servico_ano", "compiled": true, "compiled_code": "\n\nselect\n  extract(year from data) as ano,\n  consorcio,\n  servico,\n  sum(km_subsidiada) as km_subsidiada,\n  sum(receita_total_esperada) as receita_total_esperada,\n  sum(receita_tarifaria_esperada) as receita_tarifaria_esperada,\n  sum(subsidio_esperado) as subsidio_esperado,\n  sum(subsidio_glosado) as subsidio_glosado,\n  sum(receita_total_aferida) as receita_total_aferida,\n  sum(receita_tarifaria_aferida) as receita_tarifaria_aferida,\n  sum(subsidio_pago) as subsidio_pago,\n  sum(saldo) as saldo\nfrom `rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`balanco_servico_dia`\ngroup by 1,2,3\norder by 1,2,3", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`balanco_servico_ano`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.959455Z", "completed_at": "2024-09-30T15:24:20.963866Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.965101Z", "completed_at": "2024-09-30T15:24:20.965109Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008470296859741211, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.balanco_servico_quinzena", "compiled": true, "compiled_code": "\n\nWITH\n  q1 AS (\n  SELECT\n    FORMAT_DATE('%Y-%m-Q1', date) AS quinzena,\n    date AS data_inicial_quinzena,\n    DATE_ADD(date, INTERVAL 14 DAY) AS data_final_quinzena\n  FROM\n    UNNEST(GENERATE_DATE_ARRAY('2022-06-01', '2023-12-31', INTERVAL 1 MONTH)) AS date ),\n  q2 AS (\n  SELECT\n    FORMAT_DATE('%Y-%m-Q2', date) AS quinzena,\n    DATE_ADD(date, INTERVAL 15 DAY) AS data_inicial_quinzena,\n    LAST_DAY(date) AS data_final_quinzena\n  FROM\n    UNNEST(GENERATE_DATE_ARRAY('2022-06-01', '2023-12-31', INTERVAL 1 MONTH)) AS date ),\n  quinzenas AS (\n  SELECT\n    *\n  FROM\n    q1\n  UNION ALL\n  SELECT\n    *\n  FROM\n    q2\n  ORDER BY\n    data_inicial_quinzena )\nSELECT\n  quinzena,\n  data_inicial_quinzena,\n  data_final_quinzena,\n  consorcio,\n  servico,\n  COUNT(DATA) AS quantidade_dias_subsidiado,\n  SUM(km_subsidiada) AS km_subsidiada,\n  SUM(receita_total_esperada) AS receita_total_esperada,\n  SUM(receita_tarifaria_esperada) AS receita_tarifaria_esperada,\n  SUM(subsidio_esperado) AS subsidio_esperado,\n  SUM(subsidio_glosado) AS subsidio_glosado,\n  SUM(receita_total_aferida) AS receita_total_aferida,\n  SUM(receita_tarifaria_aferida) AS receita_tarifaria_aferida,\n  SUM(subsidio_pago) AS subsidio_pago,\n  SUM(saldo) AS saldo\nFROM\n  quinzenas qz\nLEFT JOIN\n  `rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`balanco_servico_dia` bs\nON\n  bs.data BETWEEN qz.data_inicial_quinzena\n  AND qz.data_final_quinzena\nGROUP BY\n  quinzena,\n  data_inicial_quinzena,\n  data_final_quinzena,\n  consorcio,\n  servico\nORDER BY\n  data_inicial_quinzena,\n  consorcio,\n  servico", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`balanco_servico_quinzena`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-30T15:24:20.968817Z", "completed_at": "2024-09-30T15:24:20.982508Z"}, {"name": "execute", "started_at": "2024-09-30T15:24:20.983891Z", "completed_at": "2024-09-30T15:24:20.983901Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.017474651336669922, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.rj_smtr.receita_tarifaria_servico_nao_identificado_quinzena", "compiled": true, "compiled_code": "\n\nWITH\n   __dbt__cte__aux_balanco_rdo_servico_dia as (\n\n\n-- 0. Lista servicos e dias at\u00edpicos (pagos por recurso)\nWITH\n  recursos AS (\n  SELECT\n    data,\n    id_recurso,\n    tipo_recurso,\n    servico,\n    SUM(valor_pago) AS valor_pago\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_recursos`.`recursos_sppo_servico_dia_pago`\n    -- `rj-smtr`.`br_rj_riodejaneiro_recursos`.`recursos_sppo_servico_dia_pago`\n  GROUP BY\n    1,\n    2,\n    3,\n    4),\nservico_dia_atipico as (\nSELECT\n  DISTINCT data, servico\nFROM\n  recursos\nWHERE\n  -- Quando o valor do recurso pago for R$ 0, desconsidera-se o recurso, pois:\n    -- Recurso pode ter sido cancelado (pago e depois revertido)\n    -- Problema reporto n\u00e3o gerou impacto na opera\u00e7\u00e3o (quando aparece apenas 1 vez)\n  valor_pago != 0\n  -- Desconsideram-se recursos do tipo \"Algoritmo\" (igual a apura\u00e7\u00e3o em produ\u00e7\u00e3o, levantado pela TR/SUBTT/CMO)\n  -- Desconsideram-se recursos do tipo \"Viagem Individual\" (n\u00e3o afeta servi\u00e7o-dia)\n  AND tipo_recurso NOT IN (\"Algoritmo\", \"Viagem Individual\")\n  -- Desconsideram-se recursos de reprocessamento que j\u00e1 constam em produ\u00e7\u00e3o\n  AND NOT (data BETWEEN \"2022-06-01\" AND \"2022-06-30\"\n            AND tipo_recurso = \"Reprocessamento\")\n),\n\n-- 3. Calcula a receita tarifaria por servico e dia\nrdo AS (\n  SELECT\n    data,\n    consorcio,\n    CASE\n      WHEN LENGTH(linha) < 3 THEN LPAD(linha, 3, \"0\")\n    ELSE\n    CONCAT( IFNULL(REGEXP_EXTRACT(linha, r\"[B-Z]+\"), \"\"), IFNULL(REGEXP_EXTRACT(linha, r\"[0-9]+\"), \"\") )\n  END\n    AS servico,\n    linha,\n    tipo_servico,\n    ordem_servico,\n    round(SUM(receita_buc) + SUM(receita_buc_supervia) + SUM(receita_cartoes_perna_unica_e_demais) + SUM(receita_especie), 0) AS receita_tarifaria_aferida\n  FROM\n    `rj-smtr`.`br_rj_riodejaneiro_rdo`.`rdo40_registros`\n    -- `rj-smtr`.`br_rj_riodejaneiro_rdo`.`rdo40_registros`\n  WHERE\n    DATA BETWEEN \"2022-06-01\" AND \"2023-12-31\"\n    AND DATA NOT IN (\"2022-10-02\", \"2022-10-30\", '2023-02-07', '2023-02-08', '2023-02-10', '2023-02-13', '2023-02-17', '2023-02-18', '2023-02-19', '2023-02-20', '2023-02-21', '2023-02-22')\n    and consorcio in (\"Internorte\", \"Intersul\", \"Santa Cruz\", \"Transcarioca\")\n    and (length(linha) != 4 and linha not like \"2%\") --  Remove rodoviarios\n  group by 1,2,3,4,5,6\n),\n-- Remove servicos nao subsidiados\nsumario_dia AS (\n  SELECT\n    DATA,\n    consorcio,\n    servico,\n    SUM(km_apurada) AS km_subsidiada,\n    sum(valor_subsidio_pago) as subsidio_pago\n  FROM\n    `rj-smtr`.`dashboard_subsidio_sppo`.`sumario_servico_dia_historico`\n    -- `rj-smtr.dashboard_subsidio_sppo.sumario_servico_dia_historico`\n  WHERE\n    DATA BETWEEN \"2022-06-01\"\n    AND \"2023-12-31\"\n    and valor_subsidio_pago = 0\n  GROUP BY\n    1,\n    2,\n    3),\nrdo_filtrada as (\n    select rdo.* from\n    (\n      select * from rdo\n      left join servico_dia_atipico sda\n      using (data, servico)\n      where sda.data is null\n    ) rdo\n    left join sumario_dia sd\n    using (data, servico)\n    where sd.servico is null\n)\nSELECT\n  bsd.data,\n  bsd.consorcio,\n  bsd.servico,\n  bsd.km_subsidiada,\n  bsd.receita_tarifaria_aferida,\n  rdo.data as data_rdo,\n  rdo.consorcio as consorcio_rdo,\n  rdo.servico as servico_tratado_rdo,\n  rdo.linha as linha_rdo,\n  rdo.tipo_servico as tipo_servico_rdo,\n  rdo.ordem_servico as ordem_servico_rdo,\n  rdo.receita_tarifaria_aferida as receita_tarifaria_aferida_rdo\nFROM\n  `rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`balanco_servico_dia` bsd\nFULL JOIN\n  rdo_filtrada rdo\nUSING\n  (data, servico)\n), q1 AS (\n  SELECT\n    FORMAT_DATE('%Y-%m-Q1', date) AS quinzena,\n    date AS data_inicial_quinzena,\n    DATE_ADD(date, INTERVAL 14 DAY) AS data_final_quinzena\n  FROM\n    UNNEST(GENERATE_DATE_ARRAY('2022-06-01', '2023-12-31', INTERVAL 1 MONTH)) AS date ),\n  q2 AS (\n  SELECT\n    FORMAT_DATE('%Y-%m-Q2', date) AS quinzena,\n    DATE_ADD(date, INTERVAL 15 DAY) AS data_inicial_quinzena,\n    LAST_DAY(date) AS data_final_quinzena\n  FROM\n    UNNEST(GENERATE_DATE_ARRAY('2022-06-01', '2023-12-31', INTERVAL 1 MONTH)) AS date ),\n  quinzenas AS (\n  SELECT\n    *\n  FROM\n    q1\n  UNION ALL\n  SELECT\n    *\n  FROM\n    q2\n  ORDER BY\n    data_inicial_quinzena )\nSELECT\n  quinzena,\n  data_inicial_quinzena,\n  data_final_quinzena,\n  consorcio_rdo,\n  servico_tratado_rdo,\n  linha_rdo,\n  tipo_servico_rdo,\n  ordem_servico_rdo,\n  COUNT(data_rdo) AS quantidade_dias_rdo,\n  SUM(receita_tarifaria_aferida_rdo) AS receita_tarifaria_aferida_rdo\nFROM\n  quinzenas qz\nLEFT JOIN (\n  SELECT * from __dbt__cte__aux_balanco_rdo_servico_dia WHERE servico is null\n) bs\nON\n  bs.data_rdo BETWEEN qz.data_inicial_quinzena\n  AND qz.data_final_quinzena\nGROUP BY\n  1,2,3,4,5,6,7,8\nORDER BY\n  2,4,5,6,7,8\n", "relation_name": "`rj-smtr`.`projeto_subsidio_sppo_encontro_contas`.`receita_tarifaria_servico_nao_identificado_quinzena`"}], "elapsed_time": 211.8564007282257, "args": {"partial_parse_file_diff": true, "static": false, "vars": {}, "defer": false, "target": "prod", "compile": true, "cache_selected_only": false, "show_resource_report": false, "static_parser": true, "log_format_file": "debug", "invocation_command": "dbt docs generate --target prod --target-path target-base/", "warn_error_options": {"include": [], "exclude": []}, "log_level_file": "debug", "quiet": false, "select": [], "favor_state": false, "populate_cache": true, "send_anonymous_usage_stats": true, "use_colors": true, "print": true, "macro_debugging": false, "enable_legacy_logger": false, "introspect": true, "indirect_selection": "eager", "use_colors_file": true, "version_check": true, "target_path": "target-base/", "write_json": true, "exclude": [], "empty_catalog": false, "partial_parse": true, "strict_mode": false, "profiles_dir": "/home/caio/projects/pipelines_rj_smtr/queries", "which": "generate", "printer_width": 80, "log_file_max_bytes": 10485760, "project_dir": "/home/caio/projects/pipelines_rj_smtr/queries", "log_format": "default", "log_level": "info", "log_path": "/home/caio/projects/pipelines_rj_smtr/queries/logs"}}