




    
        
        
    


with
    source as (
        select distinct data_autuacao as data, id_auto_infracao, "CITRAN" as fonte
        from `rj-smtr`.`transito_staging`.`autuacao_citran`
         where 
    date(data)
    between date("2022-01-01T00:00:00") and date("2022-01-01T01:00:00")
 
        union all
        select distinct data_autuacao as data, id_auto_infracao, "SERPRO" as fonte
        from `rj-smtr`.`transito_staging`.`autuacao_serpro`
         where 
    date(data)
    between date("2022-01-01T00:00:00") and date("2022-01-01T01:00:00")
 
    ),
    new_data as (
        select s.*
        from source s
        
            left join
                `rj-smtr`.`transito_staging`.`aux_autuacao_id` t
                on s.data = t.data
                and s.id_auto_infracao = t.id_auto_infracao
                and s.fonte = t.fonte
            where
                t.id_auto_infracao is null and s.data in ('2022-01-01', '2022-01-02', '2022-01-03', '2022-01-04', '2022-01-05', '2022-01-06', '2022-01-07', '2022-01-08', '2022-01-09', '2022-01-10', '2022-01-11', '2022-01-12', '2022-01-13', '2022-01-14', '2022-01-18', '2022-01-17', '2022-01-16', '2022-01-21', '2022-01-22', '2022-01-15', '2022-01-19', '2022-01-20', '2022-01-23', '2022-01-24', '2022-01-25', '2022-01-26', '2022-01-27', '2022-01-28', '2022-01-29', '2022-01-30', '2022-01-31', '2022-02-01', '2022-02-02', '2022-02-03', '2022-02-04', '2022-02-05', '2022-02-06', '2022-02-07', '2022-02-08', '2022-02-09', '2022-02-10', '2022-02-11', '2022-02-12', '2022-02-13', '2022-02-14', '2022-02-15', '2022-02-16', '2022-02-17', '2022-02-18', '2022-02-19', '2022-02-20', '2022-02-21', '2022-02-22', '2022-02-23', '2022-02-24', '2022-02-25', '2022-02-26', '2022-02-27', '2022-02-28', '2022-03-01', '2022-03-03', '2022-03-02', '2022-03-04', '2022-03-05', '2022-03-06', '2022-03-07', '2022-03-08', '2022-03-09', '2022-03-10', '2022-03-11', '2022-03-12', '2022-03-13', '2022-03-14', '2022-03-15', '2022-03-17', '2022-03-16', '2022-03-18', '2022-03-21', '2022-03-20', '2022-03-19', '2022-03-22', '2022-03-23', '2022-03-24', '2022-03-25', '2022-03-26', '2022-03-29', '2022-03-28', '2022-03-30', '2022-03-27', '2022-03-31', '2022-04-01', '2022-04-02', '2022-04-03', '2022-04-05', '2022-04-04', '2022-04-06', '2022-04-08', '2022-04-07', '2022-04-09', '2022-04-10', '2022-04-11', '2022-04-12', '2022-04-13', '2022-04-14', '2022-04-15', '2022-04-16', '2022-04-17', '2022-04-18', '2022-04-19', '2022-04-20', '2022-04-21', '2022-04-22', '2022-04-23', '2022-04-24', '2022-04-25', '2022-04-27', '2022-04-26', '2022-04-28', '2022-04-29', '2022-04-30', '2022-05-02', '2022-05-01', '2022-05-03', '2022-05-04', '2022-05-05', '2022-05-06', '2022-05-07', '2022-05-08', '2022-05-09', '2022-05-10', '2022-05-11', '2022-05-12', '2022-05-13', '2022-05-16', '2022-05-14', '2022-05-15', '2022-05-17', '2022-05-18', '2022-05-19', '2022-05-20', '2022-05-21', '2022-05-22', '2022-05-23', '2022-05-24', '2022-05-25', '2022-05-26', '2022-05-27', '2022-05-28', '2022-05-29', '2022-05-30', '2022-05-31', '2022-06-01', '2022-06-02', '2022-06-03', '2022-06-04', '2022-06-05', '2022-06-06', '2022-06-07', '2022-06-08', '2022-06-09', '2022-06-10', '2022-06-11', '2022-06-12', '2022-06-13', '2022-06-14', '2022-06-15', '2022-06-16', '2022-06-17', '2022-06-19', '2022-06-20', '2022-06-18', '2022-06-21', '2022-06-22', '2022-06-23', '2022-06-24', '2022-06-25', '2022-06-26', '2022-06-27', '2022-06-28', '2022-06-29', '2022-06-30', '2022-07-03', '2022-07-04', '2022-07-01', '2022-07-02', '2022-07-06', '2022-07-05', '2022-07-07', '2022-07-10', '2022-07-08', '2022-07-09', '2022-07-11', '2022-07-12', '2022-07-13', '2022-07-14', '2022-07-15', '2022-07-16', '2022-07-17', '2022-07-19', '2022-07-18', '2022-07-20', '2022-07-21', '2022-07-22', '2022-07-23', '2022-07-24', '2022-07-25', '2022-07-26', '2022-07-27', '2022-07-28', '2022-07-29', '2022-07-30', '2022-07-31', '2022-08-01', '2022-08-02', '2022-08-03', '2022-08-07', '2022-08-04', '2022-08-05', '2022-08-06', '2022-08-08', '2022-12-31', '2022-12-23', '2022-12-24', '2022-12-22', '2022-12-25', '2022-12-26', '2022-12-27', '2022-12-28', '2022-12-29', '2022-12-30')
        
    ),
    hash_id as (
        select
            data,
            id_auto_infracao,
            to_hex(sha256(concat(generate_uuid(), id_auto_infracao))) as id_autuacao,
            fonte,
            current_datetime("America/Sao_Paulo") as datetime_ultima_atualizacao
        from new_data
    ),
    complete_partitions as (
        select *
        from hash_id
        
            union all
            select *
            from `rj-smtr`.`transito_staging`.`aux_autuacao_id`
            where data in ('2022-01-01', '2022-01-02', '2022-01-03', '2022-01-04', '2022-01-05', '2022-01-06', '2022-01-07', '2022-01-08', '2022-01-09', '2022-01-10', '2022-01-11', '2022-01-12', '2022-01-13', '2022-01-14', '2022-01-18', '2022-01-17', '2022-01-16', '2022-01-21', '2022-01-22', '2022-01-15', '2022-01-19', '2022-01-20', '2022-01-23', '2022-01-24', '2022-01-25', '2022-01-26', '2022-01-27', '2022-01-28', '2022-01-29', '2022-01-30', '2022-01-31', '2022-02-01', '2022-02-02', '2022-02-03', '2022-02-04', '2022-02-05', '2022-02-06', '2022-02-07', '2022-02-08', '2022-02-09', '2022-02-10', '2022-02-11', '2022-02-12', '2022-02-13', '2022-02-14', '2022-02-15', '2022-02-16', '2022-02-17', '2022-02-18', '2022-02-19', '2022-02-20', '2022-02-21', '2022-02-22', '2022-02-23', '2022-02-24', '2022-02-25', '2022-02-26', '2022-02-27', '2022-02-28', '2022-03-01', '2022-03-03', '2022-03-02', '2022-03-04', '2022-03-05', '2022-03-06', '2022-03-07', '2022-03-08', '2022-03-09', '2022-03-10', '2022-03-11', '2022-03-12', '2022-03-13', '2022-03-14', '2022-03-15', '2022-03-17', '2022-03-16', '2022-03-18', '2022-03-21', '2022-03-20', '2022-03-19', '2022-03-22', '2022-03-23', '2022-03-24', '2022-03-25', '2022-03-26', '2022-03-29', '2022-03-28', '2022-03-30', '2022-03-27', '2022-03-31', '2022-04-01', '2022-04-02', '2022-04-03', '2022-04-05', '2022-04-04', '2022-04-06', '2022-04-08', '2022-04-07', '2022-04-09', '2022-04-10', '2022-04-11', '2022-04-12', '2022-04-13', '2022-04-14', '2022-04-15', '2022-04-16', '2022-04-17', '2022-04-18', '2022-04-19', '2022-04-20', '2022-04-21', '2022-04-22', '2022-04-23', '2022-04-24', '2022-04-25', '2022-04-27', '2022-04-26', '2022-04-28', '2022-04-29', '2022-04-30', '2022-05-02', '2022-05-01', '2022-05-03', '2022-05-04', '2022-05-05', '2022-05-06', '2022-05-07', '2022-05-08', '2022-05-09', '2022-05-10', '2022-05-11', '2022-05-12', '2022-05-13', '2022-05-16', '2022-05-14', '2022-05-15', '2022-05-17', '2022-05-18', '2022-05-19', '2022-05-20', '2022-05-21', '2022-05-22', '2022-05-23', '2022-05-24', '2022-05-25', '2022-05-26', '2022-05-27', '2022-05-28', '2022-05-29', '2022-05-30', '2022-05-31', '2022-06-01', '2022-06-02', '2022-06-03', '2022-06-04', '2022-06-05', '2022-06-06', '2022-06-07', '2022-06-08', '2022-06-09', '2022-06-10', '2022-06-11', '2022-06-12', '2022-06-13', '2022-06-14', '2022-06-15', '2022-06-16', '2022-06-17', '2022-06-19', '2022-06-20', '2022-06-18', '2022-06-21', '2022-06-22', '2022-06-23', '2022-06-24', '2022-06-25', '2022-06-26', '2022-06-27', '2022-06-28', '2022-06-29', '2022-06-30', '2022-07-03', '2022-07-04', '2022-07-01', '2022-07-02', '2022-07-06', '2022-07-05', '2022-07-07', '2022-07-10', '2022-07-08', '2022-07-09', '2022-07-11', '2022-07-12', '2022-07-13', '2022-07-14', '2022-07-15', '2022-07-16', '2022-07-17', '2022-07-19', '2022-07-18', '2022-07-20', '2022-07-21', '2022-07-22', '2022-07-23', '2022-07-24', '2022-07-25', '2022-07-26', '2022-07-27', '2022-07-28', '2022-07-29', '2022-07-30', '2022-07-31', '2022-08-01', '2022-08-02', '2022-08-03', '2022-08-07', '2022-08-04', '2022-08-05', '2022-08-06', '2022-08-08', '2022-12-31', '2022-12-23', '2022-12-24', '2022-12-22', '2022-12-25', '2022-12-26', '2022-12-27', '2022-12-28', '2022-12-29', '2022-12-30')
        
    )
select *
from complete_partitions