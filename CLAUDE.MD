# Guia Completo para LLMs - Projeto Prefect RJ IplanRio

Este documento consolida informa√ß√µes essenciais para LLMs trabalharem com o projeto Prefect RJ IplanRio, incluindo workflows de desenvolvimento e migra√ß√£o de Prefect 1.4 para 3.0.

## üìã Vis√£o Geral do Projeto

O projeto Prefect RJ IplanRio √© um sistema de pipelines de dados para a Prefeitura do Rio de Janeiro, utilizando Prefect 3.0 para orquestra√ß√£o de workflows. O projeto segue conven√ß√µes espec√≠ficas de nomenclatura e estrutura.

### Conven√ß√µes de Nomenclatura
- **Pipelines**: `rj_<secretaria>__<pipeline>`
- **Exemplos**: `rj_crm__api_wetalkie`, `rj_smas__cadunico`, `rj_iplanrio__dados_mestres`

## üõ†Ô∏è Workflow de Desenvolvimento

### Comandos Essenciais

#### Desenvolvimento
```sh
# Instalar depend√™ncias
uv sync

# Criar nova pipeline
uvx cookiecutter templates --output-dir=pipelines

# Executar pipeline localmente
prefect flow run <flow-name>
```

#### Deploy
```sh
# Deploy manual (se necess√°rio)
prefect deployment build <flow-file>:<flow-name> -n <deployment-name>
prefect deployment apply <deployment-name>
```

### Cria√ß√£o de Novas Pipelines

1. **Use cookiecutter**: `uvx cookiecutter templates --output-dir=pipelines`
2. **Siga conven√ß√µes**: Nomenclatura `rj_<secretaria>__<pipeline>`
3. **Configure prefect.yaml**: Work pool e secrets apropriados
4. **Teste localmente**: Antes do deploy
5. **Use staging**: Antes de produ√ß√£o

### Estrutura de Arquivos

- **Arquivos principais**: Mantenha no diret√≥rio raiz da pipeline
- **Subdiret√≥rios**: Use `utils/` apenas quando necess√°rio
- **Templates**: Siga a estrutura de templates para novas pipelines
- **Simplicidade**: N√£o crie arquivos desnecess√°rios

## üîß Troubleshooting

### Problemas Comuns

- **Erro de nomenclatura**: Verifique se segue padr√£o `rj_<secretaria>__<pipeline>`
- **Secret n√£o encontrado**: Confirme se `secretName` est√° correto no `prefect.yaml`
- **Pool incorreto**: Verifique se est√° usando `datario-pool` apenas quando necess√°rio
- **Depend√™ncias**: Use `uv sync` para sincronizar workspace

### Logs e Debug

- **GitHub Actions**: Verifique logs para problemas de deploy
- **Prefect UI**: Use para monitorar execu√ß√£o de flows
- **Documenta√ß√£o**: Consulte documenta√ß√£o oficial do Prefect para detalhes espec√≠ficos

## üîÑ Migra√ß√£o Prefect 1.4 para 3.0

### Processo de Migra√ß√£o

Quando solicitado para migrar um flow do Prefect 1.4 para 3.0:

#### 1. Migrar o Schedule
- Analise o `schedule` do Prefect 1.4 (arquivo original fornecido)
- Converta para formato compat√≠vel com Prefect 3.0
- **SEMPRE use o template** `templates/rj_{{ cookiecutter.secretaria }}__{{ cookiecutter.pipeline }}/prefect.yaml` como modelo
- Gere novo arquivo YAML seguindo a estrutura do template

#### 2. Adaptar o Flow
- **SEMPRE use o template** `templates/rj_{{ cookiecutter.secretaria }}__{{ cookiecutter.pipeline }}/flow.py` como modelo
- Modifique o flow de destino mantendo funcionalidade equivalente
- Adapte nomes de vari√°veis, fun√ß√µes e fluxo conforme o nome da pasta
- Garanta compatibilidade total com Prefect 3.0
- Mantenha a estrutura e padr√µes do template

#### 3. Output Esperado
- Conte√∫do final do YAML convertido baseado no template
- Novo flow modificado seguindo o padr√£o do template
- Coment√°rios resumindo altera√ß√µes em rela√ß√£o aos originais

### Arquivos de Refer√™ncia Obrigat√≥rios

**SEMPRE use estes templates como refer√™ncia:**
- `templates/rj_{{ cookiecutter.secretaria }}__{{ cookiecutter.pipeline }}/flow.py` - Template de flow Prefect 3.0
- `templates/rj_{{ cookiecutter.secretaria }}__{{ cookiecutter.pipeline }}/prefect.yaml` - Template de configura√ß√£o

### Principais Mudan√ßas Prefect 3.0

- Nova sintaxe de flows e tasks
- Mudan√ßas na configura√ß√£o de deployments
- Atualiza√ß√µes na estrutura de schedules
- Novos padr√µes de logging e monitoramento
- Altera√ß√µes na API e m√©todos de execu√ß√£o

## üìÅ Estrutura de Templates

### Flow Template (flow.py)
```python
@flow(log_prints=True)
def rj_{{ cookiecutter.secretaria }}__{{ cookiecutter.pipeline }}(
    # Par√¢metros espec√≠ficos da pipeline
):
    # Implementa√ß√£o do flow
```

### Prefect.yaml Template
```yaml
name: rj_{{ cookiecutter.secretaria }}__{{ cookiecutter.pipeline }}
prefect-version: 3.4.3

build:
  - prefect.deployments.steps.run_shell_script:
      id: get-commit-hash
      script: git rev-parse --short HEAD
  - prefect_docker.deployments.steps.build_docker_image:
      id: build-image
      image_name: ghcr.io/prefeitura-rio/prefect_rj_iplanrio/deployments
      tag: "rj_{{ cookiecutter.secretaria }}__{{ cookiecutter.pipeline }}-{% raw %}{{ get-commit-hash.stdout }}{% endraw %}"

deployments:
  - name: rj-{{ cookiecutter.secretaria | lower }}--{{ cookiecutter.pipeline }}--staging
    work_pool:
      name: k3s-pool
      job_variables:
        secretName: prefect-jobs-secrets-staging
  - name: rj-{{ cookiecutter.secretaria | lower }}--{{ cookiecutter.pipeline }}--prod
    schedules:
      - cron: "0 0 * * *"
    work_pool:
      name: k3s-pool
      job_variables:
        secretName: prefect-jobs-secrets
```

## üéØ Diretrizes para LLMs

### Ao Trabalhar com o Projeto

1. **Sempre use os templates** como refer√™ncia para novos flows e configura√ß√µes
2. **Siga as conven√ß√µes de nomenclatura** rigorosamente
3. **Mantenha a estrutura simples** - evite arquivos desnecess√°rios
4. **Teste localmente** antes de sugerir deploys
5. **Use staging** como ambiente intermedi√°rio

### Ao Migrar Flows

1. **Analise o flow original** completamente
2. **Use os templates obrigat√≥rios** como base
3. **Mantenha a funcionalidade equivalente**
4. **Adapte nomes** conforme a conven√ß√£o da pasta
5. **Documente as mudan√ßas** realizadas

### Ao Criar Novas Pipelines

1. **Use cookiecutter** para gerar a estrutura base
2. **Configure prefect.yaml** com work pools e secrets corretos
3. **Implemente o flow** seguindo o template
4. **Teste localmente** antes do deploy
5. **Configure schedules** apropriados

---

**Nota**: Este guia deve ser consultado sempre que trabalhar com o projeto Prefect RJ IplanRio para garantir consist√™ncia e seguir as melhores pr√°ticas estabelecidas.