name: rj_smi__siscob
prefect-version: 3.4.3

build:
  - prefect.deployments.steps.run_shell_script:
      id: get-commit-hash
      script: git rev-parse --short HEAD
      stream_output: false
  - prefect_docker.deployments.steps.build_docker_image:
      id: build-image
      requires: prefect-docker>=0.6.5
      image_name: ghcr.io/prefeitura-rio/prefect_rj_iplanrio/deployments
      tag: "rj_smi__siscob-{{ get-commit-hash.stdout }}"
      dockerfile: pipelines/rj_smi__siscob/Dockerfile

push:
  - prefect_docker.deployments.steps.push_docker_image:
      requires: prefect-docker>=0.6.5
      image_name: "{{ build-image.image_name }}"
      tag: "{{ build-image.tag }}"

pull:
  - prefect.deployments.steps.set_working_directory:
      directory: /opt/prefect/prefect_rj_iplanrio

deployments:
  - name: rj-smi--siscob--prod
    version: "{{ get-commit-hash.stdout }}"
    entrypoint: pipelines/rj_smi__siscob/flow.py:rj_smi__siscob
    work_pool:
      name: k3s-pool
      work_queue_name: default
      job_variables:
        image: "{{ build-image.image_name }}:{{ build-image.tag }}"
        command: uv run --package rj_smi__siscob -- prefect flow-run execute
        secretName: prefect-jobs-secrets
        image_pull_policy: Always
    schedules:
      - interval: 86400
        anchor_date: '2025-07-15T01:00:00'
        timezone: America/Sao_Paulo
        slug: obra
        parameters:
          table_id: obra
          dump_mode: overwrite
          execute_query: SELECT DISTINCT CD_OBRA, REPLACE(REPLACE(DS_TITULO, CHAR(13), ''), CHAR(10), '') AS DS_TITULO, ORGAO_CONTRATANTE,
            ORGAO_EXECUTOR, NR_PROCESSO, OBJETO, NM_FAVORECIDO, CNPJ, NR_LICITACAO, MODALIDADE, DT_ASS_CONTRATO, DT_INICIO_OBRA,
            DT_TERMINO_PREVISTO, DT_TERMINO_ATUAL, NR_CONTRATO, AA_EXERCICIO, SITUACAO, VL_ORCADO_C_BDI, VL_CONTRATADO, VL_VIGENTE,
            PC_MEDIDO, PRAZO_INICIAL FROM dbo.fuSEGOVI_Dados_da_Obra()
      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: medicao
        parameters:
          table_id: medicao
          dump_mode: overwrite
          execute_query: SELECT DISTINCT CD_OBRA, NR_MEDICAO, CD_ETAPA, TP_MEDICAO_D, DT_INI_MEDICAO, DT_FIM_MEDICAO, VL_FINAL FROM
            dbo.fuSEGOVI_Medicoes()
      - interval: 86400
        anchor_date: '2025-07-15T01:20:00'
        timezone: America/Sao_Paulo
        slug: termo_aditivo
        parameters:
          table_id: termo_aditivo
          dump_mode: overwrite
          execute_query: SELECT DISTINCT CD_OBRA, NR_DO_TERMO, TP_ACERTO, DT_DO, DT_AUTORIZACAO, VL_ACERTO FROM dbo.fuSEGOVI_Termos_Aditivos()
      - interval: 86400
        anchor_date: '2025-07-15T01:30:00'
        timezone: America/Sao_Paulo
        slug: cronograma_financeiro
        parameters:
          table_id: cronograma_financeiro
          dump_mode: overwrite
          execute_query: SELECT DISTINCT CD_OBRA, ETAPA, DT_INICIO_ETAPA, DT_FIM_ETAPA, PC_PERCENTUAL, VL_ESTIMADO FROM dbo.fuSEGOVI_Cronograma_Financeiro()
      - interval: 86400
        anchor_date: '2025-07-15T01:40:00'
        timezone: America/Sao_Paulo
        slug: cronograma_alteracao
        parameters:
          table_id: cronograma_alteracao
          dump_mode: overwrite
          execute_query: "SELECT DISTINCT CD_OBRA, NR_PROCESSO, TP_ALTERACAO, DT_PUBL_DO, CD_ETAPA, NR_PRAZO, DT_VALIDADE, REPLACE(REPLACE(DS_OBSERVACAO,\
            \ CHAR(13), ''), CHAR(10), '') AS DS_OBSERVACAO FROM dbo.fuSEGOVI_Altera\xE7\xE3o_de_Cronograma()"
      - interval: 86400
        anchor_date: '2025-07-15T01:50:00'
        timezone: America/Sao_Paulo
        slug: obras_suspensas
        parameters:
          table_id: obras_suspensas
          dump_mode: overwrite
          execute_query: SELECT DISTINCT CD_OBRA, REPLACE(REPLACE(DS_TITULO_OBJETO, CHAR(13), ''), CHAR(10), '') AS DS_TITULO_OBJETO,
            DT_SUSPENSAO, REPLACE(REPLACE(DS_MOTIVO, CHAR(13), ''), CHAR(10), '') AS DS_MOTIVO, REPLACE(REPLACE(DS_PREVISAO, CHAR(13),
            ''), CHAR(10), '') AS DS_PREVISAO, REPLACE(REPLACE(DS_JUSTIFICATIVA, CHAR(13), ''), CHAR(10), '') AS DS_JUSTIFICATIVA,
            NM_RESPONSAVEL FROM dbo.fuSEGOVI_Obras_Suspensas()
      - interval: 86400
        anchor_date: '2025-07-15T02:00:00'
        timezone: America/Sao_Paulo
        slug: itens_medicao
        parameters:
          table_id: itens_medicao
          dump_mode: overwrite
          execute_query: SELECT DISTINCT CD_OBRA, REPLACE(REPLACE(DS_TITULO_OBJETO, CHAR(13), ''), CHAR(10), '') AS DS_TITULO_OBJETO,
            DS_ESTADO, NR_MEDICAO, DT_INI_MEDICAO, DT_FIM_MEDICAO, CD_ETAPA, NM_SISTEMA, NM_SUB_SISTEMA, NM_PLANILHA, NR_ITEM, CD_CHAVE_EXTERNA,
            REPLACE(REPLACE(DS_ITEM_SERVICO, CHAR(13), ''), CHAR(10), '') AS DS_ITEM_SERVICO, TX_UNIDADE_MEDIDA, VL_ITEM_SERVICO,
            QT_MEDIDA, QT_ACUMULADA, VL_MEDIDO FROM dbo.fuSEGOVI_Itens_Medicao()
      - interval: 86400
        anchor_date: '2025-07-15T02:10:00'
        timezone: America/Sao_Paulo
        slug: orcamento_licitado
        parameters:
          table_id: orcamento_licitado
          dump_mode: overwrite
          execute_query: SELECT DISTINCT CD_OBRA, REPLACE(REPLACE(DS_TITULO_OBJETO, CHAR(13), ''), CHAR(10), '') AS DS_TITULO_OBJETO,
            NM_SISTEMA, NM_SUB_SISTEMA, NM_PLANILHA, NR_ITEM, CD_CHAVE_EXTERNA, REPLACE(REPLACE(DS_ITEM_SERVICO, CHAR(13), ''),
            CHAR(10), '') AS DS_ITEM_SERVICO, TX_UNIDADE_MEDIDA, QT_CONTRATADO, VL_UNITARIO, VL_TOTAL FROM dbo.fuSEGOVI_Orcamento_Licitado()
      - interval: 86400
        anchor_date: '2025-07-15T02:20:00'
        timezone: America/Sao_Paulo
        slug: itens_medidos_finalizados
        parameters:
          table_id: itens_medidos_finalizados
          dump_mode: overwrite
          execute_query: SELECT DISTINCT CD_OBRA, NM_SISTEMA, NM_SUB_SISTEMA, NM_PLANILHA, NR_ITEM, CD_CHAVE_EXTERNA, REPLACE(REPLACE(DS_ITEM_SERVICO,
            CHAR(13), ''), CHAR(10), '') AS DS_ITEM_SERVICO, TX_UNIDADE_MEDIDA, QT_CONTRATADA, VL_UNITARIO_LICITACAO, QT_ACUMULADA,
            VL_ACUMULADO_MEDIDO, DT_FIM_OBRA FROM dbo.fuSEGOVI_Itens_Medidos_Finalizados()
      - interval: 86400
        anchor_date: '2025-07-15T02:30:00'
        timezone: America/Sao_Paulo
        slug: localizacao_obra
        parameters:
          table_id: localizacao_obra
          dump_mode: overwrite
          execute_query: SELECT DISTINCT CD_OBRA, ENDERECO, NM_BAIRRO, NM_RA, NM_AP FROM dbo.fuSEGOVI_Localizacoes_obra()
      - interval: 86400
        anchor_date: '2025-07-15T02:40:00'
        timezone: America/Sao_Paulo
        slug: programa_fonte
        parameters:
          table_id: programa_fonte
          dump_mode: overwrite
          execute_query: SELECT DISTINCT CD_OBRA, CD_PRG_TRAB, PROGRAMA_TRABALHO, CD_FONTE_RECURSO, FONTE_RECURSO, CD_NATUREZA_DSP,
            NATUREZA_DESPESA FROM dbo.fuSEGOVI_Programa_Fonte()
      - interval: 86400
        anchor_date: '2025-07-15T02:50:00'
        timezone: America/Sao_Paulo
        slug: fiscal
        parameters:
          table_id: fiscal
          dump_mode: overwrite
          execute_query: SELECT CD_OBRA, DT_INICIO_VIG, DT_FIM_VIG, MATRICULA, NOME, EMAIL FROM dbo.fuSEGOVI_Fiscais()