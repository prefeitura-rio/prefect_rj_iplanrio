name: rj_crm__disparo_template
prefect-version: 3.4.3

build:
  - prefect.deployments.steps.run_shell_script:
      id: get-commit-hash
      script: git rev-parse --short HEAD
      stream_output: false
  - prefect_docker.deployments.steps.build_docker_image:
      id: build-image
      requires: prefect-docker>=0.6.5
      image_name: ghcr.io/prefeitura-rio/prefect_rj_iplanrio/deployments
      tag: "rj_crm__disparo_template-{{ get-commit-hash.stdout }}"
      dockerfile: pipelines/rj_crm__disparo_template/Dockerfile

push:
  - prefect_docker.deployments.steps.push_docker_image:
      requires: prefect-docker>=0.6.5
      image_name: "{{ build-image.image_name }}"
      tag: "{{ build-image.tag }}"

pull:
  - prefect.deployments.steps.set_working_directory:
      directory: /opt/prefect/prefect_rj_iplanrio

deployments:
  - name: rj-crm--disparo-template--staging
    version: "{{ build-image.tag }}"
    entrypoint: pipelines/rj_crm__disparo_template/flow.py:rj_crm__disparo_template
    work_pool:
      name: default-pool
      work_queue_name: default
      job_variables:
        image: "{{ build-image.image_name }}:{{ build-image.tag }}"
        command: uv run --package rj_crm__disparo_template -- prefect flow-run execute
        secretName: prefect-jobs-crm-registry-secrets-staging
        image_pull_policy: Always
    parameters:
      # Valores padrão (podem ser alterados na UI)
      id_hsm: 101
      campaign_name: disparo-template-prod
      cost_center_id: 71
      chunk_size: 1000
      dataset_id: brutos_wetalkie
      table_id: disparos
      dump_mode: append
      infisical_secret_path: /wetalkie
    schedules:
      # Daily schedule para flow cvl-pesquisa1746-prod
      - interval: 86400
        anchor_date: "2021-01-01T19:00:00"
        timezone: America/Sao_Paulo
        slug: daily-cvl-pesquisa1746-prod
        parameters:
          id_hsm: 192
          campaign_name: cvl-pesquisa1746-prod
          cost_center_id: 71
          chunk_size: 1000
          dataset_id: brutos_wetalkie
          table_id: disparos
          dump_mode: append
          test_mode: false
          sleep_minutes: 5
          whitelist_percentage: 100
          infisical_secret_path: "/wetalkie"
          whitelist_environment: "production"
          query: |
            WITH tabela_global AS (
                SELECT
                    DISTINCT
                    -- Identificação do chamado e protocolo
                    t1.id_chamado,
                    t3.id_protocolo,
                    t3.id_protocolo_chamado,
                    t3.ic_motivo,

                    -- Descrição e canal de origem
                    t1.descricao AS descricao_chamado,
                    t5.no_origem_ocorrencia AS canal_atendimento,
                    CASE
                    WHEN t1.id_origem_ocorrencia = '1' THEN 'Central 1746'
                    WHEN t1.id_origem_ocorrencia = '11' THEN 'Aplicativo 1746'
                    WHEN t1.id_origem_ocorrencia = '12' THEN 'Agência 1746'
                    WHEN t1.id_origem_ocorrencia = '13' THEN 'Site 1746'
                    WHEN t1.id_origem_ocorrencia = '16' THEN 'Carioca Digital'
                    WHEN t1.id_origem_ocorrencia = '17' THEN 'WhatsApp 1746'
                    WHEN t1.id_origem_ocorrencia = '18' THEN 'Van 1746'
                    WHEN t1.id_origem_ocorrencia = '26' THEN 'Agência 1746'
                    WHEN t1.id_origem_ocorrencia = '28' THEN 'WhatsApp 1746'
                    ELSE t1.id_origem_ocorrencia
                    END AS canal_tratado,

                    -- Dados do cidadão
                    t3.cpf,
                    t4.id_pessoa,
                    t4.nome,
                    CONCAT(
                    INITCAP(SPLIT(t4.nome, ' ')[OFFSET(0)]),
                    ' ',
                    INITCAP(SPLIT(t4.nome, ' ')[OFFSET(ARRAY_LENGTH(SPLIT(t4.nome, ' ')) - 1)])
                    ) AS nome_tratado,
                    t4.email,

                    -- Telefones limpos e formatados
                    COALESCE(
                    `rj-crm-registry.udf.VALIDATE_AND_FORMAT_CELLPHONE`(REGEXP_REPLACE(t4.telefone_1, r'[^\d]', '')),
                    `rj-crm-registry.udf.VALIDATE_AND_FORMAT_CELLPHONE`(REGEXP_REPLACE(t4.telefone_2, r'[^\d]', '')),
                    `rj-crm-registry.udf.VALIDATE_AND_FORMAT_CELLPHONE`(REGEXP_REPLACE(t4.telefone_3, r'[^\d]', ''))
                    ) AS telefone,

                    -- Datas e informações operacionais
                    t1.data_inicio,
                    t1.data_fim,
                    t1.data_alvo_finalizacao,
                    t1.categoria,
                    t1.id_tipo,
                    t1.tipo,
                    t1.id_subtipo,

                    -- Subtipo tratado (descrição legível)
                    CASE
                    WHEN t1.id_subtipo = '1274' THEN 'Verificação de frequência irregular da coleta domiciliar'
                    WHEN t1.id_subtipo = '1242' THEN 'Verificação de ar condicionado inoperante no ônibus'
                    WHEN t1.id_subtipo = '1287' THEN 'Varrição de logradouro'
                    WHEN t1.id_subtipo = '2178' THEN 'Reposição de tampão ou grelha'
                    WHEN t1.id_subtipo = '3139' THEN 'Reparo de sinal de trânsito apagado'
                    WHEN t1.id_subtipo = '5799' THEN 'Reparo de Luminária'
                    WHEN t1.id_subtipo = '78' THEN 'Reparo de buraco na pista'
                    WHEN t1.id_subtipo = '1298' THEN 'Remoção de resíduos no logradouro'
                    WHEN t1.id_subtipo = '1325' THEN 'Remoção de entulho e bens inservíveis'
                    WHEN t1.id_subtipo = '1319' THEN 'Poda de árvore em logradouro'
                    WHEN t1.id_subtipo = '5071' THEN 'Fiscalização de perturbação do sossego'
                    WHEN t1.id_subtipo = '114' THEN 'Fiscalização de obstáculo fixo na calçada'
                    WHEN t1.id_subtipo = '2966' THEN 'Fiscalização de estacionamento irregular de veículo'
                    WHEN t1.id_subtipo = '1101' THEN 'Fiscalização de comércio ambulante'
                    WHEN t1.id_subtipo = '5841' THEN 'Fiscalização da ocupação de área pública'
                    WHEN t1.id_subtipo = '100' THEN 'Desobstrução de ramais e ralos'
                    WHEN t1.id_subtipo = '1316' THEN 'Controle de roedores e caramujos africanos'
                    WHEN t1.id_subtipo = '1279' THEN 'Capina em logradouro'
                    ELSE t1.subtipo
                    END AS subtipo_tratado,

                    -- Localização e unidade responsável
                    t1.subtipo,
                    t1.id_territorialidade,
                    t1.id_unidade_organizacional,
                    t1.nome_unidade_organizacional,
                    t1.id_bairro,
                    t2.bairro,
                    t2.no_subprefeitura AS subprefeitura,
                    t1.id_logradouro,
                    t1.numero_logradouro,

                    -- Status e tempo de atendimento
                    t1.status,
                    t1.situacao,
                    t1.tipo_situacao,
                    t1.tempo_prazo

                FROM rj-segovi.adm_central_atendimento_1746.chamado t1
                LEFT JOIN rj-iplanrio.brutos_extracoes_google_sheets.relacao_bairro_subprefeitura t2
                    ON t1.id_bairro = t2.id_bairro
                LEFT JOIN rj-segovi.adm_central_atendimento_1746.chamado_cpf t3
                    ON t1.id_chamado = t3.id_chamado
                LEFT JOIN rj-segovi.adm_central_atendimento_1746.pessoa t4
                    ON t3.id_pessoa = CAST(t4.id_pessoa AS STRING)
                LEFT JOIN rj-segovi.adm_central_atendimento_1746.origem_ocorrencia t5
                    ON t1.id_origem_ocorrencia = CAST(t5.id_origem_ocorrencia AS STRING)
                WHERE 1=1
                    AND t1.data_inicio >= '2025-01-01 00:00:00.000' -- Considera somente chamados a partir de Jan/25
                    AND t1.id_subtipo IN (
                    '2966','1325','5799','78','100','1298','1319','1316','1274','1242',
                    '1287','5071','1279','2178','3139','114','5841','1101'
                    ) -- 18 serviços selecionados pela SUBTD
                    AND t1.data_fim IS NOT NULL -- Somente chamados fechados
                    AND t1.id_bairro IS NOT NULL -- Somente chamados com bairro classificado
                    AND t1.categoria IN ('Serviço') -- Desconsidera ouvidoria
                    AND t1.id_origem_ocorrencia NOT IN ('23','25','27') -- Exclui Táxi.Rio, Facebook e Conservação
                    AND COALESCE(t4.telefone_1, t4.telefone_2, t4.telefone_3) IS NOT NULL -- Exclui sem telefone
                    AND t3.ic_motivo IN ('E','O') -- Apenas ocorrências e equivalências
                ),

                dados_finais AS (
                SELECT
                    id_chamado,
                    canal_tratado,
                    cpf,
                    nome_tratado AS nome,
                    telefone,
                    data_inicio,
                    data_fim,
                    subtipo_tratado,
                    id_subtipo
                FROM tabela_global
                WHERE 1=1
                    AND (
                    CASE
                        -- Se for sábado ou domingo, joga para uma data no futuro (retorna vazio)
                        WHEN EXTRACT(DAYOFWEEK FROM CURRENT_DATE()) IN (7, 1)
                        THEN DATE(data_fim) = DATE_ADD(CURRENT_DATE(), INTERVAL 1 YEAR)
                        -- Se for segunda-feira, pega chamados fechados na sexta, sábado e domingo
                        WHEN EXTRACT(DAYOFWEEK FROM CURRENT_DATE()) = 2
                        THEN DATE(data_fim) IN (
                            DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY),
                            DATE_SUB(CURRENT_DATE(), INTERVAL 2 DAY),
                            DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
                        )
                        -- Nos demais dias, pega chamados fechados no dia anterior
                        ELSE DATE(data_fim) = DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
                    END
                    )
                    AND telefone IS NOT NULL
                )

                SELECT
                TO_JSON_STRING(
                    STRUCT(
                    telefone AS celular_disparo,
                    STRUCT(
                        nome AS NOME_SOBRENOME,
                        nome AS CC_WT_NOME_SOBRENOME,
                        subtipo_tratado AS SOLICITACAO,
                        subtipo_tratado AS CC_WT_SOLICITACAO,
                        canal_tratado AS CANAL,
                        canal_tratado AS CC_WT_CANAL,
                        cpf AS CC_WT_CPF_CIDADAO,
                        CAST(id_chamado AS STRING) AS CC_WT_ID_CHAMADO,
                        CAST(id_subtipo AS STRING) AS CC_WT_ID_SUBTIPO
                    ) AS vars,
                    CAST(cpf AS STRING) AS externalId
                    )
                ) AS destination_data
                FROM dados_finais;
      # Daily schedule para flow pgm-divida-ativa-prod
      - interval: 86400
        anchor_date: "2021-01-01T19:00:00"
        timezone: America/Sao_Paulo
        slug: daily-pgm-divida-ativa-prod
        parameters:
          id_hsm: 196
          query_replacements: {"id_hsm_placeholder": 196}
          campaign_name: pgm-divida-ativa-prod-v1
          cost_center_id: 71
          chunk_size: 1000
          dataset_id: brutos_wetalkie
          table_id: disparos
          dump_mode: append
          test_mode: false
          sleep_minutes: 5
          whitelist_percentage: 100
          infisical_secret_path: "/wetalkie"
          whitelist_environment: "production"
          query: |
            with final as (
                select *
                FROM `rj-crm-registry-dev.staging__ab_test.divida_ativa` da
                left join `rj-crm-registry.brutos_wetalkie_staging.fluxo_atendimento_*` fl
                        on fl.flattarget = da.telefone and fl.templateId = cast({id_hsm_placeholder} as int64)
                        and fl.createDate >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 15 DAY)
                    where fl.flattarget is null and grupo="tratamento"
            )
            SELECT
                TO_JSON_STRING(
                    STRUCT(
                        telefone AS celular_disparo,
                        STRUCT(
                            INITCAP(
                            IF(
                                ARRAY_LENGTH(SPLIT(nome, ' ')) > 1,
                                CONCAT(
                                    SPLIT(nome, ' ')[SAFE_OFFSET(0)], ' ',
                                    SPLIT(nome, ' ')[SAFE_OFFSET(ARRAY_LENGTH(SPLIT(nome, ' ')) - 1)]
                                ),
                                nome
                            )
                            )  AS NOME_SOBRENOME,
                            INITCAP(
                                IF(
                                    ARRAY_LENGTH(SPLIT(nome, ' ')) > 1,
                                    CONCAT(
                                        SPLIT(nome, ' ')[SAFE_OFFSET(0)], ' ',
                                        SPLIT(nome, ' ')[SAFE_OFFSET(ARRAY_LENGTH(SPLIT(nome, ' ')) - 1)]
                                    ),
                                    nome
                                )
                            ) AS CC_WT_NOME_SOBRENOME,
                            cpf AS CC_WT_CPF_CIDADAO
                        ) AS vars,
                        CAST(cpf AS STRING) AS externalId
                        )
                    ) AS destination_data
            from final
            limit 200

  - name: rj-crm--disparo-template--prod
    version: "{{ get-commit-hash.stdout }}"
    entrypoint: pipelines/rj_crm__disparo_template/flow.py:rj_crm__disparo_template
    work_pool:
      name: default-pool
      work_queue_name: default
      job_variables:
        image: "{{ build-image.image_name }}:{{ build-image.tag }}"
        command: uv run --package rj_crm__disparo_template -- prefect flow-run execute
        secretName: prefect-jobs-crm-registry-secrets
        image_pull_policy: Always
    parameters:
      # Valores padrão (podem ser alterados na UI)
      id_hsm: 101
      campaign_name: disparo-template-prod
      cost_center_id: 71
      chunk_size: 1000
      dataset_id: brutos_wetalkie
      table_id: disparos
      dump_mode: append
      infisical_secret_path: /wetalkie
    schedules:
      # Daily schedule para flow cvl-pesquisa1746-prod
      - interval: 86400
        anchor_date: "2021-01-01T12:00:00"
        timezone: America/Sao_Paulo
        slug: cvl-pesquisa1746-prod
        parameters:
          id_hsm: 192
          campaign_name: daily-cvl-pesquisa1746-prod
          cost_center_id: 71
          chunk_size: 1000
          dataset_id: brutos_wetalkie
          table_id: disparos
          dump_mode: append
          test_mode: false
          sleep_minutes: 5
          whitelist_percentage: 100
          infisical_secret_path: "/wetalkie"
          whitelist_environment: "production"
          query: |
            WITH tabela_global AS (
            SELECT
                DISTINCT
                -- Identificação do chamado e protocolo
                t1.id_chamado,
                t3.id_protocolo,
                t3.id_protocolo_chamado,
                t3.ic_motivo,

                -- Descrição e canal de origem
                t1.descricao AS descricao_chamado,
                t5.no_origem_ocorrencia AS canal_atendimento,
                CASE
                WHEN t1.id_origem_ocorrencia = '1' THEN 'Central 1746'
                WHEN t1.id_origem_ocorrencia = '11' THEN 'Aplicativo 1746'
                WHEN t1.id_origem_ocorrencia = '12' THEN 'Agência 1746'
                WHEN t1.id_origem_ocorrencia = '13' THEN 'Site 1746'
                WHEN t1.id_origem_ocorrencia = '16' THEN 'Carioca Digital'
                WHEN t1.id_origem_ocorrencia = '17' THEN 'WhatsApp 1746'
                WHEN t1.id_origem_ocorrencia = '18' THEN 'Van 1746'
                WHEN t1.id_origem_ocorrencia = '26' THEN 'Agência 1746'
                WHEN t1.id_origem_ocorrencia = '28' THEN 'WhatsApp 1746'
                ELSE t1.id_origem_ocorrencia
                END AS canal_tratado,

                -- Dados do cidadão
                t3.cpf,
                t4.id_pessoa,
                t4.nome,
                CONCAT(
                INITCAP(SPLIT(t4.nome, ' ')[OFFSET(0)]),
                ' ',
                INITCAP(SPLIT(t4.nome, ' ')[OFFSET(ARRAY_LENGTH(SPLIT(t4.nome, ' ')) - 1)])
                ) AS nome_tratado,
                t4.email,

                -- Telefones limpos e formatados
                COALESCE(
                `rj-crm-registry.udf.VALIDATE_AND_FORMAT_CELLPHONE`(REGEXP_REPLACE(t4.telefone_1, r'[^\d]', '')),
                `rj-crm-registry.udf.VALIDATE_AND_FORMAT_CELLPHONE`(REGEXP_REPLACE(t4.telefone_2, r'[^\d]', '')),
                `rj-crm-registry.udf.VALIDATE_AND_FORMAT_CELLPHONE`(REGEXP_REPLACE(t4.telefone_3, r'[^\d]', ''))
                ) AS telefone,

                -- Datas e informações operacionais
                t1.data_inicio,
                t1.data_fim,
                t1.data_alvo_finalizacao,
                t1.categoria,
                t1.id_tipo,
                t1.tipo,
                t1.id_subtipo,

                -- Subtipo tratado (descrição legível)
                CASE
                WHEN t1.id_subtipo = '1274' THEN 'Verificação de frequência irregular da coleta domiciliar'
                WHEN t1.id_subtipo = '1242' THEN 'Verificação de ar condicionado inoperante no ônibus'
                WHEN t1.id_subtipo = '1287' THEN 'Varrição de logradouro'
                WHEN t1.id_subtipo = '2178' THEN 'Reposição de tampão ou grelha'
                WHEN t1.id_subtipo = '3139' THEN 'Reparo de sinal de trânsito apagado'
                WHEN t1.id_subtipo = '5799' THEN 'Reparo de Luminária'
                WHEN t1.id_subtipo = '78' THEN 'Reparo de buraco na pista'
                WHEN t1.id_subtipo = '1298' THEN 'Remoção de resíduos no logradouro'
                WHEN t1.id_subtipo = '1325' THEN 'Remoção de entulho e bens inservíveis'
                WHEN t1.id_subtipo = '1319' THEN 'Poda de árvore em logradouro'
                WHEN t1.id_subtipo = '5071' THEN 'Fiscalização de perturbação do sossego'
                WHEN t1.id_subtipo = '114' THEN 'Fiscalização de obstáculo fixo na calçada'
                WHEN t1.id_subtipo = '2966' THEN 'Fiscalização de estacionamento irregular de veículo'
                WHEN t1.id_subtipo = '1101' THEN 'Fiscalização de comércio ambulante'
                WHEN t1.id_subtipo = '5841' THEN 'Fiscalização da ocupação de área pública'
                WHEN t1.id_subtipo = '100' THEN 'Desobstrução de ramais e ralos'
                WHEN t1.id_subtipo = '1316' THEN 'Controle de roedores e caramujos africanos'
                WHEN t1.id_subtipo = '1279' THEN 'Capina em logradouro'
                ELSE t1.subtipo
                END AS subtipo_tratado,

                -- Localização e unidade responsável
                t1.subtipo,
                t1.id_territorialidade,
                t1.id_unidade_organizacional,
                t1.nome_unidade_organizacional,
                t1.id_bairro,
                t2.bairro,
                t2.no_subprefeitura AS subprefeitura,
                t1.id_logradouro,
                t1.numero_logradouro,

                -- Status e tempo de atendimento
                t1.status,
                t1.situacao,
                t1.tipo_situacao,
                t1.tempo_prazo

            FROM rj-segovi.adm_central_atendimento_1746.chamado t1
            LEFT JOIN rj-iplanrio.brutos_extracoes_google_sheets.relacao_bairro_subprefeitura t2
                ON t1.id_bairro = t2.id_bairro
            LEFT JOIN rj-segovi.adm_central_atendimento_1746.chamado_cpf t3
                ON t1.id_chamado = t3.id_chamado
            LEFT JOIN rj-segovi.adm_central_atendimento_1746.pessoa t4
                ON t3.id_pessoa = CAST(t4.id_pessoa AS STRING)
            LEFT JOIN rj-segovi.adm_central_atendimento_1746.origem_ocorrencia t5
                ON t1.id_origem_ocorrencia = CAST(t5.id_origem_ocorrencia AS STRING)
            WHERE 1=1
                AND t1.data_inicio >= '2025-01-01 00:00:00.000' -- Considera somente chamados a partir de Jan/25
                AND t1.id_subtipo IN (
                '2966','1325','5799','78','100','1298','1319','1316','1274','1242',
                '1287','5071','1279','2178','3139','114','5841','1101'
                ) -- 18 serviços selecionados pela SUBTD
                AND t1.data_fim IS NOT NULL -- Somente chamados fechados
                AND t1.id_bairro IS NOT NULL -- Somente chamados com bairro classificado
                AND t1.categoria IN ('Serviço') -- Desconsidera ouvidoria
                AND t1.id_origem_ocorrencia NOT IN ('23','25','27') -- Exclui Táxi.Rio, Facebook e Conservação
                AND COALESCE(t4.telefone_1, t4.telefone_2, t4.telefone_3) IS NOT NULL -- Exclui sem telefone
                AND t3.ic_motivo IN ('E','O') -- Apenas ocorrências e equivalências
            ),

            dados_finais AS (
            SELECT
                id_chamado,
                canal_tratado,
                cpf,
                nome_tratado AS nome,
                telefone,
                data_inicio,
                data_fim,
                subtipo_tratado,
                id_subtipo
            FROM tabela_global
            WHERE 1=1
                AND (
                CASE
                    -- Se for sábado ou domingo, joga para uma data no futuro (retorna vazio)
                    WHEN EXTRACT(DAYOFWEEK FROM CURRENT_DATE()) IN (7, 1)
                    THEN DATE(data_fim) = DATE_ADD(CURRENT_DATE(), INTERVAL 1 YEAR)
                    -- Se for segunda-feira, pega chamados fechados na sexta, sábado e domingo
                    WHEN EXTRACT(DAYOFWEEK FROM CURRENT_DATE()) = 2
                    THEN DATE(data_fim) IN (
                        DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY),
                        DATE_SUB(CURRENT_DATE(), INTERVAL 2 DAY),
                        DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
                    )
                    -- Nos demais dias, pega chamados fechados no dia anterior
                    ELSE DATE(data_fim) = DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
                END
                )
                AND telefone IS NOT NULL
            )

            SELECT
            TO_JSON_STRING(
                STRUCT(
                telefone AS celular_disparo,
                STRUCT(
                    nome AS NOME_SOBRENOME,
                    nome AS CC_WT_NOME_SOBRENOME,
                    subtipo_tratado AS SOLICITACAO,
                    subtipo_tratado AS CC_WT_SOLICITACAO,
                    canal_tratado AS CANAL,
                    canal_tratado AS CC_WT_CANAL,
                    cpf AS CC_WT_CPF_CIDADAO,
                    CAST(id_chamado AS STRING) AS CC_WT_ID_CHAMADO,
                    CAST(id_subtipo AS STRING) AS CC_WT_ID_SUBTIPO
                ) AS vars,
                CAST(cpf AS STRING) AS externalId
                )
            ) AS destination_data
            FROM dados_finais;

      # Daily schedule para flow pgm-divida-ativa-prod
      - interval: 86400
        anchor_date: "2021-01-01T19:00:00"
        timezone: America/Sao_Paulo
        slug: daily-pgm-divida-ativa-prod
        parameters:
          id_hsm: 196
          query_replacements: {"id_hsm_placeholder": 196}
          campaign_name: pgm-divida-ativa-prod-v1
          cost_center_id: 71
          chunk_size: 1000
          dataset_id: brutos_wetalkie
          table_id: disparos
          dump_mode: append
          test_mode: false
          sleep_minutes: 5
          whitelist_percentage: 100
          infisical_secret_path: "/wetalkie"
          whitelist_environment: "production"
          query: |
            with final as (
                select *
                FROM `rj-crm-registry-dev.staging__ab_test.divida_ativa` da
                left join `rj-crm-registry.brutos_wetalkie_staging.fluxo_atendimento_*` fl
                        on fl.flattarget = da.telefone and fl.templateId = cast({id_hsm_placeholder} as int64)
                        and fl.createDate >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 15 DAY)
                    where fl.flattarget is null and grupo="tratamento"
            )
            SELECT
                TO_JSON_STRING(
                    STRUCT(
                        telefone AS celular_disparo,
                        STRUCT(
                            INITCAP(
                            IF(
                                ARRAY_LENGTH(SPLIT(nome, ' ')) > 1,
                                CONCAT(
                                    SPLIT(nome, ' ')[SAFE_OFFSET(0)], ' ',
                                    SPLIT(nome, ' ')[SAFE_OFFSET(ARRAY_LENGTH(SPLIT(nome, ' ')) - 1)]
                                ),
                                nome
                            )
                            )  AS NOME_SOBRENOME,
                            INITCAP(
                                IF(
                                    ARRAY_LENGTH(SPLIT(nome, ' ')) > 1,
                                    CONCAT(
                                        SPLIT(nome, ' ')[SAFE_OFFSET(0)], ' ',
                                        SPLIT(nome, ' ')[SAFE_OFFSET(ARRAY_LENGTH(SPLIT(nome, ' ')) - 1)]
                                    ),
                                    nome
                                )
                            ) AS CC_WT_NOME_SOBRENOME,
                            cpf AS CC_WT_CPF_CIDADAO
                        ) AS vars,
                        CAST(cpf AS STRING) AS externalId
                        )
                    ) AS destination_data
            from final
            limit 200
