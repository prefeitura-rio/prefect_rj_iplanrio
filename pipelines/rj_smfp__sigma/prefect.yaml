name: rj_smfp__dump_db_ergon
prefect-version: 3.4.3

build:
  - prefect.deployments.steps.run_shell_script:
      id: get-commit-hash
      script: git rev-parse --short HEAD
      stream_output: false
  - prefect_docker.deployments.steps.build_docker_image:
      id: build-image
      requires: prefect-docker>=0.6.5
      image_name: ghcr.io/prefeitura-rio/prefect_rj_iplanrio/deployments
      tag: "rj_smfp__sigma-{{ get-commit-hash.stdout }}"
      dockerfile: pipelines/rj_smfp__sigma/Dockerfile

push:
  - prefect_docker.deployments.steps.push_docker_image:
      requires: prefect-docker>=0.6.5
      image_name: "{{ build-image.image_name }}"
      tag: "{{ build-image.tag }}"

pull:
  - prefect.deployments.steps.set_working_directory:
      directory: /opt/prefect/prefect_rj_iplanrio

deployments:
  - name: rj-smfp--sigma--prod
    version: "{{ get-commit-hash.stdout }}"
    entrypoint: pipelines/rj_smfp__sigma/flow.py:rj_smfp__sigma
    work_pool:
      name: datario-pool
      work_queue_name: default
      job_variables:
        image: "{{ build-image.image_name }}:{{ build-image.tag }}"
        command: uv run --package rj_smfp__sigma -- prefect flow-run execute
        image_pull_policy: Always
    schedules:
      - interval: 86400
        anchor_date: '2025-07-15T01:00:00'
        timezone: America/Sao_Paulo
        slug: sancao_fornecedor
        parameters:
          table_id: sancao_fornecedor
          dump_mode: overwrite
          execute_query: |
            SELECT CPF_CNPJ, RAZAO_SOCIAL, NR_ORDEM, PROCESSO_ORIGEM, PROCESSO_INSTRUTIVO, PROCESSO_FATURA, CD_SANCAO,
              DS_SANCAO, DT_SANCAO, DT_EXTINCAO_SANCAO  
            FROM SIGMA.VW_SANCAO_ADMINISTRATIVA
      
      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: movimentacao
        parameters:
          table_id: movimentacao
          dump_mode: overwrite
          execute_query: |
            SELECT CD_MATERIAL, CNPJ_FORNECEDOR, NOTA_FISCAL, SERIE, DATA_NOTA_FISCAL, QUANTIDADE_ITEM, PRECO_ITEM, TOTAL_ITEM, DATA_ULTIMA_ATUALIZACAO,
              CD_MOVIMENTACAO, DS_MOVIMENTACAO, TP_ALMOXARIFADO, CD_SECRETARIA, DS_SECRETARIA, CD_ALMOXARIFADO_DESTINO, DS_ALMOXARIFADO_DESTINO,
              CD_ALMOXARIFADO_ORIGEM, DS_ALMOXARIFADO_ORIGEM, CD_OS, DT_INI_CONTRATO_OS, DT_FIM_CONTRATO_OS, NR_EMPENHO, CNPJ_FABRICANTE
            FROM SIGMA.VW_MOVIMENTACAO

      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: fornecedor
        parameters:
          table_id: fornecedor
          dump_mode: overwrite
          execute_query: |
            SELECT CPF_CNPJ, TIPO_CPF_CNPJ, INSCRICAO_MUNICIPAL, INSCRICAO_ESTADUAL, RAZAO_SOCIAL, NOME_FANTASIA, NOME_CONTATO, EMAIL, EMAIL_CONTATO, FAX, DDD, DDI, RAMAL,
              TELEFONE, LOGRADOURO, NUMERO_PORTA, COMPLEMENTO, BAIRRO, MUNICIPIO, UF, CEP, ATIVO_INATIVO_BLOQUEADO, CD_NATUREZA_JURIDICA, DS_NATUREZA_JURIDICA, CD_RAMO_ATIVIDADE,
              DS_RAMO_ATIVIDADE, CD_PORTE_EMPRESA, DS_PORTE_EMPRESA, DATA_ULTIMA_ATUALIZACAO, TIPO_FORNECEDOR
            FROM SIGMA.VW_FORNECEDOR


      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: grupo
        parameters:
          table_id: grupo
          dump_mode: overwrite
          execute_query: |
            SELECT CD_GRUPO,DS_GRUPO,ST_STATUS FROM SIGMA.VW_GRUPO

      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: subclasse
        parameters:
          table_id: subclasse
          dump_mode: overwrite
          execute_query: |
            SELECT  CD_GRUPO, CD_CLASSE, CD_SUBCLASSE, DS_SUBCLASSE, ST_STATUS FROM SIGMA.VW_SUBCLASSE

      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: ramo_atividade
        parameters:
          table_id: ramo_atividade
          dump_mode: overwrite
          execute_query: |
            SELECT  CD_RAMO, DS_RAMO, ST_RAMO FROM SIGMA.VW_RAMO_ATIVIDADE

      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: material
        parameters:
          table_id: material
          dump_mode: overwrite
          execute_query: |
            SELECT  CD_MATERIAL, CD_GRUPO, CD_CLASSE, CD_SUBCLASSE, SEQUENCIAL, DV1, DV2, NM_PADRONIZADO, NM_COMPLEMENTAR_MATERIAL,
              UNIDADE, DS_DETALHE_MATERIAL, DT_DESATIVACAO, ST_STATUS, REMUME, ACONDICIONAMENTO, TP_GENERO, CD_MATERIAL_SUBSTITUTO,
              NM_FANTASIA, CD_COMPRASNET, TP_MATERIAL, ST_REFERENCIA, ST_SISTEMA_REGISTRO_PRECO, TERMOLABEL, ST_CONTROLADO, ST_PADRONIZADO
              ST_USO_GERAL, ST_CONTINUADO, ST_TABELADO, ST_ITEM_SUSTENTAVEL, OBSERVACAO
            FROM SIGMA.VW_MATERIAL

      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: material_referencia
        parameters:
          table_id: material_referencia
          dump_mode: overwrite
          execute_query: |
            SELECT CD_MATERIAL, CD_GRUPO, CD_CLASSE, CD_SUBCLASSE, SEQUENCIAL, DV1, DV2, CD_REFERENCIA, DS_REFERENCIA, ST_STATUS 
            FROM SIGMA.VW_MATERIAL_REFERENCIA

      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: servico
        parameters:
          table_id: servico
          dump_mode: overwrite
          execute_query: |
            SELECT CD_SERV, CD_SEQ, DV, CD_SERVICO, DS_SERVICO, ST_STATUS, CD_COMPRASNET, NM_PADRONIZADO, UNIDADE_SERVICO, ST_RESPONSAVEL_TECNICO,
              ST_SISTEMA_REGISTRO_PRECO, CD_ATIVIDADE_ECONOMICA, CD_GRUPO_CAE, CD_SUBGRUPO_CAE, CD_ATIVIDADE_CAE, DS_ATIVIDADE_ECONOMICA, DS_SUBGRUPO_CAE,
              ST_TABELADO, ST_CADASTRO_FORNECEDOR 
            FROM SIGMA.VW_SERVICO

      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: servico
        parameters:
          table_id: servico
          dump_mode: overwrite
          execute_query: |
            SELECT NM_PRESTADOR_SERVICO, CPF, MATRICULA, NM_FUNCIONARIO, EMAIL_INSTITUCIONAL, EMAIL_ALTERNATIVO, TEL_CORPORATIVO1, TEL_CORPORATIVO2,
              TEL_ALTERNATIVO1, TEL_ALTERNATIVO2, CD_ORGAO_DESIGNACAO, DS_ORGAO_DESIGNACAO, CD_PERFIL, DS_PERFIL, PRIVILEGIO_ALMOXARIFADO, HORA_ACESSO_INI
              MINUTO_ACESSO_INI, HORA_ACESSO_FIM, MINUTO_ACESSO_FIM, DT_INCLUSAO, ST_STATUS, ST_SITUACAO, CD_TERMINAL, DT_ULTIMA_SESSAO, HORA_ULTIMA_SESSAO
            FROM SIGMA.VW_USUARIO_SISTEMA

      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: servico
        parameters:
          table_id: servico
          dump_mode: overwrite
          execute_query: |
            SELECT cd_orgao, tp_orgao, ds_tipo_orgao, cd_orgao_pai, cd_secretaria_sdi, descricao, endereco, complemento, cep, numero_porta, fax1, fax2,
              tel1, tel2, sigla, email, tp_unidade, st_status, cnes, matricula_responsavel, nm_responsavel, dt_responsavel
            FROM SIGMA.VW_ORGAO

      - interval: 86400
        anchor_date: '2025-07-15T01:10:00'
        timezone: America/Sao_Paulo
        slug: servico
        parameters:
          table_id: servico
          dump_mode: overwrite
          execute_query: |
            SELECT CD_ORGAO, DS_ORGAO, MATRICULA, NM_FUNCIONARIO, TP_FUNCIONARIO, DT_INICIO, DT_TERMINO, DT_TERMO_RESPONSABILIDADE, DT_EXCEPCIONALIDADE,
              DT_PUBLICACAO_DESIGNACAO, ESCOLARIDADE, ST_CURSO_GESTAO_MATERIAL 
            FROM SIGMA.VW_USUARIO_RESPONSAVEL_AUXILIAR
